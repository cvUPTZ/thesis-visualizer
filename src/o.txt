// File: src\App.tsx

import { BrowserRouter } from 'react-router-dom';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { ThemeProvider } from '@/components/ThemeProvider';
import { Toaster } from '@/components/ui/toaster';
import { AuthProvider } from '@/contexts/AuthContext';
import { LanguageProvider } from '@/contexts/LanguageContext';
import Routes from './Routes';
import './App.css';

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 1000 * 60 * 5, // 5 minutes
      retry: 1,
    },
  },
});

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <AuthProvider>
        <LanguageProvider>
          <ThemeProvider>
            <BrowserRouter>
              <Routes />
              <Toaster />
            </BrowserRouter>
          </ThemeProvider>
        </LanguageProvider>
      </AuthProvider>
    </QueryClientProvider>
  );
}

export default App;

// File: src\components\admin\AdminDashboard.tsx

import React from 'react';
import { SystemStats } from './SystemStats';
import { SystemTest } from '../testing/SystemTest';
import { FeatureManagement } from './FeatureManagement';
import { UserManagement } from './UserManagement';
import { ThesisManagement } from './ThesisManagement';
import { IssueManagement } from './IssueManagement';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Activity, AlertTriangle, Users, FileText, Bug, Settings } from 'lucide-react';

export const AdminDashboard = () => {
  console.log('Rendering AdminDashboard');
  
  return (
    <div className="container mx-auto p-6 space-y-6">
      <h1 className="text-3xl font-bold mb-6">Admin Dashboard</h1>
      
      <SystemStats />
      
      <Tabs defaultValue="features" className="space-y-4">
        <TabsList className="grid grid-cols-6 w-full">
          <TabsTrigger value="features" className="flex items-center gap-2">
            <Settings className="w-4 h-4" />
            Features
          </TabsTrigger>
          <TabsTrigger value="users" className="flex items-center gap-2">
            <Users className="w-4 h-4" />
            Users
          </TabsTrigger>
          <TabsTrigger value="theses" className="flex items-center gap-2">
            <FileText className="w-4 h-4" />
            Theses
          </TabsTrigger>
          <TabsTrigger value="issues" className="flex items-center gap-2">
            <Bug className="w-4 h-4" />
            Issues
          </TabsTrigger>
          <TabsTrigger value="tests" className="flex items-center gap-2">
            <AlertTriangle className="w-4 h-4" />
            System Tests
          </TabsTrigger>
          <TabsTrigger value="activity" className="flex items-center gap-2">
            <Activity className="w-4 h-4" />
            Activity
          </TabsTrigger>
        </TabsList>
        
        <TabsContent value="features">
          <FeatureManagement />
        </TabsContent>
        
        <TabsContent value="users">
          <UserManagement />
        </TabsContent>
        
        <TabsContent value="theses">
          <ThesisManagement />
        </TabsContent>
        
        <TabsContent value="issues">
          <IssueManagement />
        </TabsContent>
        
        <TabsContent value="tests">
          <SystemTest />
        </TabsContent>
        
        <TabsContent value="activity">
          <ActivityLog />
        </TabsContent>
      </Tabs>
    </div>
  );
};

// New ActivityLog component for system activity monitoring
const ActivityLog = () => {
  return (
    <div className="rounded-lg border p-6">
      <h2 className="text-2xl font-bold mb-4">System Activity</h2>
      <p className="text-muted-foreground">Activity monitoring coming soon...</p>
    </div>
  );
};

// File: src\components\admin\FeatureManagement.tsx

import React, { useState } from 'react';
import { Button } from '@/components/ui/button';
import { useToast } from '@/hooks/use-toast';
import {
  Table,
  TableBody,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import { Settings, Loader2, Plus, Clock } from 'lucide-react';
import { useQuery } from '@tanstack/react-query';
import { supabase } from '@/integrations/supabase/client';
import { FeatureDialog } from './features/FeatureDialog';
import { FeatureRow } from './features/FeatureRow';
import { FeaturePricingDialog } from './features/FeaturePricingDialog';
import { TrialSettingsDialog } from './features/TrialSettingsDialog';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

export const FeatureManagement = () => {
  const { toast } = useToast();
  const [selectedFeature, setSelectedFeature] = useState<any>(null);
  const [selectedPricingFeature, setSelectedPricingFeature] = useState<any>(null);
  const [isTrialDialogOpen, setIsTrialDialogOpen] = useState(false);
  const [expandedFeatures, setExpandedFeatures] = useState<Set<string>>(new Set());

  const { data: features, isLoading: featuresLoading, error: featuresError, refetch: refetchFeatures } = useQuery({
    queryKey: ['features'],
    queryFn: async () => {
      console.log('Fetching features from Supabase...');
      const { data, error } = await supabase
        .from('features')
        .select('*')
        .order('name');

      if (error) throw error;
      return data;
    }
  });

  const { data: trialSettings, isLoading: trialLoading, refetch: refetchTrial } = useQuery({
    queryKey: ['trial-settings'],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('trial_settings')
        .select('*')
        .single();

      if (error) throw error;
      return data;
    }
  });

  const toggleFeature = async (featureId: string, currentStatus: string) => {
    try {
      const newStatus = currentStatus === 'Active' ? 'Inactive' : 'Active';
      const { error } = await supabase
        .from('features')
        .update({ 
          status: newStatus,
          last_updated: new Date().toISOString()
        })
        .eq('id', featureId);

      if (error) throw error;

      await refetchFeatures();
      
      toast({
        title: "Feature Updated",
        description: `Feature status has been updated to ${newStatus}`,
      });
    } catch (error) {
      console.error('Error updating feature:', error);
      toast({
        title: "Error",
        description: "Failed to update feature status",
        variant: "destructive",
      });
    }
  };

  const updateFeaturePricing = async (featureId: string, pricingTier: string) => {
    try {
      const { error } = await supabase
        .from('features')
        .update({ 
          pricing_tier: pricingTier,
          last_updated: new Date().toISOString()
        })
        .eq('id', featureId);

      if (error) throw error;

      await refetchFeatures();
      
      toast({
        title: "Feature Updated",
        description: `Feature pricing tier has been updated to ${pricingTier}`,
      });
    } catch (error) {
      console.error('Error updating feature pricing:', error);
      toast({
        title: "Error",
        description: "Failed to update feature pricing",
        variant: "destructive",
      });
    }
  };

  const toggleExpand = (featureId: string) => {
    setExpandedFeatures(prev => {
      const next = new Set(prev);
      if (next.has(featureId)) {
        next.delete(featureId);
      } else {
        next.add(featureId);
      }
      return next;
    });
  };

  if (featuresLoading || trialLoading) {
    return (
      <Card className="w-full h-[400px] flex items-center justify-center">
        <CardContent className="flex flex-col items-center gap-4">
          <Loader2 className="h-8 w-8 animate-spin text-primary" />
          <p className="text-muted-foreground">Loading...</p>
        </CardContent>
      </Card>
    );
  }

  if (featuresError) {
    return (
      <Card className="w-full">
        <CardHeader>
          <CardTitle className="text-destructive">Error Loading Features</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-muted-foreground">
            {featuresError instanceof Error ? featuresError.message : 'Failed to load features'}
          </p>
          <Button 
            onClick={() => refetchFeatures()} 
            variant="outline" 
            className="mt-4"
          >
            Retry
          </Button>
        </CardContent>
      </Card>
    );
  }

  const organizedFeatures = features?.reduce((acc: any, feature: any) => {
    if (!feature.parent_id) {
      if (!acc.main) acc.main = [];
      acc.main.push(feature);
    } else {
      if (!acc.sub) acc.sub = {};
      if (!acc.sub[feature.parent_id]) acc.sub[feature.parent_id] = [];
      acc.sub[feature.parent_id].push(feature);
    }
    return acc;
  }, { main: [], sub: {} });

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-2xl font-bold text-admin-accent-tertiary">Feature Management</h2>
        <div className="flex gap-2">
          <Button 
            variant="outline" 
            className="gap-2 text-admin-accent-primary hover:text-admin-accent-secondary border-admin-accent-primary/20 hover:border-admin-accent-secondary/40"
            onClick={() => setIsTrialDialogOpen(true)}
          >
            <Clock className="w-4 h-4" />
            Trial Settings ({trialSettings?.trial_days} days)
          </Button>
          <Button 
            variant="outline" 
            className="gap-2 text-admin-accent-primary hover:text-admin-accent-secondary border-admin-accent-primary/20 hover:border-admin-accent-secondary/40"
          >
            <Settings className="w-4 h-4" />
            Settings
          </Button>
        </div>
      </div>

      <div className="rounded-lg border border-admin-accent-secondary/30">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead className="text-admin-accent-tertiary">Feature Name</TableHead>
              <TableHead className="text-admin-accent-tertiary">Status</TableHead>
              <TableHead className="text-admin-accent-tertiary">Health</TableHead>
              <TableHead className="text-admin-accent-tertiary">Usage</TableHead>
              <TableHead className="text-admin-accent-tertiary">Last Updated</TableHead>
              <TableHead className="text-admin-accent-tertiary">Actions</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {organizedFeatures?.main.map((feature: any) => (
              <FeatureRow
                key={feature.id}
                feature={feature}
                subFeatures={organizedFeatures.sub[feature.id] || []}
                onToggleFeature={toggleFeature}
                onOpenDialog={setSelectedFeature}
                onOpenPricingDialog={setSelectedPricingFeature}
                expanded={expandedFeatures.has(feature.id)}
                onToggleExpand={() => toggleExpand(feature.id)}
              />
            ))}
          </TableBody>
        </Table>
      </div>

      {selectedFeature && (
        <FeatureDialog
          feature={selectedFeature}
          open={!!selectedFeature}
          onOpenChange={(open) => !open && setSelectedFeature(null)}
        />
      )}

      {selectedPricingFeature && (
        <FeaturePricingDialog
          feature={selectedPricingFeature}
          open={!!selectedPricingFeature}
          onOpenChange={(open) => !open && setSelectedPricingFeature(null)}
          onUpdatePricing={updateFeaturePricing}
        />
      )}

      {isTrialDialogOpen && (
        <TrialSettingsDialog
          open={isTrialDialogOpen}
          onOpenChange={setIsTrialDialogOpen}
          currentTrialDays={trialSettings?.trial_days || 14}
          onUpdate={() => refetchTrial()}
        />
      )}
    </div>
  );
};

// File: src\components\admin\features\FeatureDialog.tsx

import React from 'react';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Badge } from "@/components/ui/badge";
import { ScrollArea } from "@/components/ui/scroll-area";

interface FeatureDialogProps {
  feature: {
    name: string;
    description: string | null;
    status: string;
    health: string;
    usage_data: Record<string, string | number>;
    is_sub_feature: boolean;
  };
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

export const FeatureDialog = ({ feature, open, onOpenChange }: FeatureDialogProps) => {
  const formatUsageData = (data: Record<string, string | number> | null) => {
    if (!data) return null;
    return Object.entries(data).map(([key, value]) => (
      <div key={key} className="flex justify-between items-center py-1">
        <span className="text-sm font-medium capitalize">{key.replace(/_/g, ' ')}</span>
        <Badge variant="secondary">{value}</Badge>
      </div>
    ));
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-md">
        <DialogHeader>
          <div className="flex items-center gap-2">
            <DialogTitle>{feature.name}</DialogTitle>
            {feature.is_sub_feature && (
              <Badge variant="outline">Sub-feature</Badge>
            )}
          </div>
          <DialogDescription>
            {feature.description || 'No description available'}
          </DialogDescription>
        </DialogHeader>
        <ScrollArea className="max-h-[60vh]">
          <div className="space-y-4">
            <div>
              <h4 className="font-semibold mb-2">Status</h4>
              <Badge 
                variant={feature.status === 'Active' ? 'default' : 'secondary'}
              >
                {feature.status}
              </Badge>
            </div>
            <div>
              <h4 className="font-semibold mb-2">Health</h4>
              <Badge 
                variant={feature.health === 'healthy' ? 'default' : 'destructive'}
              >
                {feature.health}
              </Badge>
            </div>
            <div>
              <h4 className="font-semibold mb-2">Usage Statistics</h4>
              <div className="bg-muted rounded-lg p-3">
                {formatUsageData(feature.usage_data) || (
                  <p className="text-sm text-muted-foreground">No usage data available</p>
                )}
              </div>
            </div>
          </div>
        </ScrollArea>
      </DialogContent>
    </Dialog>
  );
};

// File: src\components\admin\features\FeaturePricingDialog.tsx

import React from 'react';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Button } from '@/components/ui/button';
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Label } from "@/components/ui/label";

interface FeaturePricingDialogProps {
  feature: {
    id: string;
    name: string;
    pricing_tier: string;
  };
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onUpdatePricing: (featureId: string, pricingTier: string) => Promise<void>;
}

export const FeaturePricingDialog = ({ 
  feature, 
  open, 
  onOpenChange,
  onUpdatePricing 
}: FeaturePricingDialogProps) => {
  const [selectedTier, setSelectedTier] = React.useState(feature.pricing_tier);
  const [isUpdating, setIsUpdating] = React.useState(false);

  const handleUpdate = async () => {
    try {
      setIsUpdating(true);
      await onUpdatePricing(feature.id, selectedTier);
      onOpenChange(false);
    } finally {
      setIsUpdating(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-[425px]">
        <DialogHeader>
          <DialogTitle>Update Feature Pricing</DialogTitle>
          <DialogDescription>
            Set the pricing tier for {feature.name}
          </DialogDescription>
        </DialogHeader>
        <div className="grid gap-4 py-4">
          <RadioGroup
            value={selectedTier}
            onValueChange={setSelectedTier}
            className="grid gap-4"
          >
            <div className="flex items-center space-x-2">
              <RadioGroupItem value="free" id="free" />
              <Label htmlFor="free">Free Tier</Label>
            </div>
            <div className="flex items-center space-x-2">
              <RadioGroupItem value="paid" id="paid" />
              <Label htmlFor="paid">Paid Tier</Label>
            </div>
          </RadioGroup>
        </div>
        <div className="flex justify-end gap-2">
          <Button
            variant="outline"
            onClick={() => onOpenChange(false)}
          >
            Cancel
          </Button>
          <Button
            onClick={handleUpdate}
            disabled={isUpdating || selectedTier === feature.pricing_tier}
          >
            {isUpdating ? 'Updating...' : 'Update'}
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  );
};

// File: src\components\admin\features\FeatureRow.tsx

import React, { useState } from 'react';
import { Button } from '@/components/ui/button';
import { TableCell, TableRow } from '@/components/ui/table';
import { Badge } from '@/components/ui/badge';
import { AlertTriangle, CheckCircle, ChevronRight, ChevronDown, Loader2 } from 'lucide-react';

// Update the FeatureRowProps interface
interface FeatureRowProps {
  feature: {
    id: string;
    name: string;
    description: string | null;
    status: string;
    health: string;
    usage_data: any;
    last_updated: string;
    is_sub_feature: boolean;
    pricing_tier: string;
  };
  subFeatures: any[];
  level?: number;
  onToggleFeature: (featureId: string, currentStatus: string) => Promise<void>;
  onOpenDialog: (feature: any) => void;
  onOpenPricingDialog: (feature: any) => void;
  expanded: boolean;
  onToggleExpand: () => void;
}

export const FeatureRow = ({
  feature,
  subFeatures,
  level = 0,
  onToggleFeature,
  onOpenDialog,
  onOpenPricingDialog,
  expanded,
  onToggleExpand,
}: FeatureRowProps) => {
  const [isUpdating, setIsUpdating] = useState(false);

  const getStatusBadge = (status: string) => {
    const variants: { [key: string]: string } = {
      'Active': 'bg-green-500',
      'In Development': 'bg-blue-500',
      'Beta': 'bg-yellow-500',
      'Inactive': 'bg-gray-500'
    };
    return (
      <Badge className={`${variants[status] || 'bg-gray-500'} text-white`}>
        {status}
      </Badge>
    );
  };

  const getHealthIcon = (health: string) => {
    if (health === 'healthy') {
      return <CheckCircle className="text-green-500 w-5 h-5" />;
    }
    return <AlertTriangle className="text-yellow-500 w-5 h-5" />;
  };

  const handleToggleFeature = async (featureId: string, currentStatus: string) => {
    try {
      setIsUpdating(true);
      await onToggleFeature(featureId, currentStatus);
    } finally {
      setIsUpdating(false);
    }
  };

  const formatUsageData = (usageData: any) => {
    if (!usageData) return 'N/A';
    
    const entries = Object.entries(usageData);
    for (const [key, value] of entries) {
      if (typeof value === 'number') {
        return value.toString();
      }
      if (typeof value === 'string' && value.includes('%')) {
        return value;
      }
    }
    
    return entries[0]?.[1]?.toString() || 'N/A';
  };

  const hasSubFeatures = subFeatures.length > 0;

  return (
    <>
      <TableRow className={level > 0 ? 'bg-gray-50' : ''}>
        <TableCell className="font-medium">
          <div className="flex items-center gap-2" style={{ paddingLeft: `${level * 20}px` }}>
            {hasSubFeatures && (
              <Button
                variant="ghost"
                size="sm"
                className="p-0 h-6 w-6 text-admin-accent-primary hover:text-admin-accent-secondary"
                onClick={onToggleExpand}
              >
                {expanded ? (
                  <ChevronDown className="h-4 w-4" />
                ) : (
                  <ChevronRight className="h-4 w-4" />
                )}
              </Button>
            )}
            <Button 
              variant="link" 
              className="p-0 text-admin-accent-primary hover:text-admin-accent-secondary transition-colors"
              onClick={() => onOpenDialog(feature)}
            >
              {feature.name}
            </Button>
          </div>
        </TableCell>
        <TableCell>{getStatusBadge(feature.status)}</TableCell>
        <TableCell>{getHealthIcon(feature.health)}</TableCell>
        <TableCell>{formatUsageData(feature.usage_data)}</TableCell>
        <TableCell>{new Date(feature.last_updated).toLocaleDateString()}</TableCell>
        <TableCell>
          <div className="flex gap-2">
            <Button
              variant="outline"
              size="sm"
              onClick={() => handleToggleFeature(feature.id, feature.status)}
              disabled={isUpdating}
              className="text-admin-accent-primary hover:text-admin-accent-secondary border-admin-accent-primary/20 hover:border-admin-accent-secondary/40"
            >
              {isUpdating ? (
                <Loader2 className="h-4 w-4 animate-spin mr-2" />
              ) : null}
              Toggle Status
            </Button>
            <Button
              variant="outline"
              size="sm"
              onClick={() => onOpenPricingDialog(feature)}
              className="text-admin-accent-primary hover:text-admin-accent-secondary border-admin-accent-primary/20 hover:border-admin-accent-secondary/40"
            >
              {feature.pricing_tier === 'paid' ? 'ðŸ’Ž Paid' : 'ðŸ†“ Free'}
            </Button>
          </div>
        </TableCell>
      </TableRow>
      {expanded && hasSubFeatures && subFeatures.map((subFeature) => (
        <FeatureRow
          key={subFeature.id}
          feature={subFeature}
          subFeatures={[]}
          level={level + 1}
          onToggleFeature={onToggleFeature}
          onOpenDialog={onOpenDialog}
          onOpenPricingDialog={onOpenPricingDialog}
          expanded={false}
          onToggleExpand={() => {}}
        />
      ))}
    </>
  );
};


// File: src\components\admin\features\TrialSettingsDialog.tsx

import React, { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { useToast } from '@/hooks/use-toast';
import { supabase } from '@/integrations/supabase/client';

interface TrialSettingsDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  settings?: { id: string; trial_days: number };
  currentTrialDays?: number;
  onUpdate?: () => Promise<any>;
}

export const TrialSettingsDialog: React.FC<TrialSettingsDialogProps> = ({ 
  open, 
  onOpenChange, 
  settings,
  currentTrialDays,
  onUpdate 
}) => {
  const { toast } = useToast();
  const [trialDays, setTrialDays] = useState<number>(currentTrialDays || settings?.trial_days || 0);

  useEffect(() => {
    if (currentTrialDays !== undefined) {
      setTrialDays(currentTrialDays);
    }
  }, [currentTrialDays]);

  const handleSave = async () => {
    try {
      const { error } = await supabase
        .from('trial_settings')
        .update({ trial_days: trialDays })
        .eq('id', settings?.id);

      if (error) throw error;

      toast({
        title: "Success",
        description: "Trial settings updated successfully",
      });
      
      if (onUpdate) await onUpdate();
      onOpenChange(false);
    } catch (error) {
      console.error('Error updating trial settings:', error);
      toast({
        title: "Error",
        description: "Failed to update trial settings",
        variant: "destructive",
      });
    }
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Trial Settings</DialogTitle>
          <div className="space-y-4">
            <input
              type="number"
              value={trialDays}
              onChange={(e) => setTrialDays(Number(e.target.value))}
              placeholder="Trial Days"
              className="w-full"
            />
            <Button onClick={handleSave} className="w-full">
              Save
            </Button>
          </div>
        </DialogHeader>
      </DialogContent>
    </Dialog>
  );
};

// File: src\components\admin\IssueManagement.tsx

import React from 'react';
import { useQuery } from '@tanstack/react-query';
import { supabase } from '@/integrations/supabase/client';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import { Badge } from '@/components/ui/badge';
import { Loader2, RefreshCw } from 'lucide-react';

export const IssueManagement = () => {
  const { data: issues, isLoading, error, refetch } = useQuery({
    queryKey: ['app-issues'],
    queryFn: async () => {
      console.log('Fetching app issues...');
      const { data, error } = await supabase
        .from('app_issues')
        .select(`
          *,
          profiles (
            email
          )
        `)
        .order('created_at', { ascending: false });

      if (error) throw error;
      return data;
    }
  });

  if (isLoading) {
    return (
      <Card className="w-full h-[400px] flex items-center justify-center">
        <CardContent className="flex flex-col items-center gap-4">
          <Loader2 className="h-8 w-8 animate-spin text-primary" />
          <p className="text-muted-foreground">Loading issues...</p>
        </CardContent>
      </Card>
    );
  }

  if (error) {
    return (
      <Card>
        <CardHeader>
          <CardTitle className="text-destructive">Error Loading Issues</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-muted-foreground">
            {error instanceof Error ? error.message : 'Failed to load issues'}
          </p>
          <Button 
            onClick={() => refetch()} 
            variant="outline" 
            className="mt-4"
          >
            Retry
          </Button>
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-2xl font-bold">Application Issues</h2>
        <Button 
          onClick={() => refetch()} 
          variant="outline" 
          className="gap-2"
        >
          <RefreshCw className="w-4 h-4" />
          Refresh
        </Button>
      </div>

      <div className="rounded-lg border">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Component</TableHead>
              <TableHead>Error Message</TableHead>
              <TableHead>User</TableHead>
              <TableHead>Browser</TableHead>
              <TableHead>Created At</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {issues?.map((issue) => (
              <TableRow key={issue.id}>
                <TableCell>
                  <Badge variant="outline">
                    {issue.component_name || 'Unknown'}
                  </Badge>
                </TableCell>
                <TableCell className="max-w-md truncate">
                  {issue.error_message}
                </TableCell>
                <TableCell>{issue.profiles?.email || 'Anonymous'}</TableCell>
                <TableCell className="max-w-xs truncate">
                  {issue.browser_info}
                </TableCell>
                <TableCell>
                  {new Date(issue.created_at).toLocaleString()}
                </TableCell>
              </TableRow>
            ))}
            {!issues?.length && (
              <TableRow>
                <TableCell colSpan={5} className="text-center py-8">
                  No issues found
                </TableCell>
              </TableRow>
            )}
          </TableBody>
        </Table>
      </div>
    </div>
  );
};

// File: src\components\admin\issues\IssueDetailsDialog.tsx

import React from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Button } from '@/components/ui/button';

interface IssueDetailsDialogProps {
  issue: any;
}

export const IssueDetailsDialog = ({ issue }: IssueDetailsDialogProps) => {
  return (
    <Dialog>
      <DialogTrigger asChild>
        <Button variant="outline" size="sm">
          View Details
        </Button>
      </DialogTrigger>
      <DialogContent className="max-w-3xl">
        <DialogHeader>
          <DialogTitle>Issue Details</DialogTitle>
        </DialogHeader>
        <ScrollArea className="h-[400px] w-full rounded-md border p-4">
          <div className="space-y-4">
            <div>
              <h3 className="font-semibold">Error Message</h3>
              <p className="text-sm">{issue.error_message}</p>
            </div>
            {issue.error_stack && (
              <div>
                <h3 className="font-semibold">Stack Trace</h3>
                <pre className="text-sm bg-muted p-2 rounded overflow-x-auto">
                  {issue.error_stack}
                </pre>
              </div>
            )}
            {issue.component_name && (
              <div>
                <h3 className="font-semibold">Component</h3>
                <pre className="text-sm bg-muted p-2 rounded">
                  {issue.component_name}
                </pre>
              </div>
            )}
            {issue.browser_info && (
              <div>
                <h3 className="font-semibold">Browser Information</h3>
                <pre className="text-sm bg-muted p-2 rounded overflow-x-auto">
                  {JSON.stringify(JSON.parse(issue.browser_info), null, 2)}
                </pre>
              </div>
            )}
          </div>
        </ScrollArea>
      </DialogContent>
    </Dialog>
  );
};

// File: src\components\admin\issues\IssueTable.tsx

import React from 'react';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { IssueDetailsDialog } from './IssueDetailsDialog';

interface IssueTableProps {
  issues: any[];
  formatDate: (date: string) => string;
}

export const IssueTable = ({ issues, formatDate }: IssueTableProps) => {
  const getStatusBadge = (error: any) => {
    if (error.error_stack?.includes('TypeError')) {
      return <Badge variant="destructive">Type Error</Badge>;
    }
    if (error.error_stack?.includes('ReferenceError')) {
      return <Badge variant="destructive">Reference Error</Badge>;
    }
    if (error.error_stack?.includes('SyntaxError')) {
      return <Badge variant="destructive">Syntax Error</Badge>;
    }
    return <Badge variant="secondary">Runtime Error</Badge>;
  };

  return (
    <Table>
      <TableHeader>
        <TableRow>
          <TableHead>Status</TableHead>
          <TableHead>User</TableHead>
          <TableHead>Error Message</TableHead>
          <TableHead>Component</TableHead>
          <TableHead>Route</TableHead>
          <TableHead>Date</TableHead>
          <TableHead>Details</TableHead>
        </TableRow>
      </TableHeader>
      <TableBody>
        {issues.map((issue) => (
          <TableRow key={issue.id}>
            <TableCell>{getStatusBadge(issue)}</TableCell>
            <TableCell>{issue.profiles?.email || 'Anonymous'}</TableCell>
            <TableCell className="max-w-[300px] truncate">
              {issue.error_message}
            </TableCell>
            <TableCell>{issue.component_name || 'N/A'}</TableCell>
            <TableCell>{issue.route_path || 'N/A'}</TableCell>
            <TableCell>{formatDate(issue.created_at)}</TableCell>
            <TableCell>
              <IssueDetailsDialog issue={issue} />
            </TableCell>
          </TableRow>
        ))}
      </TableBody>
    </Table>
  );
};

// File: src\components\admin\SystemStats.tsx

import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Users, FileText, AlertTriangle, Activity, Loader2 } from 'lucide-react';
import { useQuery } from '@tanstack/react-query';
import { supabase } from '@/integrations/supabase/client';
import { Button } from '@/components/ui/button';

export const SystemStats = () => {
  const { data: stats, isLoading, error, refetch } = useQuery({
    queryKey: ['system-stats'],
    queryFn: async () => {
      console.log('Fetching system statistics...');
      
      try {
        // Get total users count
        const { count: usersCount, error: usersError } = await supabase
          .from('profiles')
          .select('*', { count: 'exact', head: true });

        if (usersError) {
          console.error('Error fetching users count:', usersError);
          throw usersError;
        }

        // Get total theses count
        const { count: thesesCount, error: thesesError } = await supabase
          .from('theses')
          .select('*', { count: 'exact', head: true });

        if (thesesError) {
          console.error('Error fetching theses count:', thesesError);
          throw thesesError;
        }

        // Get system issues count
        const { count: issuesCount, error: issuesError } = await supabase
          .from('app_issues')
          .select('*', { count: 'exact', head: true });

        if (issuesError) {
          console.error('Error fetching issues count:', issuesError);
          throw issuesError;
        }

        // Calculate system health (example metric: 100 - (issues/users * 100))
        const healthPercentage = usersCount 
          ? Math.max(0, Math.min(100, 100 - (issuesCount / usersCount * 100)))
          : 100;

        console.log('System statistics fetched:', {
          usersCount,
          thesesCount,
          issuesCount,
          healthPercentage
        });

        return {
          users: usersCount || 0,
          theses: thesesCount || 0,
          issues: issuesCount || 0,
          health: healthPercentage.toFixed(1)
        };
      } catch (error) {
        console.error('Error fetching system stats:', error);
        throw error;
      }
    },
    refetchInterval: 30000, // Refresh every 30 seconds
    retry: 3, // Retry failed requests 3 times
    staleTime: 10000, // Consider data stale after 10 seconds
  });

  if (error) {
    return (
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
        <Card className="col-span-full">
          <CardContent className="pt-6">
            <div className="text-center text-destructive">
              <AlertTriangle className="h-8 w-8 mx-auto mb-2" />
              <p>Error loading system statistics</p>
              <Button
                variant="outline"
                size="sm"
                onClick={() => refetch()}
                className="mt-2"
              >
                Retry
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  const StatCard = ({ 
    title, 
    value, 
    description, 
    icon: Icon 
  }: { 
    title: string;
    value: string | number;
    description: string;
    icon: React.ElementType;
  }) => (
    <Card>
      <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
        <CardTitle className="text-sm font-medium">
          {title}
        </CardTitle>
        <Icon className="h-4 w-4 text-muted-foreground" />
      </CardHeader>
      <CardContent>
        <div className="text-2xl font-bold">
          {isLoading ? (
            <div className="flex items-center space-x-2">
              <Loader2 className="h-4 w-4 animate-spin" />
              <span className="text-muted">Loading...</span>
            </div>
          ) : value}
        </div>
        <p className="text-xs text-muted-foreground">
          {description}
        </p>
      </CardContent>
    </Card>
  );

  return (
    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
      <StatCard
        title="Total Users"
        value={stats?.users || 0}
        description="Active system users"
        icon={Users}
      />
      <StatCard
        title="Total Theses"
        value={stats?.theses || 0}
        description="Total theses in system"
        icon={FileText}
      />
      <StatCard
        title="System Issues"
        value={stats?.issues || 0}
        description="Reported issues"
        icon={AlertTriangle}
      />
      <StatCard
        title="System Health"
        value={`${stats?.health || 0}%`}
        description="Overall system status"
        icon={Activity}
      />
    </div>
  );
};


// File: src\components\admin\ThesisManagement.tsx

import React, { useState, useEffect } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { Button } from '@/components/ui/button';
import { useToast } from '@/hooks/use-toast';
import { useNavigate } from 'react-router-dom';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import { Eye, Trash2 } from 'lucide-react';

export const ThesisManagement = () => {
  const [theses, setTheses] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const { toast } = useToast();
  const navigate = useNavigate();

  useEffect(() => {
    fetchTheses();
  }, []);

  const fetchTheses = async () => {
    try {
      const { data, error } = await supabase
        .from('theses')
        .select(`
          *,
          thesis_collaborators (
            user_id,
            role,
            profiles (
              email
            )
          )
        `);

      if (error) throw error;
      setTheses(data || []);
    } catch (error: any) {
      console.error('Error fetching theses:', error);
      toast({
        title: 'Error',
        description: 'Failed to fetch theses',
        variant: 'destructive',
      });
    } finally {
      setLoading(false);
    }
  };

  const handleDelete = async (thesisId: string) => {
    try {
      const { error } = await supabase
        .from('theses')
        .delete()
        .eq('id', thesisId);

      if (error) throw error;

      toast({
        title: 'Success',
        description: 'Thesis deleted successfully',
      });
      fetchTheses();
    } catch (error: any) {
      console.error('Error deleting thesis:', error);
      toast({
        title: 'Error',
        description: 'Failed to delete thesis',
        variant: 'destructive',
      });
    }
  };

  const viewThesis = (thesisId: string) => {
    navigate(`/thesis/${thesisId}`);
  };

  if (loading) {
    return <div>Loading theses...</div>;
  }

  return (
    <div>
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>Title</TableHead>
            <TableHead>Owner</TableHead>
            <TableHead>Created At</TableHead>
            <TableHead>Actions</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {theses.map((thesis) => (
            <TableRow key={thesis.id}>
              <TableCell>{thesis.title}</TableCell>
              <TableCell>
                {thesis.thesis_collaborators?.find((tc: any) => tc.role === 'owner')?.profiles?.email || 'No owner'}
              </TableCell>
              <TableCell>
                {new Date(thesis.created_at).toLocaleDateString()}
              </TableCell>
              <TableCell className="space-x-2">
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => viewThesis(thesis.id)}
                >
                  <Eye className="w-4 h-4" />
                </Button>
                <Button
                  variant="destructive"
                  size="sm"
                  onClick={() => handleDelete(thesis.id)}
                >
                  <Trash2 className="w-4 h-4" />
                </Button>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  );
};

// File: src\components\admin\UserManagement.tsx

import React, { useState, useEffect } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { useToast } from '@/hooks/use-toast';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Badge } from '@/components/ui/badge';
import { Shield, ShieldCheck, User, Settings, UserPlus } from 'lucide-react';

export const UserManagement = () => {
  const [users, setUsers] = useState<any[]>([]);
  const [roles, setRoles] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const { toast } = useToast();

  useEffect(() => {
    fetchUsers();
    fetchRoles();
  }, []);

  const fetchRoles = async () => {
    try {
      const { data, error } = await supabase
        .from('roles')
        .select('*');

      if (error) throw error;
      setRoles(data || []);
    } catch (error: any) {
      console.error('Error fetching roles:', error);
      toast({
        title: 'Error',
        description: 'Failed to fetch roles',
        variant: 'destructive',
      });
    }
  };

  const fetchUsers = async () => {
    try {
      console.log('Fetching users...');
      const { data, error } = await supabase
        .from('profiles')
        .select(`
          *,
          roles (
            name
          )
        `);

      if (error) throw error;
      console.log('Users fetched:', data);
      setUsers(data || []);
    } catch (error: any) {
      console.error('Error fetching users:', error);
      toast({
        title: 'Error',
        description: 'Failed to fetch users',
        variant: 'destructive',
      });
    } finally {
      setLoading(false);
    }
  };

  const updateUserRole = async (userId: string, roleId: string) => {
    try {
      console.log('Updating user role...', { userId, roleId });
      const { error } = await supabase
        .from('profiles')
        .update({ role_id: roleId })
        .eq('id', userId);

      if (error) throw error;

      toast({
        title: 'Success',
        description: 'User role updated successfully',
      });
      fetchUsers();
    } catch (error: any) {
      console.error('Error updating user role:', error);
      toast({
        title: 'Error',
        description: 'Failed to update user role',
        variant: 'destructive',
      });
    }
  };

  const getRoleBadgeColor = (roleName: string) => {
    switch (roleName) {
      case 'admin':
        return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
      case 'user':
        return 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
      default:
        return 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';
    }
  };

  if (loading) {
    return <div className="flex items-center justify-center p-8">Loading users...</div>;
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h2 className="text-2xl font-bold text-admin-accent-tertiary">User Management</h2>
        <div className="flex gap-2">
          <Button 
            variant="outline" 
            className="gap-2 text-admin-accent-primary hover:text-admin-accent-secondary border-admin-accent-primary/20 hover:border-admin-accent-secondary/40"
          >
            <UserPlus className="w-4 h-4" />
            Add User
          </Button>
          <Button 
            variant="outline" 
            className="gap-2 text-admin-accent-primary hover:text-admin-accent-secondary border-admin-accent-primary/20 hover:border-admin-accent-secondary/40"
          >
            <Settings className="w-4 h-4" />
            Settings
          </Button>
        </div>
      </div>
      
      <div className="rounded-md border border-admin-accent-secondary/30">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead className="text-admin-accent-tertiary">User</TableHead>
              <TableHead className="text-admin-accent-tertiary">Current Role</TableHead>
              <TableHead className="text-admin-accent-tertiary">Actions</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {users.map((user) => (
              <TableRow key={user.id} className="hover:bg-muted/50">
                <TableCell className="font-medium">
                  <div className="flex items-center gap-2">
                    <User className="h-4 w-4 text-admin-accent-primary" />
                    {user.email}
                  </div>
                </TableCell>
                <TableCell>
                  <Badge 
                    variant="secondary"
                    className={`${getRoleBadgeColor(user.roles?.name)} flex w-fit items-center gap-1`}
                  >
                    {user.roles?.name === 'admin' ? (
                      <ShieldCheck className="h-3 w-3" />
                    ) : (
                      <Shield className="h-3 w-3" />
                    )}
                    {user.roles?.name || 'No role'}
                  </Badge>
                </TableCell>
                <TableCell>
                  <Select
                    onValueChange={(value) => updateUserRole(user.id, value)}
                    defaultValue={user.role_id || ''}
                  >
                    <SelectTrigger className="w-[180px] border-admin-accent-primary/20 text-admin-accent-primary">
                      <SelectValue placeholder="Select a role" />
                    </SelectTrigger>
                    <SelectContent>
                      {roles.map((role) => (
                        <SelectItem key={role.id} value={role.id}>
                          {role.name}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </div>
    </div>
  );
};

// File: src\components\auth\EmailAuthForm.tsx

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { supabase } from '@/integrations/supabase/client';
import { AuthError } from '@supabase/supabase-js';
import { Loader2 } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';

interface EmailAuthFormProps {
  mode: 'signin' | 'signup';
  onModeChange: () => void;
  onError: (error: AuthError) => void;
}

export const EmailAuthForm = ({ mode, onModeChange, onError }: EmailAuthFormProps) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [lastAttempt, setLastAttempt] = useState(0);
  const { toast } = useToast();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    // Check if enough time has passed since last attempt (3 seconds)
    const now = Date.now();
    if (now - lastAttempt < 3000) {
      toast({
        title: "Please wait",
        description: "Please wait a few seconds before trying again",
        variant: "destructive",
      });
      return;
    }
    
    setLastAttempt(now);
    setLoading(true);

    try {
      console.log('ðŸ” Attempting auth:', mode);
      const { error } = mode === 'signin'
        ? await supabase.auth.signInWithPassword({ email, password })
        : await supabase.auth.signUp({ email, password });

      if (error) {
        console.error('âŒ Auth error:', error);
        
        // Handle rate limiting specifically
        if (error.message.includes('rate limit')) {
          toast({
            title: "Too many attempts",
            description: "Please wait a moment before trying again",
            variant: "destructive",
          });
        } else {
          onError(error);
        }
      } else {
        console.log('âœ… Auth successful');
        if (mode === 'signup') {
          toast({
            title: "Success",
            description: "Please check your email to verify your account",
          });
        }
      }
    } catch (err) {
      if (err instanceof Error) {
        console.error('âŒ Unexpected auth error:', err);
        onError(err as AuthError);
      }
    } finally {
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div>
        <Input
          type="email"
          placeholder="Email"
          value={email}
          onChange={(e) => setEmail(e.target.value)}
          required
          className="bg-gray-800/50 border-gray-700 text-white placeholder:text-gray-400"
          disabled={loading}
        />
      </div>
      <div>
        <Input
          type="password"
          placeholder="Password"
          value={password}
          onChange={(e) => setPassword(e.target.value)}
          required
          className="bg-gray-800/50 border-gray-700 text-white placeholder:text-gray-400"
          disabled={loading}
        />
      </div>
      <Button
        type="submit"
        className="w-full"
        disabled={loading}
      >
        {loading ? (
          <>
            <Loader2 className="mr-2 h-4 w-4 animate-spin" />
            {mode === 'signin' ? 'Signing in...' : 'Signing up...'}
          </>
        ) : (
          mode === 'signin' ? 'Sign In' : 'Sign Up'
        )}
      </Button>
      <div className="text-center">
        <Button
          type="button"
          variant="link"
          className="text-[#9b87f5]"
          onClick={onModeChange}
          disabled={loading}
        >
          {mode === 'signin'
            ? "Don't have an account? Sign up"
            : 'Already have an account? Sign in'}
        </Button>
      </div>
    </form>
  );
};

// File: src\components\auth\SocialAuth.tsx

import { Button } from '@/components/ui/button';
import { supabase } from '@/integrations/supabase/client';
import { AuthError, Provider } from '@supabase/supabase-js';
import { Github, Loader2, Mail } from 'lucide-react';

interface SocialAuthProps {
  isLoading: boolean;
  setLoading: (loading: boolean) => void;
  onError: (error: AuthError) => void;
}

export const SocialAuth = ({ isLoading, setLoading, onError }: SocialAuthProps) => {
  const handleSocialLogin = async (provider: Provider) => {
    try {
      console.log('ðŸ”‘ Initiating social login with:', provider);
      setLoading(true);
      const { error } = await supabase.auth.signInWithOAuth({
        provider,
        options: {
          redirectTo: `${window.location.origin}/auth/callback`,
          queryParams: provider === 'google' ? {
            access_type: 'offline',
            prompt: 'consent',
          } : undefined
        }
      });

      if (error) {
        console.error('âŒ Social auth error:', error);
        onError(error);
      }
    } catch (err) {
      if (err instanceof Error) {
        console.error('âŒ Social auth error:', err);
        onError(err as AuthError);
      }
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-2">
      <Button
        type="button"
        variant="outline"
        className="w-full bg-gray-800/50 border-gray-700 text-white hover:bg-gray-700/50"
        onClick={() => handleSocialLogin('github')}
        disabled={isLoading}
      >
        {isLoading ? (
          <Loader2 className="mr-2 h-4 w-4 animate-spin" />
        ) : (
          <Github className="mr-2 h-4 w-4" />
        )}
        Continue with GitHub
      </Button>

      <Button
        type="button"
        variant="outline"
        className="w-full bg-white/10 border-gray-700 text-white hover:bg-white/20"
        onClick={() => handleSocialLogin('google')}
        disabled={isLoading}
      >
        {isLoading ? (
          <Loader2 className="mr-2 h-4 w-4 animate-spin" />
        ) : (
          <svg className="mr-2 h-4 w-4" viewBox="0 0 24 24">
            <path
              fill="currentColor"
              d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
            />
            <path
              fill="currentColor"
              d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
            />
            <path
              fill="currentColor"
              d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
            />
            <path
              fill="currentColor"
              d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
            />
          </svg>
        )}
        Continue with Google
      </Button>
    </div>
  );
};

// File: src\components\ChapterManager.tsx

import React from 'react';
import { Chapter, Section, SectionType } from '@/types/thesis';
import { Button } from '@/components/ui/button';
import { BookOpen, PlusCircle, Trash2 } from 'lucide-react';
import { ChapterItem } from './editor/chapters/ChapterItem';
import { useToast } from '@/hooks/use-toast';
import { ChapterCreationDialog } from './editor/chapters/ChapterCreationDialog';
import { useNavigate } from 'react-router-dom';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { Card } from './ui/card';
import { createEmptySection } from '@/utils/thesisUtils';

interface ChapterManagerProps {
  chapters: Chapter[];
  onUpdateChapter: (chapter: Chapter) => void;
  onAddChapter: (chapter: Chapter) => void;
  onRemoveChapter?: (chapterId: string) => void;
}

export const ChapterManager: React.FC<ChapterManagerProps> = ({
  chapters,
  onUpdateChapter,
  onAddChapter,
  onRemoveChapter
}) => {
  const [openChapters, setOpenChapters] = React.useState<string[]>([]);
  const [showCreateDialog, setShowCreateDialog] = React.useState(false);
  const [chaptersToDelete, setChaptersToDelete] = React.useState<string[]>([]);
  const { toast } = useToast();
  const navigate = useNavigate();

  const handleCreateChapter = (chapter: Chapter) => {
    console.log('Handling chapter creation:', chapter);
    onAddChapter(chapter);
    toast({
      title: "Chapter Added",
      description: "New chapter has been created successfully",
    });
  };

  const handleNavigateToSection = (sectionType: string) => {
    const thesisId = window.location.pathname.split('/')[2];
    const sectionPath = sectionType.toLowerCase().replace(/ /g, '-') as SectionType;
    
    // Create a new section using the utility function
    const newSection = createEmptySection(sectionPath);

    // Navigate to the section
    navigate(`/thesis/${thesisId}/section/${sectionPath}`);
  };

  const handleDeleteChapters = () => {
    if (onRemoveChapter && chaptersToDelete.length > 0) {
      console.log('Deleting chapters:', chaptersToDelete);
      chaptersToDelete.forEach(chapterId => {
        onRemoveChapter(chapterId);
      });
      setChaptersToDelete([]);
      toast({
        title: "Chapters Deleted",
        description: `${chaptersToDelete.length} chapter(s) have been removed successfully`,
      });
    }
  };

  const sectionTypes = [
    {
      title: "Thesis Structure Overview",
      description: "Outline the structure and organization of your thesis"
    },
    {
      title: "General Introduction",
      description: "Introduce your research topic and objectives"
    },
    {
      title: "Abstract",
      description: "Summarize your research and findings"
    },
    {
      title: "Acknowledgements",
      description: "Thank those who supported your research"
    },
    {
      title: "General Conclusion",
      description: "Summarize your findings and conclusions"
    }
  ];

  return (
    <div className="space-y-6 animate-fade-in">
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {sectionTypes.map((section) => (
          <Card
            key={section.title}
            className="p-6 cursor-pointer hover:shadow-lg transition-all duration-200 hover:scale-105"
            onClick={() => handleNavigateToSection(section.title)}
          >
            <h3 className="text-lg font-semibold mb-2">{section.title}</h3>
            <p className="text-sm text-muted-foreground">{section.description}</p>
          </Card>
        ))}
        <Card
          className="p-6 cursor-pointer hover:shadow-lg transition-all duration-200 border-dashed border-2 hover:scale-105"
          onClick={() => setShowCreateDialog(true)}
        >
          <div className="flex flex-col items-center justify-center h-full text-center">
            <PlusCircle className="w-8 h-8 mb-2 text-muted-foreground" />
            <h3 className="text-lg font-semibold">New Chapter</h3>
            <p className="text-sm text-muted-foreground">Add a new chapter to your thesis</p>
          </div>
        </Card>
      </div>

      <div className="space-y-4">
        {chapters.map((chapter) => (
          <ChapterItem
            key={chapter.id}
            chapter={chapter}
            chapterNumber={chapters.findIndex(c => c.id === chapter.id) + 1}
            isOpen={openChapters.includes(chapter.id)}
            onToggle={() => setOpenChapters(prev => 
              prev.includes(chapter.id) 
                ? prev.filter(id => id !== chapter.id)
                : [...prev, chapter.id]
            )}
            onUpdateChapter={onUpdateChapter}
            isSelected={chaptersToDelete.includes(chapter.id)}
            onSelect={() => setChaptersToDelete(prev =>
              prev.includes(chapter.id)
                ? prev.filter(id => id !== chapter.id)
                : [...prev, chapter.id]
            )}
          />
        ))}
      </div>

      {chaptersToDelete.length > 0 && (
        <div className="fixed bottom-4 right-4 bg-background border rounded-lg shadow-lg p-4 animate-slide-in-right">
          <div className="flex items-center gap-4">
            <span className="text-sm font-medium">
              {chaptersToDelete.length} chapter(s) selected
            </span>
            <Button
              onClick={() => handleDeleteChapters()}
              variant="destructive"
              className="flex items-center gap-2"
            >
              <Trash2 className="w-4 h-4" />
              Delete Selected
            </Button>
          </div>
        </div>
      )}

      <ChapterCreationDialog
        open={showCreateDialog}
        onOpenChange={setShowCreateDialog}
        onChapterCreate={handleCreateChapter}
      />

      <AlertDialog open={chaptersToDelete.length > 0} onOpenChange={(open) => !open && setChaptersToDelete([])}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Are you sure?</AlertDialogTitle>
            <AlertDialogDescription>
              This action cannot be undone. This will permanently delete {chaptersToDelete.length} chapter(s) and all their contents.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Cancel</AlertDialogCancel>
            <AlertDialogAction
              onClick={handleDeleteChapters}
              className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
            >
              Delete
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
};

// File: src\components\citation\CitationCard.tsx

import React, { useState } from 'react';
import { Citation } from '@/types/thesis';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { X, Quote, Edit2, Eye } from 'lucide-react';
import { TagInput } from '@/components/ui/tag-input';
import { useToast } from '@/hooks/use-toast';
import { supabase } from '@/integrations/supabase/client';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";

interface CitationCardProps {
  citation: Citation;
  onRemove: (id: string) => void;
  onUpdate: (citation: Citation) => void;
  onPreview?: () => void;
}

export const CitationCard = ({ citation, onRemove, onUpdate, onPreview }: CitationCardProps) => {
  const [isEditing, setIsEditing] = useState(false);
  const [authors, setAuthors] = useState(citation.authors);
  const { toast } = useToast();

  const handleRemove = async () => {
    try {
      const { error } = await supabase
        .from('citations')
        .delete()
        .eq('id', citation.id);

      if (error) throw error;

      onRemove(citation.id);
      toast({
        title: "Success",
        description: "Citation removed successfully",
      });
    } catch (error: any) {
      console.error('Error removing citation:', error);
      toast({
        title: "Error",
        description: "Failed to remove citation: " + error.message,
        variant: "destructive",
      });
    }
  };

  const handleUpdate = async (updatedFields: Partial<Citation>) => {
    try {
      const updatedCitation = { ...citation, ...updatedFields };
      
      const { error } = await supabase
        .from('citations')
        .update(updatedCitation)
        .eq('id', citation.id);

      if (error) throw error;

      onUpdate(updatedCitation);
      toast({
        title: "Success",
        description: "Citation updated successfully",
      });
    } catch (error: any) {
      console.error('Error updating citation:', error);
      toast({
        title: "Error",
        description: "Failed to update citation: " + error.message,
        variant: "destructive",
      });
    }
  };

  const handleAuthorChange = (tags: string[]) => {
    setAuthors(tags);
    handleUpdate({ authors: tags });
  };

  return (
    <Card className="group relative border-2 border-editor-border transition-all duration-200 hover:shadow-lg">
      <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
        <CardTitle className="text-sm font-medium">
          <Quote className="w-4 h-4 inline mr-2" />
          {citation.type.charAt(0).toUpperCase() + citation.type.slice(1)} Citation
        </CardTitle>
        <div className="flex gap-2 opacity-0 transition-opacity group-hover:opacity-100">
          <Button
            variant="ghost"
            size="sm"
            onClick={() => setIsEditing(!isEditing)}
            className="h-8 w-8 p-0"
          >
            <Edit2 className="h-4 w-4" />
          </Button>
          {onPreview && (
            <Button
              variant="ghost"
              size="sm"
              onClick={onPreview}
              className="h-8 w-8 p-0"
            >
              <Eye className="h-4 w-4" />
            </Button>
          )}
          <Button
            variant="ghost"
            size="sm"
            onClick={handleRemove}
            className="h-8 w-8 p-0"
          >
            <X className="w-4 h-4" />
          </Button>
        </div>
      </CardHeader>
      <CardContent className="space-y-3">
        <Select
          value={citation.type}
          onValueChange={(value: 'book' | 'article' | 'conference' | 'website' | 'other') =>
            handleUpdate({ type: value })
          }
        >
          <SelectTrigger className="w-full">
            <SelectValue placeholder="Type" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="book">Book</SelectItem>
            <SelectItem value="article">Article</SelectItem>
            <SelectItem value="conference">Conference</SelectItem>
            <SelectItem value="website">Website</SelectItem>
            <SelectItem value="other">Other</SelectItem>
          </SelectContent>
        </Select>
        <Input
          placeholder="Text"
          value={citation.text}
          onChange={(e) =>
            handleUpdate({ text: e.target.value })
          }
          className="mb-2"
        />
        <Input
          placeholder="Source"
          value={citation.source}
          onChange={(e) =>
            handleUpdate({ source: e.target.value })
          }
          className="mb-2"
        />
        <TagInput
          placeholder="Authors (comma-separated)"
          tags={authors}
          onChange={handleAuthorChange}
        />
        <Input
          placeholder="Year"
          value={citation.year}
          onChange={(e) =>
            handleUpdate({ year: e.target.value })
          }
        />
        {citation.type === 'article' && (
          <div className="space-y-2 animate-fade-in">
            <Input
              placeholder="Journal"
              value={citation.journal}
              onChange={(e) =>
                handleUpdate({ journal: e.target.value })
              }
            />
            <div className="grid grid-cols-3 gap-2">
              <Input
                placeholder="Volume"
                value={citation.volume}
                onChange={(e) =>
                  handleUpdate({ volume: e.target.value })
                }
              />
              <Input
                placeholder="Issue"
                value={citation.issue}
                onChange={(e) =>
                  handleUpdate({ issue: e.target.value })
                }
              />
              <Input
                placeholder="Pages"
                value={citation.pages}
                onChange={(e) =>
                  handleUpdate({ pages: e.target.value })
                }
              />
            </div>
          </div>
        )}
        {citation.type === 'book' && (
          <Input
            placeholder="Publisher"
            value={citation.publisher}
            onChange={(e) =>
              handleUpdate({ publisher: e.target.value })
            }
            className="animate-fade-in"
          />
        )}
        {(citation.type === 'website' || citation.type === 'other') && (
          <Input
            placeholder="URL"
            value={citation.url}
            onChange={(e) =>
              handleUpdate({ url: e.target.value })
            }
            className="animate-fade-in"
          />
        )}
      </CardContent>
    </Card>
  );
};

// File: src\components\citation\CitationFilters.tsx

import React from 'react';
import { Search, Filter, SortAsc, SortDesc } from 'lucide-react';
import { Input } from '@/components/ui/input';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { Button } from '@/components/ui/button';

interface CitationFiltersProps {
  searchTerm: string;
  onSearchChange: (value: string) => void;
  filterType: string;
  onFilterChange: (value: string) => void;
  sortField: 'year' | 'author' | 'title';
  onSortFieldChange: (field: 'year' | 'author' | 'title') => void;
  sortDirection: 'asc' | 'desc';
  onSortDirectionChange: (direction: 'asc' | 'desc') => void;
}

export const CitationFilters = ({
  searchTerm,
  onSearchChange,
  filterType,
  onFilterChange,
  sortField,
  onSortFieldChange,
  sortDirection,
  onSortDirectionChange
}: CitationFiltersProps) => {
  return (
    <div className="flex gap-4 items-center">
      <div className="flex-1">
        <Input
          placeholder="Search citations..."
          value={searchTerm}
          onChange={(e) => onSearchChange(e.target.value)}
          className="max-w-sm"
          leftIcon={<Search className="w-4 h-4" />}
        />
      </div>
      <Select value={filterType} onValueChange={onFilterChange}>
        <SelectTrigger className="w-[180px]">
          <Filter className="w-4 h-4 mr-2" />
          <SelectValue placeholder="Filter by type" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="all">All Types</SelectItem>
          <SelectItem value="article">Articles</SelectItem>
          <SelectItem value="book">Books</SelectItem>
          <SelectItem value="conference">Conference Papers</SelectItem>
          <SelectItem value="website">Websites</SelectItem>
          <SelectItem value="other">Other</SelectItem>
        </SelectContent>
      </Select>
      <DropdownMenu>
        <DropdownMenuTrigger asChild>
          <Button variant="outline" size="sm" className="gap-2">
            {sortDirection === 'asc' ? <SortAsc className="w-4 h-4" /> : <SortDesc className="w-4 h-4" />}
            Sort by
          </Button>
        </DropdownMenuTrigger>
        <DropdownMenuContent>
          <DropdownMenuItem onClick={() => onSortFieldChange('year')}>
            Year {sortField === 'year' && 'âœ“'}
          </DropdownMenuItem>
          <DropdownMenuItem onClick={() => onSortFieldChange('author')}>
            Author {sortField === 'author' && 'âœ“'}
          </DropdownMenuItem>
          <DropdownMenuItem onClick={() => onSortFieldChange('title')}>
            Title {sortField === 'title' && 'âœ“'}
          </DropdownMenuItem>
          <DropdownMenuItem onClick={() => onSortDirectionChange(sortDirection === 'asc' ? 'desc' : 'asc')}>
            {sortDirection === 'asc' ? 'Ascending' : 'Descending'}
          </DropdownMenuItem>
        </DropdownMenuContent>
      </DropdownMenu>
    </div>
  );
};

// File: src\components\citation\CitationHeader.tsx

import React from 'react';
import { Citation } from '@/types/thesis';
import { Button } from '@/components/ui/button';
import { PlusCircle } from 'lucide-react';
import { CitationStats } from './CitationStats';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { CitationSearch } from './CitationSearch';

interface CitationHeaderProps {
  citations: Citation[];
  onAddCitation: (citation: Citation) => void;
  searchDialogOpen: boolean;
  setSearchDialogOpen: (open: boolean) => void;
  handleAddCitation: () => void;
  handleSearchResult: (citation: Omit<Citation, "thesis_id">) => void;
}

export const CitationHeader = ({
  citations,
  searchDialogOpen,
  setSearchDialogOpen,
  handleAddCitation,
  handleSearchResult
}: CitationHeaderProps) => {
  return (
    <div className="flex justify-between items-center">
      <CitationStats citations={citations} />
      <div className="flex gap-2">
        <Dialog open={searchDialogOpen} onOpenChange={setSearchDialogOpen}>
          <DialogTrigger asChild>
            <Button variant="outline" size="sm">
              Search Citations
            </Button>
          </DialogTrigger>
          <DialogContent className="max-w-3xl">
            <DialogHeader>
              <DialogTitle>Search Citations</DialogTitle>
            </DialogHeader>
            <CitationSearch onCitationSelect={handleSearchResult} />
          </DialogContent>
        </Dialog>
        <Button onClick={handleAddCitation} variant="outline" size="sm" className="gap-2">
          <PlusCircle className="w-4 h-4" />
          Add Citation
        </Button>
      </div>
    </div>
  );
};

// File: src\components\citation\CitationList.tsx

import React from 'react';
import { Citation } from '@/types/thesis';
import { CitationCard } from './CitationCard';

interface CitationListProps {
  citations: Citation[];
  onRemove: (id: string) => void;
  onUpdate: (citation: Citation) => void;
  onPreview: (citation: Citation) => void;
}

export const CitationList = ({
  citations,
  onRemove,
  onUpdate,
  onPreview
}: CitationListProps) => {
  if (citations.length === 0) {
    return (
      <div className="col-span-2 text-center py-8 text-muted-foreground">
        No citations found. Try adjusting your filters or add a new citation.
      </div>
    );
  }

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
      {citations.map((citation) => (
        <CitationCard
          key={citation.id}
          citation={citation}
          onRemove={onRemove}
          onUpdate={onUpdate}
          onPreview={() => onPreview(citation)}
        />
      ))}
    </div>
  );
};

// File: src\components\citation\CitationPreview.tsx

import React from 'react';
import { Citation } from '@/types/thesis';
import { Card } from '@/components/ui/card';
import {
  Tabs,
  TabsContent,
  TabsList,
  TabsTrigger,
} from "@/components/ui/tabs";

interface CitationPreviewProps {
  citation: Citation;
  onEdit?: (citation: Citation) => void;
  onDelete?: (citation: Citation) => void;
  onClose?: () => void;
}

export const CitationPreview: React.FC<CitationPreviewProps> = ({ 
  citation,
  onEdit,
  onDelete,
  onClose
}) => {
  const formatAPA = () => {
    const authors = citation.authors
      .map((author, index) => {
        const names = author.split(' ');
        const lastName = names.pop();
        const initials = names.map(name => `${name[0]}.`).join(' ');
        return index === citation.authors.length - 1
          ? `${lastName}, ${initials}`
          : `${lastName}, ${initials},`;
      })
      .join(' ');

    let result = `${authors} (${citation.year}). ${citation.text}`;

    if (citation.type === 'article' && citation.journal) {
      result += `. ${citation.journal}`;
      if (citation.volume) result += `, ${citation.volume}`;
      if (citation.issue) result += `(${citation.issue})`;
      if (citation.pages) result += `, ${citation.pages}`;
    } else if (citation.type === 'book' && citation.publisher) {
      result += `. ${citation.publisher}`;
    }

    if (citation.doi) result += `. https://doi.org/${citation.doi}`;
    return result;
  };

  const formatMLA = () => {
    const authors = citation.authors
      .map((author, index) => {
        const names = author.split(' ');
        const lastName = names.pop();
        const firstName = names.join(' ');
        return index === 0
          ? `${lastName}, ${firstName}`
          : `${firstName} ${lastName}`;
      })
      .join(', ');

    let result = `${authors}. "${citation.text}." `;

    if (citation.type === 'article' && citation.journal) {
      result += `${citation.journal}`;
      if (citation.volume) result += ` ${citation.volume}`;
      if (citation.issue) result += `.${citation.issue}`;
      if (citation.year) result += ` (${citation.year})`;
      if (citation.pages) result += `: ${citation.pages}`;
    } else if (citation.type === 'book' && citation.publisher) {
      result += `${citation.publisher}, ${citation.year}`;
    }

    return result;
  };

  const formatChicago = () => {
    const authors = citation.authors
      .map((author, index) => {
        const names = author.split(' ');
        const lastName = names.pop();
        const firstName = names.join(' ');
        return index === 0
          ? `${lastName}, ${firstName}`
          : `${firstName} ${lastName}`;
      })
      .join(', ');

    let result = `${authors}. `;

    if (citation.type === 'article' && citation.journal) {
      result += `"${citation.text}." ${citation.journal}`;
      if (citation.volume) result += ` ${citation.volume}`;
      if (citation.issue) result += `, no. ${citation.issue}`;
      if (citation.year) result += ` (${citation.year})`;
      if (citation.pages) result += `: ${citation.pages}`;
    } else if (citation.type === 'book' && citation.publisher) {
      result += `${citation.text}. ${citation.publisher}, ${citation.year}`;
    }

    return result;
  };

  return (
    <Tabs defaultValue="apa" className="w-full">
      <TabsList className="grid w-full grid-cols-3">
        <TabsTrigger value="apa">APA</TabsTrigger>
        <TabsTrigger value="mla">MLA</TabsTrigger>
        <TabsTrigger value="chicago">Chicago</TabsTrigger>
      </TabsList>
      <TabsContent value="apa">
        <Card className="p-4">
          <p className="text-sm">{formatAPA()}</p>
        </Card>
      </TabsContent>
      <TabsContent value="mla">
        <Card className="p-4">
          <p className="text-sm">{formatMLA()}</p>
        </Card>
      </TabsContent>
      <TabsContent value="chicago">
        <Card className="p-4">
          <p className="text-sm">{formatChicago()}</p>
        </Card>
      </TabsContent>
    </Tabs>
  );
};


// File: src\components\citation\CitationSearch.tsx

import React from 'react';
import { Citation } from '@/types/thesis';
import { useToast } from '@/hooks/use-toast';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Search } from 'lucide-react';

interface CitationSearchProps {
  onCitationSelect: (citation: Omit<Citation, "thesis_id">) => void;
}

export const CitationSearch: React.FC<CitationSearchProps> = ({ onCitationSelect }) => {
  const [query, setQuery] = React.useState('');
  const { toast } = useToast();

  const searchCitations = async (e: React.FormEvent) => {
    e.preventDefault();
    
    try {
      const response = await fetch(`https://api.crossref.org/works?query=${encodeURIComponent(query)}`);
      const data = await response.json();
      
      if (data.message?.items?.length > 0) {
        const citation = formatCitation(data.message.items[0]);
        onCitationSelect(citation);
        setQuery('');
      } else {
        toast({
          title: "No Results",
          description: "No citations found for your search query.",
          variant: "destructive",
        });
      }
    } catch (error) {
      console.error('Error searching citations:', error);
      toast({
        title: "Error",
        description: "Failed to search citations. Please try again.",
        variant: "destructive",
      });
    }
  };

  const formatCitation = (result: any): Omit<Citation, "thesis_id"> => {
    const now = new Date().toISOString();
    return {
      id: crypto.randomUUID(),
      text: result.title?.[0] || '',
      source: result.publisher || '',
      authors: result.author?.map((a: any) => `${a.given} ${a.family}`) || [],
      year: result.published?.['date-parts']?.[0]?.[0]?.toString() || '',
      type: 'article',
      doi: result.DOI,
      url: result.URL,
      journal: result['container-title']?.[0],
      volume: result.volume,
      issue: result.issue,
      pages: result.page,
      publisher: result.publisher,
      title: result.title?.[0] || '',
      author_last_names: result.author?.map((a: any) => a.family) || [],
      author_first_initials: result.author?.map((a: any) => a.given?.[0] || '') || [],
      author_middle_initials: result.author?.map((a: any) => {
        const names = a.given?.split(' ') || [];
        return names.length > 1 ? names[1][0] : '';
      }) || [],
      specific_date: result.published?.['date-parts']?.[0]?.join('-'),
      container_title: result['container-title']?.[0],
      edition: result.edition,
      created_at: now,
      updated_at: now
    };
  };

  return (
    <form onSubmit={searchCitations} className="flex gap-2">
      <Input
        type="text"
        value={query}
        onChange={(e) => setQuery(e.target.value)}
        placeholder="Search for citations..."
        className="flex-1"
      />
      <Button type="submit" variant="outline">
        <Search className="h-4 w-4" />
      </Button>
    </form>
  );
};

// File: src\components\citation\CitationStats.tsx

import React from 'react';
import { Citation } from '@/types/thesis';

interface CitationStatsProps {
  citations: Citation[];
}

export const CitationStats = ({ citations }: CitationStatsProps) => {
  const stats = {
    total: citations.length,
    articles: citations.filter(c => c.type === 'article').length,
    books: citations.filter(c => c.type === 'book').length,
    others: citations.filter(c => !['article', 'book'].includes(c.type)).length
  };

  return (
    <div className="space-y-1">
      <h3 className="text-lg font-serif font-medium text-primary">Citations</h3>
      <p className="text-sm text-muted-foreground">
        {stats.total} citations ({stats.articles} articles, {stats.books} books, {stats.others} others)
      </p>
    </div>
  );
};

// File: src\components\citation\tabs\AllCitationsTab.tsx

import React from 'react';
import { Citation } from '@/types/thesis';
import { ScrollArea } from '@/components/ui/scroll-area';
import { CitationList } from '../CitationList';
import { motion, AnimatePresence } from 'framer-motion';

interface AllCitationsTabProps {
  citations: Citation[];
  onRemove: (id: string) => void;
  onUpdate: (citation: Citation) => void;
  onPreview: (citation: Citation | null) => void;
}

export const AllCitationsTab = ({
  citations,
  onRemove,
  onUpdate,
  onPreview
}: AllCitationsTabProps) => {
  return (
    <ScrollArea className="h-[600px] pr-4">
      <AnimatePresence mode="wait">
        <motion.div
          key="all-citations"
          initial={{ opacity: 0, x: -20 }}
          animate={{ opacity: 1, x: 0 }}
          exit={{ opacity: 0, x: 20 }}
          transition={{ duration: 0.2 }}
        >
          <CitationList
            citations={citations}
            onRemove={onRemove}
            onUpdate={onUpdate}
            onPreview={onPreview}
          />
        </motion.div>
      </AnimatePresence>
    </ScrollArea>
  );
};

// File: src\components\citation\tabs\CitationTabs.tsx

import React from 'react';
import { Citation } from '@/types/thesis';
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { BookOpen, Search, Clock } from 'lucide-react';
import { AllCitationsTab } from './AllCitationsTab';
import { SearchCitationsTab } from './SearchCitationsTab';
import { RecentCitationsTab } from './RecentCitationsTab';

interface CitationTabsProps {
  citations: Citation[];
  filteredCitations: Citation[];
  searchTerm: string;
  filterType: string;
  sortField: 'year' | 'author' | 'title';
  sortDirection: 'asc' | 'desc';
  onSearchChange: (value: string) => void;
  onFilterChange: (value: string) => void;
  onSortFieldChange: (field: 'year' | 'author' | 'title') => void;
  onSortDirectionChange: (direction: 'asc' | 'desc') => void;
  onRemove: (id: string) => void;
  onUpdate: (citation: Citation) => void;
  onPreview: (citation: Citation | null) => void;
}

export const CitationTabs = ({
  citations,
  filteredCitations,
  searchTerm,
  filterType,
  sortField,
  sortDirection,
  onSearchChange,
  onFilterChange,
  onSortFieldChange,
  onSortDirectionChange,
  onRemove,
  onUpdate,
  onPreview
}: CitationTabsProps) => {
  const recentCitations = React.useMemo(() => 
    [...citations]
      .sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime())
      .slice(0, 5),
    [citations]
  );

  return (
    <Tabs defaultValue="all" className="w-full">
      <TabsList className="grid w-full grid-cols-3 mb-4">
        <TabsTrigger value="all" className="flex items-center gap-2">
          <BookOpen className="w-4 h-4" />
          All Citations
        </TabsTrigger>
        <TabsTrigger value="search" className="flex items-center gap-2">
          <Search className="w-4 h-4" />
          Search & Filter
        </TabsTrigger>
        <TabsTrigger value="recent" className="flex items-center gap-2">
          <Clock className="w-4 h-4" />
          Recent
        </TabsTrigger>
      </TabsList>

      <TabsContent value="all">
        <AllCitationsTab
          citations={citations}
          onRemove={onRemove}
          onUpdate={onUpdate}
          onPreview={onPreview}
        />
      </TabsContent>

      <TabsContent value="search">
        <SearchCitationsTab
          citations={filteredCitations}
          searchTerm={searchTerm}
          filterType={filterType}
          sortField={sortField}
          sortDirection={sortDirection}
          onSearchChange={onSearchChange}
          onFilterChange={onFilterChange}
          onSortFieldChange={onSortFieldChange}
          onSortDirectionChange={onSortDirectionChange}
          onRemove={onRemove}
          onUpdate={onUpdate}
          onPreview={onPreview}
        />
      </TabsContent>

      <TabsContent value="recent">
        <RecentCitationsTab
          citations={recentCitations}
          onRemove={onRemove}
          onUpdate={onUpdate}
          onPreview={onPreview}
        />
      </TabsContent>
    </Tabs>
  );
};

// File: src\components\citation\tabs\RecentCitationsTab.tsx

import React from 'react';
import { Citation } from '@/types/thesis';
import { ScrollArea } from '@/components/ui/scroll-area';
import { CitationList } from '../CitationList';
import { motion, AnimatePresence } from 'framer-motion';

interface RecentCitationsTabProps {
  citations: Citation[];
  onRemove: (id: string) => void;
  onUpdate: (citation: Citation) => void;
  onPreview: (citation: Citation | null) => void;
}

export const RecentCitationsTab = ({
  citations,
  onRemove,
  onUpdate,
  onPreview
}: RecentCitationsTabProps) => {
  return (
    <ScrollArea className="h-[600px] pr-4">
      <AnimatePresence mode="wait">
        <motion.div
          key="recent-citations"
          initial={{ opacity: 0, x: -20 }}
          animate={{ opacity: 1, x: 0 }}
          exit={{ opacity: 0, x: 20 }}
          transition={{ duration: 0.2 }}
        >
          <CitationList
            citations={citations}
            onRemove={onRemove}
            onUpdate={onUpdate}
            onPreview={onPreview}
          />
        </motion.div>
      </AnimatePresence>
    </ScrollArea>
  );
};

// File: src\components\citation\tabs\SearchCitationsTab.tsx

import React from 'react';
import { Citation } from '@/types/thesis';
import { ScrollArea } from '@/components/ui/scroll-area';
import { CitationList } from '../CitationList';
import { CitationFilters } from '../CitationFilters';
import { motion, AnimatePresence } from 'framer-motion';

interface SearchCitationsTabProps {
  citations: Citation[];
  searchTerm: string;
  filterType: string;
  sortField: 'year' | 'author' | 'title';
  sortDirection: 'asc' | 'desc';
  onSearchChange: (value: string) => void;
  onFilterChange: (value: string) => void;
  onSortFieldChange: (field: 'year' | 'author' | 'title') => void;
  onSortDirectionChange: (direction: 'asc' | 'desc') => void;
  onRemove: (id: string) => void;
  onUpdate: (citation: Citation) => void;
  onPreview: (citation: Citation | null) => void;
}

export const SearchCitationsTab = ({
  citations,
  searchTerm,
  filterType,
  sortField,
  sortDirection,
  onSearchChange,
  onFilterChange,
  onSortFieldChange,
  onSortDirectionChange,
  onRemove,
  onUpdate,
  onPreview
}: SearchCitationsTabProps) => {
  return (
    <>
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ delay: 0.2 }}
      >
        <CitationFilters
          searchTerm={searchTerm}
          onSearchChange={onSearchChange}
          filterType={filterType}
          onFilterChange={onFilterChange}
          sortField={sortField}
          onSortFieldChange={onSortFieldChange}
          sortDirection={sortDirection}
          onSortDirectionChange={onSortDirectionChange}
        />
      </motion.div>

      <ScrollArea className="h-[500px] pr-4 mt-4">
        <AnimatePresence mode="wait">
          <motion.div
            key={searchTerm + filterType + sortField + sortDirection}
            initial={{ opacity: 0, x: -20 }}
            animate={{ opacity: 1, x: 0 }}
            exit={{ opacity: 0, x: 20 }}
            transition={{ duration: 0.2 }}
          >
            <CitationList
              citations={citations}
              onRemove={onRemove}
              onUpdate={onUpdate}
              onPreview={onPreview}
            />
          </motion.div>
        </AnimatePresence>
      </ScrollArea>
    </>
  );
};

// File: src\components\CitationManager.tsx

import React, { useState } from 'react';
import { Citation } from '@/types/thesis';
import { CitationSearch } from './citation/CitationSearch';
import { CitationList } from './citation/CitationList';
import { CitationPreview } from './citation/CitationPreview';
import { motion } from 'framer-motion';
import { Card } from './ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { BookOpen, Search, Clock } from 'lucide-react';

type CitationType = "article" | "book" | "conference" | "website" | "other" | "all";

interface CitationManagerProps {
  citations: Citation[];
  onCitationSelect?: (citation: Citation | null) => void;
  selectedCitation?: Citation | null;
  onCitationCreate?: (citation: Citation) => void;
  onCitationUpdate?: (citation: Citation) => void;
  onCitationDelete?: (citation: Citation) => void;
  thesisId: string;
}

export const CitationManager: React.FC<CitationManagerProps> = ({
  citations,
  onCitationSelect,
  selectedCitation,
  onCitationCreate,
  onCitationUpdate,
  onCitationDelete,
  thesisId
}) => {
  const [searchTerm, setSearchTerm] = useState('');
  const [filterType, setFilterType] = useState<CitationType>('all');
  const [sortField, setSortField] = useState<keyof Citation>('created_at');
  const [sortDirection, setSortDirection] = useState<'asc' | 'desc'>('desc');
  const [activeTab, setActiveTab] = useState('all');

  // Filter and sort citations
  const filteredCitations = citations.filter(citation => {
    const matchesSearch = citation.text.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         citation.authors.some(author => author.toLowerCase().includes(searchTerm.toLowerCase()));
    const matchesType = filterType === 'all' || citation.type === filterType;
    return matchesSearch && matchesType;
  });

  const sortedCitations = [...filteredCitations].sort((a, b) => {
    const aValue = a[sortField];
    const bValue = b[sortField];
    
    if (typeof aValue === 'string' && typeof bValue === 'string') {
      return sortDirection === 'asc' 
        ? aValue.localeCompare(bValue)
        : bValue.localeCompare(aValue);
    }
    return 0;
  });

  const handleCitationCreate = (citation: Omit<Citation, 'thesis_id'>) => {
    if (onCitationCreate) {
      onCitationCreate({
        ...citation,
        thesis_id: thesisId
      });
    }
  };

  return (
    <Card className="p-6 space-y-6 bg-white/50 backdrop-blur-sm border-2 border-primary/10 shadow-xl rounded-xl">
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.5 }}
      >
        <Tabs defaultValue="all" className="w-full" value={activeTab} onValueChange={setActiveTab}>
          <TabsList className="grid w-full grid-cols-3 mb-4">
            <TabsTrigger value="all" className="flex items-center gap-2">
              <BookOpen className="w-4 h-4" />
              All Citations
            </TabsTrigger>
            <TabsTrigger value="recent" className="flex items-center gap-2">
              <Clock className="w-4 h-4" />
              Recent
            </TabsTrigger>
            <TabsTrigger value="search" className="flex items-center gap-2">
              <Search className="w-4 h-4" />
              Search
            </TabsTrigger>
          </TabsList>

          <TabsContent value="all">
            <CitationList
              citations={sortedCitations}
              onRemove={(id) => {
                const citation = citations.find(c => c.id === id);
                if (citation && onCitationDelete) onCitationDelete(citation);
              }}
              onUpdate={onCitationUpdate}
              onPreview={onCitationSelect}
            />
          </TabsContent>

          <TabsContent value="recent">
            <CitationList
              citations={sortedCitations.slice(0, 5)}
              onRemove={(id) => {
                const citation = citations.find(c => c.id === id);
                if (citation && onCitationDelete) onCitationDelete(citation);
              }}
              onUpdate={onCitationUpdate}
              onPreview={onCitationSelect}
            />
          </TabsContent>

          <TabsContent value="search">
            <div className="space-y-4">
              <CitationSearch
                onCitationSelect={handleCitationCreate}
              />
              <CitationList
                citations={sortedCitations}
                onRemove={(id) => {
                  const citation = citations.find(c => c.id === id);
                  if (citation && onCitationDelete) onCitationDelete(citation);
                }}
                onUpdate={onCitationUpdate}
                onPreview={onCitationSelect}
              />
            </div>
          </TabsContent>
        </Tabs>
      </motion.div>

      {selectedCitation && (
        <CitationPreview
          citation={selectedCitation}
          onEdit={onCitationUpdate}
          onDelete={onCitationDelete}
          onClose={() => onCitationSelect?.(null)}
        />
      )}
    </Card>
  );
};

// File: src\components\collaboration\chat\ChatHeader.tsx

import React from 'react';
import { Button } from '@/components/ui/button';
import { X } from 'lucide-react';

interface ChatHeaderProps {
  onClose?: () => void;
}

export const ChatHeader: React.FC<ChatHeaderProps> = ({ onClose }) => {
  return (
    <div className="p-3 border-b bg-primary/5 rounded-t-lg backdrop-blur supports-[backdrop-filter]:bg-background/60">
      <div className="flex items-center justify-between">
        <h3 className="font-semibold">Chat</h3>
        {onClose && (
          <Button 
            variant="ghost" 
            size="icon"
            onClick={onClose}
            className="h-8 w-8 rounded-full hover:bg-primary/10"
          >
            <X className="h-4 w-4" />
          </Button>
        )}
      </div>
    </div>
  );
};

// File: src\components\collaboration\chat\ChatInput.tsx

import React, { useState } from 'react';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Send } from 'lucide-react';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/hooks/use-toast';

interface ChatInputProps {
  thesisId: string;
  onMessageSent?: () => void;
}

export const ChatInput: React.FC<ChatInputProps> = ({ thesisId, onMessageSent }) => {
  const [newMessage, setNewMessage] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const { toast } = useToast();

  const handleSendMessage = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!newMessage.trim() || !thesisId) return;

    setIsLoading(true);
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        throw new Error('User not authenticated');
      }

      console.log('Sending message:', newMessage);
      const { error } = await supabase
        .from('chat_messages')
        .insert({
          thesis_id: thesisId,
          content: newMessage.trim(),
          sender_id: user.id
        });

      if (error) {
        console.error('Error sending message:', error);
        throw error;
      }

      setNewMessage('');
      onMessageSent?.();
    } catch (error: any) {
      console.error('Error in handleSendMessage:', error);
      toast({
        title: "Error",
        description: "Failed to send message",
        variant: "destructive",
      });
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <form onSubmit={handleSendMessage} className="p-4 border-t bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
      <div className="flex items-center gap-2">
        <Input
          value={newMessage}
          onChange={(e) => setNewMessage(e.target.value)}
          placeholder="Type a message..."
          disabled={isLoading}
          className="flex-1 bg-muted/50"
        />
        <Button 
          type="submit" 
          size="icon" 
          disabled={isLoading}
          className="shrink-0 transition-all duration-200 hover:scale-105"
        >
          <Send className="h-4 w-4" />
        </Button>
      </div>
    </form>
  );
};

// File: src\components\collaboration\chat\ChatMessageInput.tsx

import React from 'react';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Send } from 'lucide-react';

interface ChatMessageInputProps {
  value: string;
  onChange: (value: string) => void;
  onSubmit: (e: React.FormEvent) => void;
  isLoading: boolean;
}

export const ChatMessageInput: React.FC<ChatMessageInputProps> = ({
  value,
  onChange,
  onSubmit,
  isLoading
}) => {
  return (
    <form onSubmit={onSubmit} className="border-t p-4 bg-gradient-to-b from-background/50 to-background backdrop-blur-sm">
      <div className="flex gap-2">
        <Textarea
          value={value}
          onChange={(e) => onChange(e.target.value)}
          placeholder="Type a message..."
          className="min-h-[80px] resize-none bg-background/80 backdrop-blur-sm"
        />
        <Button 
          type="submit" 
          disabled={isLoading}
          size="icon"
          className="h-[80px] w-[80px] bg-primary hover:bg-primary/90 transition-all duration-200"
        >
          <Send className="h-4 w-4" />
        </Button>
      </div>
    </form>
  );
};

// File: src\components\collaboration\chat\ChatMessageItem.tsx

import React from 'react';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { cn } from '@/lib/utils';
import { format } from 'date-fns';
import { ChevronRight, ChevronLeft } from 'lucide-react';

interface ChatMessageItemProps {
  message: {
    id: string;
    content: string;
    sender_id: string;
    created_at: string;
    profiles?: {
      email?: string;
    };
  };
  isCurrentUser?: boolean;
}

export const ChatMessageItem: React.FC<ChatMessageItemProps> = ({ message, isCurrentUser }) => {
  return (
    <div className={cn(
      "flex items-start gap-3 group transition-all duration-200 hover:bg-primary/5 p-2 rounded-lg",
      isCurrentUser ? "flex-row-reverse" : "flex-row"
    )}>
      <Avatar className="h-8 w-8 shrink-0 animate-fade-in">
        <AvatarImage 
          src={`https://api.dicebear.com/7.x/initials/svg?seed=${message.profiles?.email}`} 
          alt={message.profiles?.email} 
        />
        <AvatarFallback className="bg-primary/5 text-primary">
          {message.profiles?.email?.charAt(0).toUpperCase()}
        </AvatarFallback>
      </Avatar>
      
      <div className={cn(
        "flex flex-col max-w-[80%]",
        isCurrentUser ? "items-end" : "items-start"
      )}>
        <span className="text-xs font-medium text-muted-foreground mb-1">
          {message.profiles?.email}
          <span className="mx-2 text-muted-foreground/60">â€¢</span>
          <span className="text-xs text-muted-foreground/60">
            {format(new Date(message.created_at), 'HH:mm')}
          </span>
        </span>
        
        <div className={cn(
          "flex items-center gap-2",
          isCurrentUser ? "flex-row-reverse" : "flex-row"
        )}>
          {!isCurrentUser && <ChevronRight className="h-4 w-4 text-muted-foreground/40" />}
          <div className={cn(
            "rounded-2xl px-4 py-2 break-words animate-slide-up backdrop-blur-sm",
            isCurrentUser 
              ? "bg-primary text-primary-foreground rounded-tr-none bg-gradient-to-r from-primary to-primary/90" 
              : "bg-muted rounded-tl-none bg-gradient-to-r from-muted to-muted/80"
          )}>
            <p className="text-sm leading-relaxed">{message.content}</p>
          </div>
          {isCurrentUser && <ChevronLeft className="h-4 w-4 text-muted-foreground/40" />}
        </div>
      </div>
    </div>
  );
};

// File: src\components\collaboration\chat\ChatMessageList.tsx

import React from 'react';
import { useAuth } from '@/contexts/AuthContext';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Message } from '@/types/chat';

interface ChatMessageListProps {
  messages: Message[];
}

export const ChatMessageList: React.FC<ChatMessageListProps> = ({ messages }) => {
  const { session } = useAuth();
  const currentUserId = session?.user?.id;

  return (
    <ScrollArea className="flex-1 p-4">
      <div className="space-y-4">
        {messages.map((message) => {
          const isCurrentUser = message.sender_id === currentUserId;
          return (
            <div
              key={message.id}
              className={`flex gap-3 ${isCurrentUser ? 'flex-row-reverse' : 'flex-row'}`}
            >
              <Avatar className="w-8 h-8">
                <AvatarImage src={`https://avatar.vercel.sh/${message.sender_id}`} />
                <AvatarFallback>U</AvatarFallback>
              </Avatar>
              <div
                className={`max-w-[80%] rounded-lg p-3 ${
                  isCurrentUser
                    ? 'bg-primary text-primary-foreground'
                    : 'bg-muted'
                }`}
              >
                <p className="text-sm">{message.content}</p>
              </div>
            </div>
          );
        })}
      </div>
    </ScrollArea>
  );
};

// File: src\components\collaboration\chat\ChatMessages.tsx

import React, { useRef } from 'react';
import { ChatMessageList } from './ChatMessageList';
import { ChatMessageInput } from './ChatMessageInput';
import { useChatMessages } from './useChatMessages';
import { useToast } from '@/hooks/use-toast';
import { supabase } from '@/integrations/supabase/client';

interface ChatMessagesProps {
  thesisId: string;
}

export const ChatMessages: React.FC<ChatMessagesProps> = ({ thesisId }) => {
  const [newMessage, setNewMessage] = React.useState('');
  const [isLoading, setIsLoading] = React.useState(false);
  const { toast } = useToast();
  const { messages } = useChatMessages(thesisId);

  const handleSendMessage = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!newMessage.trim() || !thesisId) return;

    setIsLoading(true);
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        throw new Error('User not authenticated');
      }

      console.log('Sending message:', newMessage);
      const { error } = await supabase
        .from('chat_messages')
        .insert({
          thesis_id: thesisId,
          content: newMessage.trim(),
          sender_id: user.id
        });

      if (error) {
        console.error('Error sending message:', error);
        throw error;
      }

      setNewMessage('');
    } catch (error: any) {
      console.error('Error in handleSendMessage:', error);
      toast({
        title: "Error",
        description: "Failed to send message",
        variant: "destructive",
      });
    } finally {
      setIsLoading(false);
    }
  };

  if (!thesisId) {
    return null;
  }

  return (
    <div className="fixed bottom-4 right-4 w-[400px] h-[500px] bg-background border rounded-lg shadow-lg z-50 flex flex-col animate-slide-in-right">
      <div className="p-3 border-b bg-primary/5 rounded-t-lg">
        <h3 className="font-semibold">Chat</h3>
      </div>
      
      <ChatMessageList messages={messages} />

      <ChatMessageInput
        value={newMessage}
        onChange={setNewMessage}
        onSubmit={handleSendMessage}
        isLoading={isLoading}
      />
    </div>
  );
};

// File: src\components\collaboration\chat\types.ts

import { Message, ChatMessage } from '@/types/chat';

export type { Message, ChatMessage };

export interface ChatMessageListProps {
  messages: ChatMessage[];
}

export interface ChatMessageInputProps {
  value: string;
  onChange: (value: string) => void;
  onSubmit: (e: React.FormEvent) => void;
  isLoading?: boolean;
}

// File: src\components\collaboration\chat\useChatMessages.ts

import { useEffect, useState } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { Message } from './types';
import { useToast } from '@/hooks/use-toast';

export const useChatMessages = (thesisId: string) => {
  const [messages, setMessages] = useState<Message[]>([]);
  const [error, setError] = useState<Error | null>(null);
  const { toast } = useToast();

  useEffect(() => {
    if (!thesisId) return;

    let retryCount = 0;
    const maxRetries = 3;
    const retryDelay = 1000; // 1 second

    const fetchMessages = async (retry = 0) => {
      try {
        console.log('Fetching chat messages for thesis:', thesisId, 'attempt:', retry + 1);
        
        const { data, error } = await supabase
          .from('chat_messages')
          .select(`
            *,
            sender:profiles(email)
          `)
          .eq('thesis_id', thesisId)
          .order('created_at', { ascending: true });

        if (error) {
          console.error('Error fetching messages:', error);
          throw error;
        }

        console.log('Successfully fetched messages:', data?.length || 0);
        setMessages(data || []);
        setError(null);
      } catch (err: any) {
        console.error('Error in fetchMessages:', err);
        setError(err);

        // Retry logic
        if (retry < maxRetries) {
          console.log(`Retrying in ${retryDelay}ms... (${retry + 1}/${maxRetries})`);
          setTimeout(() => fetchMessages(retry + 1), retryDelay * (retry + 1));
        } else {
          toast({
            title: "Error loading messages",
            description: "Please check your connection and try again",
            variant: "destructive",
          });
        }
      }
    };

    // Initial fetch
    fetchMessages();

    // Subscribe to new messages
    const subscription = supabase
      .channel(`chat_messages:thesis_id=eq.${thesisId}`)
      .on('postgres_changes', { 
        event: '*', 
        schema: 'public',
        table: 'chat_messages',
        filter: `thesis_id=eq.${thesisId}`
      }, (payload) => {
        console.log('Received realtime message:', payload);
        if (payload.eventType === 'INSERT') {
          setMessages(prev => [...prev, payload.new as Message]);
        }
      })
      .subscribe((status) => {
        console.log('Subscription status:', status);
        
        if (status === 'SUBSCRIBED') {
          console.log('Successfully subscribed to chat messages');
        } else if (status === 'CHANNEL_ERROR') {
          console.error('Error subscribing to chat messages');
          toast({
            title: "Connection Error",
            description: "Failed to connect to chat. Messages may be delayed.",
            variant: "destructive",
          });
        }
      });

    return () => {
      console.log('Cleaning up chat subscription');
      subscription.unsubscribe();
    };
  }, [thesisId, toast]);

  return { messages, error };
};

// File: src\components\collaboration\ChatMessages.tsx

import React, { useState } from 'react';
import { ChatMessageList } from './chat/ChatMessageList';
import { ChatMessageInput } from './chat/ChatMessageInput';
import { useChatMessages } from './chat/useChatMessages';
import { useToast } from '@/hooks/use-toast';
import { supabase } from '@/integrations/supabase/client';
import { useTheme } from '../ThemeProvider';
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from '../ui/collapsible';
import { Button } from '../ui/button';
import { ChevronDown, ChevronUp, AlertCircle } from 'lucide-react';
import { Alert, AlertDescription, AlertTitle } from '../ui/alert';

interface ChatMessagesProps {
  thesisId: string;
}

export const ChatMessages: React.FC<ChatMessagesProps> = ({ thesisId }) => {
  const [newMessage, setNewMessage] = React.useState('');
  const [isLoading, setIsLoading] = React.useState(false);
  const [showChat, setShowChat] = useState(true);
  const { toast } = useToast();
  const { messages, error } = useChatMessages(thesisId);
  const { theme } = useTheme();

  const handleSendMessage = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!newMessage.trim() || !thesisId) return;

    setIsLoading(true);
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        throw new Error('User not authenticated');
      }

      console.log('Sending message:', newMessage);
      const { error } = await supabase
        .from('chat_messages')
        .insert({
          thesis_id: thesisId,
          content: newMessage.trim(),
          sender_id: user.id
        });

      if (error) {
        console.error('Error sending message:', error);
        throw error;
      }

      setNewMessage('');
    } catch (error: any) {
      console.error('Error in handleSendMessage:', error);
      toast({
        title: "Error",
        description: "Failed to send message. Please try again.",
        variant: "destructive",
      });
    } finally {
      setIsLoading(false);
    }
  };

  if (!thesisId) {
    return null;
  }

  return (
    <Collapsible
      open={showChat}
      onOpenChange={setShowChat}
      className="fixed bottom-4 right-4 w-[400px] z-50"
    >
      <CollapsibleTrigger asChild>
        <Button
          variant="outline"
          size="sm"
          className="absolute -top-10 right-0 bg-background shadow-md"
        >
          {showChat ? (
            <ChevronDown className="h-4 w-4" />
          ) : (
            <ChevronUp className="h-4 w-4" />
          )}
        </Button>
      </CollapsibleTrigger>
      <CollapsibleContent>
        <div className={`
          w-full h-[500px] 
          border rounded-lg shadow-lg
          flex flex-col overflow-hidden
          backdrop-blur-sm
          ${theme === 'dark' 
            ? 'bg-dark-bg/95 border-dark-border shadow-2xl' 
            : 'bg-background/95 border-border'
          }
        `}>
          <div className={`
            p-3 border-b backdrop-blur-sm
            ${theme === 'dark' 
              ? 'bg-dark-card/90 border-dark-border' 
              : 'bg-editor-bg-accent/90 border-editor-border'
            }
          `}>
            <h3 className="font-semibold">Chat</h3>
          </div>
          
          {error ? (
            <Alert variant="destructive" className="m-4">
              <AlertCircle className="h-4 w-4" />
              <AlertTitle>Error</AlertTitle>
              <AlertDescription>
                Failed to load messages. Please check your connection.
              </AlertDescription>
            </Alert>
          ) : (
            <ChatMessageList messages={messages} />
          )}

          <ChatMessageInput
            value={newMessage}
            onChange={setNewMessage}
            onSubmit={handleSendMessage}
            isLoading={isLoading}
          />
        </div>
      </CollapsibleContent>
    </Collapsible>
  );
};

// File: src\components\collaboration\CollaboratorInviteForm.tsx

import React, { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/hooks/use-toast';
import { Loader2 } from 'lucide-react';

interface CollaboratorInviteFormProps {
  thesisId: string;
  thesisTitle: string;
  onInviteSuccess: () => void;
  onInviteError: (error: Error) => void;
  isAdmin: boolean;
  setIsInviting: (isInviting: boolean) => void;
}

const VALID_ROLES = ['editor', 'viewer'] as const;
type ValidRole = typeof VALID_ROLES[number];

export const CollaboratorInviteForm = ({
  thesisId,
  thesisTitle,
  onInviteSuccess,
  onInviteError,
  isAdmin,
  setIsInviting
}: CollaboratorInviteFormProps) => {
  const [email, setEmail] = useState('');
  const [role, setRole] = useState<ValidRole>('viewer');
  const { toast } = useToast();

  const handleInvite = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!email.trim() || !role || !thesisId) {
      toast({
        title: "Error",
        description: "Please fill in all required fields",
        variant: "destructive",
      });
      return;
    }

    console.log('Starting invite process for:', { email, role, thesisId });
    setIsInviting(true);

    try {
      // First check if the user exists
      const { data: existingUser, error: userError } = await supabase
        .from('profiles')
        .select('id, email')
        .eq('email', email.toLowerCase())
        .maybeSingle();

      if (userError) {
        console.error('Error checking user:', userError);
        throw new Error('Error checking user existence');
      }

      if (!existingUser) {
        throw new Error('User not found. Please ensure the email is correct.');
      }

      // Check if user is already a collaborator
      const { data: existingCollaborator, error: collaboratorError } = await supabase
        .from('thesis_collaborators')
        .select('*')
        .eq('thesis_id', thesisId)
        .eq('user_id', existingUser.id)
        .maybeSingle();

      if (collaboratorError) {
        console.error('Error checking existing collaborator:', collaboratorError);
        throw new Error('Error checking existing collaborator');
      }

      if (existingCollaborator) {
        // If collaborator exists with same role, show error
        if (existingCollaborator.role === role) {
          throw new Error('User is already a collaborator with this role');
        }

        // If collaborator exists with different role, update role
        const { error: updateError } = await supabase
          .from('thesis_collaborators')
          .update({ role })
          .eq('thesis_id', thesisId)
          .eq('user_id', existingUser.id);

        if (updateError) {
          console.error('Error updating collaborator role:', updateError);
          throw new Error('Failed to update collaborator role');
        }

        toast({
          title: "Success",
          description: `Collaborator role updated to ${role}`,
        });
      } else {
        // Add new collaborator
        const { error: insertError } = await supabase
          .from('thesis_collaborators')
          .insert({
            thesis_id: thesisId,
            user_id: existingUser.id,
            role: role
          });

        if (insertError) {
          console.error('Error adding collaborator:', insertError);
          throw new Error('Failed to add collaborator. Please try again.');
        }

        // Create a notification for the invited user
        const { error: notificationError } = await supabase
          .from('notifications')
          .insert({
            user_id: existingUser.id,
            thesis_id: thesisId,
            type: 'invitation',
            message: `You have been invited to collaborate on "${thesisTitle}" as a ${role}`
          });

        if (notificationError) {
          console.error('Error creating notification:', notificationError);
          // Don't throw here as the collaboration was successful
        }

        toast({
          title: "Success",
          description: "Collaborator added successfully",
        });
      }

      setEmail('');
      onInviteSuccess();
    } catch (error: any) {
      console.error('Error inviting collaborator:', error);
      onInviteError(error);
      toast({
        title: "Error",
        description: error.message || "Failed to invite collaborator",
        variant: "destructive",
      });
    } finally {
      setIsInviting(false);
    }
  };

  return (
    <form onSubmit={handleInvite} className="space-y-4">
      <div className="space-y-2">
        <Label htmlFor="email">Email address</Label>
        <Input
          id="email"
          type="email"
          value={email}
          onChange={(e) => setEmail(e.target.value)}
          placeholder="Enter collaborator's email"
          required
        />
      </div>
      <div className="space-y-2">
        <Label>Role</Label>
        <Select value={role} onValueChange={(value) => setRole(value as ValidRole)}>
          <SelectTrigger>
            <SelectValue placeholder="Select role" />
          </SelectTrigger>
          <SelectContent>
            {VALID_ROLES.map((validRole) => (
              <SelectItem key={validRole} value={validRole}>
                {validRole.charAt(0).toUpperCase() + validRole.slice(1)}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>
      <Button type="submit" className="w-full">
        Send Invitation
      </Button>
    </form>
  );
};

// File: src\components\collaboration\CollaboratorPresence.tsx

import React, { useEffect, useState } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { motion, AnimatePresence } from 'framer-motion';
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { useToast } from '@/hooks/use-toast';

interface ActiveCollaborator {
  id: string;
  user_id: string;
  email?: string;
  last_seen: string;
}

interface CollaboratorPresenceProps {
  thesisId: string;
}

export const CollaboratorPresence: React.FC<CollaboratorPresenceProps> = ({ thesisId }) => {
  const [activeCollaborators, setActiveCollaborators] = useState<ActiveCollaborator[]>([]);
  const { toast } = useToast();
  const presenceChannel = React.useRef<ReturnType<typeof supabase.channel> | null>(null);

  useEffect(() => {
    const setupPresence = async () => {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        // Get initial collaborators
        const { data: collaborators, error } = await supabase
          .from('thesis_collaborators')
          .select(`
            id,
            user_id,
            profiles!inner (
              email
            )
          `)
          .eq('thesis_id', thesisId);

        if (error) throw error;

        // Set up presence channel
        presenceChannel.current = supabase.channel(`presence:${thesisId}`);
        
        presenceChannel.current
          .on('presence', { event: 'sync' }, () => {
            const state = presenceChannel.current?.presenceState() || {};
            console.log('Presence state:', state);
            
            const currentPresence = Object.values(state).flat().map((presence: any) => ({
              id: `${presence.user_id}-${Date.now()}`,
              user_id: presence.user_id,
              email: presence.email,
              last_seen: presence.online_at
            }));

            setActiveCollaborators(currentPresence);
          })
          .on('presence', { event: 'join' }, ({ key, newPresences }: any) => {
            console.log('Join event:', { key, newPresences });
            setActiveCollaborators(prev => {
              const newCollaborators = newPresences.map((presence: any) => ({
                id: `${presence.user_id}-${Date.now()}`,
                user_id: presence.user_id,
                email: presence.email,
                last_seen: new Date().toISOString()
              }));
              return [...prev, ...newCollaborators];
            });
          })
          .on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
            console.log('User left:', key, leftPresences);
          })
          .subscribe(async (status) => {
            if (status === 'SUBSCRIBED') {
              await presenceChannel.current?.track({
                user_id: user.id,
                email: user.email,
                online_at: new Date().toISOString()
              });
            }
          });

        // Initialize with collaborators from database
        const initialCollaborators = collaborators?.map(collab => ({
          id: collab.id,
          user_id: collab.user_id,
          email: collab.profiles?.email,
          last_seen: new Date().toISOString()
        })) || [];

        setActiveCollaborators(initialCollaborators);

      } catch (error) {
        console.error('Error setting up presence:', error);
        toast({
          title: "Error",
          description: "Failed to load collaborators",
          variant: "destructive",
        });
      }
    };

    setupPresence();

    return () => {
      if (presenceChannel.current) {
        console.log('Cleaning up presence channel');
        supabase.removeChannel(presenceChannel.current);
        presenceChannel.current = null;
      }
    };
  }, [thesisId, toast]);

  return (
    <div className="flex -space-x-2 overflow-hidden p-2">
      <AnimatePresence>
        {activeCollaborators.map((collaborator) => (
          <motion.div
            key={`${collaborator.user_id}-${collaborator.last_seen}`}
            initial={{ opacity: 0, scale: 0.5 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 0.5 }}
            className="relative inline-block"
          >
            <Avatar className="h-8 w-8 border-2 border-background">
              <AvatarImage 
                src={`https://api.dicebear.com/7.x/initials/svg?seed=${collaborator.email}`} 
                alt={collaborator.email} 
              />
              <AvatarFallback>
                {collaborator.email?.charAt(0).toUpperCase() || '?'}
              </AvatarFallback>
            </Avatar>
            <span className="absolute bottom-0 right-0 h-2 w-2 rounded-full bg-green-500 border border-background" />
          </motion.div>
        ))}
      </AnimatePresence>
    </div>
  );
};

// File: src\components\collaboration\NotificationCenter.tsx

import React from 'react';
import { useNotifications } from './notifications/useNotifications';
import { NotificationList } from './notifications/NotificationList';
import { Card } from '../ui/card';
import { LoadingSkeleton } from '../loading/LoadingSkeleton';

interface NotificationCenterProps {
  thesisId: string;
}

export const NotificationCenter: React.FC<NotificationCenterProps> = ({ thesisId }) => {
  console.log('ðŸŽ¯ Rendering NotificationCenter for thesis:', thesisId);
  
  const { notifications, loading, markAsRead } = useNotifications(thesisId);

  if (loading) {
    return <LoadingSkeleton />;
  }

  return (
    <Card className="w-full">
      <div className="p-4 border-b">
        <h3 className="font-semibold">Notifications</h3>
      </div>
      <NotificationList
        notifications={notifications}
        onMarkAsRead={markAsRead}
      />
    </Card>
  );
};

// File: src\components\collaboration\notifications\NotificationItem.tsx

import React from 'react';
import { Notification } from '../types';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import { Bell } from 'lucide-react';
import { formatDistanceToNow } from 'date-fns';

interface NotificationItemProps {
  notification: Notification;
  onMarkAsRead: (id: string) => void;
}

export const NotificationItem: React.FC<NotificationItemProps> = ({
  notification,
  onMarkAsRead,
}) => {
  console.log('ðŸ”” Rendering NotificationItem:', notification.id, 'Read:', notification.read);
  
  const handleMarkAsRead = () => {
    console.log('ðŸ‘† Marking notification as read:', notification.id);
    onMarkAsRead(notification.id);
  };

  return (
    <Card className={`p-4 ${notification.read ? 'bg-muted' : 'bg-primary/5'}`}>
      <div className="flex items-start gap-3">
        <Bell className="w-4 h-4 mt-1 text-primary" />
        <div className="flex-1 space-y-1">
          <p className="text-sm">{notification.message}</p>
          <div className="flex items-center justify-between">
            <span className="text-xs text-muted-foreground">
              {formatDistanceToNow(new Date(notification.created_at), { addSuffix: true })}
            </span>
            {!notification.read && (
              <Button
                variant="ghost"
                size="sm"
                onClick={handleMarkAsRead}
                className="text-xs"
              >
                Mark as read
              </Button>
            )}
          </div>
        </div>
      </div>
    </Card>
  );
};

// File: src\components\collaboration\notifications\NotificationList.tsx

import React from 'react';
import { NotificationItem } from './NotificationItem';
import { Notification } from '../types';
import { ScrollArea } from '@/components/ui/scroll-area';

interface NotificationListProps {
  notifications: Notification[];
  onMarkAsRead: (id: string) => void;
}

export const NotificationList: React.FC<NotificationListProps> = ({
  notifications,
  onMarkAsRead,
}) => {
  console.log('ðŸŽ¯ Rendering NotificationList with', notifications.length, 'notifications');
  
  return (
    <ScrollArea className="h-[300px]">
      <div className="space-y-2 p-4">
        {notifications.map((notification) => (
          <NotificationItem
            key={notification.id}
            notification={notification}
            onMarkAsRead={onMarkAsRead}
          />
        ))}
        {notifications.length === 0 && (
          <div className="text-center text-muted-foreground p-4">
            No notifications
          </div>
        )}
      </div>
    </ScrollArea>
  );
};

// File: src\components\collaboration\notifications\useNotifications.ts

import { useState, useEffect, useRef, useCallback } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/hooks/use-toast';
import { Notification } from '../types';

export const useNotifications = (thesisId: string) => {
  const [notifications, setNotifications] = useState<Notification[]>([]);
  const [loading, setLoading] = useState(true);
  const { toast } = useToast();
  const processedNotificationsRef = useRef<Set<string>>(new Set());
  const subscriptionRef = useRef<any>(null);

  const fetchNotifications = useCallback(async () => {
    try {
      console.log('ðŸ”„ Fetching notifications for thesis:', thesisId);
      const { data: userData } = await supabase.auth.getUser();
      if (!userData.user) {
        console.error('âŒ No authenticated user found');
        return;
      }

      const { data, error } = await supabase
        .from('notifications')
        .select('*')
        .eq('thesis_id', thesisId)
        .eq('user_id', userData.user.id)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('âŒ Error fetching notifications:', error);
        throw error;
      }

      console.log('âœ… Fetched notifications:', data?.length);
      setNotifications(data || []);
      data?.forEach(notification => {
        processedNotificationsRef.current.add(notification.id);
      });
    } catch (error) {
      console.error('âŒ Error in fetchNotifications:', error);
      toast({
        title: "Error",
        description: "Failed to load notifications",
        variant: "destructive",
      });
    } finally {
      setLoading(false);
    }
  }, [thesisId, toast]);

  const handleNewNotification = useCallback((payload: any) => {
    console.log('ðŸ“¨ New notification received:', payload);
    const notification = payload.new;
    
    if (processedNotificationsRef.current.has(notification.id)) {
      console.log('ðŸ”„ Notification already processed, skipping:', notification.id);
      return;
    }

    console.log('âœ¨ Processing new notification:', notification.id);
    processedNotificationsRef.current.add(notification.id);
    
    setNotifications(prev => {
      const exists = prev.some(n => n.id === notification.id);
      if (exists) {
        console.log('ðŸ”„ Notification already in state, skipping:', notification.id);
        return prev;
      }
      console.log('âž• Adding new notification to state:', notification.id);
      return [notification, ...prev];
    });

    toast({
      title: "New Notification",
      description: notification.message,
    });
  }, [toast]);

  const markAsRead = useCallback(async (notificationId: string) => {
    try {
      console.log('ðŸ“ Marking notification as read:', notificationId);
      const { error } = await supabase
        .from('notifications')
        .update({ read: true })
        .eq('id', notificationId);

      if (error) {
        console.error('âŒ Error marking notification as read:', error);
        throw error;
      }

      setNotifications(prev =>
        prev.map(n =>
          n.id === notificationId ? { ...n, read: true } : n
        )
      );
      console.log('âœ… Notification marked as read:', notificationId);
    } catch (error) {
      console.error('âŒ Error in markAsRead:', error);
      toast({
        title: "Error",
        description: "Failed to mark notification as read",
        variant: "destructive",
      });
    }
  }, [toast]);

  useEffect(() => {
    console.log('ðŸ”„ Setting up notifications subscription for thesis:', thesisId);
    
    fetchNotifications();

    const channel = supabase
      .channel('notifications')
      .on(
        'postgres_changes',
        {
          event: 'INSERT',
          schema: 'public',
          table: 'notifications',
          filter: `thesis_id=eq.${thesisId}`,
        },
        handleNewNotification
      )
      .subscribe(status => {
        console.log('ðŸ“¡ Notification subscription status:', status);
      });

    subscriptionRef.current = channel;

    return () => {
      console.log('ðŸ§¹ Cleaning up notifications subscription');
      if (subscriptionRef.current) {
        supabase.removeChannel(subscriptionRef.current);
      }
      processedNotificationsRef.current.clear();
    };
  }, [thesisId, fetchNotifications, handleNewNotification]);

  return {
    notifications,
    loading,
    markAsRead,
  };
};

// File: src\components\collaboration\types.ts

export interface Notification {
  id: string;
  message: string;
  created_at: string;
  read: boolean;
  user_id: string;
  thesis_id: string;
  type: string;
}

// File: src\components\dashboard\QuickTips.tsx

import { Lightbulb, BookOpen, Users, Save } from 'lucide-react';

export const QuickTips = () => {
  return (
    <div>
      <h2 className="text-2xl font-serif font-semibold text-primary mb-6">
        Quick Tips
      </h2>
      <div className="space-y-6">
        <div className="space-y-4">
          <div className="flex items-start gap-3">
            <div className="bg-blue-50 rounded-lg p-2">
              <BookOpen className="w-5 h-5 text-blue-600" />
            </div>
            <div>
              <h4 className="font-medium text-gray-900 font-serif">Getting Started</h4>
              <p className="text-sm text-muted-foreground font-sans">
                Click "Create New Thesis" to begin your academic journey
              </p>
            </div>
          </div>
          
          <div className="flex items-start gap-3">
            <div className="bg-green-50 rounded-lg p-2">
              <Users className="w-5 h-5 text-green-600" />
            </div>
            <div>
              <h4 className="font-medium text-gray-900 font-serif">Collaboration</h4>
              <p className="text-sm text-muted-foreground font-sans">
                Invite collaborators through the sharing menu in your thesis
              </p>
            </div>
          </div>
          
          <div className="flex items-start gap-3">
            <div className="bg-amber-50 rounded-lg p-2">
              <Save className="w-5 h-5 text-amber-600" />
            </div>
            <div>
              <h4 className="font-medium text-gray-900 font-serif">Auto-saving</h4>
              <p className="text-sm text-muted-foreground font-sans">
                Your work is automatically saved as you type
              </p>
            </div>
          </div>
          
          <div className="flex items-start gap-3">
            <div className="bg-purple-50 rounded-lg p-2">
              <Lightbulb className="w-5 h-5 text-purple-600" />
            </div>
            <div>
              <h4 className="font-medium text-gray-900 font-serif">Best Practices</h4>
              <p className="text-sm text-muted-foreground font-sans">
                Use headings to organize your content effectively
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

// File: src\components\dashboard\StatsGrid.tsx

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { FileText, Clock, Star } from "lucide-react";

interface StatsGridProps {
  stats: {
    total: number;
    inProgress: number;
    completed: number;
  };
}

export const StatsGrid = ({ stats }: StatsGridProps) => {
  return (
    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <Card className="backdrop-blur-xl bg-white/5 border-white/10">
        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
          <CardTitle className="text-sm font-medium font-sans text-[#D6BCFA]">Total Theses</CardTitle>
          <FileText className="h-4 w-4 text-[#9b87f5]" />
        </CardHeader>
        <CardContent>
          <div className="text-2xl font-bold font-sans text-white">{stats.total}</div>
        </CardContent>
      </Card>
      <Card className="backdrop-blur-xl bg-white/5 border-white/10">
        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
          <CardTitle className="text-sm font-medium font-sans text-[#D6BCFA]">In Progress</CardTitle>
          <Clock className="h-4 w-4 text-[#9b87f5]" />
        </CardHeader>
        <CardContent>
          <div className="text-2xl font-bold font-sans text-white">{stats.inProgress}</div>
        </CardContent>
      </Card>
      <Card className="backdrop-blur-xl bg-white/5 border-white/10">
        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
          <CardTitle className="text-sm font-medium font-sans text-[#D6BCFA]">Completed</CardTitle>
          <Star className="h-4 w-4 text-[#9b87f5]" />
        </CardHeader>
        <CardContent>
          <div className="text-2xl font-bold font-sans text-white">{stats.completed}</div>
        </CardContent>
      </Card>
    </div>
  );
};

// File: src\components\dashboard\thesis-map\BackgroundEffects.tsx

import React from 'react';
import { motion } from 'framer-motion';

export const BackgroundEffects = () => {
  return (
    <>
      <div className="absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,rgba(79,70,229,0.03),transparent_50%)]" />
      <motion.div
        className="absolute inset-0"
        initial={false}
        animate={{
          background: [
            'radial-gradient(600px circle at 50% 50%, rgba(79,70,229,0.02), transparent 80%)',
            'radial-gradient(800px circle at 50% 50%, rgba(79,70,229,0.04), transparent 80%)'
          ],
        }}
        transition={{ duration: 3, repeat: Infinity, repeatType: 'reverse' }}
      />
      <div className="absolute inset-0 pointer-events-none">
        {[...Array(20)].map((_, i) => (
          <motion.div
            key={i}
            className="absolute w-1 h-1 bg-primary/10 rounded-full"
            initial={{
              x: Math.random() * window.innerWidth,
              y: Math.random() * window.innerHeight,
            }}
            animate={{
              x: Math.random() * window.innerWidth,
              y: Math.random() * window.innerHeight,
            }}
            transition={{
              duration: Math.random() * 10 + 5,
              repeat: Infinity,
              repeatType: "reverse",
            }}
          />
        ))}
      </div>
    </>
  );
};

// File: src\components\dashboard\thesis-map\CentralProgress.tsx

import React from 'react';
import { motion } from 'framer-motion';
import { BookOpen, Clock } from 'lucide-react';
import { Progress } from "@/components/ui/progress";

interface CentralProgressProps {
  totalProgress: number;
}

export const CentralProgress = ({ totalProgress }: CentralProgressProps) => {
  return (
    <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
      <motion.div
        className="relative"
        animate={{ rotate: 360 }}
        transition={{ duration: 20, repeat: Infinity, ease: "linear" }}
      >
        <div className="absolute -inset-32 border-2 border-dashed border-primary/20 rounded-full" />
      </motion.div>
      
      <motion.div
        className="relative z-10 bg-white p-8 rounded-full shadow-xl"
        whileHover={{ scale: 1.1 }}
        initial={{ scale: 0 }}
        animate={{ scale: 1 }}
        transition={{ type: "spring", duration: 1 }}
      >
        <motion.div
          className="absolute inset-0 bg-primary/5 rounded-full"
          animate={{
            scale: [1, 1.2, 1],
            opacity: [0.5, 0.2, 0.5],
          }}
          transition={{ duration: 2, repeat: Infinity }}
        />
        <BookOpen size={48} className="text-primary relative z-10" />
      </motion.div>

      <div className="absolute -bottom-24 left-1/2 transform -translate-x-1/2">
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="flex flex-col items-center"
        >
          <div className="relative w-16 h-16">
            <Progress
              value={totalProgress}
              className="h-16 w-16 [&>div]:h-16 [&>div]:w-16 rotate-[-90deg]"
            />
            <div className="absolute inset-0 flex items-center justify-center">
              <Clock className="h-6 w-6 text-primary" />
            </div>
          </div>
          <div className="mt-2 text-center">
            <p className="font-medium text-sm text-primary">{totalProgress}% Complete</p>
            <p className="text-xs text-muted-foreground">Overall Progress</p>
          </div>
        </motion.div>
      </div>
    </div>
  );
};

// File: src\components\dashboard\thesis-map\SectionNode.tsx

import React from 'react';
import { motion } from 'framer-motion';
import { CheckSquare, Square } from 'lucide-react';

interface SectionNodeProps {
  id: string;
  title: string;
  progress: number;
  complete: boolean;
  position: { x: number; y: number };
  hoveredSection: string | null;
  onHover: (id: string | null) => void;
}

export const SectionNode = ({
  id,
  title,
  progress,
  complete,
  position,
  hoveredSection,
  onHover
}: SectionNodeProps) => {
  return (
    <motion.div
      key={id}
      className="absolute top-1/2 left-1/2"
      style={{
        x: position.x,
        y: position.y,
      }}
      initial={{ opacity: 0, scale: 0 }}
      animate={{ opacity: 1, scale: 1 }}
      transition={{ type: "spring", stiffness: 100 }}
    >
      <motion.div
        className={`bg-white/80 backdrop-blur-sm p-4 rounded-xl shadow-lg -translate-x-1/2 -translate-y-1/2 w-48 border border-primary/10
                   ${hoveredSection === id ? 'ring-2 ring-primary/20' : ''}`}
        whileHover={{ scale: 1.05, y: -5 }}
        onHoverStart={() => onHover(id)}
        onHoverEnd={() => onHover(null)}
      >
        <div className="space-y-2">
          <div className="flex items-center justify-between">
            {complete ? (
              <motion.div
                initial={{ scale: 0 }}
                animate={{ scale: 1 }}
                transition={{ type: "spring" }}
              >
                <CheckSquare className="text-green-500" />
              </motion.div>
            ) : (
              <Square className="text-muted-foreground" />
            )}
            <span className="text-sm font-medium text-primary">{title}</span>
          </div>
          <div className="relative h-2 bg-muted rounded-full overflow-hidden">
            <motion.div
              className="absolute inset-y-0 left-0 bg-primary rounded-full"
              initial={{ width: 0 }}
              animate={{ width: `${progress}%` }}
              transition={{ duration: 1 }}
            />
          </div>
          <div className="flex justify-between items-center text-xs text-muted-foreground">
            <span>{progress}%</span>
            <span className={`px-2 py-1 rounded-full text-xs ${
              complete 
                ? 'bg-green-500/10 text-green-500' 
                : 'bg-primary/10 text-primary'
            }`}>
              {complete ? 'Completed' : 'In Progress'}
            </span>
          </div>
        </div>
      </motion.div>
    </motion.div>
  );
};

// File: src\components\dashboard\thesis-map\StatsDisplay.tsx

import React from 'react';
import { motion } from 'framer-motion';
import { ChartBar, ChartLine, ChartPie } from 'lucide-react';

interface StatsDisplayProps {
  stats: {
    total: number;
    inProgress: number;
    completed: number;
  };
}

export const StatsDisplay = ({ stats }: StatsDisplayProps) => {
  return (
    <div className="absolute bottom-8 left-1/2 transform -translate-x-1/2 flex gap-8">
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.2 }}
        className="flex items-center gap-2 bg-white/80 backdrop-blur-sm p-4 rounded-xl shadow-lg"
      >
        <ChartBar className="text-primary h-5 w-5" />
        <div>
          <p className="text-xs text-muted-foreground">Total</p>
          <p className="text-lg font-semibold text-primary">{stats.total}</p>
        </div>
      </motion.div>
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.3 }}
        className="flex items-center gap-2 bg-white/80 backdrop-blur-sm p-4 rounded-xl shadow-lg"
      >
        <ChartLine className="text-primary h-5 w-5" />
        <div>
          <p className="text-xs text-muted-foreground">In Progress</p>
          <p className="text-lg font-semibold text-primary">{stats.inProgress}</p>
        </div>
      </motion.div>
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.4 }}
        className="flex items-center gap-2 bg-white/80 backdrop-blur-sm p-4 rounded-xl shadow-lg"
      >
        <ChartPie className="text-primary h-5 w-5" />
        <div>
          <p className="text-xs text-muted-foreground">Completed</p>
          <p className="text-lg font-semibold text-primary">{stats.completed}</p>
        </div>
      </motion.div>
    </div>
  );
};

// File: src\components\dashboard\ThesisProgressMap.tsx

import React, { useState } from 'react';
import { CentralProgress } from './thesis-map/CentralProgress';
import { SectionNode } from './thesis-map/SectionNode';
import { StatsDisplay } from './thesis-map/StatsDisplay';
import { BackgroundEffects } from './thesis-map/BackgroundEffects';

interface ThesisProgressMapProps {
  stats: {
    total: number;
    inProgress: number;
    completed: number;
  };
}

export const ThesisProgressMap = ({ stats }: ThesisProgressMapProps) => {
  const [hoveredSection, setHoveredSection] = useState<string | null>(null);
  const totalProgress = Math.round((stats.completed / stats.total) * 100);

  const sections = [
    { id: 'introduction', title: 'Introduction', progress: 100, complete: true },
    { id: 'literature', title: 'Literature Review', progress: 85, complete: false },
    { id: 'methodology', title: 'Methodology', progress: 60, complete: false },
    { id: 'results', title: 'Results', progress: 40, complete: false },
    { id: 'discussion', title: 'Discussion', progress: 20, complete: false },
    { id: 'conclusion', title: 'Conclusion', progress: 10, complete: false },
  ];

  const getPositionOnCircle = (index: number, total: number, radius: number) => {
    const angle = (index * 360) / total + 90;
    const x = Math.cos((angle * Math.PI) / 180) * radius;
    const y = Math.sin((angle * Math.PI) / 180) * radius;
    return { x, y };
  };

  return (
    <div className="relative w-full h-[600px] bg-white rounded-3xl overflow-hidden shadow-lg">
      <BackgroundEffects />
      <CentralProgress totalProgress={totalProgress} />

      {sections.map((section, index) => {
        const position = getPositionOnCircle(index, sections.length, 200);
        return (
          <SectionNode
            key={section.id}
            id={section.id}
            title={section.title}
            progress={section.progress}
            complete={section.complete}
            position={position}
            hoveredSection={hoveredSection}
            onHover={setHoveredSection}
          />
        );
      })}

      <StatsDisplay stats={stats} />
    </div>
  );
};

// File: src\components\dashboard\UserProfile.tsx

import { Card } from "@/components/ui/card";
import { UserCircle } from "lucide-react";

interface UserProfileProps {
  email: string;
  role: string;
}

export const UserProfile = ({ email, role }: UserProfileProps) => {
  return (
    <div className="flex items-center gap-4">
      <div className="bg-[#9b87f5]/10 rounded-full p-3">
        <UserCircle className="w-8 h-8 text-[#9b87f5]" />
      </div>
      <div className="space-y-1">
        <h2 className="text-xl font-medium font-serif text-white">
          Welcome back, <span className="text-[#9b87f5]">{email}</span>
        </h2>
        <p className="text-sm font-sans text-[#D6BCFA]/80">
          Role: <span className="font-medium capitalize">{role}</span>
        </p>
      </div>
    </div>
  );
};

// File: src\components\editor\chapters\ChapterCitations.tsx

import React from 'react';
import { Chapter, Citation } from '@/types/thesis';
import { Button } from '@/components/ui/button';
import { CitationSearch } from '../../citation/CitationSearch';
import { Trash2 } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';

interface ChapterCitationsProps {
  chapter: Chapter;
  onUpdateChapter: (chapter: Chapter) => void;
}

export const ChapterCitations: React.FC<ChapterCitationsProps> = ({
  chapter,
  onUpdateChapter
}) => {
  const { toast } = useToast();

  const handleAddCitation = (citation: Omit<Citation, "thesis_id">) => {
    if (chapter.sections[0]) {
      const updatedSections = [...chapter.sections];
      updatedSections[0] = {
        ...updatedSections[0],
        citations: [...(updatedSections[0].citations || []), { ...citation, thesis_id: chapter.id }]
      };

      onUpdateChapter({
        ...chapter,
        sections: updatedSections
      });

      toast({
        title: "Citation Added",
        description: "New citation has been added to the chapter",
      });
    }
  };

  const handleRemoveCitation = (citationId: string) => {
    const updatedSections = chapter.sections.map(section => ({
      ...section,
      citations: section.citations.filter(c => c.id !== citationId)
    }));

    onUpdateChapter({
      ...chapter,
      sections: updatedSections
    });

    toast({
      title: "Citation Removed",
      description: "Citation has been removed from the chapter",
    });
  };

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between mb-4">
        <h3 className="text-lg font-medium">Citations</h3>
        <CitationSearch onCitationSelect={handleAddCitation} />
      </div>
      <div className="space-y-2">
        {chapter.sections[0]?.citations?.map((citation) => (
          <div key={citation.id} className="border p-4 rounded-lg group relative">
            <Button
              variant="ghost"
              size="sm"
              onClick={() => handleRemoveCitation(citation.id)}
              className="absolute right-2 top-2 opacity-0 group-hover:opacity-100 transition-opacity text-destructive hover:text-destructive hover:bg-destructive/10"
            >
              <Trash2 className="w-4 h-4" />
            </Button>
            <p className="font-medium">{citation.text}</p>
            <p className="text-sm text-gray-600">
              {citation.authors.join(', ')} ({citation.year})
            </p>
          </div>
        ))}
      </div>
    </div>
  );
};

// File: src\components\editor\chapters\ChapterContent.tsx

import React from 'react';
import { Chapter, Section } from '@/types/thesis';
import { Button } from '@/components/ui/button';
import { PlusCircle, Trash2 } from 'lucide-react';
import { MarkdownEditor } from '@/components/MarkdownEditor';
import { useToast } from '@/hooks/use-toast';
import { SectionItem } from '../sections/SectionItem';

interface ChapterContentProps {
  chapter: Chapter;
  onUpdateChapter: (chapter: Chapter) => void;
}

export const ChapterContent: React.FC<ChapterContentProps> = ({
  chapter,
  onUpdateChapter
}) => {
  const { toast } = useToast();

  const handleAddSection = () => {
    const newSection: Section = {
      id: Date.now().toString(),
      title: 'New Section',
      content: '',
      type: 'custom',
      order: chapter.sections.length + 1,
      figures: [],
      tables: [],
      citations: [],
      references: []
    };

    onUpdateChapter({
      ...chapter,
      sections: [...chapter.sections, newSection]
    });

    toast({
      title: "Section Added",
      description: "New section has been added to the chapter",
    });
  };

  const handleRemoveSection = (sectionId: string) => {
    onUpdateChapter({
      ...chapter,
      sections: chapter.sections.filter(s => s.id !== sectionId)
    });

    toast({
      title: "Section Removed",
      description: "Section has been removed from the chapter",
    });
  };

  return (
    <div className="pt-4 border-t space-y-6">
      <div className="space-y-2">
        <label className="text-sm font-medium text-gray-700">Chapter Introduction</label>
        <MarkdownEditor
          value={chapter.content || ''}
          onChange={(value) => onUpdateChapter({
            ...chapter,
            content: value || ''
          })}
          placeholder="Write your chapter introduction here..."
        />
      </div>

      <div className="space-y-4">
        <div className="flex items-center justify-between">
          <h3 className="text-lg font-medium text-gray-900">Sections</h3>
          <Button
            onClick={handleAddSection}
            variant="outline"
            size="sm"
            className="gap-2"
          >
            <PlusCircle className="w-4 h-4" />
            Add Section
          </Button>
        </div>

        <div className="space-y-4">
          {chapter.sections.map((section, index) => (
            <div key={section.id} className="group relative">
              <Button
                variant="ghost"
                size="sm"
                onClick={() => handleRemoveSection(section.id)}
                className="absolute right-2 top-2 opacity-0 group-hover:opacity-100 transition-opacity text-destructive hover:text-destructive hover:bg-destructive/10"
              >
                <Trash2 className="w-4 h-4" />
              </Button>
              <SectionItem
                section={section}
                sectionNumber={index + 1}
                onUpdateSection={(updatedSection) => {
                  onUpdateChapter({
                    ...chapter,
                    sections: chapter.sections.map((s) =>
                      s.id === updatedSection.id ? updatedSection : s
                    ),
                  });
                }}
              />
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

// File: src\components\editor\chapters\ChapterCreationDialog.tsx

import React, { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { 
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Figure } from '@/types/thesis';

interface ChapterCreationDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onChapterCreate: (chapter: any) => void;
}

export const ChapterCreationDialog: React.FC<ChapterCreationDialogProps> = ({
  open,
  onOpenChange,
  onChapterCreate,
}) => {
  const [title, setTitle] = useState('');
  const [figures, setFigures] = useState<Figure[]>([]);

  const handleAddFigure = (file: File) => {
    const newFigure: Figure = {
      id: Date.now().toString(),
      url: URL.createObjectURL(file),
      caption: '',
      alt_text: '',
      title: '',
      label: `Figure ${figures.length + 1}`,
      dimensions: {
        width: 0,
        height: 0
      },
      position: 'inline'
    };
    
    setFigures(prevFigures => [...prevFigures, newFigure]);
  };

  const handleCreateChapter = () => {
    const newChapter = {
      id: Date.now().toString(),
      title,
      figures,
      sections: [],
      order: 1
    };
    onChapterCreate(newChapter);
    setTitle('');
    setFigures([]);
    onOpenChange(false);
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Create New Chapter</DialogTitle>
          <DialogDescription>
            <div className="space-y-4">
              <Input
                value={title}
                onChange={(e) => setTitle(e.target.value)}
                placeholder="Chapter Title"
                className="w-full"
              />
              <div>
                <input
                  type="file"
                  accept="image/*"
                  onChange={(e) => {
                    if (e.target.files) {
                      Array.from(e.target.files).forEach(handleAddFigure);
                    }
                  }}
                  className="w-full"
                />
              </div>
              <Button onClick={handleCreateChapter} className="w-full">
                Create Chapter
              </Button>
            </div>
          </DialogDescription>
        </DialogHeader>
      </DialogContent>
    </Dialog>
  );
};

// File: src\components\editor\chapters\ChapterFigures.tsx

import React from 'react';
import { Chapter } from '@/types/thesis';
import { FigureManager } from '@/components/FigureManager';

interface ChapterFiguresProps {
  chapter: Chapter;
  onUpdateChapter: (chapter: Chapter) => void;
}

export const ChapterFigures: React.FC<ChapterFiguresProps> = ({
  chapter,
  onUpdateChapter
}) => {
  const handleAddFigure = (figure) => {
    const updatedFigures = [...chapter.figures, figure];
    onUpdateChapter({ ...chapter, figures: updatedFigures });
  };

  const handleRemoveFigure = (id) => {
    const updatedFigures = chapter.figures.filter(figure => figure.id !== id);
    onUpdateChapter({ ...chapter, figures: updatedFigures });
  };

  const handleUpdateFigure = (updatedFigure) => {
    const updatedFigures = chapter.figures.map(figure =>
      figure.id === updatedFigure.id ? updatedFigure : figure
    );
    onUpdateChapter({ ...chapter, figures: updatedFigures });
  };

  return (
    <div>
      <h3 className="text-lg font-medium mb-4">Figures</h3>
      <FigureManager
        figures={chapter.figures}
        onAddFigure={handleAddFigure}
        onRemoveFigure={handleRemoveFigure}
        onUpdateFigure={handleUpdateFigure}
      />
    </div>
  );
};

// File: src\components\editor\chapters\ChapterItem.tsx

import React, { useState } from 'react';
import { Chapter, Footnote } from '@/types/thesis';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Checkbox } from '@/components/ui/checkbox';
import { ChevronDown, ChevronUp, GripVertical } from 'lucide-react';
import { cn } from '@/lib/utils';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { ChapterContent } from './ChapterContent';
import { ChapterFigures } from './ChapterFigures';
import { ChapterTables } from './ChapterTables';
import { ChapterCitations } from './ChapterCitations';
import { ChapterReferences } from './ChapterReferences';
import { FootnoteManager } from './FootnoteManager';

interface ChapterItemProps {
  chapter: Chapter;
  chapterNumber: number;
  isOpen: boolean;
  onToggle: () => void;
  onUpdateChapter: (chapter: Chapter) => void;
  isSelected?: boolean;
  onSelect?: () => void;
}

export const ChapterItem: React.FC<ChapterItemProps> = ({
  chapter,
  chapterNumber,
  isOpen,
  onToggle,
  onUpdateChapter,
  isSelected,
  onSelect
}) => {
  const [activeTab, setActiveTab] = useState('content');

  const handleTitleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    onUpdateChapter({
      ...chapter,
      title: e.target.value
    });
  };

  const handleFootnoteAdd = (sectionId: string, footnote: Footnote) => {
    const updatedSections = chapter.sections.map(section => {
      if (section.id === sectionId) {
        return {
          ...section,
          footnotes: [...(section.footnotes || []), footnote]
        };
      }
      return section;
    });

    onUpdateChapter({
      ...chapter,
      sections: updatedSections
    });
  };

  const handleFootnoteRemove = (sectionId: string, footnoteId: string) => {
    const updatedSections = chapter.sections.map(section => {
      if (section.id === sectionId) {
        return {
          ...section,
          footnotes: (section.footnotes || []).filter(f => f.id !== footnoteId)
        };
      }
      return section;
    });

    onUpdateChapter({
      ...chapter,
      sections: updatedSections
    });
  };

  const handleFootnoteUpdate = (sectionId: string, updatedFootnote: Footnote) => {
    const updatedSections = chapter.sections.map(section => {
      if (section.id === sectionId) {
        return {
          ...section,
          footnotes: (section.footnotes || []).map(f => 
            f.id === updatedFootnote.id ? updatedFootnote : f
          )
        };
      }
      return section;
    });

    onUpdateChapter({
      ...chapter,
      sections: updatedSections
    });
  };

  return (
    <div className={cn(
      "border rounded-xl bg-white shadow-sm transition-all duration-200",
      "hover:shadow-md",
      isOpen && "ring-2 ring-primary/10",
      isSelected && "ring-2 ring-primary"
    )}>
      <div className="p-4 flex items-center justify-between group">
        <div className="flex items-center gap-3">
          <Checkbox
            checked={isSelected}
            onCheckedChange={() => onSelect?.()}
            className="ml-2"
          />
          <div className="p-2 bg-gray-100 rounded-lg group-hover:bg-gray-200 transition-colors cursor-move">
            <GripVertical className="w-4 h-4 text-gray-500" />
          </div>
          <div className="flex items-center gap-2">
            <div className="bg-primary/10 text-primary font-medium px-3 py-1 rounded-md">
              Ch. {chapterNumber}
            </div>
            <Input
              value={chapter.title}
              onChange={handleTitleChange}
              className="text-xl font-serif border-none bg-transparent px-0 focus-visible:ring-0 w-full min-w-[300px]"
              placeholder="Chapter Title"
            />
          </div>
        </div>
        <div className="flex items-center gap-2">
          <span className="text-sm text-gray-500">
            {chapter.sections.length} {chapter.sections.length === 1 ? 'section' : 'sections'}
          </span>
          <Button
            variant="ghost"
            size="sm"
            onClick={onToggle}
            className="p-2"
          >
            {isOpen ? (
              <ChevronUp className="w-5 h-5 text-gray-500" />
            ) : (
              <ChevronDown className="w-5 h-5 text-gray-500" />
            )}
          </Button>
        </div>
      </div>

      {isOpen && (
        <div className="p-4 pt-0 space-y-4">
          <Tabs value={activeTab} onValueChange={setActiveTab} className="w-full">
            <TabsList className="grid w-full grid-cols-6">
              <TabsTrigger value="content">Content</TabsTrigger>
              <TabsTrigger value="figures">Figures</TabsTrigger>
              <TabsTrigger value="tables">Tables</TabsTrigger>
              <TabsTrigger value="citations">Citations</TabsTrigger>
              <TabsTrigger value="references">References</TabsTrigger>
              <TabsTrigger value="footnotes">Footnotes</TabsTrigger>
            </TabsList>

            <TabsContent value="content">
              <ChapterContent 
                chapter={chapter}
                onUpdateChapter={onUpdateChapter}
              />
            </TabsContent>

            <TabsContent value="figures">
              <ChapterFigures
                chapter={chapter}
                onUpdateChapter={onUpdateChapter}
              />
            </TabsContent>

            <TabsContent value="tables">
              <ChapterTables
                chapter={chapter}
                onUpdateChapter={onUpdateChapter}
              />
            </TabsContent>

            <TabsContent value="citations">
              <ChapterCitations
                chapter={chapter}
                onUpdateChapter={onUpdateChapter}
              />
            </TabsContent>

            <TabsContent value="references">
              <ChapterReferences
                chapter={chapter}
                onUpdateChapter={onUpdateChapter}
              />
            </TabsContent>

            <TabsContent value="footnotes">
              {chapter.sections.map((section) => (
                <div key={section.id} className="mb-8">
                  <h3 className="text-lg font-medium mb-4">
                    Section: {section.title}
                  </h3>

                  <FootnoteManager
                    footnotes={section.footnotes || []}
                    onAddFootnote={(footnote) => handleFootnoteAdd(section.id, footnote)}
                    onRemoveFootnote={(id) => handleFootnoteRemove(section.id, id)}
                    onUpdateFootnote={(footnote) => handleFootnoteUpdate(section.id, footnote)}
                    thesisId={chapter.id}
                    sectionId={section.id}
                    onUpdate={() => {}}
                  />
                </div>
              ))}
            </TabsContent>
          </Tabs>
        </div>
      )}
    </div>
  );
};


// File: src\components\editor\chapters\ChapterReferences.tsx

import React from 'react';
import { Chapter, Reference } from '@/types/thesis';
import { Button } from '@/components/ui/button';
import { ReferenceDialog } from '../../reference/ReferenceDialog';
import { Trash2 } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';

interface ChapterReferencesProps {
  chapter: Chapter;
  onUpdateChapter: (chapter: Chapter) => void;
}

export const ChapterReferences: React.FC<ChapterReferencesProps> = ({
  chapter,
  onUpdateChapter
}) => {
  const { toast } = useToast();

  const handleAddReference = (reference: Reference) => {
    if (chapter.sections[0]) {
      const updatedSections = [...chapter.sections];
      updatedSections[0] = {
        ...updatedSections[0],
        references: [...(updatedSections[0].references || []), reference]
      };

      onUpdateChapter({
        ...chapter,
        sections: updatedSections
      });

      toast({
        title: "Reference Added",
        description: "New reference has been added to the chapter",
      });
    }
  };

  const handleRemoveReference = (referenceId: string) => {
    const updatedSections = chapter.sections.map(section => ({
      ...section,
      references: section.references?.filter(r => r.id !== referenceId) || []
    }));

    onUpdateChapter({
      ...chapter,
      sections: updatedSections
    });

    toast({
      title: "Reference Removed",
      description: "Reference has been removed from the chapter",
    });
  };

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between mb-4">
        <h3 className="text-lg font-medium">References</h3>
        <ReferenceDialog onAddReference={handleAddReference} />
      </div>
      <div className="space-y-2">
        {chapter.sections[0]?.references?.map((reference) => (
          <div key={reference.id} className="border p-4 rounded-lg group relative">
            <Button
              variant="ghost"
              size="sm"
              onClick={() => handleRemoveReference(reference.id)}
              className="absolute right-2 top-2 opacity-0 group-hover:opacity-100 transition-opacity text-destructive hover:text-destructive hover:bg-destructive/10"
            >
              <Trash2 className="w-4 h-4" />
            </Button>
            <p className="font-medium">{reference.title}</p>
            <p className="text-sm text-gray-600">
              {reference.authors.join(', ')} ({reference.year})
            </p>
          </div>
        ))}
      </div>
    </div>
  );
};

// File: src\components\editor\chapters\ChapterTables.tsx

import React from 'react';
import { Chapter, Table } from '@/types/thesis';
import { Button } from '@/components/ui/button';
import { TableDialog } from '../../table/TableDialog';
import { Trash2 } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';

interface ChapterTablesProps {
  chapter: Chapter;
  onUpdateChapter: (chapter: Chapter) => void;
}

export const ChapterTables: React.FC<ChapterTablesProps> = ({
  chapter,
  onUpdateChapter
}) => {
  const { toast } = useToast();

  const handleAddTable = (table: Table) => {
    if (chapter.sections[0]) {
      const updatedSections = [...chapter.sections];
      updatedSections[0] = {
        ...updatedSections[0],
        tables: [...(updatedSections[0].tables || []), table]
      };

      onUpdateChapter({
        ...chapter,
        sections: updatedSections
      });

      toast({
        title: "Table Added",
        description: "New table has been added to the chapter",
      });
    }
  };

  const handleRemoveTable = (tableId: string) => {
    const updatedSections = chapter.sections.map(section => ({
      ...section,
      tables: section.tables.filter(t => t.id !== tableId)
    }));

    onUpdateChapter({
      ...chapter,
      sections: updatedSections
    });

    toast({
      title: "Table Removed",
      description: "Table has been removed from the chapter",
    });
  };

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between mb-4">
        <h3 className="text-lg font-medium">Tables</h3>
        <TableDialog onAddTable={handleAddTable} />
      </div>
      <div className="space-y-4">
        {chapter.sections[0]?.tables?.map((table) => (
          <div key={table.id} className="border p-4 rounded-lg group relative">
            <Button
              variant="ghost"
              size="sm"
              onClick={() => handleRemoveTable(table.id)}
              className="absolute right-2 top-2 opacity-0 group-hover:opacity-100 transition-opacity text-destructive hover:text-destructive hover:bg-destructive/10"
            >
              <Trash2 className="w-4 h-4" />
            </Button>
            <div dangerouslySetInnerHTML={{ __html: table.content }} />
          </div>
        ))}
      </div>
    </div>
  );
};

// File: src\components\editor\chapters\FootnoteManager.tsx

import React from 'react';
import { Footnote } from '@/types/thesis';

interface FootnoteManagerProps {
  thesisId: string;
  sectionId: string;
  footnotes: Footnote[];
  onUpdate: (footnotes: Footnote[]) => void;
  onAddFootnote?: (footnote: Footnote) => void;
  onRemoveFootnote?: (id: string) => void;
  onUpdateFootnote?: (footnote: Footnote) => void;
}

export const FootnoteManager: React.FC<FootnoteManagerProps> = ({
  thesisId,
  sectionId,
  footnotes,
  onUpdate,
  onAddFootnote,
  onRemoveFootnote,
  onUpdateFootnote
}) => {
  const handleAddFootnote = () => {
    const newFootnote: Footnote = {
      id: Date.now().toString(),
      thesis_id: thesisId,
      section_id: sectionId,
      content: '',
      number: (footnotes.length + 1),
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    };
    
    if (onAddFootnote) {
      onAddFootnote(newFootnote);
    } else {
      onUpdate([...footnotes, newFootnote]);
    }
  };

  const handleRemoveFootnote = (id: string) => {
    if (onRemoveFootnote) {
      onRemoveFootnote(id);
    } else {
      onUpdate(footnotes.filter(footnote => footnote.id !== id));
    }
  };

  const handleUpdateFootnote = (id: string, content: string) => {
    const updatedFootnote = footnotes.find(f => f.id === id);
    if (updatedFootnote) {
      const newFootnote = { ...updatedFootnote, content, updated_at: new Date().toISOString() };
      if (onUpdateFootnote) {
        onUpdateFootnote(newFootnote);
      } else {
        onUpdate(footnotes.map(f => f.id === id ? newFootnote : f));
      }
    }
  };

  return (
    <div>
      <h3 className="text-lg font-semibold">Footnotes</h3>
      <button onClick={handleAddFootnote} className="btn btn-primary">
        Add Footnote
      </button>
      <ul>
        {footnotes.map(footnote => (
          <li key={footnote.id} className="flex items-center">
            <input
              type="text"
              value={footnote.content}
              onChange={(e) => handleUpdateFootnote(footnote.id, e.target.value)}
              className="border p-2 rounded"
              placeholder="Footnote content"
            />
            <button onClick={() => handleRemoveFootnote(footnote.id)} className="ml-2 btn btn-danger">
              Remove
            </button>
          </li>
        ))}
      </ul>
    </div>
  );
};

// File: src\components\editor\content\EditorContent.tsx

import React from 'react';
import EditorSection from '@/components/thesis/section/EditorSection';
import { MarkdownEditor } from '@/components/MarkdownEditor';
import { Input } from '@/components/ui/input';
import { Badge } from '@/components/ui/badge';

interface EditorContentProps {
  title: string;
  content: string;
  required?: boolean;
  onTitleChange: (title: string) => void;
  onContentChange: (content: string) => void;
}

export const EditorContent: React.FC<EditorContentProps> = ({
  title,
  content,
  required,
  onTitleChange,
  onContentChange
}) => {
  const handleTitleChange = (newTitle: string) => {
    if (newTitle.trim() === '') {
      console.error('Title cannot be empty');
      return;
    }
    onTitleChange(newTitle);
  };

  const handleContentChange = (newContent: string) => {
    if (newContent.trim() === '') {
      console.error('Content cannot be empty');
      return;
    }
    onContentChange(newContent);
  };

  return (
    <div className="space-y-6">
      <div className="flex items-center gap-3">
        <Input
          value={title}
          onChange={(e) => handleTitleChange(e.target.value)}
          className="text-xl font-serif border-none bg-transparent px-0 focus-visible:ring-0 text-editor-text"
          placeholder="Section Title"
        />
        {required && (
          <Badge variant="secondary" className="bg-editor-accent/10 text-editor-accent">
            Required
          </Badge>
        )}
      </div>
      
      <MarkdownEditor
        value={content}
        onChange={handleContentChange}
        placeholder="Start writing..."
      />
    </div>
  );
};

// File: src\components\editor\figures\FigureController.tsx

import React from 'react';
import { Figure } from '@/types/thesis';
import { Card, CardContent } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { Trash2 } from 'lucide-react';

interface FigureControllerProps {
  figure: Figure;
  onUpdate: (figure: Figure) => void;
  onDelete: (id: string) => void;
}

export const FigureController: React.FC<FigureControllerProps> = ({
  figure,
  onUpdate,
  onDelete
}) => {
  const handleChange = (field: keyof Figure, value: string) => {
    onUpdate({
      ...figure,
      [field]: value
    });
  };

  return (
    <Card>
      <CardContent className="space-y-4 p-4">
        <div className="space-y-2">
          <Label>Title</Label>
          <Input
            value={figure.title}
            onChange={(e) => handleChange('title', e.target.value)}
            placeholder="Enter figure title"
          />
        </div>

        <div className="space-y-2">
          <Label>Caption</Label>
          <Input
            value={figure.caption}
            onChange={(e) => handleChange('caption', e.target.value)}
            placeholder="Enter figure caption"
          />
        </div>

        <div className="space-y-2">
          <Label>Alt Text</Label>
          <Input
            value={figure.alt_text}
            onChange={(e) => handleChange('alt_text', e.target.value)}
            placeholder="Describe the image for accessibility"
          />
        </div>

        <div className="flex justify-end">
          <Button
            variant="destructive"
            size="sm"
            onClick={() => onDelete(figure.id)}
          >
            <Trash2 className="w-4 h-4 mr-2" />
            Delete
          </Button>
        </div>
      </CardContent>
    </Card>
  );
};

// File: src\components\editor\layout\EditorLayout.tsx

import React from 'react';
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from '@/components/ui/resizable';
import { ScrollArea } from '@/components/ui/scroll-area';
import { cn } from '@/lib/utils';

interface EditorLayoutProps {
  sidebar?: React.ReactNode;
  content?: React.ReactNode;
  preview?: React.ReactNode;
  reviewPanel?: React.ReactNode;
  showPreview?: boolean;
}

export const EditorLayout = ({ 
  sidebar, 
  content, 
  preview, 
  reviewPanel,
  showPreview = false 
}: EditorLayoutProps) => {
  console.log('EditorLayout render:', { showPreview, hasPreview: !!preview });
  
  return (
    <div className="h-screen bg-background flex flex-col overflow-hidden animate-fade-in">
      <ResizablePanelGroup direction="horizontal">
        {sidebar && (
          <>
            <ResizablePanel defaultSize={20} minSize={15} maxSize={30} className="h-screen">
              <ScrollArea className="h-full">
                {sidebar}
              </ScrollArea>
            </ResizablePanel>
            <ResizableHandle withHandle />
          </>
        )}
        
        <ResizablePanel 
          defaultSize={showPreview ? 40 : 60} 
          minSize={30}
          className="h-screen"
        >
          <ScrollArea className="h-full">
            <div className="p-6">
              {content}
            </div>
          </ScrollArea>
        </ResizablePanel>

        {showPreview && preview && (
          <>
            <ResizableHandle withHandle />
            <ResizablePanel defaultSize={20} minSize={20} className="h-screen">
              <ScrollArea className="h-full">
                <div className="p-6">
                  {preview}
                </div>
              </ScrollArea>
            </ResizablePanel>
          </>
        )}

        {reviewPanel && (
          <>
            <ResizableHandle withHandle />
            <ResizablePanel defaultSize={20} minSize={15} maxSize={30} className="h-screen">
              <ScrollArea className="h-full">
                <div className="p-6">
                  {reviewPanel}
                </div>
              </ScrollArea>
            </ResizablePanel>
          </>
        )}
      </ResizablePanelGroup>
    </div>
  );
};

// File: src\components\editor\managers\FigureList.tsx

import React from 'react';
import { Figure } from '@/types/thesis';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { X, ZoomIn } from 'lucide-react';
import { Label } from '@/components/ui/label';

interface FigureListProps {
  figures: Figure[];
  onRemove: (id: string) => void;
  onUpdate: (figure: Figure) => void;
  onPreview: (imageUrl: string) => void;
}

export const FigureList = ({ figures, onRemove, onUpdate, onPreview }: FigureListProps) => {
  console.log('Rendering FigureList:', { figuresCount: figures.length });

  const handleInputChange = (
    figureId: string,
    field: 'title' | 'caption' | 'alt_text',
    value: string
  ) => {
    const figure = figures.find(f => f.id === figureId);
    if (figure) {
      console.log('Updating figure:', { figureId, field, value });
      onUpdate({
        ...figure,
        [field]: value
      });
    }
  };

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
      {figures.map((figure) => (
        <Card key={figure.id} className="border-2 border-editor-border">
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">
              {figure.label}
            </CardTitle>
            <div className="flex gap-2">
              {figure.url && (
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => onPreview(figure.url)}
                  className="h-8 w-8 p-0"
                >
                  <ZoomIn className="w-4 h-4" />
                </Button>
              )}
              <Button
                variant="ghost"
                size="sm"
                onClick={() => onRemove(figure.id)}
                className="h-8 w-8 p-0"
              >
                <X className="w-4 h-4" />
              </Button>
            </div>
          </CardHeader>
          <CardContent className="space-y-4">
            {figure.url && (
              <img
                src={figure.url}
                alt={figure.alt_text || 'Figure preview'}
                className="w-full h-32 object-contain bg-accent/10 rounded-lg"
              />
            )}
            <div className="space-y-3">
              <div className="space-y-2">
                <Label>Title</Label>
                <Input
                  placeholder="Enter title"
                  value={figure.title || ''}
                  onChange={(e) => handleInputChange(figure.id, 'title', e.target.value)}
                />
              </div>
              <div className="space-y-2">
                <Label>Caption</Label>
                <Input
                  placeholder="Enter caption"
                  value={figure.caption || ''}
                  onChange={(e) => handleInputChange(figure.id, 'caption', e.target.value)}
                />
              </div>
              <div className="space-y-2">
                <Label>Alt Text</Label>
                <Input
                  placeholder="Enter alt text"
                  value={figure.alt_text || ''}
                  onChange={(e) => handleInputChange(figure.id, 'alt_text', e.target.value)}
                />
              </div>
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  );
};

// File: src\components\editor\managers\FigureUpload.tsx

import React from 'react';
import { useDropzone } from 'react-dropzone';
import { Card } from '@/components/ui/card';
import { Upload } from 'lucide-react';

interface FigureUploadProps {
  onUpload: (file: File) => void;
  imageUrl?: string;
  altText?: string;
}

export const FigureUpload: React.FC<FigureUploadProps> = ({ onUpload, imageUrl, altText }) => {
  const { getRootProps, getInputProps } = useDropzone({
    accept: {
      'image/*': ['.png', '.jpg', '.jpeg', '.gif']
    },
    multiple: false,
    onDrop: (acceptedFiles) => {
      if (acceptedFiles && acceptedFiles.length > 0) {
        onUpload(acceptedFiles[0]);
      }
    }
  });

  return (
    <Card 
      {...getRootProps()} 
      className="relative aspect-video cursor-pointer hover:border-primary transition-colors p-4"
    >
      <input {...getInputProps()} />
      {imageUrl ? (
        <img
          src={imageUrl}
          alt={altText}
          className="object-contain w-full h-full"
        />
      ) : (
        <div className="flex flex-col items-center justify-center h-full">
          <Upload className="w-8 h-8 text-gray-400" />
          <p className="text-sm text-gray-500 mt-2">Drop image here or click to upload</p>
        </div>
      )}
    </Card>
  );
};

// File: src\components\editor\section\EditorSection.tsx

import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useToast } from '@/hooks/use-toast';
import { Card } from '@/components/ui/card';
import { MarkdownEditor } from '@/components/MarkdownEditor';
import { useThesisData } from '@/hooks/useThesisData';
import { supabase } from '@/integrations/supabase/client';
import { Section, Thesis } from '@/types/thesis';
import { Skeleton } from '@/components/ui/skeleton';
import { Button } from '@/components/ui/button';
import { ArrowLeft } from 'lucide-react';
import { EditorLayout } from '@/components/editor/layout/EditorLayout';
import { SectionHeader } from '@/components/editor/SectionHeader';

export default function SectionEditor() {
  const { thesisId, sectionId } = useParams();
  const { thesis, setThesis } = useThesisData(thesisId);
  const { toast } = useToast();
  const [isLoading, setIsLoading] = useState(true);
  const [section, setSection] = useState<Section | null>(null);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();

  // Authentication check
  useEffect(() => {
    const checkAuth = async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        navigate('/login');
        return;
      }
    };
    checkAuth();
  }, [navigate]);

  // Initial load and section finding
  useEffect(() => {
    if (!thesis || !sectionId) return;
    
    const loadSection = async () => {
      try {
        setIsLoading(true);
        console.log('Starting to load section:', { thesisId, sectionId });
        console.log('Current thesis state:', JSON.stringify(thesis, null, 2));
        
        const section = await findSection();
        if (section) {
          console.log('Successfully found/created section:', section);
          setSection(section);
        } else {
          throw new Error('Section not found and could not be created');
        }
      } catch (err) {
        console.error('Error in loadSection:', err);
        setError(err instanceof Error ? err.message : 'Failed to load section');
        toast({
          title: "Error Loading Section",
          description: err instanceof Error ? err.message : 'Failed to load section',
          variant: "destructive",
        });
      } finally {
        setIsLoading(false);
      }
    };

    loadSection();
  }, [thesis, sectionId]);

  const ensureThesisStructure = (thesis: Thesis): Thesis => {
    const baseStructure = {
      metadata: {},
      frontMatter: [],
      generalIntroduction: {
        id: 'general-introduction',
        title: 'General Introduction',
        content: '',
        type: 'general_introduction',
        required: true
      },
      chapters: [],
      generalConclusion: {
        id: 'general-conclusion',
        title: 'General Conclusion',
        content: '',
        type: 'general_conclusion',
        required: true
      },
      backMatter: []
    };

    const result = {
      ...baseStructure,
      ...thesis,
      metadata: { ...baseStructure.metadata, ...thesis.metadata },
      frontMatter: Array.isArray(thesis.frontMatter) ? thesis.frontMatter : baseStructure.frontMatter,
      generalIntroduction: thesis.generalIntroduction || baseStructure.generalIntroduction,
      chapters: Array.isArray(thesis.chapters) ? thesis.chapters : baseStructure.chapters,
      generalConclusion: thesis.generalConclusion || baseStructure.generalConclusion,
      backMatter: Array.isArray(thesis.backMatter) ? thesis.backMatter : baseStructure.backMatter
    };

    console.log('Ensured thesis structure:', JSON.stringify(result, null, 2));
    return result;
  };

  const findSection = async (): Promise<Section | null> => {
    if (!thesis || !sectionId || !thesisId) {
      console.log('Missing required parameters:', { hasThesis: !!thesis, sectionId, thesisId });
      return null;
    }

    // Look for existing section first
    const existingSection = findExistingSection(thesis, sectionId);
    if (existingSection) {
      console.log('Found existing section:', existingSection);
      return existingSection;
    }

    // If not found, ensure thesis structure and create new section
    try {
      const completeThesis = ensureThesisStructure(thesis);
      
      // Update thesis with complete structure
      console.log('Updating thesis with complete structure...');
      const { error: updateError } = await supabase
        .from('theses')
        .update({ 
          content: completeThesis,
          updated_at: new Date().toISOString()
        })
        .eq('id', thesisId);

      if (updateError) {
        console.error('Error updating thesis structure:', updateError);
        throw updateError;
      }

      // Create new section
      console.log('Creating new section...');
      const { data: newSectionId, error: createError } = await supabase.rpc(
        'create_section_if_not_exists',
        { 
          p_thesis_id: thesisId,
          p_section_title: 'New Section',
          p_section_type: 'custom'
        }
      );

      if (createError) {
        console.error('Error creating new section:', createError);
        throw createError;
      }

      // Fetch updated thesis
      console.log('Fetching updated thesis...');
      const { data: refreshedThesis, error: refreshError } = await supabase
        .from('theses')
        .select('*')
        .eq('id', thesisId)
        .single();

      if (refreshError) throw refreshError;

      if (!refreshedThesis) {
        throw new Error('Failed to fetch updated thesis');
      }

      const content = typeof refreshedThesis.content === 'string' 
        ? JSON.parse(refreshedThesis.content) 
        : refreshedThesis.content;

      const newSection = findExistingSection(content, newSectionId);
      if (!newSection) {
        throw new Error('New section not found in updated thesis');
      }

      return newSection;
    } catch (err) {
      console.error('Error in section creation process:', err);
      throw new Error(`Failed to create new section: ${err.message}`);
    }
  };

  const findExistingSection = (thesis: Thesis, targetId: string): Section | null => {
    // Check special sections
    if (thesis.generalIntroduction?.id === targetId) return thesis.generalIntroduction;
    if (thesis.generalConclusion?.id === targetId) return thesis.generalConclusion;

    // Check front matter
    const frontMatterSection = thesis.frontMatter?.find(s => s.id === targetId);
    if (frontMatterSection) return frontMatterSection;

    // Check back matter
    const backMatterSection = thesis.backMatter?.find(s => s.id === targetId);
    if (backMatterSection) return backMatterSection;

    // Check chapters
    for (const chapter of thesis.chapters || []) {
      const chapterSection = chapter.sections.find(s => s.id === targetId);
      if (chapterSection) return chapterSection;
    }

    return null;
  };

  const handleContentChange = async (newContent: string) => {
    if (!thesis || !section || !thesisId) return;

    try {
      console.log('Handling content change...');
      const updatedThesis = { ...thesis };

      // Update the appropriate section
      if (section.type === 'general_introduction') {
        updatedThesis.generalIntroduction = {
          ...updatedThesis.generalIntroduction,
          content: newContent
        };
      } else if (section.type === 'general_conclusion') {
        updatedThesis.generalConclusion = {
          ...updatedThesis.generalConclusion,
          content: newContent
        };
      } else {
        // Update in front/back matter or chapters
        const frontMatterIndex = thesis.frontMatter?.findIndex(s => s.id === section.id) ?? -1;
        if (frontMatterIndex !== -1) {
          updatedThesis.frontMatter[frontMatterIndex] = {
            ...thesis.frontMatter[frontMatterIndex],
            content: newContent
          };
        } else {
          updatedThesis.chapters = (thesis.chapters || []).map(chapter => ({
            ...chapter,
            sections: chapter.sections.map(s => 
              s.id === section.id ? { ...s, content: newContent } : s
            )
          }));
        }
      }

      // Ensure complete structure before saving
      const completeThesis = ensureThesisStructure(updatedThesis);

      console.log('Saving updated thesis...');
      const { error } = await supabase
        .from('theses')
        .update({ 
          content: completeThesis,
          updated_at: new Date().toISOString()
        })
        .eq('id', thesisId);

      if (error) throw error;

      setThesis(completeThesis);
      setSection({ ...section, content: newContent });

      toast({
        title: "Success",
        description: "Content updated successfully",
      });
    } catch (err) {
      console.error('Error updating content:', err);
      toast({
        title: "Error",
        description: "Failed to update content. Please try again.",
        variant: "destructive",
      });
    }
  };

  return (
    <EditorLayout
      sidebar={
        <div className="p-4 space-y-4">
          <Button
            variant="ghost"
            className="w-full justify-start"
            onClick={() => navigate(`/thesis/${thesisId}`)}
          >
            <ArrowLeft className="mr-2 h-4 w-4" />
            Back to Thesis
          </Button>
        </div>
      }
      content={
        <div className="container mx-auto p-8">
          {isLoading ? (
            <>
              <Skeleton className="h-8 w-64 mb-6" />
              <Skeleton className="h-[500px] w-full" />
            </>
          ) : error ? (
            <Card className="p-6">
              <h1 className="text-2xl font-bold text-destructive">Error</h1>
              <p className="mt-4 text-muted-foreground">{error}</p>
            </Card>
          ) : !section ? (
            <Card className="p-6">
              <h1 className="text-2xl font-bold text-destructive">Section not found</h1>
              <p className="mt-4 text-muted-foreground">
                The requested section could not be found. Please check the URL and try again.
              </p>
            </Card>
          ) : (
            <Card className="p-6">
              <SectionHeader 
                title={section.title} 
                onTitleChange={(newTitle) => {
                  setSection({ ...section, title: newTitle });
                }}
                required={section.required}
              />
              <div className="mt-6">
                <MarkdownEditor
                  value={section.content}
                  onChange={handleContentChange}
                  placeholder="Start writing your section content..."
                />
              </div>
            </Card>
          )}
        </div>
      }
    />
  );
}

// File: src\components\editor\SectionContent.tsx

import React from 'react';
import { MarkdownEditor } from '../MarkdownEditor';

interface SectionContentProps {
  content: string;
  onContentChange: (content: string) => void;
}

export const SectionContent = ({ content, onContentChange }: SectionContentProps) => {
  console.log('Rendering SectionContent:', { contentLength: content?.length });
  
  const handleContentChange = (newContent: string) => {
    console.log('Content changed:', newContent);
    onContentChange(newContent);
  };
  
  return (
    <div className="editor-content">
      <MarkdownEditor
        value={content}
        onChange={handleContentChange}
        placeholder="Start writing..."
      />
    </div>
  );
};

// File: src\components\editor\SectionHeader.tsx

import React from 'react';
import { Input } from '@/components/ui/input';
import { Badge } from '@/components/ui/badge';

interface SectionHeaderProps {
  title: string;
  required?: boolean;
  onTitleChange: (title: string) => void;
}

export const SectionHeader = ({ title, required, onTitleChange }: SectionHeaderProps) => {
  console.log('Rendering SectionHeader:', { title, required });
  
  return (
    <div className="editor-header">
      <div className="flex items-center gap-3">
        <Input
          value={title}
          onChange={(e) => onTitleChange(e.target.value)}
          className="text-xl font-serif border-none bg-transparent px-0 focus-visible:ring-0 
                     text-editor-text placeholder:text-editor-placeholder"
          placeholder="Section Title"
        />
        {required && (
          <Badge variant="secondary" className="bg-editor-accent/10 text-editor-accent">
            Required
          </Badge>
        )}
      </div>
    </div>
  );
};

// File: src\components\editor\SectionManagers.tsx

import React from 'react';
import { Section } from '@/types/thesis';
import { FigureManager } from '../FigureManager';
import { TableManager } from '../TableManager';
import { CitationManager } from '../CitationManager';
import { ReferenceManager } from '../ReferenceManager';
import { Image, Table, Quote, BookOpen } from 'lucide-react';

interface SectionManagersProps {
  section: Section;
  onSectionUpdate: (updatedSection: Section) => void;
}

export const SectionManagers = ({ section, onSectionUpdate }: SectionManagersProps) => {
  console.log('Rendering SectionManagers:', { 
    sectionId: section.id,
    figuresCount: section.figures?.length,
    tablesCount: section.tables?.length,
    citationsCount: section.citations?.length
  });

  // Validate section structure
  if (!section || typeof section !== 'object') {
    console.error('Invalid section object:', section);
    return null;
  }
  if (!Array.isArray(section.figures)) {
    console.error('Invalid figures structure in section:', section);
    return null;
  }
  if (!Array.isArray(section.tables)) {
    console.error('Invalid tables structure in section:', section);
    return null;
  }
  if (!Array.isArray(section.citations)) {
    console.error('Invalid citations structure in section:', section);
    return null;
  }
  if (!Array.isArray(section.references)) {
    console.error('Invalid references structure in section:', section);
    return null;
  }

  const handleFigureUpdate = (figures: Section['figures']) => {
    console.log('Updating figures:', figures);
    try {
      onSectionUpdate({
        ...section,
        figures
      });
    } catch (error) {
      console.error('Error updating figures:', error);
      alert('Failed to update figures: ' + error.message);
    }
  };

  const handleTableUpdate = (tables: Section['tables']) => {
    console.log('Updating tables:', tables);
    try {
      onSectionUpdate({
        ...section,
        tables
      });
    } catch (error) {
      console.error('Error updating tables:', error);
      alert('Failed to update tables: ' + error.message);
    }
  };

  const handleCitationUpdate = (citations: Section['citations']) => {
    console.log('Updating citations:', citations);
    try {
      onSectionUpdate({
        ...section,
        citations
      });
    } catch (error) {
      console.error('Error updating citations:', error);
      alert('Failed to update citations: ' + error.message);
    }
  };

  const handleReferenceUpdate = (references: Section['references']) => {
    console.log('Updating references:', references);
    try {
      onSectionUpdate({
        ...section,
        references
      });
    } catch (error) {
      console.error('Error updating references:', error);
      alert('Failed to update references: ' + error.message);
    }
  };

  return (
    <div className="space-y-8 pt-4">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div className="p-6 rounded-lg border-2 transition-all duration-200 hover:shadow-lg
          bg-editor-manager-figure-bg border-editor-manager-figure-border">
          <div className="flex items-center gap-3 mb-4">
            <div className="p-2 rounded-full bg-white">
              <Image className="w-5 h-5 text-editor-manager-figure-icon" />
            </div>
            <h3 className="text-lg font-serif font-medium">Figures</h3>
          </div>
          <FigureManager
            figures={section.figures}
            onAddFigure={(figure) => handleFigureUpdate([...section.figures, figure])}
            onRemoveFigure={(id) => handleFigureUpdate(section.figures.filter(f => f.id !== id))}
            onUpdateFigure={(figure) => handleFigureUpdate(section.figures.map(f => f.id === figure.id ? figure : f))}
          />
        </div>

        <div className="p-6 rounded-lg border-2 transition-all duration-200 hover:shadow-lg
          bg-editor-manager-table-bg border-editor-manager-table-border">
          <div className="flex items-center gap-3 mb-4">
            <div className="p-2 rounded-full bg-white">
              <Table className="w-5 h-5 text-editor-manager-table-icon" />
            </div>
            <h3 className="text-lg font-serif font-medium">Tables</h3>
          </div>
          <TableManager
            tables={section.tables}
            onAddTable={(table) => handleTableUpdate([...section.tables, table])}
            onRemoveTable={(id) => handleTableUpdate(section.tables.filter(t => t.id !== id))}
            onUpdateTable={(table) => handleTableUpdate(section.tables.map(t => t.id === table.id ? table : t))}
          />
        </div>

        <div className="p-6 rounded-lg border-2 transition-all duration-200 hover:shadow-lg
          bg-editor-manager-citation-bg border-editor-manager-citation-border">
          <div className="flex items-center gap-3 mb-4">
            <div className="p-2 rounded-full bg-white">
              <Quote className="w-5 h-5 text-editor-manager-citation-icon" />
            </div>
            <h3 className="text-lg font-serif font-medium">Citations</h3>
          </div>
          <CitationManager
            citations={section.citations}
            onCitationCreate={(citation) => handleCitationUpdate([...section.citations, citation])}
            onCitationUpdate={(citation) => handleCitationUpdate(section.citations.map(c => c.id === citation.id ? citation : c))}
            onCitationDelete={(citation) => handleCitationUpdate(section.citations.filter(c => c.id !== citation.id))}
            thesisId={section.id}
          />
        </div>

        {section.type === 'references' && (
          <div className="p-6 rounded-lg border-2 transition-all duration-200 hover:shadow-lg
            bg-editor-manager-reference-bg border-editor-manager-reference-border">
            <div className="flex items-center gap-3 mb-4">
              <div className="p-2 rounded-full bg-white">
                <BookOpen className="w-5 h-5 text-editor-manager-reference-icon" />
              </div>
              <h3 className="text-lg font-serif font-medium">References</h3>
            </div>
            <ReferenceManager
              items={section.references || []}
              onAdd={(reference) => handleReferenceUpdate([...(section.references || []), reference])}
              onRemove={(id) => handleReferenceUpdate((section.references || []).filter(r => r.id !== id))}
              onUpdate={(reference) => handleReferenceUpdate((section.references || []).map(r => r.id === reference.id ? reference : r))}
            />
          </div>
        )}
      </div>
    </div>
  );
};


// File: src\components\editor\sections\GeneralSectionEditor.tsx

import React from 'react';
import { Section, StructuredContent } from '@/types/thesis';
import { Card } from '@/components/ui/card';
import { MarkdownEditor } from '@/components/MarkdownEditor';
import { Input } from '@/components/ui/input';

interface GeneralSectionEditorProps {
  section: Section;
  title: string;
  onUpdate: (section: Section) => void;
}

export const GeneralSectionEditor: React.FC<GeneralSectionEditorProps> = ({
  section,
  title,
  onUpdate,
}) => {
  console.log('GeneralSectionEditor rendering:', { title, section });

  const handleContentChange = (value: string) => {
    const newContent: StructuredContent[] = [{
      type: 'paragraph',
      content: value || '',
      metadata: {}
    }];

    onUpdate({
      ...section,
      content: newContent
    });
  };

  const getContentValue = () => {
    if (!section.content) return '';
    if (Array.isArray(section.content)) {
      return section.content.map(item => item.content).join('\n\n');
    }
    return section.content;
  };
  
  return (
    <Card className="p-6 space-y-4">
      <div className="space-y-2">
        <Input
          value={section.title || title}
          onChange={(e) => onUpdate({ ...section, title: e.target.value })}
          className="text-xl font-serif"
          placeholder={title}
        />
      </div>
      
      <MarkdownEditor
        value={getContentValue()}
        onChange={handleContentChange}
        placeholder={`Write your ${title.toLowerCase()} here...`}
      />
    </Card>
  );
};

// File: src\components\editor\sections\SectionItem.tsx

import React from 'react';
import { Section } from '@/types/thesis';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { FileText, GripVertical } from 'lucide-react';
import { cn } from '@/lib/utils';

interface SectionItemProps {
  section: Section;
  sectionNumber: number;
  onUpdateSection: (updatedSection: Section) => void;
}

export const SectionItem: React.FC<SectionItemProps> = ({
  section,
  sectionNumber,
  onUpdateSection,
}) => {
  return (
    <div className={cn(
      "border rounded-lg p-4 space-y-4 bg-gray-50/50 mb-4",
      "hover:shadow-sm transition-all duration-200",
      "group"
    )}>
      <div className="flex items-center gap-3">
        <div className="p-2 bg-white rounded-lg group-hover:bg-gray-100 transition-colors">
          <GripVertical className="w-4 h-4 text-gray-500" />
        </div>
        <div className="flex items-center gap-2 flex-1">
          <div className="bg-gray-200 text-gray-700 font-medium px-2 py-1 rounded text-sm">
            {sectionNumber}
          </div>
          <Input
            value={section.title}
            onChange={(e) => onUpdateSection({ ...section, title: e.target.value })}
            className="text-lg font-medium bg-transparent border-none focus-visible:ring-1 focus-visible:ring-primary/20 px-2"
            placeholder="Section Title"
          />
        </div>
      </div>

      <Textarea
        value={section.content}
        onChange={(e) => onUpdateSection({ ...section, content: e.target.value })}
        className="min-h-[100px] bg-white border focus-visible:ring-1 focus-visible:ring-primary/20"
        placeholder="Start writing your section content..."
      />

      <div className="flex items-center gap-2 text-sm text-gray-500">
        <FileText className="w-4 h-4" />
        <span>{section.content.length} characters</span>
      </div>
    </div>
  );
};

// File: src\components\EditorSection.tsx

import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { Section } from '@/types/thesis';
import { useToast } from '@/hooks/use-toast';
import { SectionHeader } from './editor/SectionHeader';
import { SectionContent } from './editor/SectionContent';
import { SectionManagers } from './editor/SectionManagers';
import { SectionProps } from '@/types/components';
import { Button } from './ui/button';
import { Plus, ChevronDown, ChevronRight, Edit, Settings } from 'lucide-react';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
  DropdownMenuSeparator,
} from './ui/dropdown-menu';
import { Card } from './ui/card';
import { cn } from '@/lib/utils';
import { Input } from './ui/input';

export const EditorSection: React.FC<SectionProps> = ({
  section,
  isActive,
  onContentChange,
  onTitleChange
}) => {
  const { toast } = useToast();
  const [isEditing, setIsEditing] = useState(false);
  const navigate = useNavigate();
  
  console.log('EditorSection rendering with section:', { 
    id: section.id, 
    title: section.title,
    isActive 
  });

  if (!isActive) return null;

  const handleSectionUpdate = (updatedSection: Section) => {
    console.log('Updating section:', updatedSection);
    try {
      onContentChange(updatedSection.id, updatedSection.content);
      toast({
        title: "Success",
        description: "Section updated successfully",
      });
    } catch (error) {
      console.error('Error updating section:', error);
      toast({
        title: "Error",
        description: "Failed to update section",
      });
    }
  };

  const handleAddSection = (sectionType: string) => {
    const newSection: Section = {
      id: crypto.randomUUID(),
      title: sectionType,
      content: '',
      type: sectionType.toLowerCase().replace(/ /g, '_'),
      order: 0,
      figures: [],
      tables: [],
      citations: [],
      required: sectionType === 'General Introduction' || sectionType === 'General Conclusion',
      references: []
    };

    handleSectionUpdate(newSection);
    toast({
      title: "Section Added",
      description: `Added new ${sectionType} section`,
    });
  };

  const handleAddCustomSection = () => {
    const newSection: Section = {
      id: crypto.randomUUID(),
      title: 'Custom Section',
      content: '',
      type: 'custom',
      order: 0,
      figures: [],
      tables: [],
      citations: [],
      required: false,
      references: []
    };

    handleSectionUpdate(newSection);
    toast({
      title: "Success",
      description: `Added new custom section`,
    });
  };

  // Create a complete Section object from the minimal section data
  const fullSection: Section = {
    id: section.id,
    title: section.title,
    content: section.content,
    type: section.type || 'custom',
    order: section.order || 0,
    figures: section.figures || [],
    tables: section.tables || [],
    citations: section.citations || [],
    required: section.required || false,
    references: section.references || []
  };

  const navigateToEditor = () => {
    const thesisId = window.location.pathname.split('/')[2];
    navigate(`/thesis/${thesisId}/sections/${section.id}`);
  };

  return (
    <div className="editor-section space-y-4">
      <div className="flex justify-between items-center mb-4">
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="outline" className="ml-2">
              <Plus className="h-4 w-4 mr-2" />
              Add Section
              <ChevronDown className="h-4 w-4 ml-2" />
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end" className="w-56">
            <DropdownMenuItem onClick={() => handleAddSection('Thesis Structure Overview')}>
              Thesis Structure Overview
            </DropdownMenuItem>
            <DropdownMenuItem onClick={() => handleAddSection('Abstract')}>
              Abstract
            </DropdownMenuItem>
            <DropdownMenuItem onClick={() => handleAddSection('Acknowledgements')}>
              Acknowledgements
            </DropdownMenuItem>
            <DropdownMenuItem onClick={() => handleAddSection('Chapter')}>
              New Chapter
            </DropdownMenuItem>
            <DropdownMenuSeparator />
            <DropdownMenuItem onClick={handleAddCustomSection}>
              <Settings className="h-4 w-4 mr-2" />
              Custom Section
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      </div>

      <Card 
        className={cn(
          "p-6 cursor-pointer transition-all duration-200",
          "hover:shadow-md",
          isEditing && "ring-2 ring-primary"
        )}
      >
        <div className="flex items-center justify-between">
          <SectionHeader
            title={fullSection.title}
            required={fullSection.required}
            onTitleChange={(title) => onTitleChange(fullSection.id, title)}
          />
          <div className="flex items-center gap-2">
            <Button
              variant="ghost"
              size="sm"
              onClick={(e) => {
                e.stopPropagation();
                setIsEditing(!isEditing);
              }}
            >
              {isEditing ? (
                <ChevronDown className="h-4 w-4" />
              ) : (
                <ChevronRight className="h-4 w-4" />
              )}
            </Button>
            <Button
              variant="outline"
              size="sm"
              onClick={navigateToEditor}
              className="flex items-center gap-2"
            >
              <Edit className="h-4 w-4" />
              Edit in Full Page
            </Button>
          </div>
        </div>

        {isEditing && (
          <div className="mt-4 space-y-6">
            <SectionContent
              content={fullSection.content}
              onContentChange={(content) => onContentChange(fullSection.id, content)}
            />
            <SectionManagers
              section={fullSection}
              onSectionUpdate={handleSectionUpdate}
            />
          </div>
        )}
      </Card>
    </div>
  );
};

// File: src\components\error\ErrorState.tsx

import React from 'react';
import { Button } from '@/components/ui/button';
import { AlertCircle } from 'lucide-react';

export interface ErrorStateProps {
  error: string;
  onRetry?: () => void;
}

export const ErrorState = ({ error, onRetry }: ErrorStateProps) => {
  return (
    <div className="flex flex-col items-center justify-center p-8 space-y-4">
      <AlertCircle className="w-12 h-12 text-destructive" />
      <h3 className="text-lg font-medium">Something went wrong</h3>
      <p className="text-sm text-muted-foreground">{error}</p>
      {onRetry && (
        <Button onClick={onRetry} variant="outline">
          Try again
        </Button>
      )}
    </div>
  );
};

// File: src\components\ErrorBoundary.tsx

import React from 'react';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/hooks/use-toast';
import { Button } from './ui/button';
import { AlertCircle, RefreshCw, ArrowLeft } from 'lucide-react';
import { Alert, AlertDescription, AlertTitle } from './ui/alert';

interface Props {
  children: React.ReactNode;
}

interface State {
  hasError: boolean;
  error: Error | null;
  errorInfo: React.ErrorInfo | null;
  retryCount: number;
}

class ErrorBoundary extends React.Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { 
      hasError: false, 
      error: null,
      errorInfo: null,
      retryCount: 0
    };
  }

  static getDerivedStateFromError(error: Error) {
    return { hasError: true, error };
  }

  async componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error('Error caught by boundary:', error);
    this.setState({ errorInfo });
    
    try {
      // Check if it's an auth error
      const isAuthError = error.message.includes('auth/v1/user') || 
                         error.message.includes('auth/v1/token');

      if (isAuthError) {
        console.log('Auth error detected, attempting to refresh session...');
        const { data: { session }, error: refreshError } = await supabase.auth.getSession();
        
        if (refreshError) {
          console.error('Session refresh failed:', refreshError);
          // Redirect to auth page if session refresh fails
          window.location.href = '/auth';
          return;
        }

        if (!session) {
          console.log('No valid session found, redirecting to auth...');
          window.location.href = '/auth';
          return;
        }
      }

      const { data: { user } } = await supabase.auth.getUser();
      
      // Only log to database if it's not a network error and we have a user
      if (!(error instanceof TypeError && error.message === 'Failed to fetch') && user) {
        const browserInfo = {
          userAgent: navigator.userAgent,
          platform: navigator.platform,
          language: navigator.language,
          url: window.location.href,
          timestamp: new Date().toISOString()
        };

        const { error: dbError } = await supabase
          .from('app_issues')
          .insert([
            {
              user_id: user.id,
              error_message: error.message,
              error_stack: error.stack,
              component_name: errorInfo.componentStack,
              route_path: window.location.pathname,
              browser_info: JSON.stringify(browserInfo),
            },
          ]);

        if (dbError) {
          console.error('Error saving issue:', dbError);
        }
      }
    } catch (err) {
      console.error('Error in error boundary:', err);
    }
  }

  handleRetry = async () => {
    console.log('Attempting retry...');
    this.setState(prev => ({ retryCount: prev.retryCount + 1 }));
    
    try {
      // Check session and refresh if needed
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      
      if (sessionError) {
        console.error('Session check failed:', sessionError);
        window.location.href = '/auth';
        return;
      }

      if (!session) {
        console.log('No valid session, redirecting to auth...');
        window.location.href = '/auth';
        return;
      }

      // If we have a valid session, reload the page
      window.location.reload();
    } catch (error) {
      console.error('Retry failed:', error);
      window.location.href = '/auth';
    }
  };

  handleGoBack = () => {
    window.history.back();
  };

  render() {
    if (this.state.hasError) {
      const isNetworkError = this.state.error instanceof TypeError && 
                            this.state.error.message === 'Failed to fetch';
      
      const isAuthError = this.state.error?.message.includes('auth/v1/user') ||
                         this.state.error?.message.includes('auth/v1/token');

      return (
        <div className="min-h-screen flex items-center justify-center bg-background p-4">
          <div className="w-full max-w-md space-y-4">
            <Alert variant="destructive">
              <AlertCircle className="h-4 w-4" />
              <AlertTitle>
                {isAuthError ? 'Authentication Error' : 
                 isNetworkError ? 'Connection Error' : 
                 'Something went wrong'}
              </AlertTitle>
              <AlertDescription className="mt-2">
                {isAuthError ? 'Please sign in again to continue.' :
                 isNetworkError ? 'Unable to connect to the server. Please check your internet connection and try again.' :
                 "We've encountered an unexpected error and our team has been notified."}
              </AlertDescription>
            </Alert>
            
            <div className="flex gap-2 justify-end">
              <Button
                variant="outline"
                onClick={this.handleGoBack}
                className="gap-2"
              >
                <ArrowLeft className="h-4 w-4" />
                Go Back
              </Button>
              <Button
                variant="default"
                onClick={this.handleRetry}
                className="gap-2"
              >
                <RefreshCw className="h-4 w-4" />
                {isAuthError ? 'Sign In' : 'Try Again'}
              </Button>
            </div>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}

export default ErrorBoundary;

// File: src\components\FigureManager.tsx

import React, { useState } from 'react';
import { Figure } from '@/types/thesis';
import { Button } from '@/components/ui/button';
import { PlusCircle, Image as ImageIcon } from 'lucide-react';
import { FigureController } from './editor/figures/FigureController';
import { FigureUpload } from './editor/managers/FigureUpload';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { useToast } from '@/hooks/use-toast';
import { motion, AnimatePresence } from 'framer-motion';
import { Card } from './ui/card';
import { ScrollArea } from './ui/scroll-area';

interface FigureManagerProps {
  figures: Figure[];
  onAddFigure: (figure: Figure) => void;
  onRemoveFigure: (id: string) => void;
  onUpdateFigure: (figure: Figure) => void;
}

export const FigureManager = ({
  figures,
  onAddFigure,
  onRemoveFigure,
  onUpdateFigure
}: FigureManagerProps) => {
  const [isAddingFigure, setIsAddingFigure] = useState(false);
  const [selectedFigure, setSelectedFigure] = useState<Figure | null>(null);
  const { toast } = useToast();

  const handleFileUpload = async (file: File) => {
    try {
      const reader = new FileReader();
      reader.onloadend = () => {
        const imageUrl = reader.result as string;
        
        const img = new Image();
        img.onload = () => {
          const newFigure: Figure = {
            id: Date.now().toString(),
            url: imageUrl,
            title: '',
            caption: '',
            alt_text: '',
            label: `Figure ${(figures?.length || 0) + 1}`,
            dimensions: {
              width: img.width,
              height: img.height
            },
            position: 'inline'
          };
          
          onAddFigure(newFigure);
          setIsAddingFigure(false);
          
          toast({
            title: "Figure Added",
            description: "New figure has been added successfully.",
          });
        };
        img.src = imageUrl;
      };
      reader.readAsDataURL(file);
    } catch (error) {
      console.error('Error uploading figure:', error);
      toast({
        title: "Error",
        description: "Failed to add figure. Please try again.",
        variant: "destructive",
      });
    }
  };

  return (
    <Card className="p-6 space-y-6 bg-white/50 backdrop-blur-sm border-2 border-primary/10 shadow-xl rounded-xl">
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.3 }}
        className="flex justify-between items-center"
      >
        <div className="flex items-center gap-3">
          <div className="p-2 bg-primary/10 rounded-full">
            <ImageIcon className="w-5 h-5 text-primary" />
          </div>
          <h3 className="text-lg font-serif font-medium text-primary">Figures</h3>
        </div>
        <Button
          onClick={() => setIsAddingFigure(true)} 
          variant="outline" 
          size="sm"
          className="gap-2 hover:bg-primary/10 transition-colors"
        >
          <PlusCircle className="w-4 h-4" />
          Add Figure
        </Button>
      </motion.div>

      <Dialog open={isAddingFigure} onOpenChange={setIsAddingFigure}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Add Figure</DialogTitle>
          </DialogHeader>
          <motion.div
            initial={{ opacity: 0, scale: 0.95 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ duration: 0.2 }}
          >
            <FigureUpload
              onUpload={handleFileUpload}
              imageUrl={selectedFigure?.url}
              altText="Preview"
            />
          </motion.div>
        </DialogContent>
      </Dialog>

      <ScrollArea className="h-[600px] pr-4">
        <AnimatePresence mode="wait">
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ delay: 0.2 }}
            className="space-y-6"
          >
            {figures?.map((figure) => (
              <motion.div
                key={figure.id}
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -20 }}
                transition={{ duration: 0.2 }}
              >
                <FigureController
                  figure={figure}
                  onUpdate={onUpdateFigure}
                  onDelete={onRemoveFigure}
                />
              </motion.div>
            ))}
          </motion.div>
        </AnimatePresence>
      </ScrollArea>
    </Card>
  );
};

// File: src\components\landing\DemoPreview.tsx

import React from "react";
import { motion } from "framer-motion";
import { Edit3, Users, GitBranch, FileCheck } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Link } from "react-router-dom";

export const DemoPreview = () => {
  const features = [
    {
      icon: Edit3,
      title: "Smart Editor",
      description: "Write and format your thesis with our intelligent editor"
    },
    {
      icon: Users,
      title: "Real-time Collaboration",
      description: "Work together with advisors and peers seamlessly"
    },
    {
      icon: GitBranch,
      title: "Version Control",
      description: "Track changes and manage different versions effortlessly"
    },
    {
      icon: FileCheck,
      title: "Export Options",
      description: "Export your thesis in multiple formats including DOCX and PDF"
    }
  ];

  return (
    <section className="py-20 bg-gradient-to-b from-white to-gray-50">
      <div className="max-w-7xl mx-auto px-4">
        <div className="text-center mb-12">
          <motion.h2 
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="text-3xl font-bold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-admin-accent-primary to-admin-accent-secondary"
          >
            See How It Works
          </motion.h2>
          <p className="text-gray-600 max-w-2xl mx-auto">
            Experience the power of our thesis writing platform through this interactive demo
          </p>
        </div>
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
          <div className="bg-gradient-to-b from-white to-gray-50 p-8 rounded-xl shadow-lg">
            <div className="aspect-video bg-gray-100 rounded-lg mb-6 overflow-hidden">
              <img 
                src="/placeholder.svg" 
                alt="Editor Demo" 
                className="w-full h-full object-cover"
              />
            </div>
            <Link to="/auth">
              <Button className="w-full bg-gradient-to-r from-admin-accent-primary to-admin-accent-secondary hover:opacity-90 text-white">
                Try the Editor
              </Button>
            </Link>
          </div>
          
          <div className="grid grid-cols-1 gap-6">
            {features.map((feature, index) => (
              <motion.div
                key={feature.title}
                initial={{ opacity: 0, x: 20 }}
                animate={{ opacity: 1, x: 0 }}
                transition={{ delay: index * 0.1 }}
                className="flex items-start gap-4 p-6 bg-gradient-to-b from-white to-gray-50 rounded-lg shadow-sm hover:shadow-md transition-all"
              >
                <div className="p-2 bg-admin-accent-primary/10 rounded-lg">
                  <feature.icon className="w-6 h-6 text-admin-accent-primary" />
                </div>
                <div>
                  <h3 className="font-semibold mb-1 text-admin-accent-primary">{feature.title}</h3>
                  <p className="text-sm text-gray-600">{feature.description}</p>
                </div>
              </motion.div>
            ))}
          </div>
        </div>
      </div>
    </section>
  );
};

// File: src\components\landing\FeatureCard.tsx

import React from "react";

interface FeatureCardProps {
  title: string;
  description: string;
  icon: React.ElementType;
}

export const FeatureCard = ({ title, description, icon: Icon }: FeatureCardProps) => (
  <div className="p-6 bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow">
    <div className="w-12 h-12 bg-[#F1F0FB] rounded-lg flex items-center justify-center mb-4">
      <Icon className="w-6 h-6 text-[#9b87f5]" />
    </div>
    <h3 className="text-xl font-semibold mb-2">{title}</h3>
    <p className="text-gray-600">{description}</p>
  </div>
);

// File: src\components\landing\FeaturesComparison.tsx

import React from "react";
import { Check, Star } from "lucide-react";
import { motion } from "framer-motion";

interface Feature {
  name: string;
  free: boolean;
  pro: boolean;
  enterprise: boolean;
}

export const FeaturesComparison = () => {
  const features: Feature[] = [
    {
      name: "Basic Thesis Editor",
      free: true,
      pro: true,
      enterprise: true,
    },
    {
      name: "Real-time Collaboration",
      free: false,
      pro: true,
      enterprise: true,
    },
    {
      name: "Version Control",
      free: false,
      pro: true,
      enterprise: true,
    },
    {
      name: "Export to PDF/DOCX",
      free: true,
      pro: true,
      enterprise: true,
    },
    {
      name: "Citation Management",
      free: false,
      pro: true,
      enterprise: true,
    },
    {
      name: "AI Writing Assistant",
      free: false,
      pro: true,
      enterprise: true,
    },
    {
      name: "Priority Support",
      free: false,
      pro: false,
      enterprise: true,
    },
    {
      name: "Custom Templates",
      free: false,
      pro: false,
      enterprise: true,
    },
  ];

  return (
    <section className="py-20 bg-white">
      <div className="max-w-7xl mx-auto px-4">
        <div className="text-center mb-12">
          <motion.h2
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="text-3xl font-bold mb-4"
          >
            Choose Your Plan
          </motion.h2>
          <p className="text-gray-600 max-w-2xl mx-auto">
            Select the perfect plan for your thesis writing journey
          </p>
        </div>

        <div className="overflow-x-auto">
          <table className="w-full border-collapse">
            <thead>
              <tr className="border-b">
                <th className="p-4 text-left">Features</th>
                <th className="p-4 text-center">
                  <div className="font-semibold mb-1">Free</div>
                  <div className="text-sm text-gray-500">0 DZD/month</div>
                </th>
                <th className="p-4 text-center bg-primary/5">
                  <div className="font-semibold mb-1 flex items-center justify-center gap-1">
                    Pro <Star className="w-4 h-4 text-primary" />
                  </div>
                  <div className="text-sm text-gray-500">3,900 DZD/month</div>
                </th>
                <th className="p-4 text-center">
                  <div className="font-semibold mb-1">Enterprise</div>
                  <div className="text-sm text-gray-500">Custom pricing</div>
                </th>
              </tr>
            </thead>
            <tbody>
              {features.map((feature, index) => (
                <motion.tr
                  key={feature.name}
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ delay: index * 0.1 }}
                  className="border-b hover:bg-gray-50"
                >
                  <td className="p-4">{feature.name}</td>
                  <td className="p-4 text-center">
                    {feature.free && <Check className="w-5 h-5 text-green-500 mx-auto" />}
                  </td>
                  <td className="p-4 text-center bg-primary/5">
                    {feature.pro && <Check className="w-5 h-5 text-green-500 mx-auto" />}
                  </td>
                  <td className="p-4 text-center">
                    {feature.enterprise && <Check className="w-5 h-5 text-green-500 mx-auto" />}
                  </td>
                </motion.tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </section>
  );
};

// File: src\components\landing\FeaturesSection.tsx

import React from "react";
import { motion } from "framer-motion";
import { BookOpen, Users, Shield, Rocket } from "lucide-react";
import { useTranslation } from "@/hooks/useTranslation";

export const FeaturesSection = () => {
  const { t } = useTranslation();

  const features = [
    {
      icon: BookOpen,
      title: t('landing.features.smartEditor.title'),
      description: t('landing.features.smartEditor.description')
    },
    {
      icon: Users,
      title: t('landing.features.collaboration.title'),
      description: t('landing.features.collaboration.description')
    },
    {
      icon: Shield,
      title: t('landing.features.versionControl.title'),
      description: t('landing.features.versionControl.description')
    },
    {
      icon: Rocket,
      title: t('landing.features.aiPowered.title'),
      description: t('landing.features.aiPowered.description')
    }
  ];

  return (
    <section id="features" className="py-20 bg-[#1A1F2C]">
      <div className="max-w-7xl mx-auto px-4">
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          whileInView={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.6 }}
          viewport={{ once: true }}
          className="text-center mb-16"
        >
          <h2 className="text-3xl font-bold text-white mb-4">
            {t('landing.features.title')}
          </h2>
          <p className="text-gray-400">
            {t('landing.features.subtitle')}
          </p>
        </motion.div>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
          {features.map((feature, index) => (
            <motion.div
              key={feature.title}
              initial={{ opacity: 0, y: 20 }}
              whileInView={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.5, delay: index * 0.1 }}
              viewport={{ once: true }}
              className="bg-[#2D3748] p-6 rounded-xl hover:bg-[#2D3748]/80 transition-all"
            >
              <feature.icon className="w-12 h-12 text-[#6B46C1] mb-4" />
              <h3 className="text-xl font-semibold text-white mb-2">
                {feature.title}
              </h3>
              <p className="text-gray-400">{feature.description}</p>
            </motion.div>
          ))}
        </div>
      </div>
    </section>
  );
};

// File: src\components\landing\FeedbackForm.tsx

import React from "react";
import { supabase } from "@/integrations/supabase/client";
import { useToast } from "@/hooks/use-toast";

export const FeedbackForm = () => {
  const { toast } = useToast();

  const handleFeedback = async (event: React.FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    const formData = new FormData(event.currentTarget);
    const email = formData.get('email') as string;
    const feedback = formData.get('feedback') as string;

    if (!email || !feedback) {
      toast({
        title: "Error",
        description: "Please fill in all fields",
        variant: "destructive",
      });
      return;
    }

    try {
      const { error } = await supabase
        .from('user_feedback')
        .insert([{ email, message: feedback }]);

      if (error) throw error;

      toast({
        title: "Thank you!",
        description: "Your feedback has been received.",
      });
      
      (event.target as HTMLFormElement).reset();
    } catch (error) {
      console.error('Error sending feedback:', error);
      toast({
        title: "Error",
        description: "Failed to send feedback. Please try again.",
        variant: "destructive",
      });
    }
  };

  return (
    <form onSubmit={handleFeedback} className="space-y-4">
      <input
        type="email"
        name="email"
        placeholder="Your email"
        className="w-full p-2 border rounded"
      />
      <textarea
        name="feedback"
        placeholder="Your feedback"
        className="w-full p-2 border rounded"
        rows={4}
      />
      <button
        type="submit"
        className="w-full bg-[#9b87f5] text-white p-2 rounded hover:bg-[#7E69AB]"
      >
        Send Feedback
      </button>
    </form>
  );
};

// File: src\components\landing\Footer.tsx

import React from "react";
import { Link } from "react-router-dom";

export const Footer = () => (
  <footer className="bg-[#1A1F2C] text-white py-12 border-t border-gray-800">
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
        <div>
          <h3 className="text-xl font-bold text-[#9b87f5] mb-4">Thesis Visualizer</h3>
          <p className="text-gray-400">Making thesis writing easier</p>
        </div>
        <div>
          <h4 className="text-lg font-semibold mb-4">Product</h4>
          <ul className="space-y-2">
            <li><Link to="/features" className="text-gray-400 hover:text-[#D6BCFA] transition-colors">Features</Link></li>
            <li><Link to="/pricing" className="text-gray-400 hover:text-[#D6BCFA] transition-colors">Pricing</Link></li>
          </ul>
        </div>
        <div>
          <h4 className="text-lg font-semibold mb-4">Company</h4>
          <ul className="space-y-2">
            <li><Link to="/about" className="text-gray-400 hover:text-[#D6BCFA] transition-colors">About</Link></li>
            <li><Link to="/contact" className="text-gray-400 hover:text-[#D6BCFA] transition-colors">Contact</Link></li>
          </ul>
        </div>
        <div>
          <h4 className="text-lg font-semibold mb-4">Legal</h4>
          <ul className="space-y-2">
            <li><Link to="/privacy" className="text-gray-400 hover:text-[#D6BCFA] transition-colors">Privacy</Link></li>
            <li><Link to="/terms" className="text-gray-400 hover:text-[#D6BCFA] transition-colors">Terms</Link></li>
          </ul>
        </div>
      </div>
      <div className="mt-8 pt-8 border-t border-gray-800 text-center">
        <p className="text-gray-400">&copy; {new Date().getFullYear()} Thesis Visualizer. All rights reserved.</p>
      </div>
    </div>
  </footer>
);

// File: src\components\landing\HeroSection.tsx

import React from "react";
import { motion } from "framer-motion";
import { GraduationCap } from "lucide-react";
import { Button } from "@/components/ui/button";
import { useNavigate } from "react-router-dom";
import { useToast } from "@/hooks/use-toast";
import { useTranslation } from "@/hooks/useTranslation";

export const HeroSection = () => {
  const navigate = useNavigate();
  const { toast } = useToast();
  const { t } = useTranslation();

  return (
    <section className="relative h-screen flex items-center justify-center overflow-hidden">
      <div className="absolute inset-0 bg-gradient-to-b from-[#1A1F2C] to-[#0A0D14] opacity-90" />
      
      <div className="relative z-10 text-center px-4 max-w-5xl mx-auto">
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.8 }}
          className="space-y-6"
        >
          <GraduationCap className="w-20 h-20 mx-auto text-[#6B46C1]" />
          <h1 className="text-4xl md:text-6xl font-bold text-white">
            {t('landing.hero.title')}
          </h1>
          <p className="text-xl text-gray-300 max-w-2xl mx-auto">
            {t('landing.hero.subtitle')}
          </p>
          <div className="flex justify-center gap-4 pt-8">
            <Button
              size="lg"
              className="bg-[#6B46C1] hover:bg-[#553C9A] text-white px-8"
              onClick={() => {
                toast({
                  title: "Welcome!",
                  description: "Let's get started with your thesis journey.",
                });
                navigate('/auth');
              }}
            >
              {t('landing.hero.cta')}
            </Button>
            <Button
              variant="outline"
              size="lg"
              className="border-[#6B46C1] text-[#6B46C1] hover:bg-[#6B46C1] hover:text-white"
              onClick={() => {
                const featuresSection = document.getElementById('features');
                featuresSection?.scrollIntoView({ behavior: 'smooth' });
              }}
            >
              {t('landing.hero.learnMore')}
            </Button>
          </div>
        </motion.div>
      </div>
    </section>
  );
};

// File: src\components\landing\Navbar.tsx

import { Link } from "react-router-dom";
import { Button } from "@/components/ui/button";
import { LanguageSwitcher } from "@/components/LanguageSwitcher";
import { useTranslation } from "@/hooks/useTranslation";

export const Navbar = () => {
  const { t } = useTranslation();

  return (
    <nav className="fixed top-0 left-0 right-0 w-full bg-[#1A1F2C] text-white z-50 py-4">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 w-full">
        <div className="flex justify-between items-center">
          <Link to="/" className="text-2xl font-bold text-[#9b87f5]">
            Thesis Visualizer
          </Link>
          <div className="hidden md:flex space-x-8">
            <Link to="/" className="hover:text-[#D6BCFA] transition-colors">
              {t('common.features')}
            </Link>
            <Link to="/" className="hover:text-[#D6BCFA] transition-colors">
              {t('common.about')}
            </Link>
          </div>
          <div className="flex items-center space-x-4">
            <LanguageSwitcher />
            <Link to="/auth">
              <Button 
                variant="outline" 
                className="bg-transparent text-white border-white hover:bg-white hover:text-[#1A1F2C]"
              >
                {t('common.getStarted')}
              </Button>
            </Link>
          </div>
        </div>
      </div>
    </nav>
  );
};

// File: src\components\landing\PricingSection.tsx

import React from "react";
import { motion } from "framer-motion";
import { Check, Star } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Link } from "react-router-dom";
import { useTranslation } from "@/hooks/useTranslation";

const PricingTier = ({ 
  title, 
  price, 
  features, 
  popular = false,
  buttonVariant = "outline",
  duration = "per thesis"
}: { 
  title: string;
  price: string;
  features: string[];
  popular?: boolean;
  buttonVariant?: "outline" | "default";
  duration?: string;
}) => {
  const { t } = useTranslation();
  
  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      className={`bg-gradient-to-b from-white to-gray-50 p-8 rounded-xl shadow-lg hover:shadow-xl transition-all relative ${
        popular ? 'border-2 border-admin-accent-primary' : ''
      }`}
    >
      {popular && (
        <div className="absolute -top-4 left-1/2 transform -translate-x-1/2">
          <span className="bg-gradient-to-r from-admin-accent-primary to-admin-accent-secondary text-white px-4 py-1 rounded-full text-sm font-medium">
            Most Popular
          </span>
        </div>
      )}
      <h3 className="text-2xl font-bold mb-4 text-admin-accent-primary">{title}</h3>
      <div className="mb-6">
        <p className="text-4xl font-bold text-admin-accent-secondary">{price}</p>
        <p className="text-sm text-gray-500">{duration}</p>
      </div>
      <ul className="space-y-4 mb-8">
        {features.map((feature, index) => (
          <li key={index} className="flex items-center">
            <Check className="w-5 h-5 text-admin-accent-primary mr-2 flex-shrink-0" />
            <span className="text-gray-600">{feature}</span>
          </li>
        ))}
      </ul>
      <Link to="/auth" className="block">
        <Button 
          className={`w-full ${
            buttonVariant === "default" 
              ? "bg-gradient-to-r from-admin-accent-primary to-admin-accent-secondary hover:opacity-90 text-white" 
              : "border-admin-accent-primary/20 text-admin-accent-primary hover:border-admin-accent-secondary"
          }`} 
          variant={buttonVariant}
        >
          {t('common.getStarted')}
        </Button>
      </Link>
    </motion.div>
  );
};

export const PricingSection = () => {
  const { t } = useTranslation();

  const pricingTiers = [
    {
      title: t('landing.pricing.basic.title'),
      price: t('landing.pricing.basic.price'),
      duration: t('landing.pricing.basic.duration'),
      features: [
        "Basic Thesis Editor",
        "Export to PDF/DOCX",
        "Basic Templates",
        "14-day access"
      ]
    },
    {
      title: t('landing.pricing.standard.title'),
      price: t('landing.pricing.standard.price'),
      duration: t('landing.pricing.standard.duration'),
      features: [
        "Everything in Basic",
        "Real-time Collaboration",
        "Version Control",
        "Citation Management",
        "AI Writing Assistant",
        "6 months access"
      ],
      popular: true
    },
    {
      title: t('landing.pricing.research.title'),
      price: t('landing.pricing.research.price'),
      duration: t('landing.pricing.research.duration'),
      features: [
        "Everything in Standard",
        "Priority Support",
        "Custom Templates",
        "Multiple Thesis Support",
        "Advanced Analytics",
        "Unlimited access"
      ]
    }
  ];

  return (
    <section className="py-20 bg-gradient-to-b from-gray-50 to-white">
      <div className="max-w-7xl mx-auto px-4">
        <div className="text-center mb-12">
          <motion.h2
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="text-3xl font-bold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-admin-accent-primary to-admin-accent-secondary"
          >
            {t('landing.pricing.title')}
          </motion.h2>
          <p className="text-gray-600 max-w-2xl mx-auto">
            {t('landing.pricing.subtitle')}
          </p>
        </div>
        
        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
          {pricingTiers.map((tier, index) => (
            <PricingTier
              key={tier.title}
              {...tier}
              buttonVariant={tier.popular ? "default" : "outline"}
            />
          ))}
        </div>

        <div className="mt-12 text-center">
          <p className="text-sm text-gray-500">
            All prices are in Algerian Dinars (DZD). Need a custom plan? 
            <Link to="/contact" className="text-admin-accent-primary hover:text-admin-accent-secondary ml-1">
              Contact us
            </Link>
          </p>
        </div>
      </div>
    </section>
  );
};

// File: src\components\landing\TestimonialCard.tsx

import React from "react";

interface TestimonialCardProps {
  quote: string;
  author: string;
  role: string;
}

export const TestimonialCard = ({ quote, author, role }: TestimonialCardProps) => (
  <div className="bg-white p-6 rounded-xl shadow-lg">
    <p className="text-gray-600 mb-4">{quote}</p>
    <div>
      <p className="font-semibold text-[#1A1F2C]">{author}</p>
      <p className="text-sm text-gray-500">{role}</p>
    </div>
  </div>
);

// File: src\components\landing\TestimonialCarousel.tsx

import React from "react";
import { Quote, Star } from "lucide-react";
import { motion } from "framer-motion";
import {
  Carousel,
  CarouselContent,
  CarouselItem,
  CarouselNext,
  CarouselPrevious,
} from "@/components/ui/carousel";

interface Testimonial {
  quote: string;
  author: string;
  role: string;
  rating: number;
}

const testimonials: Testimonial[] = [
  {
    quote: "This platform revolutionized how I write my thesis. The collaboration features are incredible!",
    author: "Sarah Johnson",
    role: "PhD Candidate, Computer Science",
    rating: 5,
  },
  {
    quote: "The AI-powered suggestions and formatting tools saved me countless hours.",
    author: "Michael Chen",
    role: "Master's Student, Engineering",
    rating: 5,
  },
  {
    quote: "Working with my advisor has never been easier. Real-time feedback is a game-changer.",
    author: "Emma Davis",
    role: "Research Scholar",
    rating: 5,
  },
  {
    quote: "The citation management system is brilliant. It handles everything automatically!",
    author: "David Wilson",
    role: "PhD Student, Biology",
    rating: 5,
  },
];

export const TestimonialCarousel = () => {
  return (
    <section className="py-20 bg-gradient-to-b from-gray-50 to-white">
      <div className="max-w-7xl mx-auto px-4">
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.6 }}
          className="text-center mb-12"
        >
          <h2 className="text-3xl font-bold mb-4">What Our Users Say</h2>
          <p className="text-gray-600 max-w-2xl mx-auto">
            Join thousands of satisfied researchers who have transformed their thesis writing experience
          </p>
        </motion.div>

        <Carousel
          opts={{
            align: "start",
            loop: true,
          }}
          className="w-full max-w-5xl mx-auto"
        >
          <CarouselContent>
            {testimonials.map((testimonial, index) => (
              <CarouselItem key={index} className="md:basis-1/2 lg:basis-1/3">
                <motion.div
                  initial={{ opacity: 0, scale: 0.9 }}
                  animate={{ opacity: 1, scale: 1 }}
                  transition={{ delay: index * 0.1 }}
                  className="h-full"
                >
                  <div className="bg-white p-6 rounded-xl shadow-lg h-full flex flex-col">
                    <div className="mb-4">
                      <Quote className="w-8 h-8 text-primary opacity-50" />
                    </div>
                    <p className="text-gray-600 mb-4 flex-grow">{testimonial.quote}</p>
                    <div>
                      <div className="flex mb-2">
                        {[...Array(testimonial.rating)].map((_, i) => (
                          <Star
                            key={i}
                            className="w-4 h-4 text-yellow-400 fill-current"
                          />
                        ))}
                      </div>
                      <p className="font-semibold text-[#1A1F2C]">{testimonial.author}</p>
                      <p className="text-sm text-gray-500">{testimonial.role}</p>
                    </div>
                  </div>
                </motion.div>
              </CarouselItem>
            ))}
          </CarouselContent>
          <CarouselPrevious className="hidden md:flex" />
          <CarouselNext className="hidden md:flex" />
        </Carousel>
      </div>
    </section>
  );
};

// File: src\components\landing\ThesisVisualization.tsx

import React, { useState, useEffect } from 'react';
import { motion } from 'framer-motion';
import { useParams } from 'react-router-dom';
import { useThesisData } from '@/hooks/useThesisData';
import { BookOpen, Users, CheckCircle, AlertCircle } from 'lucide-react';
import { Progress } from '@/components/ui/progress';

export default function ThesisVisualization() {
  const { thesisId } = useParams();
  const { thesis, isLoading } = useThesisData(thesisId);
  const [hoveredSection, setHoveredSection] = useState<number | null>(null);

  if (isLoading || !thesis) {
    return (
      <div className="flex items-center justify-center h-[600px]">
        <BookOpen className="w-8 h-8 text-primary animate-pulse" />
      </div>
    );
  }

  // Calculate overall progress
  const allSections = [
    ...thesis.frontMatter,
    ...thesis.chapters.flatMap(chapter => chapter.sections),
    ...thesis.backMatter
  ];
  
  const completedSections = allSections.filter(section => 
    section.content && section.content.trim().length > 100
  ).length;
  
  const totalProgress = Math.round((completedSections / allSections.length) * 100);

  // Calculate chapter completion status
  const chapterStatus = thesis.chapters.map(chapter => {
    const completedChapterSections = chapter.sections.filter(
      section => section.content && section.content.trim().length > 100
    ).length;
    return {
      title: chapter.title,
      progress: Math.round((completedChapterSections / chapter.sections.length) * 100),
      complete: completedChapterSections === chapter.sections.length
    };
  });

  // Get time metrics
  const createdDate = new Date(thesis.created_at);
  const lastUpdateDate = new Date(thesis.updated_at);
  const daysSinceCreation = Math.round((Date.now() - createdDate.getTime()) / (1000 * 60 * 60 * 24));
  
  // Calculate positions for chapter nodes
  const getPositionOnCircle = (index: number, total: number) => {
    const radius = 300;
    const angle = ((index * 360) / total) + 90;
    const x = Math.cos((angle * Math.PI) / 180) * radius;
    const y = Math.sin((angle * Math.PI) / 180) * radius;
    return { x, y };
  };

  return (
    <div className="py-24 bg-gradient-to-b from-gray-50 to-white overflow-hidden">
      <div className="max-w-7xl mx-auto px-4">
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          className="relative"
        >
          {/* Central Book Icon with Pulse Effect */}
          <div className="flex justify-center mb-16">
            <motion.div
              whileHover={{ scale: 1.1 }}
              className="relative"
            >
              <motion.div
                animate={{
                  scale: [1, 1.2, 1],
                  opacity: [0.5, 0.8, 0.5],
                }}
                transition={{
                  duration: 2,
                  repeat: Infinity,
                  ease: "easeInOut",
                }}
                className="absolute inset-0 bg-primary/20 rounded-full"
              />
              <div className="bg-primary/10 p-8 rounded-full relative z-10">
                <BookOpen size={64} className="text-primary" />
              </div>
            </motion.div>
          </div>

          {/* Progress Circle */}
          <div className="relative">
            <motion.div
              initial={{ scale: 0 }}
              animate={{ scale: 1 }}
              transition={{ duration: 0.5 }}
              className="absolute inset-0 flex items-center justify-center"
            >
              <div className="w-[600px] h-[600px] border-4 border-dashed border-gray-200 rounded-full" />
            </motion.div>

            {/* Chapter Nodes */}
            {chapterStatus.map((chapter, index) => {
              const position = getPositionOnCircle(index, chapterStatus.length);
              return (
                <motion.div
                  key={index}
                  initial={{ opacity: 0, scale: 0 }}
                  animate={{ opacity: 1, scale: 1 }}
                  transition={{ delay: index * 0.1 }}
                  className="absolute left-1/2 top-1/2"
                  style={{
                    transform: `translate(${position.x}px, ${position.y}px)`,
                  }}
                  onHoverStart={() => setHoveredSection(index)}
                  onHoverEnd={() => setHoveredSection(null)}
                >
                  <motion.div
                    whileHover={{ scale: 1.1 }}
                    className={`bg-white p-4 rounded-lg shadow-lg -translate-x-1/2 -translate-y-1/2 w-48 transition-colors ${
                      hoveredSection === index ? 'bg-primary/5' : ''
                    }`}
                  >
                    <div className="space-y-2">
                      <div className="flex items-center justify-between">
                        {chapter.complete ? (
                          <CheckCircle className="text-green-500" />
                        ) : (
                          <AlertCircle className="text-yellow-500" />
                        )}
                        <span className="text-sm font-medium">{chapter.title}</span>
                      </div>
                      <Progress value={chapter.progress} className="h-2" />
                      <span className="text-xs text-muted-foreground">{chapter.progress}% Complete</span>
                    </div>
                  </motion.div>
                </motion.div>
              );
            })}

            {/* Stats */}
            <div className="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-12 flex gap-6">
              <motion.div
                initial={{ opacity: 0, y: -20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: 0.5 }}
                whileHover={{ y: -5 }}
                className="bg-white px-6 py-3 rounded-xl shadow-lg"
              >
                <div className="flex items-center gap-3">
                  <BookOpen className="text-primary" size={20} />
                  <div>
                    <p className="text-sm text-gray-600">Overall Progress</p>
                    <p className="text-lg font-semibold">{totalProgress}%</p>
                  </div>
                </div>
              </motion.div>

              <motion.div
                initial={{ opacity: 0, y: -20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: 0.6 }}
                whileHover={{ y: -5 }}
                className="bg-white px-6 py-3 rounded-xl shadow-lg"
              >
                <div className="flex items-center gap-3">
                  <Users className="text-primary" size={20} />
                  <div>
                    <p className="text-sm text-gray-600">Time Active</p>
                    <p className="text-lg font-semibold">{daysSinceCreation} days</p>
                  </div>
                </div>
              </motion.div>
            </div>

            {/* Last Update */}
            <motion.div
              initial={{ opacity: 0, x: -20 }}
              animate={{ opacity: 1, x: 0 }}
              transition={{ delay: 1 }}
              className="absolute left-0 top-1/2 transform -translate-y-1/2 -translate-x-12"
            >
              <div className="bg-white p-4 rounded-xl shadow-lg space-y-2">
                <div className="flex items-center gap-2">
                  <CheckCircle className="text-primary" size={20} />
                  <span className="text-sm font-medium">Last Update</span>
                </div>
                <p className="text-xs text-gray-500">
                  {lastUpdateDate.toLocaleDateString()}
                </p>
              </div>
            </motion.div>
          </div>
        </motion.div>
      </div>
    </div>
  );
}

// File: src\components\landing\visualization\CentralIcon.tsx

import React from 'react';
import { motion } from 'framer-motion';
import { BookOpen } from 'lucide-react';

export const CentralIcon = () => {
  return (
    <motion.div 
      className="central-icon"
      whileHover={{ scale: 1.1 }}
    >
      <div className="central-icon-pulse" />
      <BookOpen size={64} className="text-primary" />
    </motion.div>
  );
};

// File: src\components\landing\visualization\CollaboratorBadge.tsx

import React from "react";
import { motion } from "framer-motion";
import { Users } from "lucide-react";

interface CollaboratorBadgeProps {
  id: number;
  role: string;
  active: boolean;
}

export const CollaboratorBadge = ({ id, role, active }: CollaboratorBadgeProps) => {
  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ delay: 0.8 + id * 0.1 }}
      whileHover={{ scale: 1.05 }}
      className={`flex items-center gap-2 px-4 py-2 rounded-full shadow-md ${
        active ? "bg-white" : "bg-gray-50"
      }`}
    >
      <div className="relative">
        <Users className={active ? "text-primary" : "text-gray-400"} size={20} />
        {active && (
          <span className="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full" />
        )}
      </div>
      <span
        className={`text-sm font-medium ${
          active ? "text-gray-900" : "text-gray-500"
        }`}
      >
        {role}
      </span>
    </motion.div>
  );
};

// File: src\components\landing\visualization\CollaboratorCard.tsx

import React from 'react';
import { motion } from 'framer-motion';
import { Users } from 'lucide-react';

interface CollaboratorProps {
  id: number;
  name: string;
  role: string;
  active: boolean;
}

export const CollaboratorCard = ({ id, name, role, active }: CollaboratorProps) => {
  return (
    <motion.div
      key={id}
      className="collaborator-card"
      whileHover={{ scale: 1.05 }}
    >
      <Users size={20} />
      <div className="collaborator-info">
        <span>{name}</span>
        <span>{role}</span>
      </div>
      {active && (
        <div className="active-indicator" />
      )}
    </motion.div>
  );
};

// File: src\components\landing\visualization\CollaboratorOrbit.tsx

import React from 'react';
import { motion } from 'framer-motion';
import { Users } from 'lucide-react';
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";

interface Collaborator {
  id: number;
  name: string;
  role: string;
  email: string;
}

interface CollaboratorOrbitProps {
  collaborators: Collaborator[];
}

export const CollaboratorOrbit = ({ collaborators }: CollaboratorOrbitProps) => {
  return (
    <div className="absolute inset-0">
      {collaborators.slice(0, 2).map((collaborator, index) => {
        const angle = (index * 360) / 2;
        const radius = 120; // Increased radius to move avatars outside the book icon
        const x = Math.cos((angle * Math.PI) / 180) * radius;
        const y = Math.sin((angle * Math.PI) / 180) * radius;

        return (
          <motion.div
            key={collaborator.id}
            initial={{ opacity: 0, scale: 0 }}
            animate={{ 
              opacity: 1, 
              scale: 1,
              rotate: 360,
            }}
            transition={{ 
              rotate: {
                duration: 20,
                repeat: Infinity,
                ease: "linear"
              },
              opacity: { duration: 0.5 },
              scale: { duration: 0.5 }
            }}
            className="absolute left-1/2 top-1/2"
            style={{
              transform: `translate(${x}px, ${y}px)`,
            }}
          >
            <motion.div
              whileHover={{ scale: 1.2 }}
              className="relative -translate-x-1/2 -translate-y-1/2"
            >
              <Avatar className="h-8 w-8 border-2 border-primary/20 bg-white/80 backdrop-blur-sm hover:border-primary/50 transition-all duration-200">
                <AvatarImage 
                  src={`https://api.dicebear.com/7.x/initials/svg?seed=${collaborator.email}`} 
                  alt={collaborator.name} 
                />
                <AvatarFallback>
                  {collaborator.name.substring(0, 2).toUpperCase()}
                </AvatarFallback>
              </Avatar>
              <motion.div
                initial={{ opacity: 0, y: 10 }}
                whileHover={{ opacity: 1, y: 0 }}
                className="absolute top-full left-1/2 -translate-x-1/2 mt-2 whitespace-nowrap bg-white/80 backdrop-blur-sm px-2 py-1 rounded-md text-xs shadow-sm border border-primary/10"
              >
                {collaborator.name} â€¢ {collaborator.role}
              </motion.div>
            </motion.div>
          </motion.div>
        );
      })}
    </div>
  );
};

// File: src\components\landing\visualization\EnhancedThesisViz.tsx

import React, { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
  BookOpen,
  Users,
  CheckSquare,
  Square,
  ArrowUp,
  Calendar,
  ChartBar,
  ChartLine,
  ChartPie,
  Clock
} from 'lucide-react';
import { Progress } from "@/components/ui/progress";

// Types
interface Section {
  id: number;
  title: string;
  complete: boolean;
  progress: number;
  summary: string;
}

// Data
const sections: Section[] = [
  { id: 1, title: 'Introduction', complete: true, progress: 100, summary: 'Research background and objectives' },
  { id: 2, title: 'Literature Review', complete: true, progress: 100, summary: 'Theoretical framework' },
  { id: 3, title: 'Methodology', complete: false, progress: 75, summary: 'Research design' },
  { id: 4, title: 'Results', complete: false, progress: 40, summary: 'Data analysis' },
  { id: 5, title: 'Discussion', complete: false, progress: 20, summary: 'Interpretation' },
  { id: 6, title: 'Conclusion', complete: false, progress: 10, summary: 'Summary' }
];

// Calculate positions on circle
const getPositionOnCircle = (index: number, total: number, radius: number) => {
  const angle = (index * 360) / total;
  const x = Math.cos((angle * Math.PI) / 180) * radius;
  const y = Math.sin((angle * Math.PI) / 180) * radius;
  return { x, y };
};

export default function EnhancedThesisViz() {
  const [hoveredSection, setHoveredSection] = useState<number | null>(null);
  const [rotation, setRotation] = useState(0);
  const [progress] = useState(65);

  return (
    <div className="relative w-full h-[800px] bg-gradient-to-b from-white to-gray-50 overflow-hidden rounded-3xl">
      {/* Background Elements */}
      <div className="absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,rgba(79,70,229,0.1),transparent_50%)]" />
      <motion.div
        className="absolute inset-0"
        initial={false}
        animate={{
          background: [
            'radial-gradient(600px circle at 50% 50%, rgba(79,70,229,0.05), transparent 80%)',
            'radial-gradient(800px circle at 50% 50%, rgba(79,70,229,0.08), transparent 80%)'
          ],
        }}
        transition={{ duration: 3, repeat: Infinity, repeatType: 'reverse' }}
      />

      {/* Central Book Icon */}
      <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
        <motion.div
          className="relative"
          animate={{ rotate: 360 }}
          transition={{ duration: 20, repeat: Infinity, ease: "linear" }}
        >
          <div className="absolute -inset-32 border-2 border-dashed border-primary/20 rounded-full" />
        </motion.div>
        
        <motion.div
          className="relative z-10 bg-white p-8 rounded-full shadow-xl"
          whileHover={{ scale: 1.1 }}
          initial={{ scale: 0 }}
          animate={{ scale: 1 }}
          transition={{ type: "spring", duration: 1 }}
        >
          <motion.div
            className="absolute inset-0 bg-primary/10 rounded-full"
            animate={{
              scale: [1, 1.2, 1],
              opacity: [0.5, 0.2, 0.5],
            }}
            transition={{ duration: 2, repeat: Infinity }}
          />
          <BookOpen size={48} className="text-primary relative z-10" />
        </motion.div>

        {/* Timeline Progress Ring */}
        <div className="absolute -bottom-24 left-1/2 transform -translate-x-1/2">
          <div className="relative">
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              className="flex flex-col items-center"
            >
              <div className="relative w-16 h-16">
                <Progress
                  value={progress}
                  className="h-16 w-16 [&>div]:h-16 [&>div]:w-16 rotate-[-90deg]"
                />
                <div className="absolute inset-0 flex items-center justify-center">
                  <Clock className="h-6 w-6 text-primary" />
                </div>
              </div>
              <div className="mt-2 text-xs text-center text-gray-600">
                <p className="font-medium">{progress}% Complete</p>
                <p>2 months left</p>
              </div>
            </motion.div>
          </div>
        </div>
      </div>

      {/* Sections */}
      {sections.map((section, index) => {
        const position = getPositionOnCircle(index, sections.length, 250);
        return (
          <motion.div
            key={section.id}
            className="absolute top-1/2 left-1/2"
            style={{
              x: position.x,
              y: position.y,
            }}
            initial={{ opacity: 0, scale: 0 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ delay: index * 0.2 }}
          >
            <motion.div
              className={`bg-white/90 backdrop-blur-sm p-4 rounded-xl shadow-lg -translate-x-1/2 -translate-y-1/2 w-48 border border-primary/10
                         ${hoveredSection === section.id ? 'ring-2 ring-primary/20' : ''}`}
              whileHover={{ scale: 1.05, y: -5 }}
              onHoverStart={() => setHoveredSection(section.id)}
              onHoverEnd={() => setHoveredSection(null)}
            >
              <div className="space-y-2">
                <div className="flex items-center justify-between">
                  {section.complete ? (
                    <motion.div
                      initial={{ scale: 0 }}
                      animate={{ scale: 1 }}
                      transition={{ type: "spring" }}
                    >
                      <CheckSquare className="text-green-500" />
                    </motion.div>
                  ) : (
                    <Square className="text-gray-400" />
                  )}
                  <span className="text-sm font-medium text-gray-700">{section.title}</span>
                </div>
                <div className="relative h-2 bg-gray-100 rounded-full overflow-hidden">
                  <motion.div
                    className="absolute inset-y-0 left-0 bg-primary rounded-full"
                    initial={{ width: 0 }}
                    animate={{ width: `${section.progress}%` }}
                    transition={{ duration: 1, delay: index * 0.1 }}
                  />
                </div>
                <AnimatePresence>
                  {hoveredSection === section.id && (
                    <motion.p
                      initial={{ opacity: 0, height: 0 }}
                      animate={{ opacity: 1, height: 'auto' }}
                      exit={{ opacity: 0, height: 0 }}
                      className="text-xs text-gray-500"
                    >
                      {section.summary}
                    </motion.p>
                  )}
                </AnimatePresence>
              </div>
            </motion.div>
          </motion.div>
        );
      })}

      {/* Floating Particles */}
      <div className="absolute inset-0 pointer-events-none">
        {[...Array(20)].map((_, i) => (
          <motion.div
            key={i}
            className="absolute w-1 h-1 bg-primary/20 rounded-full"
            initial={{
              x: Math.random() * window.innerWidth,
              y: Math.random() * window.innerHeight,
            }}
            animate={{
              x: Math.random() * window.innerWidth,
              y: Math.random() * window.innerHeight,
            }}
            transition={{
              duration: Math.random() * 10 + 5,
              repeat: Infinity,
              repeatType: "reverse",
            }}
          />
        ))}
      </div>
    </div>
  );
}

// File: src\components\landing\visualization\NotificationsPanel.tsx

import React from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { AlertCircle } from 'lucide-react';

interface Section {
  id: number;
  title: string;
  progress: number;
  complete: boolean;
}

interface NotificationsPanelProps {
  showNotifications: boolean;
  sections: Section[];
}

export const NotificationsPanel = ({ showNotifications, sections }: NotificationsPanelProps) => {
  return (
    <AnimatePresence>
      {showNotifications && (
        <motion.div
          className="notifications-panel"
          initial={{ opacity: 0, x: 100 }}
          animate={{ opacity: 1, x: 0 }}
          exit={{ opacity: 0, x: 100 }}
        >
          <div className="notification-header">
            <AlertCircle size={20} />
            <span>Thesis Updates</span>
          </div>
          <div className="notification-content">
            {sections
              .filter(s => !s.complete)
              .map(section => (
                <div key={section.id} className="notification-item">
                  <span>{section.title} needs attention</span>
                  <span>{section.progress}% complete</span>
                </div>
              ))
            }
          </div>
        </motion.div>
      )}
    </AnimatePresence>
  );
};

// File: src\components\landing\visualization\SectionCard.tsx

import React from 'react';
import { motion } from 'framer-motion';
import { CheckSquare, Square } from 'lucide-react';

interface Section {
  id: number;
  title: string;
  complete: boolean;
  progress: number;
  wordCount: number;
  citations: number;
}

interface SectionCardProps {
  section: Section;
  position: { x: number; y: number };
  onHoverStart: () => void;
  onHoverEnd: () => void;
}

export const SectionCard = ({ section, position, onHoverStart, onHoverEnd }: SectionCardProps) => {
  return (
    <motion.div
      key={section.id}
      className="section-card"
      style={{
        transform: `translate(${position.x}px, ${position.y}px)`
      }}
      whileHover={{ scale: 1.05 }}
      onHoverStart={onHoverStart}
      onHoverEnd={onHoverEnd}
    >
      <div className="section-header">
        <h3>{section.title}</h3>
        {section.complete ? (
          <CheckSquare className="text-success" />
        ) : (
          <Square className="text-secondary" />
        )}
      </div>
      <div className="progress-bar">
        <motion.div
          className="progress-bar-fill"
          initial={{ width: 0 }}
          animate={{ width: `${section.progress}%` }}
        />
      </div>
      <div className="section-details">
        <span>{section.wordCount} words</span>
        <span>{section.citations} citations</span>
      </div>
    </motion.div>
  );
};

// File: src\components\landing\visualization\StatCard.tsx

import React from 'react';
import { motion } from 'framer-motion';
import { ArrowUp, ArrowDown, Minus } from 'lucide-react';
import type { LucideIcon } from 'lucide-react';

interface StatCardProps {
  id: number;
  icon: LucideIcon;
  label: string;
  value: string;
  target: string;
  trend: 'up' | 'down' | 'stable';
  change: string;
}

export const StatCard = ({ id, icon: Icon, label, value, target, trend, change }: StatCardProps) => {
  return (
    <motion.div
      key={id}
      className="stat-card"
      whileHover={{ y: -5 }}
    >
      <div className="stat-header">
        <Icon size={20} />
        <span>{label}</span>
      </div>
      <div className="stat-value">
        {value}
        <span className="stat-target">/ {target}</span>
      </div>
      <div className={`stat-trend ${trend}`}>
        {trend === 'up' && <ArrowUp size={16} />}
        {trend === 'down' && <ArrowDown size={16} />}
        {trend === 'stable' && <Minus size={16} />}
        <span>{change}</span>
      </div>
    </motion.div>
  );
};

// File: src\components\landing\visualization\styles.ts

export const styles = `
  .thesis-viz {
    --primary-color: #4F46E5;
    --secondary-color: #E5E7EB;
    --success-color: #10B981;
    --warning-color: #F59E0B;
    --error-color: #EF4444;
    --text-primary: #111827;
    --text-secondary: #6B7280;
    --bg-primary: #FFFFFF;
    --bg-secondary: #F8FAFC;
  }

  .thesis-container {
    min-height: 100vh;
    background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
    padding: 2rem;
    overflow: hidden;
  }

  .visualization-wrapper {
    max-width: 1200px;
    margin: 0 auto;
    position: relative;
    background: var(--bg-primary);
    border-radius: 24px;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.05);
    padding: 2rem;
  }

  .central-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-primary);
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .central-icon-pulse {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: var(--primary-color);
    opacity: 0.2;
    animation: pulse 2s infinite;
  }

  .sections-circle {
    position: relative;
    width: 800px;
    height: 800px;
    margin: 0 auto;
    transform: rotate(-90deg);
  }

  .section-card {
    position: absolute;
    width: 240px;
    background: var(--bg-primary);
    border-radius: 16px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    padding: 1.5rem;
    transition: all 0.3s ease;
    transform-origin: center;
  }

  .section-card:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .section-header h3 {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
  }

  .progress-bar {
    width: 100%;
    height: 6px;
    background: var(--secondary-color);
    border-radius: 3px;
    margin: 0.75rem 0;
    overflow: hidden;
  }

  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-color), #818CF8);
    transition: width 0.5s ease;
  }

  .section-details {
    display: flex;
    justify-content: space-between;
    font-size: 0.875rem;
    color: var(--text-secondary);
  }

  .stats-dashboard {
    position: absolute;
    top: 2rem;
    right: 2rem;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
  }

  .stat-card {
    background: var(--bg-primary);
    padding: 1.25rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: transform 0.3s ease;
  }

  .stat-card:hover {
    transform: translateY(-2px);
  }

  .collaboration-panel {
    position: absolute;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 1rem;
  }

  .collaborator-card {
    background: var(--bg-primary);
    padding: 0.75rem 1.25rem;
    border-radius: 999px;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: transform 0.3s ease;
  }

  .collaborator-card:hover {
    transform: translateY(-2px);
  }

  .active-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--success-color);
  }

  .timeline-card {
    position: absolute;
    left: 2rem;
    top: 50%;
    transform: translateY(-50%);
    background: var(--bg-primary);
    padding: 1.25rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    width: 200px;
  }

  @keyframes pulse {
    0% {
      transform: scale(1);
      opacity: 0.2;
    }
    50% {
      transform: scale(1.5);
      opacity: 0.1;
    }
    100% {
      transform: scale(1);
      opacity: 0.2;
    }
  }

  @media (max-width: 1024px) {
    .sections-circle {
      transform: scale(0.8) rotate(-90deg);
    }
    
    .stats-dashboard {
      position: relative;
      top: 0;
      right: 0;
      margin-top: 2rem;
    }
  }
`;


// File: src\components\landing\visualization\ThesisFeature.tsx

import React from "react";
import { motion } from "framer-motion";
import { Square, CheckSquare } from "lucide-react";

interface ThesisFeatureProps {
  id: number;
  title: string;
  complete: boolean;
  progress: number;
  hoveredSection: number | null;
  setHoveredSection: (id: number | null) => void;
  angle: number;
  radius: number;
}

export const ThesisFeature = ({
  id,
  title,
  complete,
  progress,
  hoveredSection,
  setHoveredSection,
  angle,
  radius,
}: ThesisFeatureProps) => {
  const x = Math.cos((angle * Math.PI) / 180) * radius;
  const y = Math.sin((angle * Math.PI) / 180) * radius;

  return (
    <motion.div
      initial={{ opacity: 0, scale: 0 }}
      animate={{ opacity: 1, scale: 1 }}
      transition={{ delay: id * 0.1 }}
      className="absolute left-1/2 top-1/2"
      style={{
        transform: `translate(${x}px, ${y}px)`,
      }}
      onHoverStart={() => setHoveredSection(id)}
      onHoverEnd={() => setHoveredSection(null)}
    >
      <motion.div
        whileHover={{ scale: 1.1 }}
        className={`bg-white p-4 rounded-lg shadow-lg -translate-x-1/2 -translate-y-1/2 w-48 transition-colors ${
          hoveredSection === id ? "bg-primary/5" : ""
        }`}
      >
        <div className="space-y-2">
          <div className="flex items-center justify-between">
            {complete ? (
              <CheckSquare className="text-green-500" />
            ) : (
              <Square className="text-gray-400" />
            )}
            <span className="text-sm font-medium">{title}</span>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-2">
            <motion.div
              initial={{ width: 0 }}
              animate={{ width: `${progress}%` }}
              transition={{ duration: 1, delay: id * 0.2 }}
              className="bg-primary rounded-full h-2"
            />
          </div>
        </div>
      </motion.div>
    </motion.div>
  );
};

// File: src\components\landing\visualization\ThesisNode.tsx

import React from "react";
import { motion } from "framer-motion";
import { CheckCircle, Circle } from "lucide-react";

interface ThesisNodeProps {
  title: string;
  progress: number;
  complete: boolean;
  delay?: number;
}

export const ThesisNode = ({ title, progress, complete, delay = 0 }: ThesisNodeProps) => {
  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ delay }}
      className="bg-white/5 backdrop-blur-sm p-6 rounded-lg border border-white/10 hover:border-[#6B46C1]/50 transition-colors"
    >
      <div className="flex items-center justify-between mb-4">
        <h3 className="text-white font-medium">{title}</h3>
        {complete ? (
          <CheckCircle className="text-green-500" size={20} />
        ) : (
          <Circle className="text-gray-400" size={20} />
        )}
      </div>
      
      <div className="w-full bg-gray-700 rounded-full h-2">
        <motion.div
          initial={{ width: 0 }}
          animate={{ width: `${progress}%` }}
          transition={{ duration: 1, delay: delay + 0.5 }}
          className="bg-[#6B46C1] rounded-full h-2"
        />
      </div>
      
      <p className="text-right mt-2 text-sm text-gray-400">
        {progress}%
      </p>
    </motion.div>
  );
};

// File: src\components\landing\visualization\ThesisStat.tsx

import React from "react";
import { motion } from "framer-motion";
import { LucideIcon } from "lucide-react";

interface ThesisStatProps {
  id: number;
  icon: LucideIcon;
  label: string;
  value: string;
  target: string;
}

export const ThesisStat = ({ id, icon: Icon, label, value, target }: ThesisStatProps) => {
  return (
    <motion.div
      initial={{ opacity: 0, y: -20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ delay: 0.5 + id * 0.1 }}
      whileHover={{ y: -5 }}
      className="bg-white/5 backdrop-blur-sm p-6 rounded-lg border border-white/10"
    >
      <div className="flex items-center gap-3">
        <Icon className="text-[#6B46C1]" size={20} />
        <div>
          <p className="text-sm text-gray-400">{label}</p>
          <p className="text-lg font-semibold text-white">
            {value}
            <span className="text-xs text-gray-500 ml-1">/ {target}</span>
          </p>
        </div>
      </div>
    </motion.div>
  );
};

// File: src\components\landing\visualization\ThesisVisualization.tsx

import React, { useState, useEffect } from 'react';
import { motion } from 'framer-motion';
import { Thesis } from '@/types/thesis';
import { supabase } from '@/integrations/supabase/client';

export const ThesisVisualization = () => {
  const [thesis, setThesis] = useState<Thesis | null>(null);

  useEffect(() => {
    const fetchThesis = async () => {
      const { data, error } = await supabase
        .from('theses')
        .select('*')
        .limit(1)
        .single();

      if (error) {
        console.error('Error fetching thesis:', error);
        return;
      }

      if (data) {
        const content = typeof data.content === 'string' 
          ? JSON.parse(data.content)
          : data.content;

        setThesis({
          ...data,
          content,
          metadata: {
            description: '',
            keywords: [],
            createdAt: data.created_at,
            universityName: '',
            departmentName: '',
            authorName: '',
            thesisDate: '',
            committeeMembers: [],
          },
          frontMatter: content.frontMatter || [],
          chapters: content.chapters || [],
          backMatter: content.backMatter || [],
        });
      }
    };

    fetchThesis();
  }, []);

  if (!thesis) {
    return null;
  }

  return (
    <div className="relative w-full h-full">
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ duration: 0.5 }}
        className="absolute inset-0"
      >
        {/* Visualization content */}
        <div className="grid grid-cols-3 gap-4 p-4">
          {thesis.chapters.map((chapter, index) => (
            <motion.div
              key={chapter.id}
              initial={{ y: 20, opacity: 0 }}
              animate={{ y: 0, opacity: 1 }}
              transition={{ delay: index * 0.1 }}
              className="p-4 bg-white rounded-lg shadow"
            >
              <h3 className="font-bold">{chapter.title}</h3>
              <p className="text-sm text-gray-600">
                {chapter.sections?.length || 0} sections
              </p>
            </motion.div>
          ))}
        </div>
      </motion.div>
      <style>{`
        .visualization-container {
          position: relative;
          width: 100%;
          height: 100%;
          overflow: hidden;
        }
      `}</style>
    </div>
  );
};

// File: src\components\landing\visualization\ThesisVisualizationDemo.tsx

import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
  BookOpen, Users, CheckSquare, Square, Calendar,
  ChartBar, ChartLine, ChartPie, Clock, AlertCircle,
  FileText, GitBranch, MessageSquare, Award, ArrowUp,
  ArrowDown, Minus
} from 'lucide-react';

// Types
interface Section {
  id: number;
  title: string;
  complete: boolean;
  progress: number;
  lastUpdated: string;
  wordCount: number;
  citations: number;
  summary: string;
}

interface Collaborator {
  id: number;
  role: string;
  active: boolean;
  name: string;
  lastActive: string;
  contributions: number;
  avatar?: string;
}

interface Stat {
  id: number;
  icon: any;
  label: string;
  value: string;
  target: string;
  trend: 'up' | 'down' | 'stable';
  change: string;
}

// Styles
const styles = `
  .thesis-viz {
    --primary-color: #4F46E5;
    --secondary-color: #E5E7EB;
    --success-color: #10B981;
    --warning-color: #F59E0B;
    --error-color: #EF4444;
    --text-primary: #111827;
    --text-secondary: #6B7280;
    --bg-primary: #FFFFFF;
    --bg-secondary: #F9FAFB;
  }

  .thesis-container {
    min-height: 100vh;
    background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
    padding: 2rem;
    overflow: hidden;
  }

  .visualization-wrapper {
    max-width: 1200px;
    margin: 0 auto;
    position: relative;
  }

  .central-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
  }

  .central-icon-pulse {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: var(--primary-color);
    opacity: 0.2;
    animation: pulse 2s infinite;
  }

  .sections-circle {
    position: relative;
    width: 800px;
    height: 800px;
    margin: 0 auto;
  }

  .section-card {
    position: absolute;
    width: 200px;
    background: var(--bg-primary);
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    padding: 1rem;
    transition: all 0.3s ease;
  }

  .section-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  }

  .progress-bar {
    width: 100%;
    height: 4px;
    background: var(--secondary-color);
    border-radius: 2px;
    margin: 0.5rem 0;
    overflow: hidden;
  }

  .progress-bar-fill {
    height: 100%;
    background: var(--primary-color);
    transition: width 0.5s ease;
  }

  .stats-dashboard {
    position: absolute;
    top: 2rem;
    right: 2rem;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
  }

  .stat-card {
    background: var(--bg-primary);
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .collaboration-panel {
    position: absolute;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 1rem;
  }

  .collaborator-card {
    background: var(--bg-primary);
    padding: 0.75rem 1rem;
    border-radius: 999px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .notifications-panel {
    position: fixed;
    top: 2rem;
    right: 2rem;
    background: var(--bg-primary);
    border-radius: 8px;
    padding: 1rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    z-index: 50;
  }

  @keyframes pulse {
    0% {
      transform: scale(1);
      opacity: 0.2;
    }
    50% {
      transform: scale(1.5);
      opacity: 0.1;
    }
    100% {
      transform: scale(1);
      opacity: 0.2;
    }
  }

  @media (max-width: 1024px) {
    .sections-circle {
      transform: scale(0.8);
    }
    
    .stats-dashboard {
      position: relative;
      top: 0;
      right: 0;
      margin-top: 2rem;
    }
  }
`;

export default function EnhancedThesisVisualization() {
  const [hoveredSection, setHoveredSection] = useState<number | null>(null);
  const [showNotifications, setShowNotifications] = useState(false);
  const [activeView, setActiveView] = useState<'progress' | 'timeline' | 'collaboration'>('progress');

  // Data
  const sections: Section[] = [
    {
      id: 1,
      title: 'Introduction',
      complete: true,
      progress: 100,
      lastUpdated: '2024-01-02',
      wordCount: 2500,
      citations: 12,
      summary: 'Research background and objectives'
    },
    {
      id: 2,
      title: 'Literature Review',
      complete: true,
      progress: 100,
      lastUpdated: '2024-01-15',
      wordCount: 4000,
      citations: 45,
      summary: 'Theoretical framework and previous studies'
    },
    {
      id: 3,
      title: 'Methodology',
      complete: false,
      progress: 75,
      lastUpdated: '2024-02-01',
      wordCount: 3000,
      citations: 18,
      summary: 'Research design and methods'
    },
    {
      id: 4,
      title: 'Results',
      complete: false,
      progress: 40,
      lastUpdated: '2024-02-15',
      wordCount: 2000,
      citations: 8,
      summary: 'Data analysis and findings'
    },
    {
      id: 5,
      title: 'Discussion',
      complete: false,
      progress: 20,
      lastUpdated: '2024-02-20',
      wordCount: 1500,
      citations: 15,
      summary: 'Interpretation of results'
    },
    {
      id: 6,
      title: 'Conclusion',
      complete: false,
      progress: 10,
      lastUpdated: '2024-02-25',
      wordCount: 800,
      citations: 5,
      summary: 'Summary and future work'
    }
  ];

  const collaborators: Collaborator[] = [
    {
      id: 1,
      name: 'John Doe',
      role: 'Author',
      active: true,
      lastActive: '2 minutes ago',
      contributions: 156
    },
    {
      id: 2,
      name: 'Dr. Smith',
      role: 'Supervisor',
      active: true,
      lastActive: '1 hour ago',
      contributions: 45
    },
    {
      id: 3,
      name: 'Prof. Johnson',
      role: 'Committee Member',
      active: false,
      lastActive: '2 days ago',
      contributions: 12
    }
  ];

  const stats: Stat[] = [
    {
      id: 1,
      icon: ChartBar,
      label: 'Words',
      value: '13,800',
      target: '20,000',
      trend: 'up',
      change: '+15%'
    },
    {
      id: 2,
      icon: ChartLine,
      label: 'Citations',
      value: '103',
      target: '150',
      trend: 'up',
      change: '+8%'
    },
    {
      id: 3,
      icon: ChartPie,
      label: 'Overall Progress',
      value: '57%',
      target: '100%',
      trend: 'stable',
      change: '0%'
    }
  ];

  // Calculate positions
  const getPositionOnCircle = (index: number, total: number) => {
    const radius = 300;
    const angle = (index * 360) / total;
    const x = Math.cos((angle * Math.PI) / 180) * radius;
    const y = Math.sin((angle * Math.PI) / 180) * radius;
    return { x, y };
  };

  // Animations
  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        duration: 0.5,
        staggerChildren: 0.1
      }
    }
  };

  const itemVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: {
      opacity: 1,
      y: 0,
      transition: {
        duration: 0.5
      }
    }
  };

  // Effects
  useEffect(() => {
    const checkDeadlines = () => {
      const incompleteSections = sections.filter(s => !s.complete);
      if (incompleteSections.length > 0) {
        setShowNotifications(true);
      }
    };

    checkDeadlines();
    const interval = setInterval(checkDeadlines, 3600000);
    return () => clearInterval(interval);
  }, []);

  return (
    <>
      <style>{styles}</style>
      <div className="thesis-container">
        <motion.div
          className="visualization-wrapper"
          variants={containerVariants}
          initial="hidden"
          animate="visible"
        >
          {/* Central Icon */}
          <motion.div 
            className="central-icon"
            whileHover={{ scale: 1.1 }}
          >
            <div className="central-icon-pulse" />
            <BookOpen size={64} className="text-primary" />
          </motion.div>

          {/* Sections Circle */}
          <div className="sections-circle">
            {sections.map((section, index) => {
              const position = getPositionOnCircle(index, sections.length);
              return (
                <motion.div
                  key={section.id}
                  className="section-card"
                  style={{
                    transform: `translate(${position.x}px, ${position.y}px)`
                  }}
                  variants={itemVariants}
                  whileHover={{ scale: 1.05 }}
                  onHoverStart={() => setHoveredSection(section.id)}
                  onHoverEnd={() => setHoveredSection(null)}
                >
                  <div className="section-header">
                    <h3>{section.title}</h3>
                    {section.complete ? (
                      <CheckSquare className="text-success" />
                    ) : (
                      <Square className="text-secondary" />
                    )}
                  </div>
                  <div className="progress-bar">
                    <motion.div
                      className="progress-bar-fill"
                      initial={{ width: 0 }}
                      animate={{ width: `${section.progress}%` }}
                    />
                  </div>
                  <div className="section-details">
                    <span>{section.wordCount} words</span>
                    <span>{section.citations} citations</span>
                  </div>
                </motion.div>
              );
            })}
          </div>

          {/* Stats Dashboard */}
          <motion.div 
            className="stats-dashboard"
            variants={containerVariants}
          >
            {stats.map((stat) => (
              <motion.div
                key={stat.id}
                className="stat-card"
                variants={itemVariants}
              >
                <div className="stat-header">
                  <stat.icon size={20} />
                  <span>{stat.label}</span>
                </div>
                <div className="stat-value">
                  {stat.value}
                  <span className="stat-target">/ {stat.target}</span>
                </div>
                <div className={`stat-trend ${stat.trend}`}>
                  {stat.trend === 'up' && <ArrowUp size={16} />}
                  {stat.trend === 'down' && <ArrowDown size={16} />}
                  {stat.trend === 'stable' && <Minus size={16} />}
                  <span>{stat.change}</span>
                </div>
              </motion.div>
            ))}
          </motion.div>

          {/* Collaboration Panel */}
          <motion.div
            className="collaboration-panel"
            variants={containerVariants}
          >
            {collaborators.map((collaborator) => (
              <motion.div
                key={collaborator.id}
                className="collaborator-card"
                variants={itemVariants}
              >
                <Users size={20} />
                <div className="collaborator-info">
                  <span>{collaborator.name}</span>
                  <span>{collaborator.role}</span>
                </div>
                {collaborator.active && (
                  <div className="active-indicator" />
                )}
              </motion.div>
            ))}
          </motion.div>

          {/* Notifications */}
          <AnimatePresence>
            {showNotifications && (
              <motion.div
                className="notifications-panel"
                initial={{ opacity: 0, x: 100 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, x: 100 }}
              >
                <div className="notification-header">
                  <AlertCircle size={20} />
                  <span>Thesis Updates</span>
                </div>
                <div className="notification-content">
                  {sections
                    .filter(s => !s.complete)
                    .map(section => (
                      <div key={section.id} className="notification-item">
                        <span>{section.title} needs attention</span>
                        <span>{section.progress}% complete</span>
                      </div>
                    ))
                  }
                </div>
              </motion.div>
            )}
          </AnimatePresence>
        </motion.div>
      </div>
    </>
  );
}

// File: src\components\landing\visualization\TimelineIndicator.tsx

import React from "react";
import { motion } from "framer-motion";
import { Calendar, Clock } from "lucide-react";

export const TimelineIndicator = () => {
  // Calculate progress (example: 3 months in, 2 months left = 60% complete)
  const timeProgress = 60;

  return (
    <motion.div
      initial={{ opacity: 0, scale: 0.8 }}
      animate={{ opacity: 1, scale: 1 }}
      transition={{ delay: 1 }}
      className="absolute left-1/2 top-1/2 transform -translate-x-1/2 translate-y-[80px] w-[200px]"
    >
      <div className="relative">
        {/* Circular Progress */}
        <svg className="w-full h-24" viewBox="0 0 100 100">
          {/* Background circle */}
          <circle
            cx="50"
            cy="50"
            r="45"
            fill="none"
            stroke="rgba(255,255,255,0.2)"
            strokeWidth="8"
          />
          {/* Progress circle */}
          <motion.circle
            cx="50"
            cy="50"
            r="45"
            fill="none"
            stroke="rgba(79,70,229,0.6)"
            strokeWidth="8"
            strokeLinecap="round"
            strokeDasharray={`${timeProgress * 2.83}, 283`}
            transform="rotate(-90 50 50)"
            initial={{ strokeDasharray: "0, 283" }}
            animate={{ strokeDasharray: `${timeProgress * 2.83}, 283` }}
            transition={{ duration: 1.5, ease: "easeInOut" }}
          />
          {/* Center content */}
          <foreignObject x="25" y="25" width="50" height="50">
            <div className="h-full flex items-center justify-center">
              <Clock className="w-6 h-6 text-primary/70" />
            </div>
          </foreignObject>
        </svg>

        {/* Timeline details */}
        <motion.div
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 1.2 }}
          className="absolute -bottom-12 left-1/2 transform -translate-x-1/2 w-full text-center"
        >
          <div className="bg-white/80 backdrop-blur-sm px-3 py-2 rounded-lg shadow-sm border border-primary/10">
            <div className="flex items-center justify-center gap-2 mb-1">
              <Calendar className="text-primary/70 h-3 w-3" />
              <span className="text-[10px] font-medium text-gray-700">Timeline</span>
            </div>
            <div className="space-y-0.5">
              <p className="text-[9px] text-gray-500">2 months remaining</p>
              <div className="flex items-center justify-center gap-1">
                <span className="text-[9px] text-primary/70 font-medium">{timeProgress}%</span>
                <span className="text-[9px] text-gray-400">complete</span>
              </div>
            </div>
          </div>
        </motion.div>
      </div>
    </motion.div>
  );
};

// File: src\components\LanguageSwitcher.tsx

import { Button } from "@/components/ui/button";
import { useLanguage } from "@/contexts/LanguageContext";

export function LanguageSwitcher() {
  const { language, setLanguage } = useLanguage();

  return (
    <div className="flex gap-2">
      <Button
        variant={language === 'en' ? "default" : "outline"}
        size="sm"
        onClick={() => setLanguage('en')}
      >
        EN
      </Button>
      <Button
        variant={language === 'fr' ? "default" : "outline"}
        size="sm"
        onClick={() => setLanguage('fr')}
      >
        FR
      </Button>
      <Button
        variant={language === 'ar' ? "default" : "outline"}
        size="sm"
        onClick={() => setLanguage('ar')}
      >
        Ø¹Ø±Ø¨ÙŠ
      </Button>
    </div>
  );
}

// File: src\components\loading\LoadingProgress.tsx

import { useState, useEffect } from 'react';
import { Progress } from "@/components/ui/progress";

export const LoadingProgress = () => {
  const [progress, setProgress] = useState(0);

  useEffect(() => {
    const timer = setInterval(() => {
      setProgress((oldProgress) => {
        // Slow down progress as it gets closer to 90%
        const increment = Math.max(1, (90 - oldProgress) / 10);
        const newProgress = Math.min(oldProgress + increment, 90);
        return newProgress;
      });
    }, 200);

    return () => clearInterval(timer);
  }, []);

  return (
    <div className="w-full space-y-4">
      <Progress value={progress} className="w-full h-2" />
      <p className="text-sm text-muted-foreground text-center animate-pulse">
        Loading your content...
      </p>
    </div>
  );
};

// File: src\components\loading\LoadingSkeleton.tsx

import { motion } from "framer-motion";
import { LoadingProgress } from "./LoadingProgress";

export const LoadingSkeleton = () => (
  <motion.div
    initial={{ opacity: 0 }}
    animate={{ opacity: 1 }}
    exit={{ opacity: 0 }}
    className="min-h-screen bg-background p-8 flex items-center justify-center"
  >
    <div className="container mx-auto max-w-xl space-y-8">
      <LoadingProgress />
      <div className="space-y-6">
        {[1, 2, 3].map((i) => (
          <motion.div
            key={i}
            initial={{ y: 20, opacity: 0 }}
            animate={{ y: 0, opacity: 1 }}
            transition={{ delay: i * 0.1 }}
            className="bg-card rounded-lg p-6 shadow-lg"
          >
            <div className="space-y-3">
              <div className="h-4 w-24 bg-muted rounded animate-pulse" />
              <div className="h-8 w-16 bg-muted rounded animate-pulse" />
              <div className="h-4 w-32 bg-muted rounded animate-pulse" />
            </div>
          </motion.div>
        ))}
      </div>
    </div>
  </motion.div>
);

// File: src\components\MarkdownEditor.tsx

import React from 'react';
import MDEditor, { commands, ICommand, PreviewType } from '@uiw/react-md-editor';
import { motion } from 'framer-motion';
import { Card } from './ui/card';
import rehypeSanitize from 'rehype-sanitize';

interface EditorProps {
  value: string;
  onChange: (value: string | undefined) => void;
  placeholder?: string;
  readOnly?: boolean;
  preview?: PreviewType;
}

export const MarkdownEditor: React.FC<EditorProps> = ({
  value,
  onChange,
  placeholder,
  readOnly = false,
  preview = "live"
}) => {
  console.log('MarkdownEditor rendering with:', { valueLength: value?.length, readOnly });

  const extraCommands: ICommand[] = [
    commands.title1,
    commands.title2,
    commands.title3,
    commands.title4,
    commands.title5,
    commands.title6,
    commands.divider,
    commands.group([
      commands.title1,
      commands.title2,
      commands.title3,
      commands.title4,
      commands.title5,
      commands.title6,
    ], {
      name: 'title',
      groupName: 'title',
      buttonProps: { 'aria-label': 'Insert title' },
    }),
    commands.group([
      commands.orderedListCommand,
      commands.unorderedListCommand,
      commands.checkedListCommand,
    ], {
      name: 'list',
      groupName: 'list',
      buttonProps: { 'aria-label': 'Insert list' },
    }),
  ];

  return (
    <Card className="w-full">
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ duration: 0.3 }}
        className="w-full"
      >
        <MDEditor
          value={value}
          onChange={onChange}
          commands={extraCommands}
          preview={preview}
          hideToolbar={readOnly}
          textareaProps={{
            placeholder: placeholder || 'Start writing...',
            'aria-label': 'Markdown editor',
            readOnly: readOnly
          }}
          previewOptions={{
            rehypePlugins: [[rehypeSanitize as any]]
          }}
          className="w-full min-h-[200px]"
        />
      </motion.div>
    </Card>
  );
};

// File: src\components\onboarding\GettingStartedWizard.tsx

import React from 'react';
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Progress } from "@/components/ui/progress";
import { CheckCircle2, Circle } from "lucide-react";

interface WizardStep {
  title: string;
  description: string;
  completed: boolean;
}

export const GettingStartedWizard = () => {
  const [steps, setSteps] = React.useState<WizardStep[]>([
    {
      title: "Create Your Profile",
      description: "Set up your academic profile and preferences",
      completed: false
    },
    {
      title: "Choose Your Template",
      description: "Select a thesis template that matches your needs",
      completed: false
    },
    {
      title: "Set Up Chapters",
      description: "Organize your thesis structure with chapters and sections",
      completed: false
    },
    {
      title: "Add Collaborators",
      description: "Invite supervisors or co-authors to your project",
      completed: false
    }
  ]);

  const progress = (steps.filter(step => step.completed).length / steps.length) * 100;

  const toggleStep = (index: number) => {
    const newSteps = [...steps];
    newSteps[index].completed = !newSteps[index].completed;
    setSteps(newSteps);
  };

  return (
    <Card className="w-full max-w-2xl mx-auto">
      <CardHeader>
        <CardTitle>Getting Started</CardTitle>
        <CardDescription>
          Complete these steps to set up your thesis project
        </CardDescription>
      </CardHeader>
      <CardContent>
        <Progress value={progress} className="mb-4" />
        <div className="space-y-4">
          {steps.map((step, index) => (
            <div
              key={index}
              className="flex items-center space-x-4 p-4 rounded-lg hover:bg-accent cursor-pointer"
              onClick={() => toggleStep(index)}
            >
              {step.completed ? (
                <CheckCircle2 className="h-6 w-6 text-primary" />
              ) : (
                <Circle className="h-6 w-6 text-muted-foreground" />
              )}
              <div>
                <h3 className="font-medium">{step.title}</h3>
                <p className="text-sm text-muted-foreground">
                  {step.description}
                </p>
              </div>
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  );
};

// File: src\components\onboarding\GuidedTour.tsx

import React from 'react';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { useToast } from "@/hooks/use-toast";

interface TourStep {
  title: string;
  description: string;
  target: string;
}

const tourSteps: TourStep[] = [
  {
    title: "Welcome to Your Thesis Journey",
    description: "Let's take a quick tour of the main features to help you get started.",
    target: "welcome-step"
  },
  {
    title: "Create Your First Thesis",
    description: "Click here to start a new thesis project. You can choose from various templates or start from scratch.",
    target: "create-thesis"
  },
  {
    title: "Organize Your Content",
    description: "Use the sidebar to navigate through different sections of your thesis.",
    target: "thesis-sidebar"
  },
  {
    title: "Collaborate with Others",
    description: "Invite collaborators to work on your thesis in real-time.",
    target: "collaboration"
  }
];

export const GuidedTour = () => {
  const [isOpen, setIsOpen] = React.useState(true);
  const [currentStep, setCurrentStep] = React.useState(0);
  const { toast } = useToast();

  const handleNext = () => {
    if (currentStep < tourSteps.length - 1) {
      setCurrentStep(currentStep + 1);
    } else {
      setIsOpen(false);
      toast({
        title: "Tour Completed!",
        description: "You're now ready to start working on your thesis.",
      });
    }
  };

  const handleSkip = () => {
    setIsOpen(false);
    toast({
      title: "Tour Skipped",
      description: "You can restart the tour anytime from the help menu.",
    });
  };

  return (
    <Dialog open={isOpen} onOpenChange={setIsOpen}>
      <DialogContent className="sm:max-w-[425px]">
        <DialogHeader>
          <DialogTitle>{tourSteps[currentStep].title}</DialogTitle>
          <DialogDescription>
            {tourSteps[currentStep].description}
          </DialogDescription>
        </DialogHeader>
        <div className="flex justify-between mt-4">
          <Button variant="outline" onClick={handleSkip}>
            Skip Tour
          </Button>
          <Button onClick={handleNext}>
            {currentStep === tourSteps.length - 1 ? "Finish" : "Next"}
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  );
};

// File: src\components\reference\ReferenceCard.tsx

import React, { useState } from 'react';
import { Reference } from '@/types/thesis';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { BookOpen, Trash2, Edit2, ExternalLink } from 'lucide-react';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { TagInput } from '@/components/ui/tag-input';
import { useToast } from '@/hooks/use-toast';

interface ReferenceCardProps {
  reference: Reference;
  onRemove: (id: string) => void;
  onUpdate: (reference: Reference) => void;
  onClick?: (reference: Reference) => void;
}

export const ReferenceCard = ({ reference, onRemove, onUpdate, onClick }: ReferenceCardProps) => {
  const [isEditing, setIsEditing] = React.useState(false);
  const { toast } = useToast();
  const [editedReference, setEditedReference] = React.useState<Reference>(reference);

  const handleClick = () => {
    if (!isEditing && onClick) {
      onClick(reference);
    }
  };

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' || e.key === ' ') {
      handleClick();
    }
  };

  const handleSave = () => {
    onUpdate(editedReference);
    setIsEditing(false);
    toast({
      title: "Reference Updated",
      description: "The reference has been successfully updated.",
    });
  };

  const handleCancel = () => {
    setEditedReference(reference);
    setIsEditing(false);
  };

  const handleChange = (field: keyof Reference, value: any) => {
    setEditedReference(prev => ({
      ...prev,
      [field]: value
    }));
  };

  return (
    <Card 
      className={`group relative border-2 border-editor-border transition-all duration-200 hover:shadow-lg ${!isEditing ? 'cursor-pointer hover:border-primary/50' : ''}`}
      onClick={handleClick}
      onKeyPress={handleKeyPress}
      tabIndex={isEditing ? -1 : 0}
      role={isEditing ? undefined : 'button'}
    >
      <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
        <CardTitle className="text-sm font-medium">
          <BookOpen className="w-4 h-4 inline mr-2" />
          {reference.type.charAt(0).toUpperCase() + reference.type.slice(1)}
        </CardTitle>
        <div className="flex gap-2 opacity-0 transition-opacity group-hover:opacity-100">
          <Button
            variant="ghost"
            size="sm"
            onClick={(e) => {
              e.stopPropagation();
              setIsEditing(!isEditing);
            }}
            className="h-8 w-8 p-0"
          >
            <Edit2 className="h-4 w-4" />
          </Button>
          <Button
            variant="ghost"
            size="sm"
            onClick={(e) => {
              e.stopPropagation();
              onRemove(reference.id);
            }}
            className="h-8 w-8 p-0"
          >
            <Trash2 className="h-4 w-4" />
          </Button>
          {reference.url && (
            <Button
              variant="ghost"
              size="sm"
              onClick={(e) => {
                e.stopPropagation();
                window.open(reference.url, '_blank');
              }}
              className="h-8 w-8 p-0"
            >
              <ExternalLink className="h-4 w-4" />
            </Button>
          )}
        </div>
      </CardHeader>
      <CardContent>
        {isEditing ? (
          <div className="space-y-4 animate-fade-in">
            <Select
              value={editedReference.type}
              onValueChange={(value: any) => handleChange('type', value)}
            >
              <SelectTrigger>
                <SelectValue placeholder="Type" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="article">Article</SelectItem>
                <SelectItem value="book">Book</SelectItem>
                <SelectItem value="conference">Conference</SelectItem>
                <SelectItem value="thesis">Thesis</SelectItem>
                <SelectItem value="website">Website</SelectItem>
                <SelectItem value="other">Other</SelectItem>
              </SelectContent>
            </Select>
            <Input
              placeholder="Title"
              value={editedReference.title}
              onChange={(e) => handleChange('title', e.target.value)}
            />
            <TagInput
              placeholder="Authors (comma-separated)"
              tags={editedReference.authors}
              onChange={(tags) => handleChange('authors', tags)}
            />
            <Input
              placeholder="Year"
              value={editedReference.year}
              onChange={(e) => handleChange('year', e.target.value)}
            />
            {editedReference.type === 'article' && (
              <>
                <Input
                  placeholder="DOI"
                  value={editedReference.doi || ''}
                  onChange={(e) => handleChange('doi', e.target.value)}
                />
                <Input
                  placeholder="Journal"
                  value={editedReference.journal || ''}
                  onChange={(e) => handleChange('journal', e.target.value)}
                />
                <div className="grid grid-cols-3 gap-2">
                  <Input
                    placeholder="Volume"
                    value={editedReference.volume || ''}
                    onChange={(e) => handleChange('volume', e.target.value)}
                  />
                  <Input
                    placeholder="Issue"
                    value={editedReference.issue || ''}
                    onChange={(e) => handleChange('issue', e.target.value)}
                  />
                  <Input
                    placeholder="Pages"
                    value={editedReference.pages || ''}
                    onChange={(e) => handleChange('pages', e.target.value)}
                  />
                </div>
              </>
            )}
            {(editedReference.type === 'website' || editedReference.type === 'other') && (
              <Input
                placeholder="URL"
                value={editedReference.url || ''}
                onChange={(e) => handleChange('url', e.target.value)}
              />
            )}
            <div className="flex justify-end gap-2">
              <Button
                variant="outline"
                size="sm"
                onClick={handleCancel}
              >
                Cancel
              </Button>
              <Button
                size="sm"
                onClick={handleSave}
              >
                Save
              </Button>
            </div>
          </div>
        ) : (
          <div className="space-y-2">
            <h4 className="font-medium">{reference.title}</h4>
            <p className="text-sm text-muted-foreground">
              {reference.authors.join(', ')} ({reference.year})
            </p>
            {reference.journal && (
              <p className="text-sm italic">{reference.journal}</p>
            )}
            {reference.doi && (
              <p className="text-sm">DOI: {reference.doi}</p>
            )}
            {reference.url && (
              <p className="text-sm">
                <a 
                  href={reference.url} 
                  target="_blank" 
                  rel="noopener noreferrer" 
                  className="text-primary hover:underline"
                  onClick={(e) => e.stopPropagation()}
                >
                  {reference.url}
                </a>
              </p>
            )}
          </div>
        )}
      </CardContent>
    </Card>
  );
};

// File: src\components\reference\ReferenceDialog.tsx

import React, { useState } from 'react';
import { Reference } from '@/types/thesis';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Input } from '@/components/ui/input';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { PlusCircle } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { parseReference } from '@/utils/referenceParser';
import { Card } from '@/components/ui/card';
import { TagInput } from '@/components/ui/tag-input';

interface ReferenceDialogProps {
  onAddReference: (reference: Reference) => void;
}

export const ReferenceDialog = ({ onAddReference }: ReferenceDialogProps) => {
  const [rawText, setRawText] = useState('');
  const [parsedReference, setParsedReference] = useState<any>(null);
  const [isOpen, setIsOpen] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const { toast } = useToast();

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    
    try {
      console.log('Attempting to parse reference:', rawText);
      const parsed = parseReference(rawText);
      
      if (!parsed.title || !parsed.authors.length) {
        throw new Error('Could not parse required fields from reference');
      }

      setParsedReference(parsed);
      setIsEditing(true);
      console.log('Parsed reference:', parsed);

    } catch (error) {
      console.error('Error parsing reference:', error);
      toast({
        title: "Parsing Error",
        description: "Could not parse the reference. Please check the format.",
        variant: "destructive"
      });
    }
  };

  const handleAddReference = () => {
    if (!parsedReference) return;

    const newReference: Reference = {
      id: crypto.randomUUID(),
      text: rawText,
      title: parsedReference.title,
      source: parsedReference.journal || 'Unknown',
      authors: parsedReference.authors,
      year: parsedReference.year,
      type: 'article',
      doi: parsedReference.doi,
      url: parsedReference.url,
      journal: parsedReference.journal,
      volume: parsedReference.volume,
      issue: parsedReference.issue,
      pages: parsedReference.pages,
      publisher: parsedReference.publisher,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString(),
    };

    onAddReference(newReference);
    setRawText('');
    setParsedReference(null);
    setIsEditing(false);
    setIsOpen(false);
    
    toast({
      title: "Reference Added",
      description: "Successfully added the reference",
    });
  };

  const handleUpdateParsedField = (field: string, value: any) => {
    setParsedReference(prev => ({
      ...prev,
      [field]: value
    }));
  };

  return (
    <Dialog open={isOpen} onOpenChange={setIsOpen}>
      <DialogTrigger asChild>
        <Button variant="outline" size="sm" className="gap-2">
          <PlusCircle className="w-4 h-4" />
          Add Reference
        </Button>
      </DialogTrigger>
      <DialogContent className="sm:max-w-[625px]">
        <DialogHeader>
          <DialogTitle>Add New Reference</DialogTitle>
        </DialogHeader>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="space-y-2">
            <label className="text-sm font-medium">Reference Text</label>
            <Textarea
              value={rawText}
              onChange={(e) => setRawText(e.target.value)}
              placeholder="Paste your reference text here..."
              className="min-h-[100px]"
            />
            <p className="text-sm text-muted-foreground">
              Paste any formatted reference (APA, MLA, Chicago, etc.) and we'll automatically parse it.
            </p>
          </div>
          
          <div className="flex gap-2">
            <Button type="submit" variant="outline">Parse Reference</Button>
            {parsedReference && (
              <Button type="button" onClick={handleAddReference}>
                Add Reference
              </Button>
            )}
          </div>

          {parsedReference && isEditing && (
            <Card className="p-4 mt-4 space-y-4 text-sm">
              <div className="space-y-2">
                <h4 className="font-semibold">Authors:</h4>
                <TagInput
                  placeholder="Add authors"
                  tags={parsedReference.authors}
                  onChange={(tags) => handleUpdateParsedField('authors', tags)}
                />
              </div>
              
              <div>
                <h4 className="font-semibold">Year:</h4>
                <Input
                  value={parsedReference.year}
                  onChange={(e) => handleUpdateParsedField('year', e.target.value)}
                  className="mt-1"
                />
              </div>
              
              <div>
                <h4 className="font-semibold">Title:</h4>
                <Input
                  value={parsedReference.title}
                  onChange={(e) => handleUpdateParsedField('title', e.target.value)}
                  className="mt-1"
                />
              </div>
              
              <div>
                <h4 className="font-semibold">Journal:</h4>
                <Input
                  value={parsedReference.journal || ''}
                  onChange={(e) => handleUpdateParsedField('journal', e.target.value)}
                  className="mt-1"
                />
              </div>
              
              <div className="grid grid-cols-3 gap-4">
                <div>
                  <h4 className="font-semibold">Volume:</h4>
                  <Input
                    value={parsedReference.volume || ''}
                    onChange={(e) => handleUpdateParsedField('volume', e.target.value)}
                    className="mt-1"
                  />
                </div>
                <div>
                  <h4 className="font-semibold">Issue:</h4>
                  <Input
                    value={parsedReference.issue || ''}
                    onChange={(e) => handleUpdateParsedField('issue', e.target.value)}
                    className="mt-1"
                  />
                </div>
                <div>
                  <h4 className="font-semibold">Pages:</h4>
                  <Input
                    value={parsedReference.pages || ''}
                    onChange={(e) => handleUpdateParsedField('pages', e.target.value)}
                    className="mt-1"
                  />
                </div>
              </div>
              
              <div>
                <h4 className="font-semibold">DOI:</h4>
                <Input
                  value={parsedReference.doi || ''}
                  onChange={(e) => handleUpdateParsedField('doi', e.target.value)}
                  className="mt-1"
                />
              </div>
              
              <div>
                <h4 className="font-semibold">URL:</h4>
                <Input
                  value={parsedReference.url || ''}
                  onChange={(e) => handleUpdateParsedField('url', e.target.value)}
                  className="mt-1"
                />
              </div>
              
              <div>
                <h4 className="font-semibold">Publisher:</h4>
                <Input
                  value={parsedReference.publisher || ''}
                  onChange={(e) => handleUpdateParsedField('publisher', e.target.value)}
                  className="mt-1"
                />
              </div>
            </Card>
          )}
        </form>
      </DialogContent>
    </Dialog>
  );
};

// File: src\components\ReferenceManager.tsx

import React, { useState } from 'react';
import { Reference } from '@/types/thesis';
import { ReferenceDialog } from './reference/ReferenceDialog';
import { ReferenceCard } from './reference/ReferenceCard';
import { ReferenceManagerProps } from '@/types/components';
import { motion, AnimatePresence } from 'framer-motion';
import { Card } from './ui/card';
import { ScrollArea } from './ui/scroll-area';
import { BookOpen } from 'lucide-react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";

export const ReferenceManager: React.FC<ReferenceManagerProps> = ({
  items,
  onAdd,
  onRemove,
  onUpdate
}) => {
  const [selectedReference, setSelectedReference] = useState<Reference | null>(null);

  const handleReferenceClick = (reference: Reference) => {
    setSelectedReference(reference);
  };

  return (
    <Card className="p-6 space-y-6 bg-white/50 backdrop-blur-sm border-2 border-primary/10 shadow-xl rounded-xl">
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.3 }}
        className="flex justify-between items-center"
      >
        <div className="flex items-center gap-3">
          <div className="p-2 bg-primary/10 rounded-full">
            <BookOpen className="w-5 h-5 text-primary" />
          </div>
          <h3 className="text-lg font-serif font-medium text-primary">References</h3>
        </div>
        <ReferenceDialog onAddReference={onAdd} />
      </motion.div>

      <ScrollArea className="h-[600px] pr-4">
        <AnimatePresence mode="wait">
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ delay: 0.2 }}
            className="grid grid-cols-1 md:grid-cols-2 gap-4"
          >
            {items.map((reference, index) => (
              <motion.div
                key={reference.id}
                initial={{ opacity: 0, x: -20 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, x: 20 }}
                transition={{ duration: 0.2, delay: index * 0.1 }}
              >
                <ReferenceCard
                  reference={reference}
                  onRemove={onRemove}
                  onUpdate={onUpdate}
                  onClick={handleReferenceClick}
                />
              </motion.div>
            ))}
          </motion.div>
        </AnimatePresence>
      </ScrollArea>

      <Dialog open={!!selectedReference} onOpenChange={() => setSelectedReference(null)}>
        <DialogContent className="sm:max-w-[600px]">
          <DialogHeader>
            <DialogTitle>Reference Details</DialogTitle>
          </DialogHeader>
          {selectedReference && (
            <div className="space-y-4">
              <div className="space-y-2">
                <h4 className="font-medium text-lg">{selectedReference.title}</h4>
                <p className="text-muted-foreground">
                  {selectedReference.authors.join(', ')} ({selectedReference.year})
                </p>
                {selectedReference.journal && (
                  <p className="italic">{selectedReference.journal}</p>
                )}
                {selectedReference.doi && (
                  <p className="text-sm">DOI: {selectedReference.doi}</p>
                )}
                {selectedReference.url && (
                  <p className="text-sm">
                    <a
                      href={selectedReference.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-primary hover:underline"
                    >
                      {selectedReference.url}
                    </a>
                  </p>
                )}
                {selectedReference.volume && selectedReference.issue && (
                  <p className="text-sm">
                    Volume: {selectedReference.volume}, Issue: {selectedReference.issue}
                  </p>
                )}
                {selectedReference.pages && (
                  <p className="text-sm">Pages: {selectedReference.pages}</p>
                )}
                {selectedReference.publisher && (
                  <p className="text-sm">Publisher: {selectedReference.publisher}</p>
                )}
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>
    </Card>
  );
};

// File: src\components\review\CommentInput.tsx

import React, { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Card } from '@/components/ui/card';
import { Profile } from '@/types/profile';

interface CommentInputProps {
  onSubmit: (content: string) => Promise<void>;
}

export const CommentInput = ({ onSubmit }: CommentInputProps) => {
  const [newComment, setNewComment] = useState('');

  const handleSubmit = async () => {
    if (!newComment.trim()) return;
    await onSubmit(newComment);
    setNewComment('');
  };

  return (
    <Card className="p-4">
      <Textarea
        value={newComment}
        onChange={(e) => setNewComment(e.target.value)}
        placeholder="Add your comment..."
        className="mb-2"
      />
      <Button onClick={handleSubmit}>
        Submit Comment
      </Button>
    </Card>
  );
};

// File: src\components\review\CommentList.tsx

import React from 'react';
import { CommentThread } from '@/types/thesis';
import { Profile } from '@/types/profile';
import { CommentThread as CommentThreadComponent } from './CommentThread';

interface CommentListProps {
  comments: CommentThread[];
  currentUser: Profile | null;
  thesisId: string;
  sectionId: string;
}

export const CommentList = ({ 
  comments, 
  currentUser,
  thesisId,
  sectionId 
}: CommentListProps) => {
  return (
    <div className="space-y-6">
      {comments.map((thread) => (
        <CommentThreadComponent
          key={thread.id}
          thread={thread}
          currentUser={currentUser}
          thesisId={thesisId}
          sectionId={sectionId}
        />
      ))}
    </div>
  );
};

// File: src\components\review\CommentThread.tsx

import React, { useState } from 'react';
import { Profile } from '@/types/profile';
import type { CommentThread as CommentThreadType } from '@/types/thesis';
import { Card } from '@/components/ui/card';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/hooks/use-toast';

interface CommentThreadProps {
  thread: CommentThreadType;
  currentUser: Profile | null;
  thesisId: string;
  sectionId: string;
}

export const CommentThread = ({
  thread,
  currentUser,
  thesisId,
  sectionId
}: CommentThreadProps) => {
  const [replyContent, setReplyContent] = useState('');
  const [showReplyForm, setShowReplyForm] = useState(false);
  const { toast } = useToast();

  const handleReply = async () => {
    if (!currentUser || !replyContent.trim()) return;

    try {
      const { data, error } = await supabase
        .from('thesis_reviews')
        .insert({
          thesis_id: thesisId,
          section_id: sectionId,
          reviewer_id: currentUser.id,
          content: { text: replyContent },
          parent_id: thread.id,
          status: 'pending'
        })
        .select()
        .single();

      if (error) throw error;

      toast({
        title: "Reply added",
        description: "Your reply has been posted successfully.",
      });

      setReplyContent('');
      setShowReplyForm(false);
    } catch (error: any) {
      console.error('Error adding reply:', error);
      toast({
        title: "Error",
        description: "Failed to post reply. Please try again.",
        variant: "destructive",
      });
    }
  };

  const mainComment = thread.comments[0];

  return (
    <div className="space-y-4">
      <Card className="p-4">
        <div className="flex items-start space-x-4">
          <Avatar>
            <AvatarFallback>
              {mainComment.user_id.substring(0, 2).toUpperCase()}
            </AvatarFallback>
          </Avatar>
          <div className="flex-1">
            <div className="prose prose-sm">
              <p>{mainComment.content}</p>
            </div>
            <Button
              variant="ghost"
              size="sm"
              onClick={() => setShowReplyForm(!showReplyForm)}
            >
              Reply
            </Button>
          </div>
        </div>
      </Card>

      {thread.comments.slice(1).map((reply) => (
        <Card key={reply.id} className="p-4 ml-8">
          <div className="flex items-start space-x-4">
            <Avatar>
              <AvatarFallback>
                {reply.user_id.substring(0, 2).toUpperCase()}
              </AvatarFallback>
            </Avatar>
            <div className="flex-1 prose prose-sm">
              <p>{reply.content}</p>
            </div>
          </div>
        </Card>
      ))}

      {showReplyForm && (
        <div className="ml-8 space-y-2">
          <Textarea
            value={replyContent}
            onChange={(e) => setReplyContent(e.target.value)}
            placeholder="Write your reply..."
            className="min-h-[100px]"
          />
          <div className="flex justify-end space-x-2">
            <Button
              variant="outline"
              onClick={() => setShowReplyForm(false)}
            >
              Cancel
            </Button>
            <Button onClick={handleReply}>
              Post Reply
            </Button>
          </div>
        </div>
      )}
    </div>
  );
};

// File: src\components\review\ReviewerInterface.tsx

import React, { useState, useEffect } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/hooks/use-toast';
import { Profile } from '@/types/profile';
import { CommentThread } from '@/types/thesis';
import { CommentList } from './CommentList';
import { CommentInput } from './CommentInput';
import { transformComment } from '@/utils/commentTransforms';

interface ReviewerInterfaceProps {
  thesisId: string;
  sectionId: string;
}

export const ReviewerInterface = ({ thesisId, sectionId }: ReviewerInterfaceProps) => {
  const [comments, setComments] = useState<CommentThread[]>([]);
  const [loading, setLoading] = useState(true);
  const [profile, setProfile] = useState<Profile | null>(null);
  const { toast } = useToast();

  useEffect(() => {
    const fetchComments = async () => {
      try {
        console.log('Fetching comments for thesis:', thesisId, 'section:', sectionId);
        const { data: commentsData, error: commentsError } = await supabase
          .from('thesis_reviews')
          .select(`
            *,
            profiles (
              email,
              roles (
                name
              )
            )
          `)
          .eq('thesis_id', thesisId)
          .eq('section_id', sectionId)
          .order('created_at', { ascending: true });

        if (commentsError) {
          console.error('Error fetching comments:', commentsError);
          throw commentsError;
        }

        console.log('Fetched comments:', commentsData);
        
        // Transform the flat comments into threads
        const threads: CommentThread[] = commentsData.map((comment: any) => ({
          id: comment.id,
          comments: [transformComment(comment)],
          section_id: comment.section_id,
          created_at: comment.created_at
        }));

        setComments(threads);

        const { data: profileData, error: profileError } = await supabase
          .from('profiles')
          .select(`
            *,
            roles (
              name
            )
          `)
          .eq('id', (await supabase.auth.getUser()).data.user?.id)
          .single();

        if (profileError) {
          console.error('Error fetching profile:', profileError);
          throw profileError;
        }

        console.log('Fetched profile:', profileData);
        setProfile(profileData);
      } catch (error) {
        console.error('Error in fetchComments:', error);
        toast({
          title: "Error",
          description: "Failed to load comments",
          variant: "destructive",
        });
      } finally {
        setLoading(false);
      }
    };

    fetchComments();
  }, [thesisId, sectionId, toast]);

  const handleSubmitComment = async (content: string) => {
    try {
      console.log('Submitting new comment');
      const { data, error } = await supabase
        .from('thesis_reviews')
        .insert([
          {
            thesis_id: thesisId,
            section_id: sectionId,
            reviewer_id: profile?.id,
            content: { text: content },
            status: 'pending'
          }
        ])
        .select(`
          *,
          profiles (
            email,
            roles (
              name
            )
          )
        `)
        .single();

      if (error) throw error;

      console.log('New comment submitted:', data);
      
      // Add the new comment as a thread
      const newThread: CommentThread = {
        id: data.id,
        comments: [transformComment(data)],
        section_id: data.section_id,
        created_at: data.created_at
      };
      
      setComments([...comments, newThread]);
      
      toast({
        title: "Success",
        description: "Comment added successfully",
      });
    } catch (error) {
      console.error('Error submitting comment:', error);
      toast({
        title: "Error",
        description: "Failed to submit comment",
        variant: "destructive",
      });
    }
  };

  if (loading) {
    return <div>Loading comments...</div>;
  }

  return (
    <div className="space-y-4">
      <CommentList 
        comments={comments}
        currentUser={profile}
        thesisId={thesisId}
        sectionId={sectionId}
      />
      <CommentInput onSubmit={handleSubmitComment} />
    </div>
  );
};

// File: src\components\shared\Navbar.tsx

import { Link } from "react-router-dom";
import { Button } from "@/components/ui/button";
import { Menu } from "lucide-react";
import { useState } from "react";
import { useTranslation } from "@/hooks/useTranslation";
import { LanguageSwitcher } from "@/components/LanguageSwitcher";

export const Navbar = () => {
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const { t } = useTranslation();

  return (
    <nav className="fixed top-0 left-0 right-0 w-full bg-[#1A1F2C] text-white z-50">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 w-full">
        <div className="flex justify-between items-center h-16">
          <Link to="/" className="text-2xl font-bold text-[#9b87f5] hover:text-[#D6BCFA] transition-colors">
            Thesis Visualizer
          </Link>

          {/* Mobile menu button */}
          <div className="md:hidden">
            <Button
              variant="ghost"
              size="icon"
              onClick={() => setIsMenuOpen(!isMenuOpen)}
              className="text-white hover:bg-[#2A2F3C] hover:text-[#D6BCFA]"
            >
              <Menu className="h-6 w-6" />
            </Button>
          </div>

          {/* Desktop menu */}
          <div className="hidden md:flex items-center space-x-4">
            <Link to="/" className="hover:text-[#D6BCFA] transition-colors">
              {t('common.features')}
            </Link>
            <Link to="/" className="hover:text-[#D6BCFA] transition-colors">
              {t('common.about')}
            </Link>
            <LanguageSwitcher />
            <Link to="/">
              <Button 
                variant="outline" 
                className="bg-transparent text-white border-[#9b87f5] hover:bg-[#9b87f5] hover:text-white transition-all duration-200"
              >
                {t('common.home')}
              </Button>
            </Link>
          </div>
        </div>

        {/* Mobile menu */}
        {isMenuOpen && (
          <div className="md:hidden py-4 border-t border-[#2A2F3C]">
            <div className="flex flex-col space-y-4 px-4">
              <Link
                to="/"
                className="hover:text-[#D6BCFA] transition-colors"
                onClick={() => setIsMenuOpen(false)}
              >
                {t('common.features')}
              </Link>
              <Link
                to="/"
                className="hover:text-[#D6BCFA] transition-colors"
                onClick={() => setIsMenuOpen(false)}
              >
                {t('common.about')}
              </Link>
              <div className="py-2">
                <LanguageSwitcher />
              </div>
              <Link to="/" onClick={() => setIsMenuOpen(false)}>
                <Button
                  variant="outline"
                  className="w-full bg-transparent text-white border-[#9b87f5] hover:bg-[#9b87f5] hover:text-white transition-all duration-200"
                >
                  {t('common.home')}
                </Button>
              </Link>
            </div>
          </div>
        )}
      </div>
    </nav>
  );
};

// File: src\components\table\TableCard.tsx

import React from 'react';
import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Table } from '@/types/thesis';
import { Pencil, Trash2 } from 'lucide-react';

interface TableCardProps {
  table: Table;
  onUpdate: (table: Table) => void;
  onRemove: (id: string) => void;
}

export const TableCard = ({ table, onUpdate, onRemove }: TableCardProps) => {
  return (
    <Card className="p-4 space-y-4">
      <div className="flex justify-between items-start">
        <div className="space-y-1">
          <h3 className="font-medium">Table {table.id}</h3>
          {table.caption && (
            <p className="text-sm text-muted-foreground">{table.caption}</p>
          )}
        </div>
        <div className="flex gap-2">
          <Button
            variant="outline"
            size="icon"
            onClick={() => onRemove(table.id)}
            className="h-8 w-8"
          >
            <Trash2 className="h-4 w-4" />
          </Button>
        </div>
      </div>
      
      <div 
        className="w-full overflow-x-auto"
        dangerouslySetInnerHTML={{ __html: table.content }}
      />
    </Card>
  );
};

// File: src\components\table\TableDialog.tsx

import React, { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { 
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Table } from '@/types/thesis';

interface TableDialogProps {
  open?: boolean;
  onOpenChange?: (open: boolean) => void;
  onTableCreate?: (table: Table) => void;
  onAddTable?: (table: Table) => void;
}

export const TableDialog: React.FC<TableDialogProps> = ({
  open,
  onOpenChange,
  onTableCreate,
  onAddTable,
}) => {
  const [title, setTitle] = useState('');
  const [content, setContent] = useState('');
  const [caption, setCaption] = useState('');

  const handleCreateTable = () => {
    const newTable: Table = {
      id: Date.now().toString(),
      title,
      content,
      caption,
      data: [],
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    };
    
    if (onTableCreate) onTableCreate(newTable);
    if (onAddTable) onAddTable(newTable);
    
    setTitle('');
    setContent('');
    setCaption('');
    if (onOpenChange) onOpenChange(false);
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Create New Table</DialogTitle>
          <DialogDescription>
            <div className="space-y-4">
              <Input
                value={title}
                onChange={(e) => setTitle(e.target.value)}
                placeholder="Table Title"
                className="w-full"
              />
              <Input
                value={caption}
                onChange={(e) => setCaption(e.target.value)}
                placeholder="Table Caption"
                className="w-full"
              />
              <Input
                value={content}
                onChange={(e) => setContent(e.target.value)}
                placeholder="Table Content (HTML)"
                className="w-full"
              />
              <Button onClick={handleCreateTable} className="w-full">
                Create Table
              </Button>
            </div>
          </DialogDescription>
        </DialogHeader>
      </DialogContent>
    </Dialog>
  );
};

// File: src\components\table\TableDialogFooter.tsx

import React from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';

interface TableDialogFooterProps {
  caption: string;
  onCaptionChange: (caption: string) => void;
  onCancel: () => void;
  onSave: () => void;
}

export const TableDialogFooter = ({
  caption,
  onCaptionChange,
  onCancel,
  onSave,
}: TableDialogFooterProps) => {
  return (
    <div className="space-y-4">
      <div>
        <label className="text-sm font-medium mb-1.5 block text-gray-700">
          Table Caption
        </label>
        <Input
          value={caption}
          onChange={(e) => onCaptionChange(e.target.value)}
          placeholder="Enter a descriptive caption for your table..."
          className="w-full"
        />
        <p className="text-xs text-muted-foreground mt-1">
          A good caption helps readers understand your table's content at a glance.
        </p>
      </div>
      <div className="flex justify-end gap-2">
        <Button
          variant="outline"
          onClick={onCancel}
          className="hover:bg-gray-50"
        >
          Cancel
        </Button>
        <Button 
          onClick={onSave}
          className="bg-primary hover:bg-primary/90"
        >
          Create Table
        </Button>
      </div>
    </div>
  );
};

// File: src\components\table\TableDialogGrid.tsx

import React from 'react';
import { Button } from '@/components/ui/button';
import { Plus, Minus } from 'lucide-react';
import { TableFormatControls } from './TableFormatControls';
import { TableGridCell } from './TableGridCell';

interface TableDialogGridProps {
  gridData: Array<Array<{ value: string; format: any }>>;
  onAddColumn: () => void;
  onAddRow: () => void;
  onRemoveColumn: (index: number) => void;
  onRemoveRow: (index: number) => void;
  onUpdateCell: (rowIndex: number, colIndex: number, value: string) => void;
  onFormatChange: (format: string, rowIndex: number, colIndex: number) => void;
}

export const TableDialogGrid = ({
  gridData,
  onAddColumn,
  onAddRow,
  onRemoveColumn,
  onRemoveRow,
  onUpdateCell,
  onFormatChange,
}: TableDialogGridProps) => {
  return (
    <div className="relative overflow-hidden rounded-lg border border-gray-200 shadow-sm bg-white">
      <div className="grid-controls flex justify-end gap-2 p-2 bg-gray-50/80 backdrop-blur-sm border-b">
        <Button
          variant="outline"
          size="sm"
          onClick={onAddColumn}
          className="flex items-center gap-1 bg-white hover:bg-primary/5"
        >
          <Plus className="h-3 w-3" /> Column
        </Button>
        <Button
          variant="outline"
          size="sm"
          onClick={onAddRow}
          className="flex items-center gap-1 bg-white hover:bg-primary/5"
        >
          <Plus className="h-3 w-3" /> Row
        </Button>
      </div>
      <div className="grid-content p-4 overflow-x-auto">
        <div 
          className="grid gap-2" 
          style={{ 
            gridTemplateColumns: `repeat(${gridData[0].length + 1}, minmax(min-content, 1fr))` 
          }}
        >
          <div></div>
          {gridData[0].map((_, colIndex) => (
            <div key={`col-${colIndex}`} className="flex justify-center">
              <Button
                variant="ghost"
                size="sm"
                onClick={() => onRemoveColumn(colIndex)}
                className="h-6 w-6 p-0 hover:bg-destructive/10 hover:text-destructive"
                disabled={gridData[0].length <= 1}
              >
                <Minus className="h-3 w-3" />
              </Button>
            </div>
          ))}
          
          {gridData.map((row, rowIndex) => (
            <React.Fragment key={`row-${rowIndex}`}>
              <div className="flex items-center justify-center">
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => onRemoveRow(rowIndex)}
                  className="h-6 w-6 p-0 hover:bg-destructive/10 hover:text-destructive"
                  disabled={gridData.length <= 1}
                >
                  <Minus className="h-3 w-3" />
                </Button>
              </div>
              {row.map((cell, colIndex) => (
                <div key={`cell-${rowIndex}-${colIndex}`} className="relative">
                  <TableFormatControls
                    onFormatChange={(format) => onFormatChange(format, rowIndex, colIndex)}
                    isHeader={rowIndex === 0}
                    activeFormats={cell.format}
                  />
                  <TableGridCell
                    value={cell.value}
                    onChange={(value) => onUpdateCell(rowIndex, colIndex, value)}
                    isHeader={rowIndex === 0}
                    format={cell.format}
                  />
                </div>
              ))}
            </React.Fragment>
          ))}
        </div>
      </div>
    </div>
  );
};

// File: src\components\table\TableDialogHeader.tsx

import React from 'react';
import { DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Table2 } from 'lucide-react';

export const TableDialogHeader = () => {
  return (
    <DialogHeader>
      <DialogTitle className="flex items-center gap-2 text-lg font-serif">
        <Table2 className="w-5 h-5 text-primary" />
        Create New Table
      </DialogTitle>
      <p className="text-sm text-muted-foreground mt-1">
        Design your table with an Excel-like interface. Add rows and columns as needed.
      </p>
    </DialogHeader>
  );
};

// File: src\components\table\TableFormatControls.tsx

import React from 'react';
import { Button } from '@/components/ui/button';
import { 
  AlignLeft, 
  AlignCenter, 
  AlignRight, 
  Bold, 
  Italic,
  Underline,
  Heading,
  Type,
  MinusSquare
} from 'lucide-react';
import { Separator } from '@/components/ui/separator';
import { cn } from '@/lib/utils';

interface TableFormatControlsProps {
  onFormatChange: (format: string) => void;
  isHeader?: boolean;
  activeFormats?: {
    align?: 'left' | 'center' | 'right';
    bold?: boolean;
    italic?: boolean;
    underline?: boolean;
    headerStyle?: 'none' | 'primary' | 'secondary';
  };
}

export const TableFormatControls = ({ 
  onFormatChange, 
  isHeader = false,
  activeFormats = {}
}: TableFormatControlsProps) => {
  return (
    <div className="table-editor-controls">
      <div className="format-group">
        <Button
          variant="ghost"
          size="sm"
          onClick={() => onFormatChange('align-left')}
          className={cn("format-button", activeFormats.align === 'left' && "active")}
        >
          <AlignLeft className="h-4 w-4" />
        </Button>
        <Button
          variant="ghost"
          size="sm"
          onClick={() => onFormatChange('align-center')}
          className={cn("format-button", activeFormats.align === 'center' && "active")}
        >
          <AlignCenter className="h-4 w-4" />
        </Button>
        <Button
          variant="ghost"
          size="sm"
          onClick={() => onFormatChange('align-right')}
          className={cn("format-button", activeFormats.align === 'right' && "active")}
        >
          <AlignRight className="h-4 w-4" />
        </Button>
      </div>
      
      <Separator orientation="vertical" className="h-6" />
      
      <div className="format-group">
        <Button
          variant="ghost"
          size="sm"
          onClick={() => onFormatChange('bold')}
          className={cn("format-button", activeFormats.bold && "active")}
        >
          <Bold className="h-4 w-4" />
        </Button>
        <Button
          variant="ghost"
          size="sm"
          onClick={() => onFormatChange('italic')}
          className={cn("format-button", activeFormats.italic && "active")}
        >
          <Italic className="h-4 w-4" />
        </Button>
        <Button
          variant="ghost"
          size="sm"
          onClick={() => onFormatChange('underline')}
          className={cn("format-button", activeFormats.underline && "active")}
        >
          <Underline className="h-4 w-4" />
        </Button>
      </div>

      {isHeader && (
        <>
          <Separator orientation="vertical" className="h-6" />
          <div className="format-group">
            <Button
              variant="ghost"
              size="sm"
              onClick={() => onFormatChange('header-primary')}
              className={cn(
                "format-button",
                activeFormats.headerStyle === 'primary' && "active"
              )}
              title="Primary Header Style"
            >
              <Heading className="h-4 w-4" />
            </Button>
            <Button
              variant="ghost"
              size="sm"
              onClick={() => onFormatChange('header-secondary')}
              className={cn(
                "format-button",
                activeFormats.headerStyle === 'secondary' && "active"
              )}
              title="Secondary Header Style"
            >
              <Type className="h-4 w-4" />
            </Button>
            <Button
              variant="ghost"
              size="sm"
              onClick={() => onFormatChange('header-none')}
              className={cn(
                "format-button",
                activeFormats.headerStyle === 'none' && "active"
              )}
              title="Remove Header Style"
            >
              <MinusSquare className="h-4 w-4" />
            </Button>
          </div>
        </>
      )}
    </div>
  );
};

// File: src\components\table\TableGridCell.tsx

import React from 'react';
import { Input } from '@/components/ui/input';
import { cn } from '@/lib/utils';

interface TableGridCellProps {
  value: string;
  onChange: (value: string) => void;
  isHeader?: boolean;
  format?: {
    align?: 'left' | 'center' | 'right';
    bold?: boolean;
    italic?: boolean;
    underline?: boolean;
    headerStyle?: 'none' | 'primary' | 'secondary';
  };
}

export const TableGridCell = ({ 
  value, 
  onChange, 
  isHeader = false,
  format = {}
}: TableGridCellProps) => {
  const cellClasses = cn(
    "table-editor-cell",
    {
      'font-bold': format.bold || (isHeader && format.headerStyle !== 'none'),
      'font-normal': format.headerStyle === 'none',
      'italic': format.italic,
      'underline': format.underline,
      'text-left': format.align === 'left',
      'text-center': format.align === 'center',
      'text-right': format.align === 'right',
      'bg-gray-50': isHeader && format.headerStyle === 'primary',
      'bg-gray-100/50': isHeader && format.headerStyle === 'secondary',
      'text-gray-900': isHeader && format.headerStyle === 'primary',
      'text-gray-700': isHeader && format.headerStyle === 'secondary',
      'uppercase tracking-wide text-xs': isHeader && format.headerStyle === 'primary',
      'capitalize': isHeader && format.headerStyle === 'secondary',
    }
  );

  return (
    <Input
      value={value}
      onChange={(e) => onChange(e.target.value)}
      className={cellClasses}
      placeholder={isHeader ? "Header" : "Cell content"}
    />
  );
};

// File: src\components\TableManager.tsx

import React from 'react';
import { Table } from '@/types/thesis';
import { TableDialog } from './table/TableDialog';
import { TableCard } from './table/TableCard';
import { ScrollArea } from './ui/scroll-area';
import { motion, AnimatePresence } from 'framer-motion';
import { Card } from './ui/card';
import { Table as TableIcon } from 'lucide-react';

interface TableManagerProps {
  tables: Table[];
  onUpdateTable: (table: Table) => void;
  onRemoveTable: (id: string) => void;
  onAddTable: (table: Table) => void;
}

export const TableManager: React.FC<TableManagerProps> = ({
  tables,
  onUpdateTable,
  onRemoveTable,
  onAddTable,
}) => {
  console.log('Rendering TableManager with tables:', tables);

  return (
    <Card className="p-6 space-y-6 bg-white/50 backdrop-blur-sm border-2 border-primary/10 shadow-xl rounded-xl">
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.3 }}
        className="flex justify-between items-center"
      >
        <div className="flex items-center gap-3">
          <div className="p-2 bg-primary/10 rounded-full">
            <TableIcon className="w-5 h-5 text-primary" />
          </div>
          <h3 className="text-lg font-serif font-medium text-primary">Tables</h3>
        </div>
        <TableDialog onAddTable={onAddTable} />
      </motion.div>

      <ScrollArea className="h-[600px] pr-4">
        <AnimatePresence mode="wait">
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ delay: 0.2 }}
            className="grid grid-cols-1 gap-6"
          >
            {tables.map((table, index) => (
              <motion.div
                key={table.id}
                initial={{ opacity: 0, x: -20 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, x: 20 }}
                transition={{ duration: 0.2, delay: index * 0.1 }}
              >
                <TableCard
                  table={table}
                  onUpdate={onUpdateTable}
                  onRemove={onRemoveTable}
                />
              </motion.div>
            ))}
          </motion.div>
        </AnimatePresence>
      </ScrollArea>
    </Card>
  );
};

// File: src\components\testing\SystemTest.tsx

import React, { useState, useEffect } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/hooks/use-toast';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { AlertTriangle, CheckCircle, RefreshCw, XCircle } from 'lucide-react';

interface TestResult {
  feature: string;
  status: 'success' | 'error' | 'pending';
  error?: string;
  duration?: number;
}

export const SystemTest = () => {
  const [results, setResults] = useState<TestResult[]>([]);
  const [isRunning, setIsRunning] = useState(false);
  const [progress, setProgress] = useState(0);
  const { toast } = useToast();

  const features = [
    { name: 'Authentication', test: testAuthentication },
    { name: 'Thesis Creation', test: testThesisCreation },
    { name: 'Citation Management', test: testCitationManagement },
    { name: 'Collaboration', test: testCollaboration },
    { name: 'Review System', test: testReviewSystem }
  ];

  async function testAuthentication(): Promise<TestResult> {
    console.log('Testing authentication...');
    try {
      const startTime = performance.now();
      const { data: { session }, error } = await supabase.auth.getSession();
      
      if (error) throw error;
      
      const duration = performance.now() - startTime;
      return {
        feature: 'Authentication',
        status: 'success',
        duration
      };
    } catch (error: any) {
      console.error('Authentication test failed:', error);
      await reportIssue('Authentication', error);
      return {
        feature: 'Authentication',
        status: 'error',
        error: error.message
      };
    }
  }

  async function testThesisCreation(): Promise<TestResult> {
    console.log('Testing thesis creation...');
    try {
      const startTime = performance.now();
      
      // Test thesis table access
      const { error: thesisError } = await supabase
        .from('theses')
        .select('*')
        .limit(1);

      if (thesisError) throw thesisError;

      const duration = performance.now() - startTime;
      return {
        feature: 'Thesis Creation',
        status: 'success',
        duration
      };
    } catch (error: any) {
      console.error('Thesis creation test failed:', error);
      await reportIssue('Thesis Creation', error);
      return {
        feature: 'Thesis Creation',
        status: 'error',
        error: error.message
      };
    }
  }

  async function testCitationManagement(): Promise<TestResult> {
    console.log('Testing citation management...');
    try {
      const startTime = performance.now();
      
      // Test citations table access
      const { error: citationError } = await supabase
        .from('citations')
        .select('*')
        .limit(1);

      if (citationError) throw citationError;

      const duration = performance.now() - startTime;
      return {
        feature: 'Citation Management',
        status: 'success',
        duration
      };
    } catch (error: any) {
      console.error('Citation management test failed:', error);
      await reportIssue('Citation Management', error);
      return {
        feature: 'Citation Management',
        status: 'error',
        error: error.message
      };
    }
  }

  async function testCollaboration(): Promise<TestResult> {
    console.log('Testing collaboration features...');
    try {
      const startTime = performance.now();
      
      // Test collaborators table access
      const { error: collaboratorError } = await supabase
        .from('thesis_collaborators')
        .select('*')
        .limit(1);

      if (collaboratorError) throw collaboratorError;

      const duration = performance.now() - startTime;
      return {
        feature: 'Collaboration',
        status: 'success',
        duration
      };
    } catch (error: any) {
      console.error('Collaboration test failed:', error);
      await reportIssue('Collaboration', error);
      return {
        feature: 'Collaboration',
        status: 'error',
        error: error.message
      };
    }
  }

  async function testReviewSystem(): Promise<TestResult> {
    console.log('Testing review system...');
    try {
      const startTime = performance.now();
      
      // Test reviews table access
      const { error: reviewError } = await supabase
        .from('thesis_reviews')
        .select('*')
        .limit(1);

      if (reviewError) throw reviewError;

      const duration = performance.now() - startTime;
      return {
        feature: 'Review System',
        status: 'success',
        duration
      };
    } catch (error: any) {
      console.error('Review system test failed:', error);
      await reportIssue('Review System', error);
      return {
        feature: 'Review System',
        status: 'error',
        error: error.message
      };
    }
  }

  async function reportIssue(component: string, error: any) {
    console.log('Reporting issue for component:', component, error);
    try {
      const { error: reportError } = await supabase
        .from('app_issues')
        .insert([{
          component_name: component,
          error_message: error.message,
          error_stack: error.stack,
          browser_info: navigator.userAgent,
          route_path: window.location.pathname
        }]);

      if (reportError) {
        console.error('Failed to report issue:', reportError);
      }
    } catch (err) {
      console.error('Error reporting issue:', err);
    }
  }

  const runTests = async () => {
    console.log('Starting system tests...');
    setIsRunning(true);
    setResults([]);
    setProgress(0);

    const totalTests = features.length;
    let completedTests = 0;

    for (const feature of features) {
      const result = await feature.test();
      setResults(prev => [...prev, result]);
      completedTests++;
      setProgress((completedTests / totalTests) * 100);
    }

    setIsRunning(false);
    toast({
      title: "Tests Completed",
      description: `${results.filter(r => r.status === 'success').length} of ${totalTests} tests passed`,
    });
  };

  return (
    <Card className="w-full max-w-4xl mx-auto">
      <CardHeader>
        <CardTitle className="flex items-center justify-between">
          <span>System Test Dashboard</span>
          <Button
            onClick={runTests}
            disabled={isRunning}
            className="gap-2"
          >
            {isRunning ? (
              <RefreshCw className="w-4 h-4 animate-spin" />
            ) : (
              <RefreshCw className="w-4 h-4" />
            )}
            {isRunning ? 'Running Tests...' : 'Run Tests'}
          </Button>
        </CardTitle>
        {isRunning && (
          <Progress value={progress} className="w-full" />
        )}
      </CardHeader>
      <CardContent className="space-y-4">
        {results.map((result, index) => (
          <div
            key={index}
            className="flex items-center justify-between p-4 rounded-lg border bg-card"
          >
            <div className="flex items-center gap-3">
              {result.status === 'success' ? (
                <CheckCircle className="w-5 h-5 text-green-500" />
              ) : result.status === 'error' ? (
                <XCircle className="w-5 h-5 text-red-500" />
              ) : (
                <AlertTriangle className="w-5 h-5 text-yellow-500" />
              )}
              <div>
                <h3 className="font-medium">{result.feature}</h3>
                {result.error && (
                  <p className="text-sm text-destructive">{result.error}</p>
                )}
              </div>
            </div>
            <div className="flex items-center gap-2">
              {result.duration && (
                <Badge variant="secondary">
                  {result.duration.toFixed(0)}ms
                </Badge>
              )}
              <Badge
                variant={
                  result.status === 'success'
                    ? 'secondary'
                    : result.status === 'error'
                    ? 'destructive'
                    : 'default'
                }
              >
                {result.status}
              </Badge>
            </div>
          </div>
        ))}
        {!isRunning && results.length === 0 && (
          <div className="text-center text-muted-foreground py-8">
            Click "Run Tests" to start system diagnostics
          </div>
        )}
      </CardContent>
    </Card>
  );
};


// File: src\components\ThemeProvider.tsx

import React, { createContext, useContext, useEffect, useState } from 'react';

type Theme = 'light' | 'dark';

interface ThemeContextType {
  theme: Theme;
  toggleTheme: () => void;
}

const ThemeContext = createContext<ThemeContextType>({
  theme: 'light',
  toggleTheme: () => {},
});

export const useTheme = () => useContext(ThemeContext);

export const ThemeProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [theme, setTheme] = useState<Theme>(() => {
    if (typeof window !== 'undefined') {
      return localStorage.getItem('theme') as Theme || 'light';
    }
    return 'light';
  });

  useEffect(() => {
    const root = window.document.documentElement;
    root.classList.remove('light', 'dark');
    root.classList.add(theme);
    localStorage.setItem('theme', theme);
  }, [theme]);

  const toggleTheme = () => {
    setTheme(prev => prev === 'light' ? 'dark' : 'light');
  };

  return (
    <ThemeContext.Provider value={{ theme, toggleTheme }}>
      {children}
    </ThemeContext.Provider>
  );
};

// File: src\components\ThemeToggle.tsx

import { Moon, Sun } from 'lucide-react';
import { Button } from './ui/button';
import { useTheme } from './ThemeProvider';

export const ThemeToggle = () => {
  const { theme, toggleTheme } = useTheme();

  return (
    <Button
      variant="ghost"
      size="icon"
      onClick={toggleTheme}
      className="w-9 h-9 transition-colors"
    >
      {theme === 'light' ? (
        <Moon className="h-4 w-4" />
      ) : (
        <Sun className="h-4 w-4" />
      )}
      <span className="sr-only">Toggle theme</span>
    </Button>
  );
};

// File: src\components\thesis\CollaboratorsList.tsx

import { Users } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from "@/components/ui/popover";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Skeleton } from "@/components/ui/skeleton";

interface Collaborator {
  user_id: string;
  role: string;
  profiles?: {
    email: string;
    role: string;
    roles?: {
      name: string;
    };
  };
}

interface CollaboratorsListProps {
  collaborators: Collaborator[];
  thesisId: string;
  isLoading?: boolean;
}

export const CollaboratorsList = ({ 
  collaborators, 
  thesisId,
  isLoading = false 
}: CollaboratorsListProps) => {
  console.log('Rendering CollaboratorsList:', { collaboratorsCount: collaborators.length, thesisId });

  const getRoleColor = (role: string) => {
    switch (role.toLowerCase()) {
      case 'owner':
        return 'bg-primary text-primary-foreground';
      case 'editor':
        return 'bg-blue-500 text-white';
      case 'viewer':
        return 'bg-secondary text-secondary-foreground';
      case 'admin':
        return 'bg-destructive text-destructive-foreground';
      default:
        return 'bg-muted text-muted-foreground';
    }
  };

  const getInitials = (email: string) => {
    return email.split('@')[0].substring(0, 2).toUpperCase();
  };

  return (
    <Popover>
      <PopoverTrigger asChild>
        <Button
          variant="outline"
          size="sm"
          className="gap-2"
        >
          <Users className="w-4 h-4" />
          Collaborators ({isLoading ? '...' : collaborators.length})
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-80" align="end">
        <ScrollArea className="h-[300px] pr-4">
          <div className="space-y-4">
            <h4 className="font-medium leading-none mb-4">Thesis Collaborators</h4>
            {isLoading ? (
              <div className="space-y-3">
                {[1, 2, 3].map((i) => (
                  <div key={i} className="flex items-center gap-2">
                    <Skeleton className="h-8 w-8 rounded-full" />
                    <div className="space-y-2 flex-1">
                      <Skeleton className="h-4 w-3/4" />
                    </div>
                  </div>
                ))}
              </div>
            ) : collaborators.length === 0 ? (
              <p className="text-sm text-muted-foreground text-center py-4">
                No collaborators yet
              </p>
            ) : (
              <div className="space-y-3">
                {collaborators.map((collaborator) => (
                  <div
                    key={collaborator.user_id}
                    className="flex items-center gap-3 p-2 rounded-lg hover:bg-muted/50 transition-colors"
                  >
                    <Avatar className="h-8 w-8">
                      <AvatarImage 
                        src={`https://api.dicebear.com/7.x/initials/svg?seed=${collaborator.profiles?.email}`} 
                        alt={collaborator.profiles?.email} 
                      />
                      <AvatarFallback>
                        {collaborator.profiles?.email ? getInitials(collaborator.profiles.email) : '??'}
                      </AvatarFallback>
                    </Avatar>
                    <div className="flex-1 min-w-0">
                      <p className="text-sm font-medium truncate">
                        {collaborator.profiles?.email || 'Unknown User'}
                      </p>
                      <div className="flex gap-2 mt-1">
                        <Badge 
                          variant="secondary"
                          className={`text-xs ${getRoleColor(collaborator.role)}`}
                        >
                          {collaborator.role}
                        </Badge>
                        {collaborator.profiles?.roles?.name === 'admin' && (
                          <Badge variant="destructive" className="text-xs">
                            Site Admin
                          </Badge>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </ScrollArea>
      </PopoverContent>
    </Popover>
  );
};

// File: src\components\thesis\editor\ThesisEditorContent.tsx

import React from 'react';
import { ThesisContent } from '../ThesisContent';
import { Chapter, Section, Thesis } from '@/types/thesis';

interface ThesisEditorContentProps {
  frontMatter: Section[];
  chapters: Chapter[];
  backMatter: Section[];
  generalIntroduction?: Section;
  generalConclusion?: Section;
  activeSection: string;
  onContentChange: (id: string, content: string) => void;
  onTitleChange: (id: string, title: string) => void;
  onUpdateChapter: (chapter: Chapter) => void;
  onAddChapter: (chapter: Chapter) => void;
  thesis: Thesis;
  onUpdateThesis: (thesis: Thesis) => void;
}

export const ThesisEditorContent: React.FC<ThesisEditorContentProps> = ({
  frontMatter,
  chapters,
  backMatter,
  generalIntroduction,
  generalConclusion,
  activeSection,
  onContentChange,
  onTitleChange,
  onUpdateChapter,
  onAddChapter,
  thesis,
  onUpdateThesis
}) => {
  console.log('ThesisEditorContent rendering with thesis:', thesis);

  return (
    <ThesisContent
      frontMatter={frontMatter}
      chapters={chapters}
      backMatter={backMatter}
      generalIntroduction={generalIntroduction}
      generalConclusion={generalConclusion}
      activeSection={activeSection}
      onContentChange={onContentChange}
      onTitleChange={onTitleChange}
      onUpdateChapter={onUpdateChapter}
      onAddChapter={onAddChapter}
      thesis={thesis}
      onUpdateThesis={onUpdateThesis}
      thesisId={thesis.id}
    />
  );
};

// File: src\components\thesis\editor\ThesisEditorHeader.tsx

import React from 'react';
import { ThesisToolbar } from '../ThesisToolbar';
import { Thesis } from '@/types/thesis';

interface ThesisEditorHeaderProps {
  thesis: Thesis;
  showPreview: boolean;
  onTogglePreview: () => void;
}

export const ThesisEditorHeader: React.FC<ThesisEditorHeaderProps> = ({
  thesis,
  showPreview,
  onTogglePreview
}) => {
  console.log('ðŸŽ¯ Rendering ThesisEditorHeader with thesis:', thesis?.id);
  
  return (
    <div className="flex justify-between items-center">
      <ThesisToolbar
        thesisId={thesis?.id || ''}
        thesisData={thesis}
        showPreview={showPreview}
        onTogglePreview={onTogglePreview}
      />
    </div>
  );
};

// File: src\components\thesis\editor\ThesisEditorMain.tsx

import React from 'react';
import { ThesisEditorContent } from './ThesisEditorContent';
import { ThesisEditorPreview } from './ThesisEditorPreview';
import { Chapter, Thesis } from '@/types/thesis';

interface ThesisEditorMainProps {
  thesis: Thesis | null;
  activeSection: string;
  showPreview: boolean;
  previewRef: React.RefObject<HTMLDivElement>;
  onContentChange: (id: string, content: string) => void;
  onTitleChange: (id: string, title: string) => void;
  onUpdateChapter: (chapter: Chapter) => void;
  onAddChapter: (chapter: Chapter) => void;
}

export const ThesisEditorMain: React.FC<ThesisEditorMainProps> = ({
  thesis,
  activeSection,
  showPreview,
  previewRef,
  onContentChange,
  onTitleChange,
  onUpdateChapter,
  onAddChapter
}) => {
  if (!thesis?.content) return null;

  return (
    <main className="flex-1 p-8 flex">
      <div className={`transition-all duration-300 ${showPreview ? 'w-1/2' : 'w-full'}`}>
        <div className="max-w-4xl mx-auto space-y-6">
          <ThesisEditorContent
            frontMatter={thesis.content.frontMatter}
            chapters={thesis.content.chapters}
            backMatter={thesis.content.backMatter}
            generalIntroduction={thesis.content.generalIntroduction}
            generalConclusion={thesis.content.generalConclusion}
            activeSection={activeSection}
            onContentChange={onContentChange}
            onTitleChange={onTitleChange}
            onUpdateChapter={onUpdateChapter}
            onAddChapter={onAddChapter}
            thesis={thesis}
            onUpdateThesis={(updatedThesis) => {
              // Handle thesis update
              console.log('Updating thesis:', updatedThesis);
            }}
          />
        </div>
      </div>
      {showPreview && thesis && (
        <div className="w-1/2 pl-8 border-l">
          <ThesisEditorPreview thesis={thesis} previewRef={previewRef} />
        </div>
      )}
    </main>
  );
};

// File: src\components\thesis\editor\ThesisEditorPreview.tsx

import React from 'react';
import { ThesisPreview } from '../../ThesisPreview';
import { Thesis } from '@/types/thesis';

interface ThesisEditorPreviewProps {
  thesis: Thesis;
  previewRef: React.RefObject<HTMLDivElement>;
}

export const ThesisEditorPreview: React.FC<ThesisEditorPreviewProps> = ({
  thesis,
  previewRef
}) => {
  return (
    <div ref={previewRef}>
      <ThesisPreview thesis={thesis} />
    </div>
  );
};

// File: src\components\thesis\editor\ThesisEditorStatus.tsx

import React from 'react';
import { Card } from '@/components/ui/card';
import { Users, ChevronDown, ChevronUp, RefreshCw } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from '@/components/ui/collapsible';
import { ThesisTracker } from '../tracker/ThesisTracker';
import { ThesisPlanning } from '../planning/ThesisPlanning';
import { CollaboratorPresence } from '@/components/collaboration/CollaboratorPresence';
import { Thesis } from '@/types/thesis';

interface ThesisEditorStatusProps {
  thesis: Thesis;
  thesisId: string;
  progress: number;
  showTracker: boolean;
  setShowTracker: (show: boolean) => void;
}

export const ThesisEditorStatus: React.FC<ThesisEditorStatusProps> = ({
  thesis,
  thesisId,
  progress,
  showTracker,
  setShowTracker
}) => {
  return (
    <div className="space-y-6">
      <Collapsible open={showTracker} onOpenChange={setShowTracker}>
        <div className="flex items-center justify-between mb-2">
          <div className="flex items-center gap-2">
            <RefreshCw className="w-4 h-4 animate-spin text-primary" />
            <span className="text-sm text-muted-foreground">Auto-updating</span>
            <span className="text-sm font-medium">{progress}% Complete</span>
          </div>
          <CollapsibleTrigger asChild>
            <Button variant="ghost" size="sm">
              {showTracker ? (
                <ChevronUp className="h-4 w-4" />
              ) : (
                <ChevronDown className="h-4 w-4" />
              )}
            </Button>
          </CollapsibleTrigger>
        </div>
        <CollapsibleContent className="space-y-4">
          <ThesisTracker thesis={thesis} />
          <ThesisPlanning thesis={thesis} />
        </CollapsibleContent>
      </Collapsible>
      
      <Card className="p-4 mb-4 bg-white/50 backdrop-blur-sm border border-primary/10">
        <div className="flex items-center gap-2 text-sm text-muted-foreground">
          <Users className="w-4 h-4" />
          <span className="font-medium">Active Collaborators</span>
        </div>
        <CollaboratorPresence thesisId={thesisId} />
      </Card>
    </div>
  );
};

// File: src\components\thesis\form\AuthorFields.tsx

import React from 'react';
import { Input } from "@/components/ui/input";

interface AuthorFieldsProps {
  values: {
    authorName: string;
    thesisDate: string;
  };
  handleChange: (e: React.ChangeEvent<HTMLInputElement>) => void;
}

export const AuthorFields = ({ values, handleChange }: AuthorFieldsProps) => {
  return (
    <>
      <div>
        <label htmlFor="authorName" className="block text-sm font-medium mb-1">
          Author Name
        </label>
        <Input
          id="authorName"
          name="authorName"
          value={values.authorName}
          onChange={handleChange}
          placeholder="Enter author name"
          required
        />
      </div>

      <div>
        <label htmlFor="thesisDate" className="block text-sm font-medium mb-1">
          Thesis Date
        </label>
        <Input
          id="thesisDate"
          name="thesisDate"
          value={values.thesisDate}
          onChange={handleChange}
          placeholder="Enter date of thesis submission"
          required
        />
      </div>
    </>
  );
};

// File: src\components\thesis\form\BasicThesisFields.tsx

import React from 'react';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';

export interface BasicThesisFieldsProps {
  values: {
    title: string;
    description: string;
    keywords: string;
  };
  handleChange: (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => void;
  setFieldValue?: (field: string, value: any) => void;
}

export const BasicThesisFields: React.FC<BasicThesisFieldsProps> = ({
  values,
  handleChange,
  setFieldValue
}) => {
  return (
    <div className="space-y-4">
      <div>
        <label htmlFor="title" className="block text-sm font-medium text-gray-700">
          Title
        </label>
        <Input
          id="title"
          name="title"
          value={values.title}
          onChange={handleChange}
          placeholder="Enter thesis title"
          className="mt-1"
        />
      </div>

      <div>
        <label htmlFor="description" className="block text-sm font-medium text-gray-700">
          Description
        </label>
        <Textarea
          id="description"
          name="description"
          value={values.description}
          onChange={handleChange}
          placeholder="Enter thesis description"
          className="mt-1"
        />
      </div>

      <div>
        <label htmlFor="keywords" className="block text-sm font-medium text-gray-700">
          Keywords
        </label>
        <Input
          id="keywords"
          name="keywords"
          value={values.keywords}
          onChange={handleChange}
          placeholder="Enter keywords (comma separated)"
          className="mt-1"
        />
      </div>
    </div>
  );
};

// File: src\components\thesis\form\CommitteeFields.tsx

import React from 'react';
import { Input } from "@/components/ui/input";

interface CommitteeFieldsProps {
  committeeMembers: string[];
  handleCommitteeMemberChange: (index: number, value: string) => void;
}

export const CommitteeFields = ({ committeeMembers, handleCommitteeMemberChange }: CommitteeFieldsProps) => {
  return (
    <div>
      <label className="block text-sm font-medium mb-1">
        Committee Members
      </label>
      {committeeMembers.map((member, index) => (
        <Input
          key={index}
          name={`committeeMembers[${index}]`}
          value={member}
          onChange={(e) => handleCommitteeMemberChange(index, e.target.value)}
          placeholder={`Committee Member ${index + 1}`}
          className="mb-2"
        />
      ))}
    </div>
  );
};

// File: src\components\thesis\form\InstitutionFields.tsx

import React from 'react';
import { Input } from "@/components/ui/input";

interface InstitutionFieldsProps {
  values: {
    universityName: string;
    departmentName: string;
  };
  handleChange: (e: React.ChangeEvent<HTMLInputElement>) => void;
}

export const InstitutionFields = ({ values, handleChange }: InstitutionFieldsProps) => {
  return (
    <>
      <div>
        <label htmlFor="universityName" className="block text-sm font-medium mb-1">
          University Name
        </label>
        <Input
          id="universityName"
          name="universityName"
          value={values.universityName}
          onChange={handleChange}
          placeholder="Enter university name"
          required
        />
      </div>

      <div>
        <label htmlFor="departmentName" className="block text-sm font-medium mb-1">
          Department Name
        </label>
        <Input
          id="departmentName"
          name="departmentName"
          value={values.departmentName}
          onChange={handleChange}
          placeholder="Enter department name"
          required
        />
      </div>
    </>
  );
};

// File: src\components\thesis\form\ThesisMetadataFields.tsx

// File: src/components/thesis/form/ThesisMetadataFields.tsx
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";

interface ThesisMetadataFieldsProps {
  title: string;
  description: string;
  keywords: string;
  setTitle: (value: string) => void;
  setDescription: (value: string) => void;
  setKeywords: (value: string) => void;
}

export const ThesisMetadataFields = ({
  title,
  description,
  keywords,
  setTitle,
  setDescription,
  setKeywords,
}: ThesisMetadataFieldsProps) => {
  return (
    <div className="space-y-4">
      <div>
        <label htmlFor="title" className="block text-sm font-medium mb-1">
          Title
        </label>
        <Input
          id="title"
          value={title}
          onChange={(e) => setTitle(e.target.value)}
          placeholder="Enter thesis title"
          required
        />
      </div>

      <div>
        <label htmlFor="description" className="block text-sm font-medium mb-1">
          Description
        </label>
        <Textarea
          id="description"
          value={description}
          onChange={(e) => setDescription(e.target.value)}
          placeholder="Brief description of your thesis"
          required
        />
      </div>

      <div>
        <label htmlFor="keywords" className="block text-sm font-medium mb-1">
          Keywords
        </label>
        <Input
          id="keywords"
          value={keywords}
          onChange={(e) => setKeywords(e.target.value)}
          placeholder="Enter keywords separated by commas"
          required
        />
        <p className="text-sm text-muted-foreground mt-1">
          Separate keywords with commas (e.g., AI, Machine Learning, Data Science)
        </p>
      </div>
    </div>
  );
};

// File: src\components\thesis\form\useThesisCreation.ts

import { useState } from 'react';
import { useToast } from "@/hooks/use-toast";
import { supabase } from "@/integrations/supabase/client";
import { Json } from '@/integrations/supabase/types';
import { ThesisSectionType } from '@/types/thesis';

interface ThesisMetadata {
  title: string;
  description: string;
  keywords: string;
  universityName?: string;
  departmentName?: string;
  authorName?: string;
  thesisDate?: string;
  committeeMembers?: string[];
}

export const useThesisCreation = () => {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const { toast } = useToast();

  const createThesis = async (
    metadata: ThesisMetadata,
    userId: string
  ) => {
    setIsSubmitting(true);
    try {
      console.log('Starting thesis creation with metadata:', metadata);

      const thesisId = crypto.randomUUID();
      const now = new Date().toISOString();

      const keywordsArray = metadata.keywords
        ? metadata.keywords.split(',').map(k => k.trim()).filter(k => k)
        : [];

      // Prepare thesis content with proper typing and all required fields
      const thesisContent = {
        id: thesisId,
        title: metadata.title || 'Untitled Thesis',
        description: metadata.description || '',
        status: 'draft',
        created_at: now,
        updated_at: now,
        metadata: {
          description: metadata.description || '',
          keywords: keywordsArray,
          createdAt: now,
          updatedAt: now,
          universityName: metadata.universityName || '',
          departmentName: metadata.departmentName || '',
          authorName: metadata.authorName || '',
          thesisDate: metadata.thesisDate || now.split('T')[0],
          committeeMembers: metadata.committeeMembers || []
        },
        frontMatter: [
          {
            id: crypto.randomUUID(),
            title: metadata.title || 'Untitled Thesis',
            content: '',
            type: 'title' as ThesisSectionType,
            required: true,
            order: 1,
            status: 'draft',
            created_at: now,
            updated_at: now,
            figures: [],
            tables: [],
            citations: []
          },
          {
            id: crypto.randomUUID(),
            title: 'Abstract',
            content: metadata.description || '',
            type: 'abstract' as ThesisSectionType,
            required: true,
            order: 2,
            status: 'draft',
            created_at: now,
            updated_at: now,
            figures: [],
            tables: [],
            citations: []
          }
        ],
        generalIntroduction: {
          id: 'general-introduction',
          title: 'General Introduction',
          content: '',
          type: 'general-introduction' as ThesisSectionType,
          required: true,
          order: 1,
          status: 'draft',
          created_at: now,
          updated_at: now,
          figures: [],
          tables: [],
          citations: [],
          references: []
        },
        chapters: [],
        generalConclusion: {
          id: 'general-conclusion',
          title: 'General Conclusion',
          content: '',
          type: 'general-conclusion' as ThesisSectionType,
          required: true,
          order: 1,
          status: 'draft',
          created_at: now,
          updated_at: now,
          figures: [],
          tables: [],
          citations: [],
          references: []
        },
        backMatter: [
          {
            id: crypto.randomUUID(),
            title: 'References',
            content: '',
            type: 'references' as ThesisSectionType,
            required: true,
            order: 1,
            status: 'draft',
            created_at: now,
            updated_at: now,
            figures: [],
            tables: [],
            citations: []
          }
        ]
      };

      // Insert the new thesis
      const { error: insertError } = await supabase
        .from('theses')
        .insert({
          id: thesisId,
          title: metadata.title,
          content: thesisContent as unknown as Json,
          user_id: userId,
          created_at: now,
          updated_at: now,
          status: 'draft',
          version: '1.0'
        });

      if (insertError) throw insertError;

      // Add user as owner in thesis_collaborators
      const { error: collaboratorError } = await supabase
        .from('thesis_collaborators')
        .insert({
          thesis_id: thesisId,
          user_id: userId,
          role: 'owner',
          created_at: now
        });

      if (collaboratorError) throw collaboratorError;

      toast({
        title: "Success",
        description: "Your thesis has been created successfully.",
        variant: "success"
      });

      return thesisId;

    } catch (error) {
      console.error('Error creating thesis:', error);
      toast({
        title: "Error",
        description: error instanceof Error ? error.message : "Failed to create thesis",
        variant: "destructive"
      });
      return null;
    } finally {
      setIsSubmitting(false);
    }
  };

  return {
    createThesis,
    isSubmitting
  };
};

// File: src\components\thesis\header\HeaderActions.tsx

import { Button } from '@/components/ui/button';
import { Eye, EyeOff, Save, LogOut } from 'lucide-react';
import { useAuth } from '@/contexts/AuthContext';
import { useToast } from '@/hooks/use-toast';

interface HeaderActionsProps {
  showPreview: boolean;
  onTogglePreview: () => void;
  onSaveToJson: () => void;
}

export const HeaderActions = ({
  showPreview,
  onTogglePreview,
  onSaveToJson,
}: HeaderActionsProps) => {
  const { handleLogout } = useAuth();
  const { toast } = useToast();

  const handleLogoutClick = async () => {
    try {
      console.log('ðŸ”„ Initiating logout from HeaderActions...');
      await handleLogout();
    } catch (error) {
      console.error('âŒ Error during logout:', error);
      toast({
        title: "Error signing out",
        description: "An unexpected error occurred. Please try again.",
        variant: "destructive",
      });
    }
  };

  return (
    <div className="flex items-center gap-2">
      <Button
        variant="outline"
        size="sm"
        onClick={onTogglePreview}
        className="gap-2"
      >
        {showPreview ? (
          <>
            <EyeOff className="w-4 h-4" />
            Hide Preview
          </>
        ) : (
          <>
            <Eye className="w-4 h-4" />
            Show Preview
          </>
        )}
      </Button>
      <Button
        variant="outline"
        size="sm"
        onClick={onSaveToJson}
        className="gap-2"
      >
        <Save className="w-4 h-4" />
        Save as JSON
      </Button>
      <Button
        variant="outline"
        size="sm"
        onClick={handleLogoutClick}
        className="gap-2"
      >
        <LogOut className="w-4 h-4" />
        Logout
      </Button>
    </div>
  );
};

// File: src\components\thesis\header\UserSection.tsx

import { User } from 'lucide-react';
import { Badge } from '@/components/ui/badge';

interface UserSectionProps {
  userEmail: string;
  userRole: string;
}

export const UserSection = ({ userEmail, userRole }: UserSectionProps) => {
  return (
    <div className="flex items-center gap-2">
      <User className="w-4 h-4" />
      <span className="text-sm">{userEmail}</span>
      <Badge variant="secondary" className="text-xs">
        {userRole}
      </Badge>
    </div>
  );
};

// File: src\components\thesis\planning\ThesisPlanning.tsx

import React from 'react';
import { Card } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Calendar, Clock, Target, AlertCircle } from 'lucide-react';
import { motion } from 'framer-motion';
import { Thesis } from '@/types/thesis';
import { format, differenceInDays, addMonths } from 'date-fns';

interface ThesisPlanningProps {
  thesis: Thesis;
}

export const ThesisPlanning: React.FC<ThesisPlanningProps> = ({ thesis }) => {
  if (!thesis) {
    return <div>Thesis data not available</div>;
  }

  const startDate = thesis.created_at ? new Date(thesis.created_at) : null;
  const today = new Date();
  
  // Estimate end date as 6 months from start if not completed
  const estimatedEndDate = startDate ? addMonths(startDate, 6) : null;
  
  const totalDays = estimatedEndDate ? differenceInDays(estimatedEndDate, startDate) : 0;
  const daysElapsed = startDate ? differenceInDays(today, startDate) : 0;
  const daysRemaining = Math.max(0, totalDays - daysElapsed);

  // Calculate progress based on content
  const calculateProgress = () => {
    const frontMatterSections = thesis.frontMatter || [];
    const chapterSections = thesis.chapters?.flatMap(chapter => chapter.sections) || [];
    const backMatterSections = thesis.backMatter || [];
    const generalIntro = thesis.generalIntroduction ? [thesis.generalIntroduction] : [];
    const generalConc = thesis.generalConclusion ? [thesis.generalConclusion] : [];

    const allSections = [
      ...frontMatterSections,
      ...generalIntro,
      ...chapterSections,
      ...generalConc,
      ...backMatterSections
    ];
    
    const completedSections = allSections.filter(section => 
      section?.content && section.content.trim().length > 100
    ).length;
    
    return allSections.length > 0 ? Math.min(100, Math.round((completedSections / allSections.length) * 100)) : 0;
  };

  const progress = calculateProgress();
  const timeProgress = Math.min(100, Math.round((daysElapsed / totalDays) * 100));

  return (
    <Card className="p-6 space-y-6 bg-white/50 backdrop-blur-sm border-2 border-primary/10 shadow-xl rounded-xl">
      <div className="space-y-4">
        <h3 className="text-lg font-semibold flex items-center gap-2">
          <Target className="w-5 h-5 text-primary" />
          Thesis Timeline
        </h3>
        
        <div className="space-y-2">
          <div className="flex justify-between text-sm">
            <span>Timeline Progress</span>
            <span>{timeProgress}%</span>
          </div>
          <Progress value={timeProgress} className="h-2" />
        </div>

        <div className="grid grid-cols-2 gap-4">
          <motion.div 
            whileHover={{ scale: 1.02 }}
            className="p-4 rounded-lg bg-white/30 space-y-2"
          >
            <div className="flex items-center gap-2 text-sm font-medium">
              <Calendar className="w-4 h-4 text-blue-500" />
              Days Remaining
            </div>
            <p className="text-sm text-muted-foreground">
              {daysRemaining} days
            </p>
          </motion.div>

          <motion.div 
            whileHover={{ scale: 1.02 }}
            className="p-4 rounded-lg bg-white/30 space-y-2"
          >
            <div className="flex items-center gap-2 text-sm font-medium">
              <Target className="w-4 h-4 text-green-500" />
              Content Progress
            </div>
            <p className="text-sm text-muted-foreground">
              {progress}% Complete
            </p>
          </motion.div>
        </div>

        <div className="mt-4">
          <h4 className="text-sm font-medium mb-2">Important Dates</h4>
          <div className="space-y-2">
            <div className="flex justify-between text-sm">
              <span>Start Date</span>
              <span>{startDate ? format(startDate, 'MMM d, yyyy') : 'Not available'}</span>
            </div>
            <div className="flex justify-between text-sm">
              <span>Estimated Completion</span>
              <span>{estimatedEndDate ? format(estimatedEndDate, 'MMM d, yyyy') : 'Not available'}</span>
            </div>
          </div>
        </div>
      </div>
    </Card>
  );
};

// File: src\components\thesis\preview\AbstractSection.tsx

import React from 'react';
import { Section } from '@/types/thesis';
import MDEditor from '@uiw/react-md-editor';

interface AbstractSectionProps {
  abstractSection?: Section;
}

export const AbstractSection = ({ abstractSection }: AbstractSectionProps) => {
  return (
    <div className="thesis-page">
      <div className="thesis-header">Abstract</div>
      <div className="thesis-content thesis-abstract">
        <h2 className="text-2xl font-serif mb-4">Abstract</h2>
        <MDEditor.Markdown 
          source={abstractSection?.content || "No Abstract Provided"}
          className="prose prose-sm max-w-none"
        />
      </div>
      <div className="thesis-footer">
        <span>Page <span className="page-number"></span></span>
      </div>
    </div>
  );
};

// File: src\components\thesis\preview\ArabicTitlePage.tsx

import React from 'react';
import { Thesis } from '@/types/thesis';
import { GraduationCap, BookOpen, Award } from 'lucide-react';

interface ArabicTitlePageProps {
  thesis: Thesis;
  titleSection?: { content: string };
}

export const ArabicTitlePage = ({ thesis, titleSection }: ArabicTitlePageProps) => {
  return (
    <div className="thesis-page title-page" dir="rtl">
      <div className="thesis-title-content text-right">
        <div className="university-decoration">
          <GraduationCap className="title-icon text-primary mx-auto" size={48} />
        </div>
        <div className="university-name text-2xl font-bold mb-4">
          {thesis.metadata?.universityName || "Ø§Ø³Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©"}
        </div>
        <div className="department-name text-xl mb-8">
          {thesis.metadata?.departmentName || "Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…"}
        </div>
        
        <div className="thesis-decoration">
          <BookOpen className="title-icon text-primary-light mx-auto" size={36} />
        </div>
        <div className="thesis-main-title text-3xl font-bold mb-8">
          {titleSection?.content || "Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø£Ø·Ø±ÙˆØ­Ø©"}
        </div>
        
        <div className="thesis-subtitle text-lg mb-8">
          Ø±Ø³Ø§Ù„Ø© Ù…Ù‚Ø¯Ù…Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø©<br />
          Ø§Ù„Ø¯ÙƒØªÙˆØ±Ø§Ù‡ ÙÙŠ Ø§Ù„ÙÙ„Ø³ÙØ©
        </div>
        
        <div className="author-decoration">
          <Award className="title-icon text-primary mx-auto" size={32} />
        </div>
        <div className="thesis-author mb-8">
          Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·Ø§Ù„Ø¨/Ø©<br />
          {thesis.metadata?.authorName || "Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø­Ø«/Ø©"}
        </div>
        
        <div className="thesis-date mb-8">
          {thesis.metadata?.thesisDate || "Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ / Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ"}
        </div>
        
        <div className="thesis-committee">
          Ù„Ø¬Ù†Ø© Ø§Ù„Ø¥Ø´Ø±Ø§Ù:<br />
          {thesis.metadata?.committeeMembers?.map((member, index) => (
            <React.Fragment key={index}>
              {member}
              <br />
            </React.Fragment>
          ))}
        </div>
      </div>
    </div>
  );
};

// File: src\components\thesis\preview\ContentElements.tsx

import React from 'react';
import { Figure, Table, Citation } from '@/types/thesis';
import { cn } from '@/lib/utils';
import { ThesisPreviewElement } from './ThesisPreviewElement';

interface ContentElementsProps {
  figures?: Figure[];
  tables?: Table[];
  citations?: Citation[];
  elementPositions: Array<{
    id: string;
    type: 'figure' | 'table' | 'citation';
    position: 'inline' | 'top' | 'bottom' | 'custom';
    customPosition?: {
      x: number;
      y: number;
    };
  }>;
  onElementClick: (id: string, type: 'figure' | 'table' | 'citation') => void;
  onPositionChange: (elementId: string, position: { x: number; y: number }) => void;
}

export const ContentElements = ({
  figures,
  tables,
  citations,
  elementPositions,
  onElementClick,
  onPositionChange
}: ContentElementsProps) => {
  const getElementPosition = (elementId: string) => {
    const position = elementPositions.find(p => p.id === elementId);
    return position?.position || 'inline';
  };

  const getCustomPosition = (elementId: string) => {
    const position = elementPositions.find(p => p.id === elementId);
    return position?.customPosition;
  };

  const renderFigures = (position: string = 'inline') => {
    if (!figures || figures.length === 0) return null;
    
    const positionedFigures = figures.filter(figure => 
      getElementPosition(figure.id) === position
    );

    if (positionedFigures.length === 0) return null;

    return (
      <div className="figures-container space-y-8 my-8">
        {positionedFigures.map((figure) => (
          <ThesisPreviewElement
            key={figure.id}
            id={figure.id}
            type="figure"
            position={getElementPosition(figure.id)}
            customPosition={getCustomPosition(figure.id)}
            onClick={onElementClick}
            onPositionChange={(pos) => onPositionChange(figure.id, pos)}
          >
            <figure className="text-center page-break-inside-avoid">
              <img 
                src={figure.url} 
                alt={figure.alt_text}
                className="mx-auto max-w-full h-auto rounded-lg shadow-md"
              />
              <figcaption className="mt-4 text-sm text-gray-600 italic">
                {figure.label}: {figure.caption}
              </figcaption>
            </figure>
          </ThesisPreviewElement>
        ))}
      </div>
    );
  };

  const renderTables = (position: string = 'inline') => {
    if (!tables || tables.length === 0) return null;

    const positionedTables = tables.filter(table => 
      getElementPosition(table.id) === position
    );

    if (positionedTables.length === 0) return null;

    return positionedTables.map((table) => (
      <ThesisPreviewElement
        key={table.id}
        id={table.id}
        type="table"
        position={getElementPosition(table.id)}
        customPosition={getCustomPosition(table.id)}
        onClick={onElementClick}
        onPositionChange={(pos) => onPositionChange(table.id, pos)}
      >
        <div className="my-8 page-break-inside-avoid">
          <div className="overflow-x-auto">
            <div dangerouslySetInnerHTML={{ __html: table.content }} />
          </div>
          {table.caption && (
            <p className="mt-2 text-sm text-gray-600 text-center">
              Table {table.id}: {table.caption}
            </p>
          )}
        </div>
      </ThesisPreviewElement>
    ));
  };

  const renderCitations = (position: string = 'inline') => {
    if (!citations || citations.length === 0) return null;

    const positionedCitations = citations.filter(citation => 
      getElementPosition(citation.id) === position
    );

    if (positionedCitations.length === 0) return null;

    return (
      <div className="citations-section mt-8 border-t pt-4 page-break-inside-avoid">
        <h3 className="text-lg font-serif mb-2">Citations</h3>
        <div className="space-y-2">
          {positionedCitations.map((citation) => (
            <ThesisPreviewElement
              key={citation.id}
              id={citation.id}
              type="citation"
              position={getElementPosition(citation.id)}
              customPosition={getCustomPosition(citation.id)}
              onClick={onElementClick}
              onPositionChange={(pos) => onPositionChange(citation.id, pos)}
            >
              <div className="citation-reference text-sm">
                {citation.authors.join(', ')} ({citation.year}). {citation.text}.
                {citation.journal && ` ${citation.journal}.`}
                {citation.doi && ` DOI: ${citation.doi}`}
              </div>
            </ThesisPreviewElement>
          ))}
        </div>
      </div>
    );
  };

  return (
    <>
      {renderFigures('top')}
      {renderTables('top')}
      {renderCitations('top')}
      
      {renderFigures('inline')}
      {renderTables('inline')}
      {renderCitations('inline')}
      
      {renderFigures('bottom')}
      {renderTables('bottom')}
      {renderCitations('bottom')}
      
      {renderFigures('custom')}
      {renderTables('custom')}
      {renderCitations('custom')}
    </>
  );
};

// File: src\components\thesis\preview\ContentSection.tsx

import React from 'react';
import { Section } from '@/types/thesis';
import MDEditor from '@uiw/react-md-editor';
import { cn } from '@/lib/utils';
import { ContentElements } from './ContentElements';

interface ContentSectionProps {
  section: Section;
  chapterTitle?: string;
  elementPositions: Array<{
    id: string;
    type: 'figure' | 'table' | 'citation';
    position: 'inline' | 'top' | 'bottom' | 'custom';
    customPosition?: {
      x: number;
      y: number;
    };
  }>;
  onElementClick: (id: string, type: 'figure' | 'table' | 'citation') => void;
  onPositionChange: (elementId: string, position: { x: number; y: number }) => void;
}

export const ContentSection = ({ 
  section, 
  chapterTitle, 
  elementPositions,
  onElementClick,
  onPositionChange 
}: ContentSectionProps) => {
  const isSpecialSection = section.type === 'references' || section.type === 'table-of-contents';

  return (
    <div className="thesis-page">
      <div className="thesis-header">
        {chapterTitle ? `Chapter ${chapterTitle} - ${section.title}` : section.title}
      </div>
      
      <div className={cn(
        "thesis-content",
        section.type === 'references' && "thesis-references",
        "prose prose-sm max-w-none"
      )}>
        {section.type !== 'table-of-contents' && (
          <>
            {chapterTitle && (
              <h2 className="text-2xl font-serif mb-4 break-after-avoid">
                {section.title}
              </h2>
            )}
            <div className="break-inside-avoid">
              <MDEditor.Markdown source={section.content} />
            </div>
            
            <ContentElements
              figures={section.figures}
              tables={section.tables}
              citations={section.citations}
              elementPositions={elementPositions}
              onElementClick={onElementClick}
              onPositionChange={onPositionChange}
            />
          </>
        )}

        {section.type === 'table-of-contents' && (
          <div className="toc-content break-inside-avoid">
            <h2 className="text-2xl font-serif mb-4">Table of Contents</h2>
          </div>
        )}
      </div>

      {section.footnotes && section.footnotes.length > 0 && (
        <div className="thesis-footnotes">
          {section.footnotes.map((footnote) => (
            <div key={footnote.id} className="thesis-footnote">
              {footnote.content}
            </div>
          ))}
        </div>
      )}

      <div className="thesis-footer">
        {!isSpecialSection && <span>Page <span className="page-number"></span></span>}
      </div>
    </div>
  );
};

// File: src\components\thesis\preview\ElementControls.tsx

import React, { useState } from 'react';
import { Card } from '@/components/ui/card';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Slider } from '@/components/ui/slider';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { ArrowUp, ArrowDown, Move, Maximize2, Minimize2, AlignLeft, AlignCenter, AlignRight } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { motion } from 'framer-motion';

interface ElementControlsProps {
  elementId: string;
  type: 'figure' | 'table' | 'citation';
  position: 'inline' | 'top' | 'bottom' | 'custom';
  x?: number;
  y?: number;
  width?: number;
  height?: number;
  onUpdatePosition: (position: string) => void;
  onUpdateCoordinates: (x: number, y: number) => void;
  onUpdateSize: (width: number, height: number) => void;
  onClose: () => void;
}

export const ElementControls = ({
  elementId,
  type,
  position,
  x = 0,
  y = 0,
  width,
  height,
  onUpdatePosition,
  onUpdateCoordinates,
  onUpdateSize,
  onClose
}: ElementControlsProps) => {
  const { toast } = useToast();
  const [alignment, setAlignment] = useState<'left' | 'center' | 'right'>('left');
  const [marginTop, setMarginTop] = useState(0);
  const [marginBottom, setMarginBottom] = useState(0);

  const handlePositionChange = (newPosition: string) => {
    console.log('Updating element position:', { elementId, newPosition });
    onUpdatePosition(newPosition);
    
    toast({
      title: "Position Updated",
      description: `${type.charAt(0).toUpperCase() + type.slice(1)} position updated successfully`,
    });
  };

  const handleCoordinateChange = (newX: number, newY: number) => {
    console.log('Updating element coordinates:', { elementId, x: newX, y: newY });
    onUpdateCoordinates(newX, newY);
  };

  const handleAlignmentChange = (newAlignment: 'left' | 'center' | 'right') => {
    setAlignment(newAlignment);
    let newX = x;
    if (newAlignment === 'center') newX = window.innerWidth / 2 - (width || 0) / 2;
    if (newAlignment === 'right') newX = window.innerWidth - (width || 0) - 20;
    handleCoordinateChange(newX, y);
  };

  const handleMarginChange = (top: number, bottom: number) => {
    setMarginTop(top);
    setMarginBottom(bottom);
    handleCoordinateChange(x, y + top);
  };

  return (
    <motion.div
      initial={{ opacity: 0, scale: 0.95 }}
      animate={{ opacity: 1, scale: 1 }}
      exit={{ opacity: 0, scale: 0.95 }}
      transition={{ duration: 0.2 }}
    >
      <Card className="fixed z-50 p-4 space-y-4 shadow-lg w-80 bg-background/95 backdrop-blur">
        <div className="flex justify-between items-center">
          <h3 className="text-sm font-medium">
            {type.charAt(0).toUpperCase() + type.slice(1)} Controls
          </h3>
          <Button variant="ghost" size="sm" onClick={onClose}>Ã—</Button>
        </div>

        <div className="space-y-4">
          <div className="space-y-2">
            <Label>Position Type</Label>
            <Select value={position} onValueChange={handlePositionChange}>
              <SelectTrigger>
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="inline">Inline with Text</SelectItem>
                <SelectItem value="top">Top of Page</SelectItem>
                <SelectItem value="bottom">Bottom of Page</SelectItem>
                <SelectItem value="custom">Custom Position</SelectItem>
              </SelectContent>
            </Select>
          </div>

          {position === 'custom' && (
            <motion.div
              initial={{ opacity: 0, height: 0 }}
              animate={{ opacity: 1, height: 'auto' }}
              exit={{ opacity: 0, height: 0 }}
              transition={{ duration: 0.2 }}
              className="space-y-4"
            >
              <div className="space-y-2">
                <Label>Alignment</Label>
                <div className="flex gap-2">
                  <Button
                    variant={alignment === 'left' ? 'default' : 'outline'}
                    size="sm"
                    onClick={() => handleAlignmentChange('left')}
                  >
                    <AlignLeft className="w-4 h-4" />
                  </Button>
                  <Button
                    variant={alignment === 'center' ? 'default' : 'outline'}
                    size="sm"
                    onClick={() => handleAlignmentChange('center')}
                  >
                    <AlignCenter className="w-4 h-4" />
                  </Button>
                  <Button
                    variant={alignment === 'right' ? 'default' : 'outline'}
                    size="sm"
                    onClick={() => handleAlignmentChange('right')}
                  >
                    <AlignRight className="w-4 h-4" />
                  </Button>
                </div>
              </div>

              <div className="space-y-2">
                <Label>Margins</Label>
                <div className="space-y-4">
                  <div>
                    <Label className="text-xs">Top Margin (px)</Label>
                    <Slider
                      value={[marginTop]}
                      onValueChange={([value]) => handleMarginChange(value, marginBottom)}
                      max={100}
                      step={1}
                    />
                  </div>
                  <div>
                    <Label className="text-xs">Bottom Margin (px)</Label>
                    <Slider
                      value={[marginBottom]}
                      onValueChange={([value]) => handleMarginChange(marginTop, value)}
                      max={100}
                      step={1}
                    />
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-2">
                <div className="space-y-1">
                  <Label>X Position (px)</Label>
                  <Input
                    type="number"
                    value={x}
                    onChange={(e) => handleCoordinateChange(Number(e.target.value), y)}
                    min={0}
                    step={1}
                  />
                </div>
                <div className="space-y-1">
                  <Label>Y Position (px)</Label>
                  <Input
                    type="number"
                    value={y}
                    onChange={(e) => handleCoordinateChange(x, Number(e.target.value))}
                    min={0}
                    step={1}
                  />
                </div>
              </div>

              {(type === 'figure' || type === 'table') && (
                <div className="grid grid-cols-2 gap-2">
                  <div className="space-y-1">
                    <Label>Width (px)</Label>
                    <Input
                      type="number"
                      value={width}
                      onChange={(e) => onUpdateSize(Number(e.target.value), height || 0)}
                      min={0}
                      step={1}
                    />
                  </div>
                  <div className="space-y-1">
                    <Label>Height (px)</Label>
                    <Input
                      type="number"
                      value={height}
                      onChange={(e) => onUpdateSize(width || 0, Number(e.target.value))}
                      min={0}
                      step={1}
                    />
                  </div>
                </div>
              )}

              <div className="flex gap-2 justify-center pt-2">
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => handlePositionChange('inline')}
                  className="gap-1"
                >
                  <Move className="w-4 h-4" />
                  Reset Position
                </Button>
              </div>
            </motion.div>
          )}
        </div>
      </Card>
    </motion.div>
  );
};

// File: src\components\thesis\preview\ElementPositionManager.tsx

import React, { useState } from 'react';
import { Figure, Table, Citation } from '@/types/thesis';
import { ElementControls } from './ElementControls';

interface ElementPosition {
  id: string;
  type: 'figure' | 'table' | 'citation';
  position: 'inline' | 'top' | 'bottom' | 'custom';
  customPosition?: {
    x: number;
    y: number;
  };
  size?: {
    width: number;
    height: number;
  };
}

interface ElementPositionManagerProps {
  figures: Figure[];
  tables: Table[];
  citations: Citation[];
  onUpdatePosition: (elementId: string, position: ElementPosition) => void;
}

export const ElementPositionManager = ({
  figures,
  tables,
  citations,
  onUpdatePosition
}: ElementPositionManagerProps) => {
  const [selectedElement, setSelectedElement] = useState<ElementPosition | null>(null);
  const [isDragging, setIsDragging] = useState(false);

  const handleElementClick = (element: { id: string, type: ElementPosition['type'] }) => {
    console.log('Element clicked:', element);
    setSelectedElement({
      id: element.id,
      type: element.type,
      position: 'inline',
      customPosition: { x: 0, y: 0 }
    });
  };

  const handlePositionChange = (position: ElementPosition['position']) => {
    if (!selectedElement) return;
    console.log('Position changed:', position);
    
    onUpdatePosition(selectedElement.id, {
      ...selectedElement,
      position
    });
  };

  const handleCoordinatesChange = (x: number, y: number) => {
    if (!selectedElement) return;
    console.log('Coordinates changed:', { x, y });
    
    onUpdatePosition(selectedElement.id, {
      ...selectedElement,
      position: 'custom',
      customPosition: { x, y }
    });
  };

  const handleSizeChange = (width: number, height: number) => {
    if (!selectedElement) return;
    console.log('Size changed:', { width, height });
    
    onUpdatePosition(selectedElement.id, {
      ...selectedElement,
      size: { width, height }
    });
  };

  const handleDragStart = () => {
    setIsDragging(true);
  };

  const handleDragEnd = () => {
    setIsDragging(false);
  };

  return (
    <div className="relative">
      {selectedElement && (
        <ElementControls
          elementId={selectedElement.id}
          type={selectedElement.type}
          position={selectedElement.position}
          x={selectedElement.customPosition?.x}
          y={selectedElement.customPosition?.y}
          width={selectedElement.size?.width}
          height={selectedElement.size?.height}
          onUpdatePosition={handlePositionChange}
          onUpdateCoordinates={handleCoordinatesChange}
          onUpdateSize={handleSizeChange}
          onClose={() => setSelectedElement(null)}
        />
      )}

      <style>
        {`
          .interactive-element {
            cursor: ${isDragging ? 'grabbing' : 'grab'};
            transition: outline 0.2s ease;
            user-select: none;
          }
          .interactive-element:hover {
            outline: 2px solid #3b82f6;
          }
          .interactive-element.selected {
            outline: 2px solid #2563eb;
          }
        `}
      </style>
    </div>
  );
};

// File: src\components\thesis\preview\FrenchTitlePage.tsx

import React from 'react';
import { GraduationCap, BookOpen, Award } from 'lucide-react';
import { Section, Thesis } from '@/types/thesis';

interface FrenchTitlePageProps {
  thesis: Thesis;
  titleSection?: Section;
}

export const FrenchTitlePage = ({ thesis, titleSection }: FrenchTitlePageProps) => {
  return (
    <div className="thesis-page title-page">
      <div className="thesis-title-content">
        <div className="university-decoration">
          <GraduationCap className="title-icon text-primary" size={48} />
        </div>
        <div className="university-name">
          {thesis.metadata?.universityName || "Nom de l'UniversitÃ©"}
        </div>
        <div className="department-name">
          {thesis.metadata?.departmentName || "DÃ©partement"}
        </div>
        
        <div className="thesis-decoration">
          <BookOpen className="title-icon text-primary-light" size={36} />
        </div>
        <div className="thesis-main-title">
          {titleSection?.content || "Titre de la thÃ¨se"}
        </div>
        
        <div className="thesis-subtitle">
          ThÃ¨se prÃ©sentÃ©e en vue de l'obtention<br />
          du grade de Docteur en<br />
          {thesis.metadata?.departmentName || "[Discipline]"}
        </div>
        
        <div className="author-decoration">
          <Award className="title-icon text-primary" size={32} />
        </div>
        <div className="thesis-author">
          par<br />
          {thesis.metadata?.authorName || "Nom de l'auteur"}
        </div>
        
        <div className="thesis-date">
          {thesis.metadata?.thesisDate || "Mois AnnÃ©e"}
        </div>
        
        <div className="thesis-committee">
          Membres du jury :<br />
          {thesis.metadata?.committeeMembers?.map((member, index) => (
            <React.Fragment key={index}>
              {member}<br />
            </React.Fragment>
          ))}
        </div>
      </div>
    </div>
  );
};

// File: src\components\thesis\preview\ThesisPreviewElement.tsx

import React, { useState, useRef } from 'react';
import { cn } from '@/lib/utils';
import { useToast } from '@/hooks/use-toast';

interface ThesisPreviewElementProps {
  id: string;
  type: 'figure' | 'table' | 'citation';
  position?: 'inline' | 'top' | 'bottom' | 'custom';
  customPosition?: { x: number; y: number };
  size?: { width: number; height: number };
  onClick: (id: string, type: 'figure' | 'table' | 'citation') => void;
  onPositionChange?: (position: { x: number; y: number }) => void;
  children: React.ReactNode;
}

export const ThesisPreviewElement = ({
  id,
  type,
  position = 'inline',
  customPosition,
  size,
  onClick,
  onPositionChange,
  children
}: ThesisPreviewElementProps) => {
  const [isDragging, setIsDragging] = useState(false);
  const elementRef = useRef<HTMLDivElement>(null);
  const { toast } = useToast();

  const handleDragStart = (e: React.MouseEvent) => {
    if (position !== 'custom') return;
    
    setIsDragging(true);
    const rect = elementRef.current?.getBoundingClientRect();
    if (rect) {
      const offsetX = e.clientX - rect.left;
      const offsetY = e.clientY - rect.top;
      
      const handleMouseMove = (moveEvent: MouseEvent) => {
        if (!isDragging) return;
        
        const newX = moveEvent.clientX - offsetX;
        const newY = moveEvent.clientY - offsetY;
        
        if (onPositionChange) {
          onPositionChange({ x: newX, y: newY });
        }
      };

      const handleMouseUp = () => {
        setIsDragging(false);
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
        
        toast({
          title: "Position Updated",
          description: `${type.charAt(0).toUpperCase() + type.slice(1)} position updated`,
        });
      };

      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);
    }
  };

  return (
    <div
      ref={elementRef}
      className={cn(
        "interactive-element",
        position === 'custom' && "absolute cursor-move",
        isDragging && "opacity-70",
        "transition-all duration-200"
      )}
      style={{
        ...(position === 'custom' && customPosition
          ? {
              top: customPosition.y,
              left: customPosition.x,
            }
          : {}),
        ...(size
          ? {
              width: size.width,
              height: size.height,
            }
          : {})
      }}
      onClick={() => onClick(id, type)}
      onMouseDown={handleDragStart}
    >
      {children}
    </div>
  );
};

// File: src\components\thesis\preview\TitlePage.tsx

import React from 'react';
import { Section, ThesisMetadata } from '@/types/thesis';
import { GraduationCap, BookOpen, Award } from 'lucide-react';

interface TitlePageProps {
  metadata: ThesisMetadata;
  titleSection?: Section;
}

export const TitlePage = ({ metadata, titleSection }: TitlePageProps) => {
  console.log('Rendering Title Page with data:', metadata);
  
  return (
    <div className="thesis-page title-page min-h-[297mm] flex flex-col items-center justify-between py-16 px-8">
      <div className="thesis-title-content w-full max-w-3xl mx-auto space-y-12 text-center">
        <div className="university-section space-y-4">
          <div className="university-decoration flex justify-center">
            <GraduationCap className="title-icon text-primary" size={48} />
          </div>
          <div className="university-name text-2xl font-semibold">
            {metadata?.universityName || "Your University Name"}
          </div>
          <div className="department-name text-xl">
            {metadata?.departmentName || "Department of Your Field"}
          </div>
        </div>
        
        <div className="thesis-section space-y-6 mt-16">
          <div className="thesis-decoration flex justify-center">
            <BookOpen className="title-icon text-primary-light" size={36} />
          </div>
          <div className="thesis-main-title text-3xl font-bold leading-relaxed">
            {titleSection?.content || "Untitled Thesis"}
          </div>
        </div>
        
        <div className="thesis-subtitle text-lg leading-relaxed mt-8">
          A thesis submitted in partial fulfillment<br />
          of the requirements for the degree of<br />
          Doctor of Philosophy
        </div>
        
        <div className="author-section space-y-4 mt-16">
          <div className="author-decoration flex justify-center">
            <Award className="title-icon text-primary" size={32} />
          </div>
          <div className="thesis-author text-xl">
            by<br />
            <span className="font-semibold">{metadata?.authorName || "Author Name"}</span>
          </div>
        </div>
        
        <div className="thesis-date text-lg mt-8">
          {metadata?.thesisDate || "Month Year"}
        </div>
        
        <div className="thesis-committee text-lg mt-12">
          <div className="font-semibold mb-2">Thesis Committee:</div>
          {metadata?.committeeMembers?.map((member, index) => (
            <div key={index} className="committee-member">
              {member}
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

// File: src\components\thesis\section\EditorSection.tsx

import React, { useState, useEffect } from 'react';
import { useParams } from 'react-router-dom';
import { useToast } from '@/hooks/use-toast';
import { Card } from '@/components/ui/card';
import { MarkdownEditor } from '@/components/MarkdownEditor';
import { useThesisData } from '@/hooks/useThesisData';
import { supabase } from '@/integrations/supabase/client';
import { Section } from '@/types/thesis';
import { Skeleton } from '@/components/ui/skeleton';

export default function SectionEditor() {
  const { thesisId, sectionId } = useParams();
  const { thesis, setThesis } = useThesisData(thesisId);
  const { toast } = useToast();
  const [isLoading, setIsLoading] = useState(true);
  const [section, setSection] = useState<Section | null>(null);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (!thesis || !sectionId) return;
    
    const loadSection = async () => {
      try {
        setIsLoading(true);
        const section = await findSection();
        if (section) {
          setSection(section);
        }
      } catch (err) {
        console.error('Error loading section:', err);
        setError(err instanceof Error ? err.message : 'Failed to load section');
        toast({
          title: "Error",
          description: "Failed to load section. Please try again.",
          variant: "destructive",
        });
      } finally {
        setIsLoading(false);
      }
    };

    loadSection();
  }, [thesis, sectionId]);

  const findSection = async (): Promise<Section | null> => {
    if (!thesis || !sectionId) return null;

    // Check if it's the general introduction
    if (thesis.generalIntroduction?.id === sectionId || sectionId === 'general-introduction') {
      return thesis.generalIntroduction || null;
    }

    // Check if it's the general conclusion
    if (thesis.generalConclusion?.id === sectionId || sectionId === 'general-conclusion') {
      return thesis.generalConclusion || null;
    }

    // Check front matter
    const frontMatterSection = thesis.frontMatter?.find(s => s.id === sectionId);
    if (frontMatterSection) return frontMatterSection;

    // Check back matter
    const backMatterSection = thesis.backMatter?.find(s => s.id === sectionId);
    if (backMatterSection) return backMatterSection;

    // Check chapters
    if (thesis.chapters) {
      for (const chapter of thesis.chapters) {
        if (chapter.sections) {
          const section = chapter.sections.find(s => s.id === sectionId);
          if (section) return section;
        }
      }
    }

    // If section not found, try to create it
    try {
      console.log('Creating new section for:', { thesisId, sectionId });
      const { data: newSectionId, error } = await supabase.rpc(
        'create_section_if_not_exists',
        { 
          p_thesis_id: thesisId,
          p_section_title: 'New Section',
          p_section_type: 'custom'
        }
      );

      if (error) {
        console.error('Error creating section:', error);
        throw error;
      }

      // Refresh thesis data to get the new section
      const { data: updatedThesis, error: thesisError } = await supabase
        .from('theses')
        .select('*')
        .eq('id', thesisId)
        .single();

      if (thesisError) throw thesisError;

      if (updatedThesis) {
        const content = typeof updatedThesis.content === 'string' 
          ? JSON.parse(updatedThesis.content) 
          : updatedThesis.content;

        // Find the newly created section
        const newSection = content.frontMatter?.find((s: Section) => s.id === newSectionId);
        if (newSection) {
          return newSection;
        }
      }
    } catch (err) {
      console.error('Error creating section:', err);
      throw new Error('Failed to create new section');
    }

    return null;
  };

  const handleContentChange = async (newContent: string) => {
    if (!thesis || !section) return;

    try {
      const updatedThesis = { ...thesis };
      
      // Update the appropriate section based on its location
      if (section.id === thesis.generalIntroduction?.id) {
        updatedThesis.generalIntroduction = {
          ...thesis.generalIntroduction,
          content: newContent
        };
      } else if (section.id === thesis.generalConclusion?.id) {
        updatedThesis.generalConclusion = {
          ...thesis.generalConclusion,
          content: newContent
        };
      } else {
        // Update in front matter or chapters
        const frontMatterIndex = thesis.frontMatter?.findIndex(s => s.id === section.id);
        if (frontMatterIndex !== -1) {
          updatedThesis.frontMatter[frontMatterIndex] = {
            ...thesis.frontMatter[frontMatterIndex],
            content: newContent
          };
        } else {
          updatedThesis.chapters = thesis.chapters.map(chapter => ({
            ...chapter,
            sections: chapter.sections.map(s => 
              s.id === section.id ? { ...s, content: newContent } : s
            )
          }));
        }
      }

      setThesis(updatedThesis);
      setSection({ ...section, content: newContent });

      toast({
        title: "Success",
        description: "Section content updated",
      });
    } catch (err) {
      console.error('Error updating section:', err);
      toast({
        title: "Error",
        description: "Failed to update section content",
        variant: "destructive",
      });
    }
  };

  if (isLoading) {
    return (
      <div className="container mx-auto p-8">
        <Skeleton className="h-8 w-64 mb-6" />
        <Skeleton className="h-[500px] w-full" />
      </div>
    );
  }

  if (error) {
    return (
      <div className="container mx-auto p-8">
        <Card className="p-6">
          <h1 className="text-2xl font-bold text-destructive">Error</h1>
          <p className="mt-4 text-muted-foreground">{error}</p>
        </Card>
      </div>
    );
  }

  if (!section) {
    return (
      <div className="container mx-auto p-8">
        <Card className="p-6">
          <h1 className="text-2xl font-bold text-destructive">Section not found</h1>
          <p className="mt-4 text-muted-foreground">
            The requested section could not be found. Please check the URL and try again.
          </p>
        </Card>
      </div>
    );
  }

  return (
    <div className="container mx-auto p-8">
      <Card className="p-6">
        <h1 className="text-2xl font-bold mb-6">{section.title}</h1>
        <MarkdownEditor
          value={section.content}
          onChange={handleContentChange}
          placeholder="Start writing your section content..."
        />
      </Card>
    </div>
  );
}

// File: src\components\thesis\sidebar\TableOfContents.tsx

import React from 'react';
import { Section } from '@/types/thesis';
import { ThesisSidebarProps } from '@/types/components';

export const TableOfContents: React.FC<ThesisSidebarProps> = ({ sections, activeSection, onSectionSelect }) => {
  return (
    <div className="sidebar">
      <h2 className="text-lg font-semibold">Table of Contents</h2>
      <ul className="space-y-2">
        {sections.map((section) => (
          <li key={section.id} className={`cursor-pointer ${activeSection === section.id ? 'font-bold' : ''}`} onClick={() => onSectionSelect(section.id)}>
            {section.title}
          </li>
        ))}
      </ul>
    </div>
  );
};


// File: src\components\thesis\ThesisContent.tsx

import React from 'react';
import { Chapter, Section, Thesis } from '@/types/thesis';
import { ChapterManager } from '../ChapterManager';
import { Input } from '@/components/ui/input';
import { MarkdownEditor } from '../MarkdownEditor';
import { ChatMessages } from '../collaboration/ChatMessages';
import { GeneralSectionEditor } from '../editor/sections/GeneralSectionEditor';

interface ThesisContentProps {
  frontMatter: Section[];
  chapters: Chapter[];
  backMatter: Section[];
  generalIntroduction?: Section;
  generalConclusion?: Section;
  activeSection: string;
  onContentChange: (id: string, content: string) => void;
  onTitleChange: (id: string, title: string) => void;
  onUpdateChapter: (chapter: Chapter) => void;
  onAddChapter: (chapter: Chapter) => void;
  thesis: Thesis;
  thesisId: string;
  onUpdateThesis: (thesis: Thesis) => void;
}

export const ThesisContent: React.FC<ThesisContentProps> = ({
  frontMatter,
  chapters,
  backMatter,
  generalIntroduction,
  generalConclusion,
  activeSection,
  onContentChange,
  onTitleChange,
  onUpdateChapter,
  onAddChapter,
  thesis,
  thesisId,
  onUpdateThesis
}) => {
  console.log('ThesisContent rendering with thesis:', thesis);

  const renderSectionContent = (section: Section) => {
    const isActive = activeSection === section.id;
    if (!isActive) return null;

    return (
      <div key={section.id} className="editor-section space-y-6">
        <div className="flex items-center gap-3 mb-4">
          <Input
            value={section.title}
            onChange={(e) => onTitleChange(section.id, e.target.value)}
            className="text-xl font-serif border-none bg-transparent px-0 focus-visible:ring-0"
            placeholder="Section Title"
          />
        </div>
        <div className="mb-6">
          <MarkdownEditor
            value={Array.isArray(section.content) 
              ? section.content.map(item => item.content).join('\n\n')
              : section.content}
            onChange={(value) => onContentChange(section.id, value || '')}
            placeholder="Start writing..."
          />
        </div>
      </div>
    );
  };

  return (
    <div className="space-y-6">
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="lg:col-span-2 space-y-6">
          {generalIntroduction && activeSection === generalIntroduction.id && (
            <GeneralSectionEditor
              section={generalIntroduction}
              title="General Introduction"
              onUpdate={(updatedSection) => {
                onUpdateThesis({
                  ...thesis,
                  content: {
                    ...thesis.content,
                    generalIntroduction: updatedSection
                  }
                });
              }}
            />
          )}

          {frontMatter.map(section => renderSectionContent(section))}
          
          <div className="space-y-8">
            <ChapterManager
              chapters={chapters}
              onUpdateChapter={onUpdateChapter}
              onAddChapter={onAddChapter}
            />
          </div>

          {generalConclusion && activeSection === generalConclusion.id && (
            <GeneralSectionEditor
              section={generalConclusion}
              title="General Conclusion"
              onUpdate={(updatedSection) => {
                onUpdateThesis({
                  ...thesis,
                  content: {
                    ...thesis.content,
                    generalConclusion: updatedSection
                  }
                });
              }}
            />
          )}

          {backMatter.map(section => renderSectionContent(section))}
        </div>

        <div className="lg:col-span-1">
          <ChatMessages thesisId={thesisId} />
        </div>
      </div>
    </div>
  );
};

// File: src\components\thesis\ThesisCreationForm.tsx

import { useState, useEffect } from 'react';
import { Button } from "@/components/ui/button";
import { useToast } from "@/hooks/use-toast";
import { supabase } from "@/integrations/supabase/client";
import { useNavigate } from 'react-router-dom';
import { useForm } from '@/hooks/useForm';
import { useThesisCreation } from '@/components/thesis/form/useThesisCreation';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { BasicThesisFields } from './form/BasicThesisFields';
import { InstitutionFields } from './form/InstitutionFields';
import { AuthorFields } from './form/AuthorFields';
import { CommitteeFields } from './form/CommitteeFields';
import { ArrowLeft } from 'lucide-react';

export const ThesisCreationForm = () => {
  const {
    values,
    errors,
    isSubmitting,
    handleChange,
    handleSubmit,
    handleArrayChange
  } = useForm({
    initialValues: {
      title: '',
      description: '',
      keywords: '',
      universityName: '',
      departmentName: '',
      authorName: '',
      thesisDate: '',
      committeeMembers: ['', '', ''],
    },
    validate: (values) => {
      const err: any = {};
      if (!values.title) {
        err.title = "Title is required";
      }
      if (!values.description) {
        err.description = "Description is required";
      }
      if (!values.keywords) {
        err.keywords = "Keywords are required";
      }
      return err;
    },
    onSubmit: async (values) => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user?.id) {
        setError('You must be logged in to create a thesis');
        return;
      }

      const metadata = {
        ...values,
        keywords: values.keywords
      };
      const result = await createThesis(metadata, session.user.id);
      if (result?.thesisId) {
        navigate(`/thesis/${result.thesisId}`);
      }
    },
  });

  const [error, setError] = useState<string | null>(null);
  const { createThesis } = useThesisCreation();
  const { toast } = useToast();
  const navigate = useNavigate();

  useEffect(() => {
    const checkAuth = async () => {
      const { data: { session }, error: authError } = await supabase.auth.getSession();
      if (authError || !session) {
        console.error('Authentication error:', authError);
        toast({
          title: "Authentication Required",
          description: "Please sign in to create a thesis.",
          variant: "destructive",
        });
        navigate('/auth');
      }
    };

    checkAuth();
  }, [navigate, toast]);

  const handleCommitteeMemberChange = (index: number, value: string) => {
    handleArrayChange('committeeMembers', index, value)
  }

  const handleCancel = () => {
    navigate(-1);
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-6 max-w-2xl mx-auto p-6 relative">
      <Button
        variant="ghost"
        size="icon"
        className="absolute -top-2 -left-2"
        onClick={() => navigate(-1)}
      >
        <ArrowLeft className="h-6 w-6" />
      </Button>

      <Card>
        <CardHeader>
          <CardTitle className="text-2xl font-bold">Create New Thesis</CardTitle>
        </CardHeader>
        <CardContent>
          {error && (
            <Alert variant="destructive" className="mb-4">
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}

          <div className="space-y-6">
            <BasicThesisFields values={values} handleChange={handleChange} />
            <InstitutionFields values={values} handleChange={handleChange} />
            <AuthorFields values={values} handleChange={handleChange} />
            <CommitteeFields
              committeeMembers={values.committeeMembers}
              handleCommitteeMemberChange={handleCommitteeMemberChange}
            />
            
            <div className="flex gap-4">
              <Button 
                type="submit" 
                disabled={isSubmitting} 
                className="flex-1"
              >
                {isSubmitting ? 'Creating...' : 'Create Thesis'}
              </Button>
              <Button 
                type="button" 
                variant="destructive" 
                onClick={handleCancel}
                className="flex-1"
              >
                Cancel
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>
    </form>
  );
};

// File: src\components\thesis\ThesisCreationModal.tsx

import React from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { ThesisTemplateSelector } from './ThesisTemplateSelector';
import { useNavigate } from 'react-router-dom';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/hooks/use-toast';
import { PlusCircle } from 'lucide-react';

interface ThesisCreationModalProps {
  onThesisCreated?: () => void;
}

export const ThesisCreationModal: React.FC<ThesisCreationModalProps> = ({ onThesisCreated }) => {
  const navigate = useNavigate();
  const { toast } = useToast();
  const [open, setOpen] = React.useState(false);

  const handleTemplateSelect = async (template: any) => {
    try {
      console.log('Creating new thesis from template:', template);
      
      const { data: session } = await supabase.auth.getSession();
      if (!session?.session?.user) {
        throw new Error('User not authenticated');
      }

      const { data: thesis, error } = await supabase
        .from('theses')
        .insert({
          title: 'Untitled Thesis',
          content: {
            frontMatter: template.structure.frontMatter || [],
            chapters: template.structure.chapters || [],
            backMatter: template.structure.backMatter || [],
            generalIntroduction: template.structure.generalIntroduction || {
              id: 'general-introduction',
              title: 'General Introduction',
              type: 'general-introduction',
              content: ''
            },
            generalConclusion: template.structure.generalConclusion || {
              id: 'general-conclusion',
              title: 'General Conclusion',
              type: 'general-conclusion',
              content: ''
            },
            metadata: template.structure.metadata || {},
            description: template.structure.description || '',
          },
          description: template.structure.description || '',
          metadata: template.structure.metadata || {},
          frontMatter: template.structure.frontMatter || [],
          generalIntroduction: template.structure.generalIntroduction || {
            id: 'general-introduction',
            title: 'General Introduction',
            type: 'general-introduction',
            content: ''
          },
          generalConclusion: template.structure.generalConclusion || {
            id: 'general-conclusion',
            title: 'General Conclusion',
            type: 'general-conclusion',
            content: ''
          },
          backMatter: template.structure.backMatter || [],
          user_id: session.session.user.id,
        })
        .select()
        .single();

      if (error) throw error;

      if (!thesis) throw new Error('Failed to create thesis');

      // Add the user as an owner collaborator
      const { error: collabError } = await supabase
        .from('thesis_collaborators')
        .insert({
          thesis_id: thesis.id,
          user_id: session.session.user.id,
          role: 'owner'
        });

      if (collabError) throw collabError;

      console.log('Thesis created successfully:', thesis);
      console.log('Thesis created with ID:', thesis.id);
      console.log('Navigating to thesis with ID:', thesis.id);
      console.log('Redirecting to thesis route:', `/thesis/${thesis.id}`);
      
      toast({
        title: "Success",
        description: "New thesis created from template",
      });

      navigate(`/thesis/${thesis.id}`); // Redirect to the new thesis route
      setOpen(false); // Close the modal
    } catch (error: any) {
      console.error('Error creating thesis:', error);
      toast({
        title: "Error",
        description: error.message || "Failed to create thesis",
        variant: "destructive",
      });
    }
  };

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button className="gap-2">
          <PlusCircle className="w-4 h-4" />
          New Thesis
        </Button>
      </DialogTrigger>
      <DialogContent className="max-w-3xl">
        <DialogHeader>
          <DialogTitle>Choose a Template</DialogTitle>
        </DialogHeader>
        <ThesisTemplateSelector onSelect={handleTemplateSelect} />
      </DialogContent>
    </Dialog>
  );
};

// File: src\components\thesis\ThesisHeader.tsx

import React, { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/hooks/use-toast';
import { CollaboratorsList } from './CollaboratorsList';
import { UserSection } from './header/UserSection';
import { HeaderActions } from './header/HeaderActions';
import { Collaborator } from '@/types/collaborator';

interface ThesisHeaderProps {
  showPreview: boolean;
  onTogglePreview: () => void;
  thesisId: string;
  thesisTitle: string;
  isAdmin?: boolean;
  thesisData: any;
}

export const ThesisHeader = ({ 
  showPreview, 
  onTogglePreview,
  thesisId,
  thesisTitle,
  isAdmin = false,
  thesisData
}: ThesisHeaderProps) => {
  const navigate = useNavigate();
  const { toast } = useToast();
  const [userEmail, setUserEmail] = useState<string>('');
  const [userRole, setUserRole] = useState<string>('');
  const [collaborators, setCollaborators] = useState<Collaborator[]>([]);
  const [currentUserRole, setCurrentUserRole] = useState<string | null>(null);

  useEffect(() => {
    const fetchUserProfile = async () => {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          navigate('/auth');
          return;
        }

        const { data: profile, error } = await supabase
          .from('profiles')
          .select(`
            email,
            roles (
              name
            )
          `)
          .eq('id', session.user.id)
          .single();

        if (error) {
          console.error('Error fetching profile:', error);
          return;
        }

        if (profile) {
          setUserEmail(profile.email);
          setUserRole(profile.roles?.name || '');
        }

        const { data: collaboratorData } = await supabase
          .from('thesis_collaborators')
          .select('role')
          .eq('thesis_id', thesisId)
          .eq('user_id', session.user.id)
          .single();

        setCurrentUserRole(collaboratorData?.role || null);
      } catch (error) {
        console.error('Error fetching user profile:', error);
      }
    };

    fetchUserProfile();
  }, [thesisId, navigate]);

  useEffect(() => {
    const fetchCollaborators = async () => {
      try {
        const { data, error } = await supabase
          .from('thesis_collaborators')
          .select(`
            user_id,
            role,
            profiles (
              email,
              roles (
                name
              )
            )
          `)
          .eq('thesis_id', thesisId);

        if (error) {
          console.error('Error fetching collaborators:', error);
          return;
        }

        if (data) {
          setCollaborators(data as Collaborator[]);
        }
      } catch (error) {
        console.error('Error fetching collaborators:', error);
      }
    };

    if (thesisId) {
      fetchCollaborators();
    }
  }, [thesisId]);

  const handleLogout = async () => {
    try {
      const { error } = await supabase.auth.signOut();
      if (error) {
        toast({
          title: "Error signing out",
          description: error.message,
          variant: "destructive",
        });
        return;
      }
      navigate('/auth');
    } catch (error: any) {
      console.error('Error during logout:', error);
      toast({
        title: "Error signing out",
        description: "An unexpected error occurred. Please try again.",
        variant: "destructive",
      });
      navigate('/auth');
    }
  };

  const handleSaveToJson = () => {
    try {
      const jsonData = JSON.stringify(thesisData, null, 2);
      const blob = new Blob([jsonData], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `thesis_${thesisId}_${new Date().toISOString()}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      toast({
        title: "Success",
        description: "Thesis saved as JSON file.",
      });
    } catch (error) {
      console.error('Error saving thesis to JSON:', error);
      toast({
        title: "Error",
        description: "Failed to save thesis as JSON file.",
        variant: "destructive",
      });
    }
  };

  return (
    <div className="flex justify-between items-center">
      <h1 className="text-2xl font-serif">Thesis Editor</h1>
      <div className="flex items-center gap-4">
        {userEmail && <UserSection userEmail={userEmail} userRole={userRole} />}
        <CollaboratorsList collaborators={collaborators} thesisId={thesisId} />
        <HeaderActions
          showPreview={showPreview}
          onTogglePreview={onTogglePreview}
          onSaveToJson={handleSaveToJson}
        />
      </div>
    </div>
  );
};


// File: src\components\thesis\ThesisList.tsx

import { useCallback, useEffect, useState } from 'react';
import { Button } from '@/components/ui/button';
import { ScrollArea } from "@/components/ui/scroll-area";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { ArrowDown, ArrowUp, Loader2 } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { useNavigate } from 'react-router-dom';
import { useThesesList } from '@/hooks/useThesesList';
import { ThesisListItem } from './ThesisListItem';
import { supabase } from '@/integrations/supabase/client';

export const ThesisList = () => {
  const [open, setOpen] = useState(false);
  const [loadingThesis, setLoadingThesis] = useState<string | null>(null);
  const { thesisList, isLoading, error, fetchTheses } = useThesesList();
  const { toast } = useToast();
  const navigate = useNavigate();

  const handleLoadThesis = async (thesisId: string) => {
    try {
      console.log('ðŸ“ Loading thesis:', thesisId);
      setLoadingThesis(thesisId);
      
      const { data: session } = await supabase.auth.getSession();
      if (!session?.session?.user) {
        console.error('âŒ No authenticated user found');
        toast({
          title: "Authentication Error",
          description: "Please sign in to view this thesis",
          variant: "destructive",
        });
        return;
      }

      const { data: collaborator, error: collaboratorError } = await supabase
        .from('thesis_collaborators')
        .select('role')
        .eq('thesis_id', thesisId)
        .eq('user_id', session.session.user.id)
        .maybeSingle();

      if (collaboratorError) {
        console.error('âŒ Error checking thesis access:', collaboratorError);
        toast({
          title: "Access Error",
          description: "You don't have permission to view this thesis",
          variant: "destructive",
        });
        return;
      }

      navigate(`/thesis/${thesisId}`);
      setOpen(false);
      toast({
        title: "Loading thesis",
        description: "Please wait while we load your thesis...",
      });
    } catch (error: any) {
      console.error('âŒ Error loading thesis:', error);
      toast({
        title: "Error",
        description: "Failed to load thesis. Please try again.",
        variant: "destructive",
      });
    } finally {
      setLoadingThesis(null);
    }
  };

  // Only fetch theses when the popover is opened
  const handleToggleOpen = useCallback(() => {
    setOpen((prevOpen) => !prevOpen);
  }, []);

  // Only fetch theses once when the popover is opened
  useEffect(() => {
    if (open) {
      console.log('ðŸ”„ Fetching theses list...');
      fetchTheses();
    }
  }, [open]);

  return (
    <Popover open={open} onOpenChange={setOpen}>
      <PopoverTrigger asChild>
        <Button
          onClick={handleToggleOpen}
          className="gap-2 bg-transparent border-gray-700 text-white hover:bg-white/5 font-sans"
          disabled={isLoading}
        >
          {isLoading ? (
            <Loader2 className="w-4 h-4 animate-spin" />
          ) : open ? (
            <ArrowUp className="w-4 h-4" />
          ) : (
            <ArrowDown className="w-4 h-4" />
          )}
          Load Thesis
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-80 bg-[#1A1F2C] border-gray-700">
        <ScrollArea className="h-[200px] pr-4">
          {error ? (
            <div className="text-center py-4">
              <p className="text-red-400 text-sm">{error}</p>
              <Button
                variant="ghost"
                onClick={fetchTheses}
                className="mt-2 text-gray-300 hover:text-white"
              >
                Try Again
              </Button>
            </div>
          ) : (
            <div className="space-y-2">
              {thesisList.map((thesis) => (
                <ThesisListItem
                  key={thesis.id}
                  id={thesis.id}
                  title={thesis.title}
                  isLoading={loadingThesis === thesis.id}
                  onSelect={handleLoadThesis}
                />
              ))}
              {thesisList.length === 0 && !isLoading && (
                <p className="text-center text-sm text-gray-400 py-4 font-sans">
                  No theses found
                </p>
              )}
              {isLoading && (
                <div className="flex justify-center py-4">
                  <Loader2 className="w-6 h-6 animate-spin text-[#9b87f5]" />
                </div>
              )}
            </div>
          )}
        </ScrollArea>
      </PopoverContent>
    </Popover>
  );
};

// File: src\components\thesis\ThesisListItem.tsx

import { Button } from '@/components/ui/button';
import { Loader2 } from 'lucide-react';

interface ThesisListItemProps {
  id: string;
  title: string;
  isLoading: boolean;
  onSelect: (id: string) => void;
}

export const ThesisListItem = ({ id, title, isLoading, onSelect }: ThesisListItemProps) => {
  return (
    <Button
      variant="ghost"
      className="w-full text-left text-gray-300 hover:bg-white/5 hover:text-white font-sans"
      onClick={() => onSelect(id)}
      disabled={isLoading}
    >
      {title}
      {isLoading && <Loader2 className="w-4 h-4 ml-2 animate-spin" />}
    </Button>
  );
};

// File: src\components\thesis\ThesisSaveButton.tsx

// File: src/components/thesis/ThesisSaveButton.tsx
import { Button } from "@/components/ui/button";
import { useToast } from "@/hooks/use-toast";
import { supabase } from "@/integrations/supabase/client";
import { Thesis } from "@/types/thesis";
import { Save } from "lucide-react";
import { useState } from "react";
import { Json } from '@/integrations/supabase/types';


interface ThesisSaveButtonProps {
  thesisId: string;
  thesisData: Thesis;
}

export const ThesisSaveButton = ({ thesisId, thesisData }: ThesisSaveButtonProps) => {
  const [isSaving, setIsSaving] = useState(false);
  const { toast } = useToast();

  const handleSave = async () => {
    try {
      setIsSaving(true);
      console.log('Starting thesis save operation:', { thesisId, content: thesisData });
      
      // First check if thesis exists
      const { data: existingThesis, error: checkError } = await supabase
        .from('theses')
        .select('*')
        .eq('id', thesisId)
        .maybeSingle();

      if (checkError) {
        console.error('Error checking thesis:', checkError);
        throw checkError;
      }

      if (!existingThesis) {
        console.error('Thesis not found:', thesisId);
        throw new Error('Thesis not found. Please refresh the page and try again.');
      }

      // Convert Thesis object to a JSON-compatible format
      const thesisContent = JSON.parse(JSON.stringify({
        metadata: thesisData.metadata,
        frontMatter: thesisData.frontMatter,
        chapters: thesisData.chapters,
        backMatter: thesisData.backMatter
      })) as unknown as Json;

      const { data, error } = await supabase
        .from('theses')
        .update({ 
          content: thesisContent,
          updated_at: new Date().toISOString()
        })
        .eq('id', thesisId)
        .select()
        .maybeSingle();

      if (error) {
        console.error('Error saving thesis:', error);
        throw error;
      }

      if (!data) {
        throw new Error('Failed to save thesis. Please try again.');
      }

      console.log('Thesis saved successfully:', data);

      toast({
        title: "Success",
        description: "Your thesis has been saved.",
      });
    } catch (error: any) {
      console.error('Error in save operation:', error);
      toast({
        title: "Error",
        description: error.message || "Failed to save thesis. Please try again.",
        variant: "destructive",
      });
    } finally {
      setIsSaving(false);
    }
  };

  return (
    <Button 
      onClick={handleSave} 
      disabled={isSaving}
      className="gap-2"
    >
      <Save className="h-4 w-4" />
      {isSaving ? 'Saving...' : 'Save'}
    </Button>
  );
};

// File: src\components\thesis\ThesisTemplateSelector.tsx

import React from 'react';
import { useQuery } from '@tanstack/react-query';
import { supabase } from '@/integrations/supabase/client';
import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { useToast } from '@/hooks/use-toast';
import { Skeleton } from '@/components/ui/skeleton';
import { motion } from 'framer-motion';

interface ThesisTemplate {
  id: string;
  name: string;
  description: string;
  structure: any;
  language: string;
}

interface ThesisTemplateSelectorProps {
  onSelect: (template: ThesisTemplate) => void;
}

export const ThesisTemplateSelector: React.FC<ThesisTemplateSelectorProps> = ({ onSelect }) => {
  const { toast } = useToast();
  
  const { data: templates, isLoading, error } = useQuery({
    queryKey: ['thesis-templates'],
    queryFn: async () => {
      console.log('Fetching thesis templates');
      const { data, error } = await supabase
        .from('thesis_templates')
        .select('*')
        .order('created_at', { ascending: true });

      if (error) {
        console.error('Error fetching templates:', error);
        throw error;
      }

      console.log('Fetched templates:', data);
      return data as ThesisTemplate[];
    }
  });

  if (error) {
    toast({
      title: "Error",
      description: "Failed to load thesis templates",
      variant: "destructive",
    });
  }

  if (isLoading) {
    return (
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {[1, 2].map((i) => (
          <Skeleton key={i} className="h-[200px] w-full" />
        ))}
      </div>
    );
  }

  return (
    <ScrollArea className="h-[400px]">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4">
        {templates?.map((template, index) => (
          <motion.div
            key={template.id}
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: index * 0.1 }}
          >
            <Card className="p-6 space-y-4 hover:shadow-lg transition-shadow cursor-pointer">
              <h3 className="text-lg font-medium">{template.name}</h3>
              <p className="text-sm text-muted-foreground">{template.description}</p>
              <Button 
                onClick={() => onSelect(template)}
                className="w-full"
              >
                Use This Template
              </Button>
            </Card>
          </motion.div>
        ))}
      </div>
    </ScrollArea>
  );
};

// File: src\components\thesis\ThesisToolbar.tsx

import React from 'react';
import { Button } from '@/components/ui/button';
import { Download, Eye, EyeOff, LogOut } from 'lucide-react';
import { ThesisSaveButton } from './ThesisSaveButton';
import { Thesis } from '@/types/thesis';
import { generateThesisDocx, generatePreviewDocx } from '@/utils/docxExport';
import { Packer } from 'docx';
import { useToast } from '@/hooks/use-toast';
import { UserInfo } from './UserInfo';
import { CollaboratorSection } from './toolbar/CollaboratorSection';
import { useUser } from '@/hooks/useUser';
import { useCollaboratorPermissions } from '@/hooks/useCollaboratorPermissions';
import { CollaboratorWithProfile } from '@/types/collaborator';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";

interface ThesisToolbarProps {
  thesisId: string;
  thesisData: Thesis;
  showPreview: boolean;
  onTogglePreview: () => void;
}

export const ThesisToolbar = ({
  thesisId,
  thesisData,
  showPreview,
  onTogglePreview,
}: ThesisToolbarProps) => {
  const { toast } = useToast();
  const { userEmail, userRole, handleLogout } = useUser();
  const {
    collaborators,
    canManageCollaborators,
    currentUserRole,
    userProfile,
    loading,
    error,
  } = useCollaboratorPermissions(thesisId);

  const handleExport = async (type: 'academic' | 'preview') => {
    try {
      console.log(`Starting ${type} DOCX export with thesis data:`, thesisData);
      const doc = type === 'academic' 
        ? await generateThesisDocx(thesisData)
        : await generatePreviewDocx(thesisData);
      console.log('Document generated, converting to blob...');
      
      const blob = await Packer.toBlob(doc);
      console.log('Blob created, creating download link...');
      
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${thesisData.frontMatter?.[0]?.title || 'thesis'}_${type}.docx`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);

      toast({
        title: "Success",
        description: "Your thesis has been exported as a DOCX file.",
      });
    } catch (error: any) {
      console.error('Error exporting DOCX:', error);
      toast({
        title: "Error",
        description: error.message || "Failed to export thesis as DOCX. Please try again.",
        variant: "destructive",
      });
    }
  };

  const canManageCollaboratorsProp = currentUserRole === 'owner' || currentUserRole === 'admin' || userProfile?.roles?.name === 'admin';

  return (
    <div className="flex items-center justify-between">
      <div className="flex items-center gap-2">
        <ThesisSaveButton thesisId={thesisId} thesisData={thesisData} />
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="outline" className="gap-2">
              <Download className="h-4 w-4" />
              Export
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent>
            <DropdownMenuItem onClick={() => handleExport('academic')}>
              Academic Format
            </DropdownMenuItem>
            <DropdownMenuItem onClick={() => handleExport('preview')}>
              Preview Format
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
        {userEmail && <UserInfo email={userEmail} role={userRole} />}
        <CollaboratorSection
          collaborators={collaborators as CollaboratorWithProfile[]}
          thesisId={thesisId}
          thesisTitle={thesisData.frontMatter?.[0]?.title || 'Untitled Thesis'}
          canManageCollaborators={canManageCollaboratorsProp}
          isAdmin={userProfile?.roles?.name === 'admin'}
        />
      </div>
      <div className="flex items-center gap-2">
        <Button onClick={onTogglePreview} variant="outline" className="gap-2">
          {showPreview ? (
            <>
              <EyeOff className="h-4 w-4" />
              Hide Preview
            </>
          ) : (
            <>
              <Eye className="h-4 w-4" />
              Show Preview
            </>
          )}
        </Button>
        <Button
          variant="outline"
          size="sm"
          onClick={handleLogout}
          className="gap-2"
        >
          <LogOut className="h-4 w-4" />
          Logout
        </Button>
      </div>
    </div>
  );
};

// File: src\components\thesis\toolbar\CollaboratorSection.tsx

import React, { useState } from 'react';
import { Button } from '@/components/ui/button';
import { UserPlus, Loader2 } from 'lucide-react';
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { CollaboratorInviteForm } from '@/components/collaboration/CollaboratorInviteForm';
import { useToast } from '@/hooks/use-toast';
import { CollaboratorWithProfile } from '@/types/collaborator';

interface CollaboratorSectionProps {
  collaborators: CollaboratorWithProfile[];
  thesisId: string;
  thesisTitle: string;
  canManageCollaborators: boolean;
  isAdmin: boolean;
}

export const CollaboratorSection = ({
  collaborators,
  thesisId,
  thesisTitle,
  canManageCollaborators,
  isAdmin
}: CollaboratorSectionProps) => {
  const { toast } = useToast();
  const [isPopoverOpen, setIsPopoverOpen] = useState(false);
  const [isInviting, setIsInviting] = useState(false);

  console.log('CollaboratorSection props:', {
    collaboratorsCount: collaborators.length,
    thesisId,
    canManageCollaborators,
    isAdmin
  });

  const handleInviteSuccess = () => {
    toast({
      title: "Success",
      description: "Collaborator has been invited successfully.",
    });
    setIsPopoverOpen(false);
    setIsInviting(false);
  };

  const handleInviteError = (error: Error) => {
    toast({
      title: "Error",
      description: error.message || "Failed to invite collaborator. Please try again.",
      variant: "destructive",
    });
    setIsInviting(false);
  };

  // Show the button for editors, owners, and admins
  const shouldShowAddButton = canManageCollaborators || isAdmin;

  return (
    <div className="flex items-center gap-2">
      {shouldShowAddButton && (
        <Popover open={isPopoverOpen} onOpenChange={setIsPopoverOpen}>
          <PopoverTrigger asChild>
            <Button
              variant="outline"
              size="sm"
              className="gap-2"
              disabled={isInviting}
            >
              {isInviting ? (
                <Loader2 className="w-4 h-4 animate-spin" />
              ) : (
                <UserPlus className="w-4 h-4" />
              )}
              {isInviting ? 'Inviting...' : 'Add Collaborator'}
            </Button>
          </PopoverTrigger>
          <PopoverContent className="w-80 p-4">
            <div className="space-y-4">
              <h4 className="font-medium leading-none">Invite Collaborator</h4>
              <p className="text-sm text-muted-foreground">
                Send an invitation to collaborate on this thesis.
              </p>
              <CollaboratorInviteForm
                thesisId={thesisId}
                thesisTitle={thesisTitle}
                onInviteSuccess={handleInviteSuccess}
                onInviteError={handleInviteError}
                isAdmin={isAdmin}
                setIsInviting={setIsInviting}
              />
            </div>
          </PopoverContent>
        </Popover>
      )}
    </div>
  );
};

// File: src\components\thesis\toolbar\CollaboratorsList.tsx

import React from 'react';
import { Users } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from "@/components/ui/popover";
import { ScrollArea } from "@/components/ui/scroll-area";
import { CollaboratorWithProfile } from '@/types/collaborator';

interface CollaboratorsListProps {
  collaborators: CollaboratorWithProfile[];
  thesisId: string;
}

export const CollaboratorsList = ({ collaborators, thesisId }: CollaboratorsListProps) => {
  return (
    <Popover>
      <PopoverTrigger asChild>
        <Button
          variant="outline"
          size="sm"
          className="gap-2"
        >
          <Users className="w-4 h-4" />
          Collaborators ({collaborators.length})
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-80">
        <ScrollArea className="h-[200px] pr-4">
          <div className="space-y-2">
            {collaborators.map((collaborator) => (
              <div
                key={collaborator.user_id}
                className="flex items-center justify-between p-2 bg-muted rounded-lg"
              >
                <div className="flex items-center gap-2">
                  <span className="text-sm">{collaborator.profiles?.email || collaborator.user_id}</span>
                  <Badge variant="secondary" className="text-xs">
                    {collaborator.role}
                  </Badge>
                </div>
              </div>
            ))}
          </div>
        </ScrollArea>
      </PopoverContent>
    </Popover>
  );
};

// File: src\components\thesis\tracker\ThesisTracker.tsx

import React from 'react';
import { Card } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Clock, BookOpen, CheckCircle, AlertCircle } from 'lucide-react';
import { motion } from 'framer-motion';
import { Thesis } from '@/types/thesis';

interface ThesisTrackerProps {
  thesis: Thesis;
}

export const ThesisTracker = ({ thesis }: ThesisTrackerProps) => {
  // Calculate overall progress based on completed sections
  const calculateProgress = () => {
    const frontMatterSections = thesis.frontMatter || [];
    const chapterSections = thesis.chapters?.flatMap(chapter => chapter.sections) || [];
    const backMatterSections = thesis.backMatter || [];

    const allSections = [
      ...frontMatterSections,
      ...chapterSections,
      ...backMatterSections
    ];
    
    const completedSections = allSections.filter(section => 
      section?.content && section.content.trim().length > 100
    ).length;
    
    return allSections.length > 0 ? Math.round((completedSections / allSections.length) * 100) : 0;
  };

  // Calculate chapter completion status
  const getChapterStatus = (chapterIndex: number) => {
    const chapter = thesis.chapters?.[chapterIndex];
    if (!chapter) return { complete: false, progress: 0 };

    const sections = chapter.sections || [];
    const completedSections = sections.filter(
      section => section?.content && section.content.trim().length > 100
    ).length;

    const progress = sections.length > 0 ? Math.round((completedSections / sections.length) * 100) : 0;
    return {
      complete: progress === 100,
      progress
    };
  };

  // Get last update date
  const getLastUpdateDate = () => {
    return new Date(thesis.updated_at).toLocaleDateString();
  };

  const progress = calculateProgress();
  const chapters = thesis.chapters || [];
  const completedChapters = chapters.filter(chapter => 
    chapter.sections?.every(section => section?.content?.length > 100)
  ).length;

  return (
    <Card className="p-6 space-y-6 bg-white/50 backdrop-blur-sm border-2 border-primary/10 shadow-xl rounded-xl">
      <div className="space-y-4">
        <h3 className="text-lg font-semibold flex items-center gap-2">
          <BookOpen className="w-5 h-5 text-primary" />
          Thesis Progress Tracker
        </h3>
        
        <div className="space-y-2">
          <div className="flex justify-between text-sm">
            <span>Overall Progress</span>
            <span>{progress}%</span>
          </div>
          <Progress value={progress} className="h-2" />
        </div>

        <div className="grid grid-cols-2 gap-4">
          <motion.div 
            whileHover={{ scale: 1.02 }}
            className="p-4 rounded-lg bg-white/30 space-y-2"
          >
            <div className="flex items-center gap-2 text-sm font-medium">
              <Clock className="w-4 h-4 text-blue-500" />
              Last Updated
            </div>
            <p className="text-sm text-muted-foreground">
              {getLastUpdateDate()}
            </p>
          </motion.div>

          <motion.div 
            whileHover={{ scale: 1.02 }}
            className="p-4 rounded-lg bg-white/30 space-y-2"
          >
            <div className="flex items-center gap-2 text-sm font-medium">
              <CheckCircle className="w-4 h-4 text-green-500" />
              Completed Chapters
            </div>
            <p className="text-sm text-muted-foreground">
              {completedChapters} / {chapters.length}
            </p>
          </motion.div>
        </div>

        <div className="mt-4">
          <h4 className="text-sm font-medium mb-2">Chapter Status</h4>
          <div className="space-y-2">
            {chapters.map((chapter, index) => {
              const status = getChapterStatus(index);
              return (
                <div key={chapter.id} className="space-y-1">
                  <div className="flex justify-between text-sm">
                    <span>{chapter.title || `Chapter ${index + 1}`}</span>
                    <span>{status.progress}%</span>
                  </div>
                  <Progress value={status.progress} className="h-1.5" />
                </div>
              );
            })}
          </div>
        </div>
      </div>
    </Card>
  );
};

// File: src\components\thesis\UserInfo.tsx

// File: src/components/thesis/UserInfo.tsx
import { User } from 'lucide-react';
import { Badge } from '@/components/ui/badge';

interface UserInfoProps {
  email: string;
  role: string;
}

export const UserInfo = ({ email, role }: UserInfoProps) => {
  return (
    <div className="flex items-center gap-2">
      <User className="w-4 h-4" />
      <span className="text-sm">{email}</span>
      <Badge variant="secondary" className="text-xs">
        {role}
      </Badge>
    </div>
  );
};

// File: src\components\thesis\versioning\ThesisVersionHistory.tsx

import React, { useState } from 'react';
import { useThesisVersioning } from '@/hooks/useThesisVersioning';
import { ThesisVersion } from '@/types/thesis';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Separator } from '@/components/ui/separator';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog';
import { format } from 'date-fns';
import { Loader2, Clock, ArrowDownUp, RotateCcw } from 'lucide-react';

interface ThesisVersionHistoryProps {
  thesisId: string;
  currentVersion: string;
}

export const ThesisVersionHistory: React.FC<ThesisVersionHistoryProps> = ({
  thesisId,
  currentVersion,
}) => {
  const {
    versions,
    isLoadingVersions,
    createVersion,
    restoreVersion,
    compareVersions,
  } = useThesisVersioning(thesisId);

  const [selectedVersions, setSelectedVersions] = useState<number[]>([]);
  const [isComparing, setIsComparing] = useState(false);
  const [comparisonResult, setComparisonResult] = useState<any[]>([]);
  const [isRestoring, setIsRestoring] = useState(false);

  const handleVersionSelect = (versionNumber: number) => {
    setSelectedVersions(prev => {
      if (prev.includes(versionNumber)) {
        return prev.filter(v => v !== versionNumber);
      }
      if (prev.length >= 2) {
        return [prev[1], versionNumber];
      }
      return [...prev, versionNumber];
    });
  };

  const handleCompare = async () => {
    if (selectedVersions.length !== 2) return;
    
    setIsComparing(true);
    try {
      const diff = await compareVersions(selectedVersions[0], selectedVersions[1]);
      setComparisonResult(diff);
    } catch (error) {
      console.error('Error comparing versions:', error);
    } finally {
      setIsComparing(false);
    }
  };

  const handleRestore = async (versionNumber: number) => {
    setIsRestoring(true);
    try {
      await restoreVersion.mutateAsync(versionNumber);
    } finally {
      setIsRestoring(false);
    }
  };

  const renderVersionItem = (version: ThesisVersion) => {
    const isSelected = selectedVersions.includes(version.version_number);
    const isCurrent = version.version === currentVersion;

    return (
      <div
        key={version.id}
        className={`p-4 rounded-lg ${
          isSelected ? 'bg-primary/10' : 'bg-card'
        } ${isCurrent ? 'border-2 border-primary' : 'border border-border'}`}
      >
        <div className="flex items-center justify-between">
          <div>
            <h3 className="font-semibold">
              Version {version.version_number}
              {isCurrent && (
                <span className="ml-2 text-sm text-muted-foreground">
                  (Current)
                </span>
              )}
            </h3>
            <p className="text-sm text-muted-foreground">
              {format(new Date(version.created_at), 'PPpp')}
            </p>
          </div>
          <div className="flex gap-2">
            <Button
              variant="outline"
              size="sm"
              onClick={() => handleVersionSelect(version.version_number)}
            >
              {isSelected ? 'Deselect' : 'Select'}
            </Button>
            {!isCurrent && (
              <Button
                variant="outline"
                size="sm"
                onClick={() => handleRestore(version.version_number)}
                disabled={isRestoring}
              >
                {isRestoring ? (
                  <Loader2 className="h-4 w-4 animate-spin" />
                ) : (
                  <RotateCcw className="h-4 w-4" />
                )}
                <span className="ml-2">Restore</span>
              </Button>
            )}
          </div>
        </div>
        {version.description && (
          <p className="mt-2 text-sm">{version.description}</p>
        )}
        {version.changes && version.changes.length > 0 && (
          <div className="mt-2">
            <Separator className="my-2" />
            <details>
              <summary className="text-sm font-medium cursor-pointer">
                Changes ({version.changes.length})
              </summary>
              <ul className="mt-2 text-sm space-y-1">
                {version.changes.map((change, index) => (
                  <li key={index} className="flex items-center gap-2">
                    <span
                      className={`w-2 h-2 rounded-full ${
                        change.type === 'addition'
                          ? 'bg-green-500'
                          : change.type === 'deletion'
                          ? 'bg-red-500'
                          : 'bg-yellow-500'
                      }`}
                    />
                    <span>{change.path}</span>
                  </li>
                ))}
              </ul>
            </details>
          </div>
        )}
      </div>
    );
  };

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <h2 className="text-lg font-semibold">Version History</h2>
        <div className="flex gap-2">
          {selectedVersions.length === 2 && (
            <Button
              variant="outline"
              onClick={handleCompare}
              disabled={isComparing}
            >
              {isComparing ? (
                <Loader2 className="h-4 w-4 animate-spin" />
              ) : (
                <ArrowDownUp className="h-4 w-4" />
              )}
              <span className="ml-2">Compare Selected</span>
            </Button>
          )}
        </div>
      </div>

      {isLoadingVersions ? (
        <div className="flex items-center justify-center p-8">
          <Loader2 className="h-8 w-8 animate-spin" />
        </div>
      ) : (
        <ScrollArea className="h-[500px] rounded-md border">
          <div className="p-4 space-y-4">
            {versions?.map(renderVersionItem)}
          </div>
        </ScrollArea>
      )}

      {comparisonResult.length > 0 && (
        <Dialog>
          <DialogTrigger asChild>
            <Button variant="outline">
              <Clock className="h-4 w-4 mr-2" />
              View Comparison
            </Button>
          </DialogTrigger>
          <DialogContent className="max-w-2xl">
            <DialogHeader>
              <DialogTitle>Version Comparison</DialogTitle>
              <DialogDescription>
                Comparing Version {Math.min(...selectedVersions)} with Version{' '}
                {Math.max(...selectedVersions)}
              </DialogDescription>
            </DialogHeader>
            <ScrollArea className="h-[400px] mt-4">
              <div className="space-y-4">
                {comparisonResult.map((diff, index) => (
                  <div
                    key={index}
                    className={`p-4 rounded-lg border ${
                      diff.type === 'addition'
                        ? 'bg-green-500/10 border-green-500/20'
                        : diff.type === 'deletion'
                        ? 'bg-red-500/10 border-red-500/20'
                        : 'bg-yellow-500/10 border-yellow-500/20'
                    }`}
                  >
                    <div className="flex items-center gap-2">
                      <span
                        className={`w-2 h-2 rounded-full ${
                          diff.type === 'addition'
                            ? 'bg-green-500'
                            : diff.type === 'deletion'
                            ? 'bg-red-500'
                            : 'bg-yellow-500'
                        }`}
                      />
                      <span className="font-medium">{diff.path}</span>
                    </div>
                    {diff.type === 'modification' && (
                      <div className="mt-2 space-y-2">
                        <div className="text-sm">
                          <span className="font-medium">Old:</span>
                          <pre className="mt-1 p-2 rounded bg-muted">
                            {JSON.stringify(diff.oldValue, null, 2)}
                          </pre>
                        </div>
                        <div className="text-sm">
                          <span className="font-medium">New:</span>
                          <pre className="mt-1 p-2 rounded bg-muted">
                            {JSON.stringify(diff.newValue, null, 2)}
                          </pre>
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </ScrollArea>
          </DialogContent>
        </Dialog>
      )}
    </div>
  );
};


// File: src\components\ThesisEditor.tsx

import React, { useState, useRef } from 'react';
import { ThesisSidebar } from './ThesisSidebar';
import { Chapter, Section, Thesis } from '@/types/thesis';
import { useThesisAutosave } from '@/hooks/useThesisAutosave';
import { useThesisInitialization } from '@/hooks/useThesisInitialization';
import { useParams } from 'react-router-dom';
import { ThesisCreationModal } from './thesis/ThesisCreationModal';
import { ThesisList } from './thesis/ThesisList';
import { useThesisData } from '@/hooks/useThesisData';
import { Skeleton } from './ui/skeleton';
import { useToast } from '@/hooks/use-toast';
import { ThesisEditorHeader } from './thesis/editor/ThesisEditorHeader';
import { ThesisEditorMain } from './thesis/editor/ThesisEditorMain';
import { ThesisEditorStatus } from './thesis/editor/ThesisEditorStatus';
import { useThesisRealtime } from '@/hooks/useThesisRealtime';
import { ChatMessages } from './collaboration/ChatMessages';
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from './ui/collapsible';
import { Button } from './ui/button';
import { ChevronDown, ChevronUp } from 'lucide-react';

interface ThesisEditorProps {
  thesisId?: string;
}

export const ThesisEditor: React.FC<ThesisEditorProps> = ({ thesisId: propsThesisId }) => {
  const { thesisId: routeThesisId } = useParams();
  const currentThesisId = propsThesisId || routeThesisId;
  const { toast } = useToast();
  
  const { thesis, setThesis, isLoading, error } = useThesisData(currentThesisId);
  const [activeSection, setActiveSection] = useState<string>('');
  const [showPreview, setShowPreview] = useState(false);
  const [showChat, setShowChat] = useState(true);
  const [showTracker, setShowTracker] = useState(true);
  const previewRef = useRef<HTMLDivElement>(null);

  useThesisAutosave(thesis);
  useThesisInitialization(thesis);
  useThesisRealtime(currentThesisId, thesis, setThesis);

  const getAllSections = () => {
    if (!thesis?.content) return [];
    
    const sections: Section[] = [];
    
    // Add front matter
    if (Array.isArray(thesis.content.frontMatter)) {
      sections.push(...thesis.content.frontMatter);
    }
    
    // Add general introduction if it exists
    if (thesis.content.generalIntroduction) {
      sections.push(thesis.content.generalIntroduction);
    }
    
    // Add chapter sections
    if (Array.isArray(thesis.content.chapters)) {
      thesis.content.chapters.forEach(chapter => {
        if (Array.isArray(chapter.sections)) {
          sections.push(...chapter.sections);
        }
      });
    }
    
    // Add general conclusion if it exists
    if (thesis.content.generalConclusion) {
      sections.push(thesis.content.generalConclusion);
    }
    
    // Add back matter
    if (Array.isArray(thesis.content.backMatter)) {
      sections.push(...thesis.content.backMatter);
    }
    
    return sections;
  };

  const calculateProgress = () => {
    const sections = getAllSections();
    if (sections.length === 0) return 0;
    
    const completedSections = sections.filter(section => {
      if (!section?.content) return false;
      if (Array.isArray(section.content)) {
        return section.content.some(item => item.content && item.content.trim().length > 0);
      }
      return typeof section.content === 'string' && section.content.trim().length > 0;
    }).length;
    
    return Math.round((completedSections / sections.length) * 100);
  };

  const progress = calculateProgress();

  const handleContentChange = (id: string, content: string) => {
    if (!thesis) return;
    
    setThesis(prevThesis => {
      const updatedThesis = { ...prevThesis! };

      // Check general introduction
      if (updatedThesis.content?.generalIntroduction?.id === id) {
        updatedThesis.content.generalIntroduction = {
          ...updatedThesis.content.generalIntroduction,
          content
        };
        return updatedThesis;
      }

      // Check general conclusion
      if (updatedThesis.content?.generalConclusion?.id === id) {
        updatedThesis.content.generalConclusion = {
          ...updatedThesis.content.generalConclusion,
          content
        };
        return updatedThesis;
      }

      // Check other sections
      if (Array.isArray(updatedThesis.content?.frontMatter)) {
        updatedThesis.content.frontMatter = updatedThesis.content.frontMatter.map(section =>
          section.id === id ? { ...section, content } : section
        );
      }

      if (Array.isArray(updatedThesis.content?.chapters)) {
        updatedThesis.content.chapters = updatedThesis.content.chapters.map(chapter => ({
          ...chapter,
          sections: chapter.sections.map(section =>
            section.id === id ? { ...section, content } : section
          )
        }));
      }

      if (Array.isArray(updatedThesis.content?.backMatter)) {
        updatedThesis.content.backMatter = updatedThesis.content.backMatter.map(section =>
          section.id === id ? { ...section, content } : section
        );
      }

      return updatedThesis;
    });
  };

  const handleTitleChange = (id: string, title: string) => {
    if (!thesis) return;

    setThesis(prevThesis => ({
      ...prevThesis!,
      content: {
        ...prevThesis!.content,
        frontMatter: prevThesis!.content.frontMatter.map(section =>
          section.id === id ? { ...section, title } : section
        ),
        chapters: prevThesis!.content.chapters.map(chapter => ({
          ...chapter,
          sections: chapter.sections.map(section =>
            section.id === id ? { ...section, title } : section
          )
        })),
        backMatter: prevThesis!.content.backMatter.map(section =>
          section.id === id ? { ...section, title } : section
        )
      }
    }));
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-background p-8">
        <div className="max-w-4xl mx-auto space-y-6">
          <Skeleton className="h-12 w-full" />
          <Skeleton className="h-64 w-full" />
          <Skeleton className="h-32 w-full" />
        </div>
      </div>
    );
  }

  if (error || (!thesis && currentThesisId)) {
    console.error('Error loading thesis:', error);
    toast({
      title: "Error Loading Thesis",
      description: error?.message || "Could not load thesis. Please try again.",
      variant: "destructive",
    });
    return (
      <div className="min-h-screen bg-background flex items-center justify-center">
        <div className="text-center space-y-4">
          <h2 className="text-2xl font-semibold text-destructive">Error Loading Thesis</h2>
          <p className="text-muted-foreground">{error?.message || "Thesis not found"}</p>
        </div>
      </div>
    );
  }

  if (!thesis && !currentThesisId) {
    return (
      <div className="flex flex-col h-full">
        <div className="flex justify-between p-4 items-center">
          <ThesisCreationModal onThesisCreated={() => {}} />
          <ThesisList />
        </div>
        <div className="flex flex-1 items-center justify-center">
          <p className="text-muted-foreground text-lg">No thesis loaded</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-background flex">
      <ThesisSidebar
        sections={[
          ...(thesis?.content?.frontMatter || []),
          ...(thesis?.content?.chapters || []).flatMap(chapter => chapter.sections),
          ...(thesis?.content?.backMatter || [])
        ]}
        activeSection={activeSection}
        onSectionSelect={setActiveSection}
      />
      
      <div className="flex-1 flex flex-col">
        <ThesisEditorHeader
          thesis={thesis}
          showPreview={showPreview}
          onTogglePreview={() => setShowPreview(!showPreview)}
        />
        
        <div className="px-8 py-4">
          <ThesisEditorStatus
            thesis={thesis}
            thesisId={currentThesisId!}
            progress={progress}
            showTracker={showTracker}
            setShowTracker={setShowTracker}
          />
        </div>

        <ThesisEditorMain
          thesis={thesis}
          activeSection={activeSection}
          showPreview={showPreview}
          previewRef={previewRef}
          onContentChange={handleContentChange}
          onTitleChange={handleTitleChange}
          onUpdateChapter={(chapter: Chapter) => {
            setThesis(prev => ({
              ...prev!,
              content: {
                ...prev!.content,
                chapters: prev!.content.chapters.map(c =>
                  c.id === chapter.id ? chapter : c
                )
              }
            }));
          }}
          onAddChapter={(chapter) => {
            setThesis(prev => ({
              ...prev!,
              content: {
                ...prev!.content,
                chapters: [...(prev?.content?.chapters || []), chapter]
              }
            }));
          }}
        />
      </div>

      <Collapsible
        open={showChat}
        onOpenChange={setShowChat}
        className="fixed bottom-4 right-4 w-[400px] z-50"
      >
        <CollapsibleTrigger asChild>
          <Button
            variant="outline"
            size="sm"
            className="absolute -top-10 right-0 bg-background shadow-md"
          >
            {showChat ? (
              <ChevronDown className="h-4 w-4" />
            ) : (
              <ChevronUp className="h-4 w-4" />
            )}
          </Button>
        </CollapsibleTrigger>
        <CollapsibleContent>
          {currentThesisId && <ChatMessages thesisId={currentThesisId} />}
        </CollapsibleContent>
      </Collapsible>
    </div>
  );
};


// File: src\components\ThesisPreview.tsx

import React, { useState } from 'react';
import { ScrollArea } from './ui/scroll-area';
import { TitlePage } from './thesis/preview/TitlePage';
import { FrenchTitlePage } from './thesis/preview/FrenchTitlePage';
import { AbstractSection } from './thesis/preview/AbstractSection';
import { ContentSection } from './thesis/preview/ContentSection';
import { Button } from './ui/button';
import { FileDown, Maximize2, Minimize2, ZoomIn, ZoomOut } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { usePDF } from 'react-to-pdf';
import { cn } from '@/lib/utils';
import { Slider } from './ui/slider';

interface ThesisPreviewProps {
  thesis: any;
  language?: 'en' | 'fr';
}

export const ThesisPreview: React.FC<ThesisPreviewProps> = ({ thesis, language = 'en' }) => {
  const { toast } = useToast();
  const { toPDF, targetRef } = usePDF({
    filename: `${thesis?.frontMatter?.[0]?.title || 'thesis'}.pdf`,
    page: { 
      margin: 20,
      format: 'a4',
    }
  });
  const [isFullScreen, setIsFullScreen] = React.useState(false);
  const [previewWidth, setPreviewWidth] = useState(210); // Default A4 width in mm

  const handleExport = async () => {
    try {
      console.log('Starting PDF export with thesis data:', thesis);
      if (!thesis || !thesis.frontMatter || !Array.isArray(thesis.frontMatter)) {
        throw new Error('Invalid thesis data structure');
      }
      await toPDF();
      toast({
        title: "Success",
        description: "PDF exported successfully",
      });
    } catch (error: any) {
      console.error('PDF export error:', error);
      toast({
        title: "Error",
        description: error.message || "Failed to export PDF",
        variant: "destructive",
      });
    }
  };

  const toggleFullScreen = () => {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen().catch((err) => {
        console.error(`Error attempting to enable full-screen mode: ${err.message}`);
      });
      setIsFullScreen(true);
    } else {
      document.exitFullscreen();
      setIsFullScreen(false);
    }
  };

  React.useEffect(() => {
    const handleFullScreenChange = () => {
      setIsFullScreen(!!document.fullscreenElement);
    };

    document.addEventListener('fullscreenchange', handleFullScreenChange);
    return () => document.removeEventListener('fullscreenchange', handleFullScreenChange);
  }, []);

  const handleWidthChange = (value: number[]) => {
    setPreviewWidth(value[0]);
  };

  const adjustWidth = (increment: boolean) => {
    setPreviewWidth(prev => {
      const newWidth = increment ? prev + 10 : prev - 10;
      return Math.min(Math.max(newWidth, 150), 300); // Min 150mm, Max 300mm
    });
  };

  // Ensure thesis data is properly structured
  const frontMatter = Array.isArray(thesis?.frontMatter) ? thesis.frontMatter : [];
  const chapters = Array.isArray(thesis?.chapters) ? thesis.chapters : [];
  const backMatter = Array.isArray(thesis?.backMatter) ? thesis.backMatter : [];

  console.log('Rendering ThesisPreview with data:', {
    frontMatterLength: frontMatter.length,
    chaptersLength: chapters.length,
    backMatterLength: backMatter.length
  });

  return (
    <div className="relative bg-background min-h-screen">
      <div className="sticky top-0 z-10 bg-background p-4 border-b shadow-sm">
        <div className="flex justify-between items-center mb-4">
          <Button onClick={handleExport} className="w-full sm:w-auto">
            <FileDown className="w-4 h-4 mr-2" />
            Export to PDF
          </Button>
          <div className="flex items-center gap-2">
            <Button onClick={() => adjustWidth(false)} variant="outline" size="icon">
              <ZoomOut className="h-4 w-4" />
            </Button>
            <Button onClick={() => adjustWidth(true)} variant="outline" size="icon">
              <ZoomIn className="h-4 w-4" />
            </Button>
            <Button onClick={toggleFullScreen} variant="outline" size="icon">
              {isFullScreen ? (
                <Minimize2 className="h-4 w-4" />
              ) : (
                <Maximize2 className="h-4 w-4" />
              )}
            </Button>
          </div>
        </div>
        <div className="flex items-center gap-4 px-4">
          <span className="text-sm text-muted-foreground w-16">Width: {previewWidth}mm</span>
          <Slider
            value={[previewWidth]}
            onValueChange={handleWidthChange}
            min={150}
            max={300}
            step={5}
            className="w-full max-w-xs"
          />
        </div>
      </div>
      
      <ScrollArea className="h-[calc(100vh-8rem)]">
        <div 
          ref={targetRef} 
          className={cn(
            "thesis-preview mx-auto py-8 px-4",
            "bg-white shadow-md"
          )}
          style={{ width: `${previewWidth}mm` }}
        >
          {/* Title Page */}
          <div className="mb-8 bg-white rounded-lg overflow-hidden thesis-page">
            {language === 'en' ? (
              <TitlePage metadata={thesis?.metadata} titleSection={frontMatter[0]} />
            ) : (
              <FrenchTitlePage thesis={thesis} titleSection={frontMatter[0]} />
            )}
          </div>
          
          {/* Front Matter */}
          {frontMatter.map((section: any, index: number) => (
            <div 
              key={section.id || index} 
              className="thesis-page"
            >
              {section.type === 'abstract' ? (
                <AbstractSection abstractSection={section} />
              ) : (
                <ContentSection 
                  section={section}
                  elementPositions={[]}
                  onElementClick={() => {}}
                  onPositionChange={() => {}}
                />
              )}
            </div>
          ))}
          
          {/* Chapters */}
          {chapters.map((chapter: any) => (
            <React.Fragment key={chapter.id}>
              {Array.isArray(chapter.sections) && chapter.sections.map((section: any) => (
                <div 
                  key={section.id} 
                  className="thesis-page"
                >
                  <ContentSection
                    section={section}
                    chapterTitle={chapter.title}
                    elementPositions={[]}
                    onElementClick={() => {}}
                    onPositionChange={() => {}}
                  />
                </div>
              ))}
            </React.Fragment>
          ))}
          
          {/* Back Matter */}
          {backMatter.map((section: any) => (
            <div 
              key={section.id} 
              className="thesis-page"
            >
              <ContentSection
                section={section}
                elementPositions={[]}
                onElementClick={() => {}}
                onPositionChange={() => {}}
              />
            </div>
          ))}
        </div>
      </ScrollArea>
    </div>
  );
};

// File: src\components\ThesisSidebar.tsx

import React from 'react';
import { Section } from '@/types/thesis';
import { TableOfContents } from './thesis/sidebar/TableOfContents';
import { cn } from '@/lib/utils';

interface ThesisSidebarProps {
  sections: Section[];
  activeSection: string;
  onSectionSelect: (id: string) => void;
}

export const ThesisSidebar = ({ 
  sections = [], 
  activeSection, 
  onSectionSelect 
}: ThesisSidebarProps) => {
  console.log('Rendering ThesisSidebar:', { 
    activeSection, 
    sectionsCount: sections?.length,
    sections: sections?.map(s => ({ id: s.id, title: s.title }))
  });
  
  // Ensure sections is always an array and filter out any invalid sections
  const validSections = Array.isArray(sections) ? sections.filter(section => 
    section && typeof section === 'object' && 'id' in section && 'title' in section
  ) : [];
  
  return (
    <aside className="w-64 h-full bg-editor-bg border-r border-editor-border">
      <div className="sticky top-0 z-10 bg-editor-bg border-b border-editor-border p-4">
        <h2 className="text-lg font-serif font-medium text-editor-text">Contents</h2>
      </div>
      <div className="p-4">
        <TableOfContents
          sections={validSections}
          activeSection={activeSection}
          onSectionSelect={onSectionSelect}
        />
      </div>
    </aside>
  );
};

// File: src\components\ui\accordion.tsx

import * as React from "react"
import * as AccordionPrimitive from "@radix-ui/react-accordion"
import { ChevronDown } from "lucide-react"

import { cn } from "@/lib/utils"

const Accordion = AccordionPrimitive.Root

const AccordionItem = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>
>(({ className, ...props }, ref) => (
  <AccordionPrimitive.Item
    ref={ref}
    className={cn("border-b", className)}
    {...props}
  />
))
AccordionItem.displayName = "AccordionItem"

const AccordionTrigger = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Header className="flex">
    <AccordionPrimitive.Trigger
      ref={ref}
      className={cn(
        "flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180",
        className
      )}
      {...props}
    >
      {children}
      <ChevronDown className="h-4 w-4 shrink-0 transition-transform duration-200" />
    </AccordionPrimitive.Trigger>
  </AccordionPrimitive.Header>
))
AccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName

const AccordionContent = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Content
    ref={ref}
    className="overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down"
    {...props}
  >
    <div className={cn("pb-4 pt-0", className)}>{children}</div>
  </AccordionPrimitive.Content>
))

AccordionContent.displayName = AccordionPrimitive.Content.displayName

export { Accordion, AccordionItem, AccordionTrigger, AccordionContent }


// File: src\components\ui\alert-dialog.tsx

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

const AlertDialog = AlertDialogPrimitive.Root

const AlertDialogTrigger = AlertDialogPrimitive.Trigger

const AlertDialogPortal = AlertDialogPrimitive.Portal

const AlertDialogOverlay = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
AlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName

const AlertDialogContent = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>
>(({ className, ...props }, ref) => (
  <AlertDialogPortal>
    <AlertDialogOverlay />
    <AlertDialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    />
  </AlertDialogPortal>
))
AlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName

const AlertDialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
AlertDialogHeader.displayName = "AlertDialogHeader"

const AlertDialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
AlertDialogFooter.displayName = "AlertDialogFooter"

const AlertDialogTitle = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold", className)}
    {...props}
  />
))
AlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName

const AlertDialogDescription = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
AlertDialogDescription.displayName =
  AlertDialogPrimitive.Description.displayName

const AlertDialogAction = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Action>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Action
    ref={ref}
    className={cn(buttonVariants(), className)}
    {...props}
  />
))
AlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName

const AlertDialogCancel = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Cancel
    ref={ref}
    className={cn(
      buttonVariants({ variant: "outline" }),
      "mt-2 sm:mt-0",
      className
    )}
    {...props}
  />
))
AlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}


// File: src\components\ui\alert.tsx

import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",
  {
    variants: {
      variant: {
        default: "bg-background text-foreground",
        destructive:
          "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Alert = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>
>(({ className, variant, ...props }, ref) => (
  <div
    ref={ref}
    role="alert"
    className={cn(alertVariants({ variant }), className)}
    {...props}
  />
))
Alert.displayName = "Alert"

const AlertTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h5
    ref={ref}
    className={cn("mb-1 font-medium leading-none tracking-tight", className)}
    {...props}
  />
))
AlertTitle.displayName = "AlertTitle"

const AlertDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm [&_p]:leading-relaxed", className)}
    {...props}
  />
))
AlertDescription.displayName = "AlertDescription"

export { Alert, AlertTitle, AlertDescription }


// File: src\components\ui\aspect-ratio.tsx

import * as AspectRatioPrimitive from "@radix-ui/react-aspect-ratio"

const AspectRatio = AspectRatioPrimitive.Root

export { AspectRatio }


// File: src\components\ui\avatar.tsx

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

const Avatar = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",
      className
    )}
    {...props}
  />
))
Avatar.displayName = AvatarPrimitive.Root.displayName

const AvatarImage = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Image>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Image
    ref={ref}
    className={cn("aspect-square h-full w-full", className)}
    {...props}
  />
))
AvatarImage.displayName = AvatarPrimitive.Image.displayName

const AvatarFallback = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Fallback>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Fallback
    ref={ref}
    className={cn(
      "flex h-full w-full items-center justify-center rounded-full bg-muted",
      className
    )}
    {...props}
  />
))
AvatarFallback.displayName = AvatarPrimitive.Fallback.displayName

export { Avatar, AvatarImage, AvatarFallback }


// File: src\components\ui\badge.tsx

import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive:
          "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
        outline: "text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return (
    <div className={cn(badgeVariants({ variant }), className)} {...props} />
  )
}

export { Badge, badgeVariants }


// File: src\components\ui\breadcrumb.tsx

import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { ChevronRight, MoreHorizontal } from "lucide-react"

import { cn } from "@/lib/utils"

const Breadcrumb = React.forwardRef<
  HTMLElement,
  React.ComponentPropsWithoutRef<"nav"> & {
    separator?: React.ReactNode
  }
>(({ ...props }, ref) => <nav ref={ref} aria-label="breadcrumb" {...props} />)
Breadcrumb.displayName = "Breadcrumb"

const BreadcrumbList = React.forwardRef<
  HTMLOListElement,
  React.ComponentPropsWithoutRef<"ol">
>(({ className, ...props }, ref) => (
  <ol
    ref={ref}
    className={cn(
      "flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5",
      className
    )}
    {...props}
  />
))
BreadcrumbList.displayName = "BreadcrumbList"

const BreadcrumbItem = React.forwardRef<
  HTMLLIElement,
  React.ComponentPropsWithoutRef<"li">
>(({ className, ...props }, ref) => (
  <li
    ref={ref}
    className={cn("inline-flex items-center gap-1.5", className)}
    {...props}
  />
))
BreadcrumbItem.displayName = "BreadcrumbItem"

const BreadcrumbLink = React.forwardRef<
  HTMLAnchorElement,
  React.ComponentPropsWithoutRef<"a"> & {
    asChild?: boolean
  }
>(({ asChild, className, ...props }, ref) => {
  const Comp = asChild ? Slot : "a"

  return (
    <Comp
      ref={ref}
      className={cn("transition-colors hover:text-foreground", className)}
      {...props}
    />
  )
})
BreadcrumbLink.displayName = "BreadcrumbLink"

const BreadcrumbPage = React.forwardRef<
  HTMLSpanElement,
  React.ComponentPropsWithoutRef<"span">
>(({ className, ...props }, ref) => (
  <span
    ref={ref}
    role="link"
    aria-disabled="true"
    aria-current="page"
    className={cn("font-normal text-foreground", className)}
    {...props}
  />
))
BreadcrumbPage.displayName = "BreadcrumbPage"

const BreadcrumbSeparator = ({
  children,
  className,
  ...props
}: React.ComponentProps<"li">) => (
  <li
    role="presentation"
    aria-hidden="true"
    className={cn("[&>svg]:size-3.5", className)}
    {...props}
  >
    {children ?? <ChevronRight />}
  </li>
)
BreadcrumbSeparator.displayName = "BreadcrumbSeparator"

const BreadcrumbEllipsis = ({
  className,
  ...props
}: React.ComponentProps<"span">) => (
  <span
    role="presentation"
    aria-hidden="true"
    className={cn("flex h-9 w-9 items-center justify-center", className)}
    {...props}
  >
    <MoreHorizontal className="h-4 w-4" />
    <span className="sr-only">More</span>
  </span>
)
BreadcrumbEllipsis.displayName = "BreadcrumbElipssis"

export {
  Breadcrumb,
  BreadcrumbList,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbPage,
  BreadcrumbSeparator,
  BreadcrumbEllipsis,
}


// File: src\components\ui\button.tsx

import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-destructive-foreground hover:bg-destructive/90",
        outline:
          "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-10 px-4 py-2",
        sm: "h-9 rounded-md px-3",
        lg: "h-11 rounded-md px-8",
        icon: "h-10 w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button"
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }


// File: src\components\ui\calendar.tsx

import * as React from "react";
import { ChevronLeft, ChevronRight } from "lucide-react";
import { DayPicker } from "react-day-picker";

import { cn } from "@/lib/utils";
import { buttonVariants } from "@/components/ui/button";

export type CalendarProps = React.ComponentProps<typeof DayPicker>;

function Calendar({
  className,
  classNames,
  showOutsideDays = true,
  ...props
}: CalendarProps) {
  return (
    <DayPicker
      showOutsideDays={showOutsideDays}
      className={cn("p-3", className)}
      classNames={{
        months: "flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",
        month: "space-y-4",
        caption: "flex justify-center pt-1 relative items-center",
        caption_label: "text-sm font-medium",
        nav: "space-x-1 flex items-center",
        nav_button: cn(
          buttonVariants({ variant: "outline" }),
          "h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100"
        ),
        nav_button_previous: "absolute left-1",
        nav_button_next: "absolute right-1",
        table: "w-full border-collapse space-y-1",
        head_row: "flex",
        head_cell:
          "text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]",
        row: "flex w-full mt-2",
        cell: "h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",
        day: cn(
          buttonVariants({ variant: "ghost" }),
          "h-9 w-9 p-0 font-normal aria-selected:opacity-100"
        ),
        day_range_end: "day-range-end",
        day_selected:
          "bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",
        day_today: "bg-accent text-accent-foreground",
        day_outside:
          "day-outside text-muted-foreground opacity-50 aria-selected:bg-accent/50 aria-selected:text-muted-foreground aria-selected:opacity-30",
        day_disabled: "text-muted-foreground opacity-50",
        day_range_middle:
          "aria-selected:bg-accent aria-selected:text-accent-foreground",
        day_hidden: "invisible",
        ...classNames,
      }}
      components={{
        IconLeft: ({ ..._props }) => <ChevronLeft className="h-4 w-4" />,
        IconRight: ({ ..._props }) => <ChevronRight className="h-4 w-4" />,
      }}
      {...props}
    />
  );
}
Calendar.displayName = "Calendar";

export { Calendar };


// File: src\components\ui\card.tsx

import * as React from "react"

import { cn } from "@/lib/utils"

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-lg border bg-card text-card-foreground shadow-sm",
      className
    )}
    {...props}
  />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h3
    ref={ref}
    className={cn(
      "text-2xl font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <p
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }


// File: src\components\ui\carousel.tsx

import * as React from "react"
import useEmblaCarousel, {
  type UseEmblaCarouselType,
} from "embla-carousel-react"
import { ArrowLeft, ArrowRight } from "lucide-react"

import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"

type CarouselApi = UseEmblaCarouselType[1]
type UseCarouselParameters = Parameters<typeof useEmblaCarousel>
type CarouselOptions = UseCarouselParameters[0]
type CarouselPlugin = UseCarouselParameters[1]

type CarouselProps = {
  opts?: CarouselOptions
  plugins?: CarouselPlugin
  orientation?: "horizontal" | "vertical"
  setApi?: (api: CarouselApi) => void
}

type CarouselContextProps = {
  carouselRef: ReturnType<typeof useEmblaCarousel>[0]
  api: ReturnType<typeof useEmblaCarousel>[1]
  scrollPrev: () => void
  scrollNext: () => void
  canScrollPrev: boolean
  canScrollNext: boolean
} & CarouselProps

const CarouselContext = React.createContext<CarouselContextProps | null>(null)

function useCarousel() {
  const context = React.useContext(CarouselContext)

  if (!context) {
    throw new Error("useCarousel must be used within a <Carousel />")
  }

  return context
}

const Carousel = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & CarouselProps
>(
  (
    {
      orientation = "horizontal",
      opts,
      setApi,
      plugins,
      className,
      children,
      ...props
    },
    ref
  ) => {
    const [carouselRef, api] = useEmblaCarousel(
      {
        ...opts,
        axis: orientation === "horizontal" ? "x" : "y",
      },
      plugins
    )
    const [canScrollPrev, setCanScrollPrev] = React.useState(false)
    const [canScrollNext, setCanScrollNext] = React.useState(false)

    const onSelect = React.useCallback((api: CarouselApi) => {
      if (!api) {
        return
      }

      setCanScrollPrev(api.canScrollPrev())
      setCanScrollNext(api.canScrollNext())
    }, [])

    const scrollPrev = React.useCallback(() => {
      api?.scrollPrev()
    }, [api])

    const scrollNext = React.useCallback(() => {
      api?.scrollNext()
    }, [api])

    const handleKeyDown = React.useCallback(
      (event: React.KeyboardEvent<HTMLDivElement>) => {
        if (event.key === "ArrowLeft") {
          event.preventDefault()
          scrollPrev()
        } else if (event.key === "ArrowRight") {
          event.preventDefault()
          scrollNext()
        }
      },
      [scrollPrev, scrollNext]
    )

    React.useEffect(() => {
      if (!api || !setApi) {
        return
      }

      setApi(api)
    }, [api, setApi])

    React.useEffect(() => {
      if (!api) {
        return
      }

      onSelect(api)
      api.on("reInit", onSelect)
      api.on("select", onSelect)

      return () => {
        api?.off("select", onSelect)
      }
    }, [api, onSelect])

    return (
      <CarouselContext.Provider
        value={{
          carouselRef,
          api: api,
          opts,
          orientation:
            orientation || (opts?.axis === "y" ? "vertical" : "horizontal"),
          scrollPrev,
          scrollNext,
          canScrollPrev,
          canScrollNext,
        }}
      >
        <div
          ref={ref}
          onKeyDownCapture={handleKeyDown}
          className={cn("relative", className)}
          role="region"
          aria-roledescription="carousel"
          {...props}
        >
          {children}
        </div>
      </CarouselContext.Provider>
    )
  }
)
Carousel.displayName = "Carousel"

const CarouselContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const { carouselRef, orientation } = useCarousel()

  return (
    <div ref={carouselRef} className="overflow-hidden">
      <div
        ref={ref}
        className={cn(
          "flex",
          orientation === "horizontal" ? "-ml-4" : "-mt-4 flex-col",
          className
        )}
        {...props}
      />
    </div>
  )
})
CarouselContent.displayName = "CarouselContent"

const CarouselItem = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const { orientation } = useCarousel()

  return (
    <div
      ref={ref}
      role="group"
      aria-roledescription="slide"
      className={cn(
        "min-w-0 shrink-0 grow-0 basis-full",
        orientation === "horizontal" ? "pl-4" : "pt-4",
        className
      )}
      {...props}
    />
  )
})
CarouselItem.displayName = "CarouselItem"

const CarouselPrevious = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<typeof Button>
>(({ className, variant = "outline", size = "icon", ...props }, ref) => {
  const { orientation, scrollPrev, canScrollPrev } = useCarousel()

  return (
    <Button
      ref={ref}
      variant={variant}
      size={size}
      className={cn(
        "absolute  h-8 w-8 rounded-full",
        orientation === "horizontal"
          ? "-left-12 top-1/2 -translate-y-1/2"
          : "-top-12 left-1/2 -translate-x-1/2 rotate-90",
        className
      )}
      disabled={!canScrollPrev}
      onClick={scrollPrev}
      {...props}
    >
      <ArrowLeft className="h-4 w-4" />
      <span className="sr-only">Previous slide</span>
    </Button>
  )
})
CarouselPrevious.displayName = "CarouselPrevious"

const CarouselNext = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<typeof Button>
>(({ className, variant = "outline", size = "icon", ...props }, ref) => {
  const { orientation, scrollNext, canScrollNext } = useCarousel()

  return (
    <Button
      ref={ref}
      variant={variant}
      size={size}
      className={cn(
        "absolute h-8 w-8 rounded-full",
        orientation === "horizontal"
          ? "-right-12 top-1/2 -translate-y-1/2"
          : "-bottom-12 left-1/2 -translate-x-1/2 rotate-90",
        className
      )}
      disabled={!canScrollNext}
      onClick={scrollNext}
      {...props}
    >
      <ArrowRight className="h-4 w-4" />
      <span className="sr-only">Next slide</span>
    </Button>
  )
})
CarouselNext.displayName = "CarouselNext"

export {
  type CarouselApi,
  Carousel,
  CarouselContent,
  CarouselItem,
  CarouselPrevious,
  CarouselNext,
}


// File: src\components\ui\chart.tsx

import * as React from "react"
import * as RechartsPrimitive from "recharts"

import { cn } from "@/lib/utils"

// Format: { THEME_NAME: CSS_SELECTOR }
const THEMES = { light: "", dark: ".dark" } as const

export type ChartConfig = {
  [k in string]: {
    label?: React.ReactNode
    icon?: React.ComponentType
  } & (
    | { color?: string; theme?: never }
    | { color?: never; theme: Record<keyof typeof THEMES, string> }
  )
}

type ChartContextProps = {
  config: ChartConfig
}

const ChartContext = React.createContext<ChartContextProps | null>(null)

function useChart() {
  const context = React.useContext(ChartContext)

  if (!context) {
    throw new Error("useChart must be used within a <ChartContainer />")
  }

  return context
}

const ChartContainer = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    config: ChartConfig
    children: React.ComponentProps<
      typeof RechartsPrimitive.ResponsiveContainer
    >["children"]
  }
>(({ id, className, children, config, ...props }, ref) => {
  const uniqueId = React.useId()
  const chartId = `chart-${id || uniqueId.replace(/:/g, "")}`

  return (
    <ChartContext.Provider value={{ config }}>
      <div
        data-chart={chartId}
        ref={ref}
        className={cn(
          "flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none",
          className
        )}
        {...props}
      >
        <ChartStyle id={chartId} config={config} />
        <RechartsPrimitive.ResponsiveContainer>
          {children}
        </RechartsPrimitive.ResponsiveContainer>
      </div>
    </ChartContext.Provider>
  )
})
ChartContainer.displayName = "Chart"

const ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {
  const colorConfig = Object.entries(config).filter(
    ([_, config]) => config.theme || config.color
  )

  if (!colorConfig.length) {
    return null
  }

  return (
    <style
      dangerouslySetInnerHTML={{
        __html: Object.entries(THEMES)
          .map(
            ([theme, prefix]) => `
${prefix} [data-chart=${id}] {
${colorConfig
  .map(([key, itemConfig]) => {
    const color =
      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||
      itemConfig.color
    return color ? `  --color-${key}: ${color};` : null
  })
  .join("\n")}
}
`
          )
          .join("\n"),
      }}
    />
  )
}

const ChartTooltip = RechartsPrimitive.Tooltip

const ChartTooltipContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &
    React.ComponentProps<"div"> & {
      hideLabel?: boolean
      hideIndicator?: boolean
      indicator?: "line" | "dot" | "dashed"
      nameKey?: string
      labelKey?: string
    }
>(
  (
    {
      active,
      payload,
      className,
      indicator = "dot",
      hideLabel = false,
      hideIndicator = false,
      label,
      labelFormatter,
      labelClassName,
      formatter,
      color,
      nameKey,
      labelKey,
    },
    ref
  ) => {
    const { config } = useChart()

    const tooltipLabel = React.useMemo(() => {
      if (hideLabel || !payload?.length) {
        return null
      }

      const [item] = payload
      const key = `${labelKey || item.dataKey || item.name || "value"}`
      const itemConfig = getPayloadConfigFromPayload(config, item, key)
      const value =
        !labelKey && typeof label === "string"
          ? config[label as keyof typeof config]?.label || label
          : itemConfig?.label

      if (labelFormatter) {
        return (
          <div className={cn("font-medium", labelClassName)}>
            {labelFormatter(value, payload)}
          </div>
        )
      }

      if (!value) {
        return null
      }

      return <div className={cn("font-medium", labelClassName)}>{value}</div>
    }, [
      label,
      labelFormatter,
      payload,
      hideLabel,
      labelClassName,
      config,
      labelKey,
    ])

    if (!active || !payload?.length) {
      return null
    }

    const nestLabel = payload.length === 1 && indicator !== "dot"

    return (
      <div
        ref={ref}
        className={cn(
          "grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl",
          className
        )}
      >
        {!nestLabel ? tooltipLabel : null}
        <div className="grid gap-1.5">
          {payload.map((item, index) => {
            const key = `${nameKey || item.name || item.dataKey || "value"}`
            const itemConfig = getPayloadConfigFromPayload(config, item, key)
            const indicatorColor = color || item.payload.fill || item.color

            return (
              <div
                key={item.dataKey}
                className={cn(
                  "flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground",
                  indicator === "dot" && "items-center"
                )}
              >
                {formatter && item?.value !== undefined && item.name ? (
                  formatter(item.value, item.name, item, index, item.payload)
                ) : (
                  <>
                    {itemConfig?.icon ? (
                      <itemConfig.icon />
                    ) : (
                      !hideIndicator && (
                        <div
                          className={cn(
                            "shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]",
                            {
                              "h-2.5 w-2.5": indicator === "dot",
                              "w-1": indicator === "line",
                              "w-0 border-[1.5px] border-dashed bg-transparent":
                                indicator === "dashed",
                              "my-0.5": nestLabel && indicator === "dashed",
                            }
                          )}
                          style={
                            {
                              "--color-bg": indicatorColor,
                              "--color-border": indicatorColor,
                            } as React.CSSProperties
                          }
                        />
                      )
                    )}
                    <div
                      className={cn(
                        "flex flex-1 justify-between leading-none",
                        nestLabel ? "items-end" : "items-center"
                      )}
                    >
                      <div className="grid gap-1.5">
                        {nestLabel ? tooltipLabel : null}
                        <span className="text-muted-foreground">
                          {itemConfig?.label || item.name}
                        </span>
                      </div>
                      {item.value && (
                        <span className="font-mono font-medium tabular-nums text-foreground">
                          {item.value.toLocaleString()}
                        </span>
                      )}
                    </div>
                  </>
                )}
              </div>
            )
          })}
        </div>
      </div>
    )
  }
)
ChartTooltipContent.displayName = "ChartTooltip"

const ChartLegend = RechartsPrimitive.Legend

const ChartLegendContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> &
    Pick<RechartsPrimitive.LegendProps, "payload" | "verticalAlign"> & {
      hideIcon?: boolean
      nameKey?: string
    }
>(
  (
    { className, hideIcon = false, payload, verticalAlign = "bottom", nameKey },
    ref
  ) => {
    const { config } = useChart()

    if (!payload?.length) {
      return null
    }

    return (
      <div
        ref={ref}
        className={cn(
          "flex items-center justify-center gap-4",
          verticalAlign === "top" ? "pb-3" : "pt-3",
          className
        )}
      >
        {payload.map((item) => {
          const key = `${nameKey || item.dataKey || "value"}`
          const itemConfig = getPayloadConfigFromPayload(config, item, key)

          return (
            <div
              key={item.value}
              className={cn(
                "flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground"
              )}
            >
              {itemConfig?.icon && !hideIcon ? (
                <itemConfig.icon />
              ) : (
                <div
                  className="h-2 w-2 shrink-0 rounded-[2px]"
                  style={{
                    backgroundColor: item.color,
                  }}
                />
              )}
              {itemConfig?.label}
            </div>
          )
        })}
      </div>
    )
  }
)
ChartLegendContent.displayName = "ChartLegend"

// Helper to extract item config from a payload.
function getPayloadConfigFromPayload(
  config: ChartConfig,
  payload: unknown,
  key: string
) {
  if (typeof payload !== "object" || payload === null) {
    return undefined
  }

  const payloadPayload =
    "payload" in payload &&
    typeof payload.payload === "object" &&
    payload.payload !== null
      ? payload.payload
      : undefined

  let configLabelKey: string = key

  if (
    key in payload &&
    typeof payload[key as keyof typeof payload] === "string"
  ) {
    configLabelKey = payload[key as keyof typeof payload] as string
  } else if (
    payloadPayload &&
    key in payloadPayload &&
    typeof payloadPayload[key as keyof typeof payloadPayload] === "string"
  ) {
    configLabelKey = payloadPayload[
      key as keyof typeof payloadPayload
    ] as string
  }

  return configLabelKey in config
    ? config[configLabelKey]
    : config[key as keyof typeof config]
}

export {
  ChartContainer,
  ChartTooltip,
  ChartTooltipContent,
  ChartLegend,
  ChartLegendContent,
  ChartStyle,
}


// File: src\components\ui\checkbox.tsx

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { Check } from "lucide-react"

import { cn } from "@/lib/utils"

const Checkbox = React.forwardRef<
  React.ElementRef<typeof CheckboxPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
>(({ className, ...props }, ref) => (
  <CheckboxPrimitive.Root
    ref={ref}
    className={cn(
      "peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",
      className
    )}
    {...props}
  >
    <CheckboxPrimitive.Indicator
      className={cn("flex items-center justify-center text-current")}
    >
      <Check className="h-4 w-4" />
    </CheckboxPrimitive.Indicator>
  </CheckboxPrimitive.Root>
))
Checkbox.displayName = CheckboxPrimitive.Root.displayName

export { Checkbox }


// File: src\components\ui\collapsible.tsx

import * as CollapsiblePrimitive from "@radix-ui/react-collapsible"

const Collapsible = CollapsiblePrimitive.Root

const CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger

const CollapsibleContent = CollapsiblePrimitive.CollapsibleContent

export { Collapsible, CollapsibleTrigger, CollapsibleContent }


// File: src\components\ui\command.tsx

import * as React from "react"
import { type DialogProps } from "@radix-ui/react-dialog"
import { Command as CommandPrimitive } from "cmdk"
import { Search } from "lucide-react"

import { cn } from "@/lib/utils"
import { Dialog, DialogContent } from "@/components/ui/dialog"

const Command = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive>
>(({ className, ...props }, ref) => (
  <CommandPrimitive
    ref={ref}
    className={cn(
      "flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",
      className
    )}
    {...props}
  />
))
Command.displayName = CommandPrimitive.displayName

interface CommandDialogProps extends DialogProps {}

const CommandDialog = ({ children, ...props }: CommandDialogProps) => {
  return (
    <Dialog {...props}>
      <DialogContent className="overflow-hidden p-0 shadow-lg">
        <Command className="[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
          {children}
        </Command>
      </DialogContent>
    </Dialog>
  )
}

const CommandInput = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Input>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>
>(({ className, ...props }, ref) => (
  <div className="flex items-center border-b px-3" cmdk-input-wrapper="">
    <Search className="mr-2 h-4 w-4 shrink-0 opacity-50" />
    <CommandPrimitive.Input
      ref={ref}
      className={cn(
        "flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    />
  </div>
))

CommandInput.displayName = CommandPrimitive.Input.displayName

const CommandList = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.List
    ref={ref}
    className={cn("max-h-[300px] overflow-y-auto overflow-x-hidden", className)}
    {...props}
  />
))

CommandList.displayName = CommandPrimitive.List.displayName

const CommandEmpty = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Empty>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>
>((props, ref) => (
  <CommandPrimitive.Empty
    ref={ref}
    className="py-6 text-center text-sm"
    {...props}
  />
))

CommandEmpty.displayName = CommandPrimitive.Empty.displayName

const CommandGroup = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Group>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Group
    ref={ref}
    className={cn(
      "overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",
      className
    )}
    {...props}
  />
))

CommandGroup.displayName = CommandPrimitive.Group.displayName

const CommandSeparator = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 h-px bg-border", className)}
    {...props}
  />
))
CommandSeparator.displayName = CommandPrimitive.Separator.displayName

const CommandItem = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50",
      className
    )}
    {...props}
  />
))

CommandItem.displayName = CommandPrimitive.Item.displayName

const CommandShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn(
        "ml-auto text-xs tracking-widest text-muted-foreground",
        className
      )}
      {...props}
    />
  )
}
CommandShortcut.displayName = "CommandShortcut"

export {
  Command,
  CommandDialog,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandGroup,
  CommandItem,
  CommandShortcut,
  CommandSeparator,
}


// File: src\components\ui\context-menu.tsx

import * as React from "react"
import * as ContextMenuPrimitive from "@radix-ui/react-context-menu"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const ContextMenu = ContextMenuPrimitive.Root

const ContextMenuTrigger = ContextMenuPrimitive.Trigger

const ContextMenuGroup = ContextMenuPrimitive.Group

const ContextMenuPortal = ContextMenuPrimitive.Portal

const ContextMenuSub = ContextMenuPrimitive.Sub

const ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup

const ContextMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <ContextMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </ContextMenuPrimitive.SubTrigger>
))
ContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName

const ContextMenuSubContent = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <ContextMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
ContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName

const ContextMenuContent = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>
>(({ className, ...props }, ref) => (
  <ContextMenuPrimitive.Portal>
    <ContextMenuPrimitive.Content
      ref={ref}
      className={cn(
        "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </ContextMenuPrimitive.Portal>
))
ContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName

const ContextMenuItem = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <ContextMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
ContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName

const ContextMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <ContextMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <ContextMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </ContextMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </ContextMenuPrimitive.CheckboxItem>
))
ContextMenuCheckboxItem.displayName =
  ContextMenuPrimitive.CheckboxItem.displayName

const ContextMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <ContextMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <ContextMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </ContextMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </ContextMenuPrimitive.RadioItem>
))
ContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName

const ContextMenuLabel = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <ContextMenuPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold text-foreground",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
ContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName

const ContextMenuSeparator = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <ContextMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-border", className)}
    {...props}
  />
))
ContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName

const ContextMenuShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn(
        "ml-auto text-xs tracking-widest text-muted-foreground",
        className
      )}
      {...props}
    />
  )
}
ContextMenuShortcut.displayName = "ContextMenuShortcut"

export {
  ContextMenu,
  ContextMenuTrigger,
  ContextMenuContent,
  ContextMenuItem,
  ContextMenuCheckboxItem,
  ContextMenuRadioItem,
  ContextMenuLabel,
  ContextMenuSeparator,
  ContextMenuShortcut,
  ContextMenuGroup,
  ContextMenuPortal,
  ContextMenuSub,
  ContextMenuSubContent,
  ContextMenuSubTrigger,
  ContextMenuRadioGroup,
}


// File: src\components\ui\dialog.tsx

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Dialog = DialogPrimitive.Root

const DialogTrigger = DialogPrimitive.Trigger

const DialogPortal = DialogPrimitive.Portal

const DialogClose = DialogPrimitive.Close

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
  />
))
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    >
      {children}
      <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
))
DialogContent.displayName = DialogPrimitive.Content.displayName

const DialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-1.5 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
DialogHeader.displayName = "DialogHeader"

const DialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
DialogFooter.displayName = "DialogFooter"

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
DialogTitle.displayName = DialogPrimitive.Title.displayName

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DialogDescription.displayName = DialogPrimitive.Description.displayName

export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogClose,
  DialogTrigger,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
}


// File: src\components\ui\drawer.tsx

import * as React from "react"
import { Drawer as DrawerPrimitive } from "vaul"

import { cn } from "@/lib/utils"

const Drawer = ({
  shouldScaleBackground = true,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (
  <DrawerPrimitive.Root
    shouldScaleBackground={shouldScaleBackground}
    {...props}
  />
)
Drawer.displayName = "Drawer"

const DrawerTrigger = DrawerPrimitive.Trigger

const DrawerPortal = DrawerPrimitive.Portal

const DrawerClose = DrawerPrimitive.Close

const DrawerOverlay = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DrawerPrimitive.Overlay
    ref={ref}
    className={cn("fixed inset-0 z-50 bg-black/80", className)}
    {...props}
  />
))
DrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName

const DrawerContent = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DrawerPortal>
    <DrawerOverlay />
    <DrawerPrimitive.Content
      ref={ref}
      className={cn(
        "fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background",
        className
      )}
      {...props}
    >
      <div className="mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted" />
      {children}
    </DrawerPrimitive.Content>
  </DrawerPortal>
))
DrawerContent.displayName = "DrawerContent"

const DrawerHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn("grid gap-1.5 p-4 text-center sm:text-left", className)}
    {...props}
  />
)
DrawerHeader.displayName = "DrawerHeader"

const DrawerFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn("mt-auto flex flex-col gap-2 p-4", className)}
    {...props}
  />
)
DrawerFooter.displayName = "DrawerFooter"

const DrawerTitle = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DrawerPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
DrawerTitle.displayName = DrawerPrimitive.Title.displayName

const DrawerDescription = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DrawerPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DrawerDescription.displayName = DrawerPrimitive.Description.displayName

export {
  Drawer,
  DrawerPortal,
  DrawerOverlay,
  DrawerTrigger,
  DrawerClose,
  DrawerContent,
  DrawerHeader,
  DrawerFooter,
  DrawerTitle,
  DrawerDescription,
}


// File: src\components\ui\dropdown-menu.tsx

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const DropdownMenu = DropdownMenuPrimitive.Root

const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger

const DropdownMenuGroup = DropdownMenuPrimitive.Group

const DropdownMenuPortal = DropdownMenuPrimitive.Portal

const DropdownMenuSub = DropdownMenuPrimitive.Sub

const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup

const DropdownMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <DropdownMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </DropdownMenuPrimitive.SubTrigger>
))
DropdownMenuSubTrigger.displayName =
  DropdownMenuPrimitive.SubTrigger.displayName

const DropdownMenuSubContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
DropdownMenuSubContent.displayName =
  DropdownMenuPrimitive.SubContent.displayName

const DropdownMenuContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </DropdownMenuPrimitive.Portal>
))
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName

const DropdownMenuItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName

const DropdownMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <DropdownMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.CheckboxItem>
))
DropdownMenuCheckboxItem.displayName =
  DropdownMenuPrimitive.CheckboxItem.displayName

const DropdownMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <DropdownMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.RadioItem>
))
DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName

const DropdownMenuLabel = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName

const DropdownMenuSeparator = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName

const DropdownMenuShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn("ml-auto text-xs tracking-widest opacity-60", className)}
      {...props}
    />
  )
}
DropdownMenuShortcut.displayName = "DropdownMenuShortcut"

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuGroup,
  DropdownMenuPortal,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuRadioGroup,
}


// File: src\components\ui\editor.tsx

import React from 'react';
import { Chapter, Section } from '@/types/thesis';
import { MarkdownEditor } from '../MarkdownEditor';
import { FigureManager } from '../FigureManager';
import { TableManager } from '../TableManager';
import { CitationManager } from '../CitationManager';
import { ReferenceManager } from '../ReferenceManager';
import { Button } from '../ui/button';
import { Input } from '../ui/input';
import { PlusCircle } from 'lucide-react';

interface ThesisContentProps {
  frontMatter: Section[];
  chapters: Chapter[];
  backMatter: Section[];
  activeSection: string;
  onContentChange: (id: string, content: string) => void;
  onTitleChange: (id: string, title: string) => void;
  onUpdateChapter: (chapter: Chapter) => void;
  onAddChapter: () => void;
}

export const ThesisContent = ({
    frontMatter,
    chapters,
    backMatter,
    activeSection,
    onContentChange,
    onTitleChange,
    onUpdateChapter,
    onAddChapter
}: ThesisContentProps) => {
    const handleAddSection = (chapterId: string) => {
        const chapter = chapters.find((c) => c.id === chapterId);
        if (!chapter) return;

        const newSection: Section = {
            id: Date.now().toString(),
            title: 'New Section',
            content: '',
            type: 'custom',
            order: chapter.sections.length + 1,
            figures: [],
            tables: [],
            citations: [],
            references: []
        };
        
        const introductionSection: Section = {
            id: Date.now().toString() + "-intro",
            title: 'Introduction',
            content: 'Introduction',
             type: 'custom',
             order: 1,
             figures: [],
             tables: [],
             citations: [],
             references: []
        };
        

        onUpdateChapter({
            ...chapter,
            sections: [introductionSection, ...chapter.sections, newSection]
        });
    };

    const renderSectionContent = (section: Section) => {
        const isActive = activeSection === section.id;

        if (!isActive) return null;
        return (
            <div key={section.id} className="editor-section space-y-6">
                <div className="flex items-center gap-3 mb-4">
                    <Input
                        value={section.title}
                        onChange={(e) => onTitleChange(section.id, e.target.value)}
                        className="text-xl font-serif border-none bg-transparent px-0 focus-visible:ring-0"
                    />
                </div>
                <div className="mb-6">
                    <MarkdownEditor
                        value={section.content}
                        onChange={(value) => onContentChange(section.id, value || '')}
                        placeholder="Start writing..."
                    />
                </div>
                <div className="space-y-8">
                    <FigureManager
                        figures={section.figures}
                        onAddFigure={(figure) => {
                            section.figures.push(figure);
                            onContentChange(section.id, section.content);
                        }}
                        onRemoveFigure={(id) => {
                            section.figures = section.figures.filter(f => f.id !== id);
                            onContentChange(section.id, section.content);
                        }}
                        onUpdateFigure={(figure) => {
                            section.figures = section.figures.map(f => f.id === figure.id ? figure : f);
                            onContentChange(section.id, section.content);
                        }}
                    />
                    <TableManager
                        tables={section.tables}
                        onAddTable={(table) => {
                            section.tables.push(table);
                            onContentChange(section.id, section.content);
                        }}
                        onRemoveTable={(id) => {
                            section.tables = section.tables.filter(t => t.id !== id);
                            onContentChange(section.id, section.content);
                        }}
                        onUpdateTable={(table) => {
                            section.tables = section.tables.map(t => t.id === table.id ? table : t);
                            onContentChange(section.id, section.content);
                        }}
                    />
                    <CitationManager
                        citations={section.citations}
                        thesisId={section.id}
                        onCitationCreate={(citation) => {
                            section.citations.push(citation);
                            onContentChange(section.id, section.content);
                        }}
                        onCitationDelete={(citation) => {
                            section.citations = section.citations.filter(c => c.id !== citation.id);
                            onContentChange(section.id, section.content);
                        }}
                        onCitationUpdate={(citation) => {
                            section.citations = section.citations.map(c => c.id === citation.id ? citation : c);
                            onContentChange(section.id, section.content);
                        }}
                    />
                    {section.type === 'references' && section.references && (
                        <ReferenceManager
                            items={section.references}
                            onAdd={(reference) => {
                                section.references = [...(section.references || []), reference];
                                onContentChange(section.id, section.content);
                            }}
                            onRemove={(id) => {
                                section.references = section.references?.filter(r => r.id !== id);
                                onContentChange(section.id, section.content);
                            }}
                            onUpdate={(reference) => {
                                section.references = section.references?.map(r => r.id === reference.id ? reference : r);
                                onContentChange(section.id, section.content);
                            }}
                        />
                    )}
                </div>
            </div>
        );
    };

    return (
        <div className="space-y-6">
            {frontMatter.map(section => renderSectionContent(section))}
            <div className="space-y-6">
                <div className="flex justify-between items-center">
                    <h2 className="text-2xl font-serif font-semibold">Chapters</h2>
                    <Button onClick={onAddChapter} className="flex items-center gap-2">
                        <PlusCircle className="w-4 h-4" />
                        Add Chapter
                    </Button>
                </div>
                {chapters.map((chapter) => (
                    <div key={chapter.id} className="border rounded-lg p-6 space-y-6">
                        <Input
                            value={chapter.title}
                            onChange={(e) =>
                                onUpdateChapter({ ...chapter, title: e.target.value })
                            }
                            className="text-xl font-serif"
                            placeholder="Chapter Title"
                        />
                        <div className="space-y-6">
                            {chapter.sections.map((section) => renderSectionContent(section))}
                            <Button
                                onClick={() => handleAddSection(chapter.id)}
                                variant="outline"
                                className="mt-4"
                            >
                                Add Section
                            </Button>
                        </div>
                    </div>
                ))}
            </div>
            {backMatter.map(section => renderSectionContent(section))}
        </div>
    );
};


// File: src\components\ui\form.tsx

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { Slot } from "@radix-ui/react-slot"
import {
  Controller,
  ControllerProps,
  FieldPath,
  FieldValues,
  FormProvider,
  useFormContext,
} from "react-hook-form"

import { cn } from "@/lib/utils"
import { Label } from "@/components/ui/label"

const Form = FormProvider

type FormFieldContextValue<
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
> = {
  name: TName
}

const FormFieldContext = React.createContext<FormFieldContextValue>(
  {} as FormFieldContextValue
)

const FormField = <
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
>({
  ...props
}: ControllerProps<TFieldValues, TName>) => {
  return (
    <FormFieldContext.Provider value={{ name: props.name }}>
      <Controller {...props} />
    </FormFieldContext.Provider>
  )
}

const useFormField = () => {
  const fieldContext = React.useContext(FormFieldContext)
  const itemContext = React.useContext(FormItemContext)
  const { getFieldState, formState } = useFormContext()

  const fieldState = getFieldState(fieldContext.name, formState)

  if (!fieldContext) {
    throw new Error("useFormField should be used within <FormField>")
  }

  const { id } = itemContext

  return {
    id,
    name: fieldContext.name,
    formItemId: `${id}-form-item`,
    formDescriptionId: `${id}-form-item-description`,
    formMessageId: `${id}-form-item-message`,
    ...fieldState,
  }
}

type FormItemContextValue = {
  id: string
}

const FormItemContext = React.createContext<FormItemContextValue>(
  {} as FormItemContextValue
)

const FormItem = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const id = React.useId()

  return (
    <FormItemContext.Provider value={{ id }}>
      <div ref={ref} className={cn("space-y-2", className)} {...props} />
    </FormItemContext.Provider>
  )
})
FormItem.displayName = "FormItem"

const FormLabel = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>
>(({ className, ...props }, ref) => {
  const { error, formItemId } = useFormField()

  return (
    <Label
      ref={ref}
      className={cn(error && "text-destructive", className)}
      htmlFor={formItemId}
      {...props}
    />
  )
})
FormLabel.displayName = "FormLabel"

const FormControl = React.forwardRef<
  React.ElementRef<typeof Slot>,
  React.ComponentPropsWithoutRef<typeof Slot>
>(({ ...props }, ref) => {
  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()

  return (
    <Slot
      ref={ref}
      id={formItemId}
      aria-describedby={
        !error
          ? `${formDescriptionId}`
          : `${formDescriptionId} ${formMessageId}`
      }
      aria-invalid={!!error}
      {...props}
    />
  )
})
FormControl.displayName = "FormControl"

const FormDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => {
  const { formDescriptionId } = useFormField()

  return (
    <p
      ref={ref}
      id={formDescriptionId}
      className={cn("text-sm text-muted-foreground", className)}
      {...props}
    />
  )
})
FormDescription.displayName = "FormDescription"

const FormMessage = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, children, ...props }, ref) => {
  const { error, formMessageId } = useFormField()
  const body = error ? String(error?.message) : children

  if (!body) {
    return null
  }

  return (
    <p
      ref={ref}
      id={formMessageId}
      className={cn("text-sm font-medium text-destructive", className)}
      {...props}
    >
      {body}
    </p>
  )
})
FormMessage.displayName = "FormMessage"

export {
  useFormField,
  Form,
  FormItem,
  FormLabel,
  FormControl,
  FormDescription,
  FormMessage,
  FormField,
}


// File: src\components\ui\hover-card.tsx

import * as React from "react"
import * as HoverCardPrimitive from "@radix-ui/react-hover-card"

import { cn } from "@/lib/utils"

const HoverCard = HoverCardPrimitive.Root

const HoverCardTrigger = HoverCardPrimitive.Trigger

const HoverCardContent = React.forwardRef<
  React.ElementRef<typeof HoverCardPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <HoverCardPrimitive.Content
    ref={ref}
    align={align}
    sideOffset={sideOffset}
    className={cn(
      "z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
HoverCardContent.displayName = HoverCardPrimitive.Content.displayName

export { HoverCard, HoverCardTrigger, HoverCardContent }


// File: src\components\ui\input-otp.tsx

import * as React from "react"
import { OTPInput, OTPInputContext } from "input-otp"
import { Dot } from "lucide-react"

import { cn } from "@/lib/utils"

const InputOTP = React.forwardRef<
  React.ElementRef<typeof OTPInput>,
  React.ComponentPropsWithoutRef<typeof OTPInput>
>(({ className, containerClassName, ...props }, ref) => (
  <OTPInput
    ref={ref}
    containerClassName={cn(
      "flex items-center gap-2 has-[:disabled]:opacity-50",
      containerClassName
    )}
    className={cn("disabled:cursor-not-allowed", className)}
    {...props}
  />
))
InputOTP.displayName = "InputOTP"

const InputOTPGroup = React.forwardRef<
  React.ElementRef<"div">,
  React.ComponentPropsWithoutRef<"div">
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("flex items-center", className)} {...props} />
))
InputOTPGroup.displayName = "InputOTPGroup"

const InputOTPSlot = React.forwardRef<
  React.ElementRef<"div">,
  React.ComponentPropsWithoutRef<"div"> & { index: number }
>(({ index, className, ...props }, ref) => {
  const inputOTPContext = React.useContext(OTPInputContext)
  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]

  return (
    <div
      ref={ref}
      className={cn(
        "relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md",
        isActive && "z-10 ring-2 ring-ring ring-offset-background",
        className
      )}
      {...props}
    >
      {char}
      {hasFakeCaret && (
        <div className="pointer-events-none absolute inset-0 flex items-center justify-center">
          <div className="h-4 w-px animate-caret-blink bg-foreground duration-1000" />
        </div>
      )}
    </div>
  )
})
InputOTPSlot.displayName = "InputOTPSlot"

const InputOTPSeparator = React.forwardRef<
  React.ElementRef<"div">,
  React.ComponentPropsWithoutRef<"div">
>(({ ...props }, ref) => (
  <div ref={ref} role="separator" {...props}>
    <Dot />
  </div>
))
InputOTPSeparator.displayName = "InputOTPSeparator"

export { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }


// File: src\components\ui\input.tsx

import * as React from "react"
import { cn } from "@/lib/utils"

export interface InputProps extends React.InputHTMLAttributes<HTMLInputElement> {
  leftIcon?: React.ReactNode;
}

const Input = React.forwardRef<HTMLInputElement, InputProps>(
  ({ className, type, leftIcon, ...props }, ref) => {
    return (
      <div className="relative">
        {leftIcon && (
          <div className="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground">
            {leftIcon}
          </div>
        )}
        <input
          type={type}
          className={cn(
            "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
            leftIcon && "pl-10",
            className
          )}
          ref={ref}
          {...props}
        />
      </div>
    )
  }
)
Input.displayName = "Input"

export { Input }

// File: src\components\ui\label.tsx

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const labelVariants = cva(
  "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
)

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
    VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn(labelVariants(), className)}
    {...props}
  />
))
Label.displayName = LabelPrimitive.Root.displayName

export { Label }


// File: src\components\ui\menubar.tsx

import * as React from "react"
import * as MenubarPrimitive from "@radix-ui/react-menubar"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const MenubarMenu = MenubarPrimitive.Menu

const MenubarGroup = MenubarPrimitive.Group

const MenubarPortal = MenubarPrimitive.Portal

const MenubarSub = MenubarPrimitive.Sub

const MenubarRadioGroup = MenubarPrimitive.RadioGroup

const Menubar = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Root
    ref={ref}
    className={cn(
      "flex h-10 items-center space-x-1 rounded-md border bg-background p-1",
      className
    )}
    {...props}
  />
))
Menubar.displayName = MenubarPrimitive.Root.displayName

const MenubarTrigger = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
      className
    )}
    {...props}
  />
))
MenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName

const MenubarSubTrigger = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <MenubarPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </MenubarPrimitive.SubTrigger>
))
MenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName

const MenubarSubContent = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
MenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName

const MenubarContent = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>
>(
  (
    { className, align = "start", alignOffset = -4, sideOffset = 8, ...props },
    ref
  ) => (
    <MenubarPrimitive.Portal>
      <MenubarPrimitive.Content
        ref={ref}
        align={align}
        alignOffset={alignOffset}
        sideOffset={sideOffset}
        className={cn(
          "z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          className
        )}
        {...props}
      />
    </MenubarPrimitive.Portal>
  )
)
MenubarContent.displayName = MenubarPrimitive.Content.displayName

const MenubarItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <MenubarPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
MenubarItem.displayName = MenubarPrimitive.Item.displayName

const MenubarCheckboxItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <MenubarPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <MenubarPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </MenubarPrimitive.ItemIndicator>
    </span>
    {children}
  </MenubarPrimitive.CheckboxItem>
))
MenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName

const MenubarRadioItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <MenubarPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <MenubarPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </MenubarPrimitive.ItemIndicator>
    </span>
    {children}
  </MenubarPrimitive.RadioItem>
))
MenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName

const MenubarLabel = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <MenubarPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
MenubarLabel.displayName = MenubarPrimitive.Label.displayName

const MenubarSeparator = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
MenubarSeparator.displayName = MenubarPrimitive.Separator.displayName

const MenubarShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn(
        "ml-auto text-xs tracking-widest text-muted-foreground",
        className
      )}
      {...props}
    />
  )
}
MenubarShortcut.displayname = "MenubarShortcut"

export {
  Menubar,
  MenubarMenu,
  MenubarTrigger,
  MenubarContent,
  MenubarItem,
  MenubarSeparator,
  MenubarLabel,
  MenubarCheckboxItem,
  MenubarRadioGroup,
  MenubarRadioItem,
  MenubarPortal,
  MenubarSubContent,
  MenubarSubTrigger,
  MenubarGroup,
  MenubarSub,
  MenubarShortcut,
}


// File: src\components\ui\navigation-menu.tsx

import * as React from "react"
import * as NavigationMenuPrimitive from "@radix-ui/react-navigation-menu"
import { cva } from "class-variance-authority"
import { ChevronDown } from "lucide-react"

import { cn } from "@/lib/utils"

const NavigationMenu = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <NavigationMenuPrimitive.Root
    ref={ref}
    className={cn(
      "relative z-10 flex max-w-max flex-1 items-center justify-center",
      className
    )}
    {...props}
  >
    {children}
    <NavigationMenuViewport />
  </NavigationMenuPrimitive.Root>
))
NavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName

const NavigationMenuList = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>
>(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.List
    ref={ref}
    className={cn(
      "group flex flex-1 list-none items-center justify-center space-x-1",
      className
    )}
    {...props}
  />
))
NavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName

const NavigationMenuItem = NavigationMenuPrimitive.Item

const navigationMenuTriggerStyle = cva(
  "group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[active]:bg-accent/50 data-[state=open]:bg-accent/50"
)

const NavigationMenuTrigger = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <NavigationMenuPrimitive.Trigger
    ref={ref}
    className={cn(navigationMenuTriggerStyle(), "group", className)}
    {...props}
  >
    {children}{" "}
    <ChevronDown
      className="relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180"
      aria-hidden="true"
    />
  </NavigationMenuPrimitive.Trigger>
))
NavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName

const NavigationMenuContent = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>
>(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.Content
    ref={ref}
    className={cn(
      "left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto ",
      className
    )}
    {...props}
  />
))
NavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName

const NavigationMenuLink = NavigationMenuPrimitive.Link

const NavigationMenuViewport = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>
>(({ className, ...props }, ref) => (
  <div className={cn("absolute left-0 top-full flex justify-center")}>
    <NavigationMenuPrimitive.Viewport
      className={cn(
        "origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]",
        className
      )}
      ref={ref}
      {...props}
    />
  </div>
))
NavigationMenuViewport.displayName =
  NavigationMenuPrimitive.Viewport.displayName

const NavigationMenuIndicator = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>
>(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.Indicator
    ref={ref}
    className={cn(
      "top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in",
      className
    )}
    {...props}
  >
    <div className="relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md" />
  </NavigationMenuPrimitive.Indicator>
))
NavigationMenuIndicator.displayName =
  NavigationMenuPrimitive.Indicator.displayName

export {
  navigationMenuTriggerStyle,
  NavigationMenu,
  NavigationMenuList,
  NavigationMenuItem,
  NavigationMenuContent,
  NavigationMenuTrigger,
  NavigationMenuLink,
  NavigationMenuIndicator,
  NavigationMenuViewport,
}


// File: src\components\ui\pagination.tsx

import * as React from "react"
import { ChevronLeft, ChevronRight, MoreHorizontal } from "lucide-react"

import { cn } from "@/lib/utils"
import { ButtonProps, buttonVariants } from "@/components/ui/button"

const Pagination = ({ className, ...props }: React.ComponentProps<"nav">) => (
  <nav
    role="navigation"
    aria-label="pagination"
    className={cn("mx-auto flex w-full justify-center", className)}
    {...props}
  />
)
Pagination.displayName = "Pagination"

const PaginationContent = React.forwardRef<
  HTMLUListElement,
  React.ComponentProps<"ul">
>(({ className, ...props }, ref) => (
  <ul
    ref={ref}
    className={cn("flex flex-row items-center gap-1", className)}
    {...props}
  />
))
PaginationContent.displayName = "PaginationContent"

const PaginationItem = React.forwardRef<
  HTMLLIElement,
  React.ComponentProps<"li">
>(({ className, ...props }, ref) => (
  <li ref={ref} className={cn("", className)} {...props} />
))
PaginationItem.displayName = "PaginationItem"

type PaginationLinkProps = {
  isActive?: boolean
} & Pick<ButtonProps, "size"> &
  React.ComponentProps<"a">

const PaginationLink = ({
  className,
  isActive,
  size = "icon",
  ...props
}: PaginationLinkProps) => (
  <a
    aria-current={isActive ? "page" : undefined}
    className={cn(
      buttonVariants({
        variant: isActive ? "outline" : "ghost",
        size,
      }),
      className
    )}
    {...props}
  />
)
PaginationLink.displayName = "PaginationLink"

const PaginationPrevious = ({
  className,
  ...props
}: React.ComponentProps<typeof PaginationLink>) => (
  <PaginationLink
    aria-label="Go to previous page"
    size="default"
    className={cn("gap-1 pl-2.5", className)}
    {...props}
  >
    <ChevronLeft className="h-4 w-4" />
    <span>Previous</span>
  </PaginationLink>
)
PaginationPrevious.displayName = "PaginationPrevious"

const PaginationNext = ({
  className,
  ...props
}: React.ComponentProps<typeof PaginationLink>) => (
  <PaginationLink
    aria-label="Go to next page"
    size="default"
    className={cn("gap-1 pr-2.5", className)}
    {...props}
  >
    <span>Next</span>
    <ChevronRight className="h-4 w-4" />
  </PaginationLink>
)
PaginationNext.displayName = "PaginationNext"

const PaginationEllipsis = ({
  className,
  ...props
}: React.ComponentProps<"span">) => (
  <span
    aria-hidden
    className={cn("flex h-9 w-9 items-center justify-center", className)}
    {...props}
  >
    <MoreHorizontal className="h-4 w-4" />
    <span className="sr-only">More pages</span>
  </span>
)
PaginationEllipsis.displayName = "PaginationEllipsis"

export {
  Pagination,
  PaginationContent,
  PaginationEllipsis,
  PaginationItem,
  PaginationLink,
  PaginationNext,
  PaginationPrevious,
}


// File: src\components\ui\popover.tsx

import * as React from "react"
import * as PopoverPrimitive from "@radix-ui/react-popover"

import { cn } from "@/lib/utils"

const Popover = PopoverPrimitive.Root

const PopoverTrigger = PopoverPrimitive.Trigger

const PopoverContent = React.forwardRef<
  React.ElementRef<typeof PopoverPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <PopoverPrimitive.Portal>
    <PopoverPrimitive.Content
      ref={ref}
      align={align}
      sideOffset={sideOffset}
      className={cn(
        "z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </PopoverPrimitive.Portal>
))
PopoverContent.displayName = PopoverPrimitive.Content.displayName

export { Popover, PopoverTrigger, PopoverContent }


// File: src\components\ui\progress.tsx

import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

const Progress = React.forwardRef<
  React.ElementRef<typeof ProgressPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>
>(({ className, value, ...props }, ref) => (
  <ProgressPrimitive.Root
    ref={ref}
    className={cn(
      "relative h-4 w-full overflow-hidden rounded-full bg-secondary",
      className
    )}
    {...props}
  >
    <ProgressPrimitive.Indicator
      className="h-full w-full flex-1 bg-primary transition-all"
      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
    />
  </ProgressPrimitive.Root>
))
Progress.displayName = ProgressPrimitive.Root.displayName

export { Progress }


// File: src\components\ui\radio-group.tsx

import * as React from "react"
import * as RadioGroupPrimitive from "@radix-ui/react-radio-group"
import { Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const RadioGroup = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>
>(({ className, ...props }, ref) => {
  return (
    <RadioGroupPrimitive.Root
      className={cn("grid gap-2", className)}
      {...props}
      ref={ref}
    />
  )
})
RadioGroup.displayName = RadioGroupPrimitive.Root.displayName

const RadioGroupItem = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>
>(({ className, ...props }, ref) => {
  return (
    <RadioGroupPrimitive.Item
      ref={ref}
      className={cn(
        "aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <RadioGroupPrimitive.Indicator className="flex items-center justify-center">
        <Circle className="h-2.5 w-2.5 fill-current text-current" />
      </RadioGroupPrimitive.Indicator>
    </RadioGroupPrimitive.Item>
  )
})
RadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName

export { RadioGroup, RadioGroupItem }


// File: src\components\ui\resizable.tsx

import { GripVertical } from "lucide-react"
import * as ResizablePrimitive from "react-resizable-panels"

import { cn } from "@/lib/utils"

const ResizablePanelGroup = ({
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (
  <ResizablePrimitive.PanelGroup
    className={cn(
      "flex h-full w-full data-[panel-group-direction=vertical]:flex-col",
      className
    )}
    {...props}
  />
)

const ResizablePanel = ResizablePrimitive.Panel

const ResizableHandle = ({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
  withHandle?: boolean
}) => (
  <ResizablePrimitive.PanelResizeHandle
    className={cn(
      "relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90",
      className
    )}
    {...props}
  >
    {withHandle && (
      <div className="z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border">
        <GripVertical className="h-2.5 w-2.5" />
      </div>
    )}
  </ResizablePrimitive.PanelResizeHandle>
)

export { ResizablePanelGroup, ResizablePanel, ResizableHandle }


// File: src\components\ui\scroll-area.tsx

import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils"

const ScrollArea = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <ScrollAreaPrimitive.Root
    ref={ref}
    className={cn("relative overflow-hidden", className)}
    {...props}
  >
    <ScrollAreaPrimitive.Viewport className="h-full w-full rounded-[inherit]">
      {children}
    </ScrollAreaPrimitive.Viewport>
    <ScrollBar />
    <ScrollAreaPrimitive.Corner />
  </ScrollAreaPrimitive.Root>
))
ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName

const ScrollBar = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>
>(({ className, orientation = "vertical", ...props }, ref) => (
  <ScrollAreaPrimitive.ScrollAreaScrollbar
    ref={ref}
    orientation={orientation}
    className={cn(
      "flex touch-none select-none transition-colors",
      orientation === "vertical" &&
        "h-full w-2.5 border-l border-l-transparent p-[1px]",
      orientation === "horizontal" &&
        "h-2.5 flex-col border-t border-t-transparent p-[1px]",
      className
    )}
    {...props}
  >
    <ScrollAreaPrimitive.ScrollAreaThumb className="relative flex-1 rounded-full bg-border" />
  </ScrollAreaPrimitive.ScrollAreaScrollbar>
))
ScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName

export { ScrollArea, ScrollBar }


// File: src\components\ui\select.tsx

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { Check, ChevronDown, ChevronUp } from "lucide-react"

import { cn } from "@/lib/utils"

const Select = SelectPrimitive.Root

const SelectGroup = SelectPrimitive.Group

const SelectValue = SelectPrimitive.Value

const SelectTrigger = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
      className
    )}
    {...props}
  >
    {children}
    <SelectPrimitive.Icon asChild>
      <ChevronDown className="h-4 w-4 opacity-50" />
    </SelectPrimitive.Icon>
  </SelectPrimitive.Trigger>
))
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName

const SelectScrollUpButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollUpButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronUp className="h-4 w-4" />
  </SelectPrimitive.ScrollUpButton>
))
SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName

const SelectScrollDownButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollDownButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronDown className="h-4 w-4" />
  </SelectPrimitive.ScrollDownButton>
))
SelectScrollDownButton.displayName =
  SelectPrimitive.ScrollDownButton.displayName

const SelectContent = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
  <SelectPrimitive.Portal>
    <SelectPrimitive.Content
      ref={ref}
      className={cn(
        "relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        position === "popper" &&
          "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
        className
      )}
      position={position}
      {...props}
    >
      <SelectScrollUpButton />
      <SelectPrimitive.Viewport
        className={cn(
          "p-1",
          position === "popper" &&
            "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
        )}
      >
        {children}
      </SelectPrimitive.Viewport>
      <SelectScrollDownButton />
    </SelectPrimitive.Content>
  </SelectPrimitive.Portal>
))
SelectContent.displayName = SelectPrimitive.Content.displayName

const SelectLabel = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Label
    ref={ref}
    className={cn("py-1.5 pl-8 pr-2 text-sm font-semibold", className)}
    {...props}
  />
))
SelectLabel.displayName = SelectPrimitive.Label.displayName

const SelectItem = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <SelectPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </SelectPrimitive.ItemIndicator>
    </span>

    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
  </SelectPrimitive.Item>
))
SelectItem.displayName = SelectPrimitive.Item.displayName

const SelectSeparator = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
SelectSeparator.displayName = SelectPrimitive.Separator.displayName

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
  SelectScrollUpButton,
  SelectScrollDownButton,
}


// File: src\components\ui\separator.tsx

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

const Separator = React.forwardRef<
  React.ElementRef<typeof SeparatorPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
>(
  (
    { className, orientation = "horizontal", decorative = true, ...props },
    ref
  ) => (
    <SeparatorPrimitive.Root
      ref={ref}
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "shrink-0 bg-border",
        orientation === "horizontal" ? "h-[1px] w-full" : "h-full w-[1px]",
        className
      )}
      {...props}
    />
  )
)
Separator.displayName = SeparatorPrimitive.Root.displayName

export { Separator }


// File: src\components\ui\sheet.tsx

import * as SheetPrimitive from "@radix-ui/react-dialog"
import { cva, type VariantProps } from "class-variance-authority"
import { X } from "lucide-react"
import * as React from "react"

import { cn } from "@/lib/utils"

const Sheet = SheetPrimitive.Root

const SheetTrigger = SheetPrimitive.Trigger

const SheetClose = SheetPrimitive.Close

const SheetPortal = SheetPrimitive.Portal

const SheetOverlay = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
SheetOverlay.displayName = SheetPrimitive.Overlay.displayName

const sheetVariants = cva(
  "fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
  {
    variants: {
      side: {
        top: "inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",
        bottom:
          "inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",
        left: "inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",
        right:
          "inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm",
      },
    },
    defaultVariants: {
      side: "right",
    },
  }
)

interface SheetContentProps
  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,
  VariantProps<typeof sheetVariants> { }

const SheetContent = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Content>,
  SheetContentProps
>(({ side = "right", className, children, ...props }, ref) => (
  <SheetPortal>
    <SheetOverlay />
    <SheetPrimitive.Content
      ref={ref}
      className={cn(sheetVariants({ side }), className)}
      {...props}
    >
      {children}
      <SheetPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </SheetPrimitive.Close>
    </SheetPrimitive.Content>
  </SheetPortal>
))
SheetContent.displayName = SheetPrimitive.Content.displayName

const SheetHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
SheetHeader.displayName = "SheetHeader"

const SheetFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
SheetFooter.displayName = "SheetFooter"

const SheetTitle = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold text-foreground", className)}
    {...props}
  />
))
SheetTitle.displayName = SheetPrimitive.Title.displayName

const SheetDescription = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
SheetDescription.displayName = SheetPrimitive.Description.displayName

export {
  Sheet, SheetClose,
  SheetContent, SheetDescription, SheetFooter, SheetHeader, SheetOverlay, SheetPortal, SheetTitle, SheetTrigger
}



// File: src\components\ui\sidebar.tsx

import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { VariantProps, cva } from "class-variance-authority"
import { PanelLeft } from "lucide-react"

import { useIsMobile } from "@/hooks/use-mobile"
import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Separator } from "@/components/ui/separator"
import { Sheet, SheetContent } from "@/components/ui/sheet"
import { Skeleton } from "@/components/ui/skeleton"
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip"

const SIDEBAR_COOKIE_NAME = "sidebar:state"
const SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7
const SIDEBAR_WIDTH = "16rem"
const SIDEBAR_WIDTH_MOBILE = "18rem"
const SIDEBAR_WIDTH_ICON = "3rem"
const SIDEBAR_KEYBOARD_SHORTCUT = "b"

type SidebarContext = {
  state: "expanded" | "collapsed"
  open: boolean
  setOpen: (open: boolean) => void
  openMobile: boolean
  setOpenMobile: (open: boolean) => void
  isMobile: boolean
  toggleSidebar: () => void
}

const SidebarContext = React.createContext<SidebarContext | null>(null)

function useSidebar() {
  const context = React.useContext(SidebarContext)
  if (!context) {
    throw new Error("useSidebar must be used within a SidebarProvider.")
  }

  return context
}

const SidebarProvider = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    defaultOpen?: boolean
    open?: boolean
    onOpenChange?: (open: boolean) => void
  }
>(
  (
    {
      defaultOpen = true,
      open: openProp,
      onOpenChange: setOpenProp,
      className,
      style,
      children,
      ...props
    },
    ref
  ) => {
    const isMobile = useIsMobile()
    const [openMobile, setOpenMobile] = React.useState(false)

    // This is the internal state of the sidebar.
    // We use openProp and setOpenProp for control from outside the component.
    const [_open, _setOpen] = React.useState(defaultOpen)
    const open = openProp ?? _open
    const setOpen = React.useCallback(
      (value: boolean | ((value: boolean) => boolean)) => {
        const openState = typeof value === "function" ? value(open) : value
        if (setOpenProp) {
          setOpenProp(openState)
        } else {
          _setOpen(openState)
        }

        // This sets the cookie to keep the sidebar state.
        document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`
      },
      [setOpenProp, open]
    )

    // Helper to toggle the sidebar.
    const toggleSidebar = React.useCallback(() => {
      return isMobile
        ? setOpenMobile((open) => !open)
        : setOpen((open) => !open)
    }, [isMobile, setOpen, setOpenMobile])

    // Adds a keyboard shortcut to toggle the sidebar.
    React.useEffect(() => {
      const handleKeyDown = (event: KeyboardEvent) => {
        if (
          event.key === SIDEBAR_KEYBOARD_SHORTCUT &&
          (event.metaKey || event.ctrlKey)
        ) {
          event.preventDefault()
          toggleSidebar()
        }
      }

      window.addEventListener("keydown", handleKeyDown)
      return () => window.removeEventListener("keydown", handleKeyDown)
    }, [toggleSidebar])

    // We add a state so that we can do data-state="expanded" or "collapsed".
    // This makes it easier to style the sidebar with Tailwind classes.
    const state = open ? "expanded" : "collapsed"

    const contextValue = React.useMemo<SidebarContext>(
      () => ({
        state,
        open,
        setOpen,
        isMobile,
        openMobile,
        setOpenMobile,
        toggleSidebar,
      }),
      [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]
    )

    return (
      <SidebarContext.Provider value={contextValue}>
        <TooltipProvider delayDuration={0}>
          <div
            style={
              {
                "--sidebar-width": SIDEBAR_WIDTH,
                "--sidebar-width-icon": SIDEBAR_WIDTH_ICON,
                ...style,
              } as React.CSSProperties
            }
            className={cn(
              "group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar",
              className
            )}
            ref={ref}
            {...props}
          >
            {children}
          </div>
        </TooltipProvider>
      </SidebarContext.Provider>
    )
  }
)
SidebarProvider.displayName = "SidebarProvider"

const Sidebar = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    side?: "left" | "right"
    variant?: "sidebar" | "floating" | "inset"
    collapsible?: "offcanvas" | "icon" | "none"
  }
>(
  (
    {
      side = "left",
      variant = "sidebar",
      collapsible = "offcanvas",
      className,
      children,
      ...props
    },
    ref
  ) => {
    const { isMobile, state, openMobile, setOpenMobile } = useSidebar()

    if (collapsible === "none") {
      return (
        <div
          className={cn(
            "flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground",
            className
          )}
          ref={ref}
          {...props}
        >
          {children}
        </div>
      )
    }

    if (isMobile) {
      return (
        <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>
          <SheetContent
            data-sidebar="sidebar"
            data-mobile="true"
            className="w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden"
            style={
              {
                "--sidebar-width": SIDEBAR_WIDTH_MOBILE,
              } as React.CSSProperties
            }
            side={side}
          >
            <div className="flex h-full w-full flex-col">{children}</div>
          </SheetContent>
        </Sheet>
      )
    }

    return (
      <div
        ref={ref}
        className="group peer hidden md:block text-sidebar-foreground"
        data-state={state}
        data-collapsible={state === "collapsed" ? collapsible : ""}
        data-variant={variant}
        data-side={side}
      >
        {/* This is what handles the sidebar gap on desktop */}
        <div
          className={cn(
            "duration-200 relative h-svh w-[--sidebar-width] bg-transparent transition-[width] ease-linear",
            "group-data-[collapsible=offcanvas]:w-0",
            "group-data-[side=right]:rotate-180",
            variant === "floating" || variant === "inset"
              ? "group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]"
              : "group-data-[collapsible=icon]:w-[--sidebar-width-icon]"
          )}
        />
        <div
          className={cn(
            "duration-200 fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] ease-linear md:flex",
            side === "left"
              ? "left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]"
              : "right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",
            // Adjust the padding for floating and inset variants.
            variant === "floating" || variant === "inset"
              ? "p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]"
              : "group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l",
            className
          )}
          {...props}
        >
          <div
            data-sidebar="sidebar"
            className="flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow"
          >
            {children}
          </div>
        </div>
      </div>
    )
  }
)
Sidebar.displayName = "Sidebar"

const SidebarTrigger = React.forwardRef<
  React.ElementRef<typeof Button>,
  React.ComponentProps<typeof Button>
>(({ className, onClick, ...props }, ref) => {
  const { toggleSidebar } = useSidebar()

  return (
    <Button
      ref={ref}
      data-sidebar="trigger"
      variant="ghost"
      size="icon"
      className={cn("h-7 w-7", className)}
      onClick={(event) => {
        onClick?.(event)
        toggleSidebar()
      }}
      {...props}
    >
      <PanelLeft />
      <span className="sr-only">Toggle Sidebar</span>
    </Button>
  )
})
SidebarTrigger.displayName = "SidebarTrigger"

const SidebarRail = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button">
>(({ className, ...props }, ref) => {
  const { toggleSidebar } = useSidebar()

  return (
    <button
      ref={ref}
      data-sidebar="rail"
      aria-label="Toggle Sidebar"
      tabIndex={-1}
      onClick={toggleSidebar}
      title="Toggle Sidebar"
      className={cn(
        "absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex",
        "[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize",
        "[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize",
        "group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar",
        "[[data-side=left][data-collapsible=offcanvas]_&]:-right-2",
        "[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",
        className
      )}
      {...props}
    />
  )
})
SidebarRail.displayName = "SidebarRail"

const SidebarInset = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"main">
>(({ className, ...props }, ref) => {
  return (
    <main
      ref={ref}
      className={cn(
        "relative flex min-h-svh flex-1 flex-col bg-background",
        "peer-data-[variant=inset]:min-h-[calc(100svh-theme(spacing.4))] md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow",
        className
      )}
      {...props}
    />
  )
})
SidebarInset.displayName = "SidebarInset"

const SidebarInput = React.forwardRef<
  React.ElementRef<typeof Input>,
  React.ComponentProps<typeof Input>
>(({ className, ...props }, ref) => {
  return (
    <Input
      ref={ref}
      data-sidebar="input"
      className={cn(
        "h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring",
        className
      )}
      {...props}
    />
  )
})
SidebarInput.displayName = "SidebarInput"

const SidebarHeader = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="header"
      className={cn("flex flex-col gap-2 p-2", className)}
      {...props}
    />
  )
})
SidebarHeader.displayName = "SidebarHeader"

const SidebarFooter = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="footer"
      className={cn("flex flex-col gap-2 p-2", className)}
      {...props}
    />
  )
})
SidebarFooter.displayName = "SidebarFooter"

const SidebarSeparator = React.forwardRef<
  React.ElementRef<typeof Separator>,
  React.ComponentProps<typeof Separator>
>(({ className, ...props }, ref) => {
  return (
    <Separator
      ref={ref}
      data-sidebar="separator"
      className={cn("mx-2 w-auto bg-sidebar-border", className)}
      {...props}
    />
  )
})
SidebarSeparator.displayName = "SidebarSeparator"

const SidebarContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="content"
      className={cn(
        "flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",
        className
      )}
      {...props}
    />
  )
})
SidebarContent.displayName = "SidebarContent"

const SidebarGroup = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="group"
      className={cn("relative flex w-full min-w-0 flex-col p-2", className)}
      {...props}
    />
  )
})
SidebarGroup.displayName = "SidebarGroup"

const SidebarGroupLabel = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & { asChild?: boolean }
>(({ className, asChild = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "div"

  return (
    <Comp
      ref={ref}
      data-sidebar="group-label"
      className={cn(
        "duration-200 flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opa] ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        "group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",
        className
      )}
      {...props}
    />
  )
})
SidebarGroupLabel.displayName = "SidebarGroupLabel"

const SidebarGroupAction = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button"> & { asChild?: boolean }
>(({ className, asChild = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      ref={ref}
      data-sidebar="group-action"
      className={cn(
        "absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 after:md:hidden",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props}
    />
  )
})
SidebarGroupAction.displayName = "SidebarGroupAction"

const SidebarGroupContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    data-sidebar="group-content"
    className={cn("w-full text-sm", className)}
    {...props}
  />
))
SidebarGroupContent.displayName = "SidebarGroupContent"

const SidebarMenu = React.forwardRef<
  HTMLUListElement,
  React.ComponentProps<"ul">
>(({ className, ...props }, ref) => (
  <ul
    ref={ref}
    data-sidebar="menu"
    className={cn("flex w-full min-w-0 flex-col gap-1", className)}
    {...props}
  />
))
SidebarMenu.displayName = "SidebarMenu"

const SidebarMenuItem = React.forwardRef<
  HTMLLIElement,
  React.ComponentProps<"li">
>(({ className, ...props }, ref) => (
  <li
    ref={ref}
    data-sidebar="menu-item"
    className={cn("group/menu-item relative", className)}
    {...props}
  />
))
SidebarMenuItem.displayName = "SidebarMenuItem"

const sidebarMenuButtonVariants = cva(
  "peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",
        outline:
          "bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]",
      },
      size: {
        default: "h-8 text-sm",
        sm: "h-7 text-xs",
        lg: "h-12 text-sm group-data-[collapsible=icon]:!p-0",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

const SidebarMenuButton = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button"> & {
    asChild?: boolean
    isActive?: boolean
    tooltip?: string | React.ComponentProps<typeof TooltipContent>
  } & VariantProps<typeof sidebarMenuButtonVariants>
>(
  (
    {
      asChild = false,
      isActive = false,
      variant = "default",
      size = "default",
      tooltip,
      className,
      ...props
    },
    ref
  ) => {
    const Comp = asChild ? Slot : "button"
    const { isMobile, state } = useSidebar()

    const button = (
      <Comp
        ref={ref}
        data-sidebar="menu-button"
        data-size={size}
        data-active={isActive}
        className={cn(sidebarMenuButtonVariants({ variant, size }), className)}
        {...props}
      />
    )

    if (!tooltip) {
      return button
    }

    if (typeof tooltip === "string") {
      tooltip = {
        children: tooltip,
      }
    }

    return (
      <Tooltip>
        <TooltipTrigger asChild>{button}</TooltipTrigger>
        <TooltipContent
          side="right"
          align="center"
          hidden={state !== "collapsed" || isMobile}
          {...tooltip}
        />
      </Tooltip>
    )
  }
)
SidebarMenuButton.displayName = "SidebarMenuButton"

const SidebarMenuAction = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button"> & {
    asChild?: boolean
    showOnHover?: boolean
  }
>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      ref={ref}
      data-sidebar="menu-action"
      className={cn(
        "absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 after:md:hidden",
        "peer-data-[size=sm]/menu-button:top-1",
        "peer-data-[size=default]/menu-button:top-1.5",
        "peer-data-[size=lg]/menu-button:top-2.5",
        "group-data-[collapsible=icon]:hidden",
        showOnHover &&
          "group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0",
        className
      )}
      {...props}
    />
  )
})
SidebarMenuAction.displayName = "SidebarMenuAction"

const SidebarMenuBadge = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    data-sidebar="menu-badge"
    className={cn(
      "absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground select-none pointer-events-none",
      "peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground",
      "peer-data-[size=sm]/menu-button:top-1",
      "peer-data-[size=default]/menu-button:top-1.5",
      "peer-data-[size=lg]/menu-button:top-2.5",
      "group-data-[collapsible=icon]:hidden",
      className
    )}
    {...props}
  />
))
SidebarMenuBadge.displayName = "SidebarMenuBadge"

const SidebarMenuSkeleton = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    showIcon?: boolean
  }
>(({ className, showIcon = false, ...props }, ref) => {
  // Random width between 50 to 90%.
  const width = React.useMemo(() => {
    return `${Math.floor(Math.random() * 40) + 50}%`
  }, [])

  return (
    <div
      ref={ref}
      data-sidebar="menu-skeleton"
      className={cn("rounded-md h-8 flex gap-2 px-2 items-center", className)}
      {...props}
    >
      {showIcon && (
        <Skeleton
          className="size-4 rounded-md"
          data-sidebar="menu-skeleton-icon"
        />
      )}
      <Skeleton
        className="h-4 flex-1 max-w-[--skeleton-width]"
        data-sidebar="menu-skeleton-text"
        style={
          {
            "--skeleton-width": width,
          } as React.CSSProperties
        }
      />
    </div>
  )
})
SidebarMenuSkeleton.displayName = "SidebarMenuSkeleton"

const SidebarMenuSub = React.forwardRef<
  HTMLUListElement,
  React.ComponentProps<"ul">
>(({ className, ...props }, ref) => (
  <ul
    ref={ref}
    data-sidebar="menu-sub"
    className={cn(
      "mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5",
      "group-data-[collapsible=icon]:hidden",
      className
    )}
    {...props}
  />
))
SidebarMenuSub.displayName = "SidebarMenuSub"

const SidebarMenuSubItem = React.forwardRef<
  HTMLLIElement,
  React.ComponentProps<"li">
>(({ ...props }, ref) => <li ref={ref} {...props} />)
SidebarMenuSubItem.displayName = "SidebarMenuSubItem"

const SidebarMenuSubButton = React.forwardRef<
  HTMLAnchorElement,
  React.ComponentProps<"a"> & {
    asChild?: boolean
    size?: "sm" | "md"
    isActive?: boolean
  }
>(({ asChild = false, size = "md", isActive, className, ...props }, ref) => {
  const Comp = asChild ? Slot : "a"

  return (
    <Comp
      ref={ref}
      data-sidebar="menu-sub-button"
      data-size={size}
      data-active={isActive}
      className={cn(
        "flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground",
        "data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",
        size === "sm" && "text-xs",
        size === "md" && "text-sm",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props}
    />
  )
})
SidebarMenuSubButton.displayName = "SidebarMenuSubButton"

export {
  Sidebar,
  SidebarContent,
  SidebarFooter,
  SidebarGroup,
  SidebarGroupAction,
  SidebarGroupContent,
  SidebarGroupLabel,
  SidebarHeader,
  SidebarInput,
  SidebarInset,
  SidebarMenu,
  SidebarMenuAction,
  SidebarMenuBadge,
  SidebarMenuButton,
  SidebarMenuItem,
  SidebarMenuSkeleton,
  SidebarMenuSub,
  SidebarMenuSubButton,
  SidebarMenuSubItem,
  SidebarProvider,
  SidebarRail,
  SidebarSeparator,
  SidebarTrigger,
  useSidebar,
}


// File: src\components\ui\skeleton.tsx

import { cn } from "@/lib/utils"

function Skeleton({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) {
  return (
    <div
      className={cn("animate-pulse rounded-md bg-muted", className)}
      {...props}
    />
  )
}

export { Skeleton }


// File: src\components\ui\slider.tsx

import * as React from "react"
import * as SliderPrimitive from "@radix-ui/react-slider"

import { cn } from "@/lib/utils"

const Slider = React.forwardRef<
  React.ElementRef<typeof SliderPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>
>(({ className, ...props }, ref) => (
  <SliderPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex w-full touch-none select-none items-center",
      className
    )}
    {...props}
  >
    <SliderPrimitive.Track className="relative h-2 w-full grow overflow-hidden rounded-full bg-secondary">
      <SliderPrimitive.Range className="absolute h-full bg-primary" />
    </SliderPrimitive.Track>
    <SliderPrimitive.Thumb className="block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50" />
  </SliderPrimitive.Root>
))
Slider.displayName = SliderPrimitive.Root.displayName

export { Slider }


// File: src\components\ui\sonner.tsx

import { useTheme } from "next-themes"
import { Toaster as Sonner } from "sonner"

type ToasterProps = React.ComponentProps<typeof Sonner>

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = "system" } = useTheme()

  return (
    <Sonner
      theme={theme as ToasterProps["theme"]}
      className="toaster group"
      toastOptions={{
        classNames: {
          toast:
            "group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",
          description: "group-[.toast]:text-muted-foreground",
          actionButton:
            "group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",
          cancelButton:
            "group-[.toast]:bg-muted group-[.toast]:text-muted-foreground",
        },
      }}
      {...props}
    />
  )
}

export { Toaster }


// File: src\components\ui\switch.tsx

import * as React from "react"
import * as SwitchPrimitives from "@radix-ui/react-switch"

import { cn } from "@/lib/utils"

const Switch = React.forwardRef<
  React.ElementRef<typeof SwitchPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>
>(({ className, ...props }, ref) => (
  <SwitchPrimitives.Root
    className={cn(
      "peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",
      className
    )}
    {...props}
    ref={ref}
  >
    <SwitchPrimitives.Thumb
      className={cn(
        "pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0"
      )}
    />
  </SwitchPrimitives.Root>
))
Switch.displayName = SwitchPrimitives.Root.displayName

export { Switch }


// File: src\components\ui\table.tsx

import * as React from "react"

import { cn } from "@/lib/utils"

const Table = React.forwardRef<
  HTMLTableElement,
  React.HTMLAttributes<HTMLTableElement>
>(({ className, ...props }, ref) => (
  <div className="relative w-full overflow-auto">
    <table
      ref={ref}
      className={cn("w-full caption-bottom text-sm", className)}
      {...props}
    />
  </div>
))
Table.displayName = "Table"

const TableHeader = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <thead ref={ref} className={cn("[&_tr]:border-b", className)} {...props} />
))
TableHeader.displayName = "TableHeader"

const TableBody = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tbody
    ref={ref}
    className={cn("[&_tr:last-child]:border-0", className)}
    {...props}
  />
))
TableBody.displayName = "TableBody"

const TableFooter = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tfoot
    ref={ref}
    className={cn(
      "border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",
      className
    )}
    {...props}
  />
))
TableFooter.displayName = "TableFooter"

const TableRow = React.forwardRef<
  HTMLTableRowElement,
  React.HTMLAttributes<HTMLTableRowElement>
>(({ className, ...props }, ref) => (
  <tr
    ref={ref}
    className={cn(
      "border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",
      className
    )}
    {...props}
  />
))
TableRow.displayName = "TableRow"

const TableHead = React.forwardRef<
  HTMLTableCellElement,
  React.ThHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <th
    ref={ref}
    className={cn(
      "h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",
      className
    )}
    {...props}
  />
))
TableHead.displayName = "TableHead"

const TableCell = React.forwardRef<
  HTMLTableCellElement,
  React.TdHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <td
    ref={ref}
    className={cn("p-4 align-middle [&:has([role=checkbox])]:pr-0", className)}
    {...props}
  />
))
TableCell.displayName = "TableCell"

const TableCaption = React.forwardRef<
  HTMLTableCaptionElement,
  React.HTMLAttributes<HTMLTableCaptionElement>
>(({ className, ...props }, ref) => (
  <caption
    ref={ref}
    className={cn("mt-4 text-sm text-muted-foreground", className)}
    {...props}
  />
))
TableCaption.displayName = "TableCaption"

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}


// File: src\components\ui\tabs.tsx

import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

const Tabs = TabsPrimitive.Root

const TabsList = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",
      className
    )}
    {...props}
  />
))
TabsList.displayName = TabsPrimitive.List.displayName

const TabsTrigger = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",
      className
    )}
    {...props}
  />
))
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName

const TabsContent = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn(
      "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
      className
    )}
    {...props}
  />
))
TabsContent.displayName = TabsPrimitive.Content.displayName

export { Tabs, TabsList, TabsTrigger, TabsContent }


// File: src\components\ui\tag-input.tsx

import React, { useState, KeyboardEvent } from 'react';
import { X } from 'lucide-react';
import { cn } from '@/lib/utils';
import { Button } from './button';

interface TagInputProps {
  tags: string[];
  onChange: (tags: string[]) => void;
  placeholder?: string;
  className?: string;
}

export const TagInput = ({ tags, onChange, placeholder = 'Add tag...', className }: TagInputProps) => {
  const [input, setInput] = useState('');

  const handleKeyDown = (e: KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter' || e.key === ',') {
      e.preventDefault();
      if (input.trim()) {
        const newTag = input.trim();
        if (!tags.includes(newTag)) {
          onChange([...tags, newTag]);
        }
        setInput('');
      }
    } else if (e.key === 'Backspace' && !input && tags.length > 0) {
      onChange(tags.slice(0, -1));
    }
  };

  const removeTag = (tagToRemove: string) => {
    onChange(tags.filter(tag => tag !== tagToRemove));
  };

  return (
    <div className={cn("flex flex-wrap gap-2 p-2 border rounded-md bg-background", className)}>
      {tags.map((tag, index) => (
        <span
          key={`${tag}-${index}`}
          className="flex items-center gap-1 px-2 py-1 text-sm bg-muted rounded-md"
        >
          {tag}
          <Button
            type="button"
            variant="ghost"
            size="sm"
            className="h-4 w-4 p-0 hover:bg-transparent"
            onClick={() => removeTag(tag)}
          >
            <X className="h-3 w-3" />
          </Button>
        </span>
      ))}
      <input
        type="text"
        value={input}
        onChange={(e) => setInput(e.target.value)}
        onKeyDown={handleKeyDown}
        placeholder={tags.length === 0 ? placeholder : ''}
        className="flex-1 min-w-[120px] bg-transparent outline-none placeholder:text-muted-foreground"
      />
    </div>
  );
};

// File: src\components\ui\textarea.tsx

import * as React from "react"

import { cn } from "@/lib/utils"

export interface TextareaProps
  extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {}

const Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(
  ({ className, ...props }, ref) => {
    return (
      <textarea
        className={cn(
          "flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Textarea.displayName = "Textarea"

export { Textarea }


// File: src\components\ui\toast.tsx

import * as React from "react"
import * as ToastPrimitives from "@radix-ui/react-toast"
import { cva, type VariantProps } from "class-variance-authority"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const ToastProvider = ToastPrimitives.Provider

const ToastViewport = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Viewport>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Viewport
    ref={ref}
    className={cn(
      "fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]",
      className
    )}
    {...props}
  />
))
ToastViewport.displayName = ToastPrimitives.Viewport.displayName

const toastVariants = cva(
  "group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full",
  {
    variants: {
      variant: {
        default: "border bg-background text-foreground",
        destructive:
          "destructive group border-destructive bg-destructive text-destructive-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Toast = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &
    VariantProps<typeof toastVariants>
>(({ className, variant, ...props }, ref) => {
  return (
    <ToastPrimitives.Root
      ref={ref}
      className={cn(toastVariants({ variant }), className)}
      {...props}
    />
  )
})
Toast.displayName = ToastPrimitives.Root.displayName

const ToastAction = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Action>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Action
    ref={ref}
    className={cn(
      "inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive",
      className
    )}
    {...props}
  />
))
ToastAction.displayName = ToastPrimitives.Action.displayName

const ToastClose = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Close>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Close
    ref={ref}
    className={cn(
      "absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600",
      className
    )}
    toast-close=""
    {...props}
  >
    <X className="h-4 w-4" />
  </ToastPrimitives.Close>
))
ToastClose.displayName = ToastPrimitives.Close.displayName

const ToastTitle = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Title>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Title
    ref={ref}
    className={cn("text-sm font-semibold", className)}
    {...props}
  />
))
ToastTitle.displayName = ToastPrimitives.Title.displayName

const ToastDescription = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Description>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Description
    ref={ref}
    className={cn("text-sm opacity-90", className)}
    {...props}
  />
))
ToastDescription.displayName = ToastPrimitives.Description.displayName

type ToastProps = React.ComponentPropsWithoutRef<typeof Toast>

type ToastActionElement = React.ReactElement<typeof ToastAction>

export {
  type ToastProps,
  type ToastActionElement,
  ToastProvider,
  ToastViewport,
  Toast,
  ToastTitle,
  ToastDescription,
  ToastClose,
  ToastAction,
}


// File: src\components\ui\toaster.tsx

"use client"

import { useToast } from "@/hooks/use-toast"
import {
  Toast,
  ToastClose,
  ToastDescription,
  ToastProvider,
  ToastTitle,
  ToastViewport,
} from "@/components/ui/toast"

export function Toaster() {
  const { toasts } = useToast()

  return (
    <ToastProvider>
      {toasts.map(function ({ id, title, description, action, ...props }) {
        return (
          <Toast key={id} {...props}>
            <div className="grid gap-1">
              {title && <ToastTitle>{title}</ToastTitle>}
              {description && (
                <ToastDescription>{description}</ToastDescription>
              )}
            </div>
            {action && (
              <div className="mt-2">
                <button
                  onClick={action.onClick}
                  className="px-3 py-1 text-sm bg-primary text-white rounded-md hover:bg-primary/90"
                >
                  {action.label}
                </button>
              </div>
            )}
            <ToastClose />
          </Toast>
        )
      })}
      <ToastViewport />
    </ToastProvider>
  )
}

// File: src\components\ui\toggle-group.tsx

import * as React from "react"
import * as ToggleGroupPrimitive from "@radix-ui/react-toggle-group"
import { type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"
import { toggleVariants } from "@/components/ui/toggle"

const ToggleGroupContext = React.createContext<
  VariantProps<typeof toggleVariants>
>({
  size: "default",
  variant: "default",
})

const ToggleGroup = React.forwardRef<
  React.ElementRef<typeof ToggleGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &
    VariantProps<typeof toggleVariants>
>(({ className, variant, size, children, ...props }, ref) => (
  <ToggleGroupPrimitive.Root
    ref={ref}
    className={cn("flex items-center justify-center gap-1", className)}
    {...props}
  >
    <ToggleGroupContext.Provider value={{ variant, size }}>
      {children}
    </ToggleGroupContext.Provider>
  </ToggleGroupPrimitive.Root>
))

ToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName

const ToggleGroupItem = React.forwardRef<
  React.ElementRef<typeof ToggleGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &
    VariantProps<typeof toggleVariants>
>(({ className, children, variant, size, ...props }, ref) => {
  const context = React.useContext(ToggleGroupContext)

  return (
    <ToggleGroupPrimitive.Item
      ref={ref}
      className={cn(
        toggleVariants({
          variant: context.variant || variant,
          size: context.size || size,
        }),
        className
      )}
      {...props}
    >
      {children}
    </ToggleGroupPrimitive.Item>
  )
})

ToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName

export { ToggleGroup, ToggleGroupItem }


// File: src\components\ui\toggle.tsx

import * as React from "react"
import * as TogglePrimitive from "@radix-ui/react-toggle"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const toggleVariants = cva(
  "inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        outline:
          "border border-input bg-transparent hover:bg-accent hover:text-accent-foreground",
      },
      size: {
        default: "h-10 px-3",
        sm: "h-9 px-2.5",
        lg: "h-11 px-5",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

const Toggle = React.forwardRef<
  React.ElementRef<typeof TogglePrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &
    VariantProps<typeof toggleVariants>
>(({ className, variant, size, ...props }, ref) => (
  <TogglePrimitive.Root
    ref={ref}
    className={cn(toggleVariants({ variant, size, className }))}
    {...props}
  />
))

Toggle.displayName = TogglePrimitive.Root.displayName

export { Toggle, toggleVariants }


// File: src\components\ui\tooltip.tsx

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"

import { cn } from "@/lib/utils"

const TooltipProvider = TooltipPrimitive.Provider

const Tooltip = TooltipPrimitive.Root

const TooltipTrigger = TooltipPrimitive.Trigger

const TooltipContent = React.forwardRef<
  React.ElementRef<typeof TooltipPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <TooltipPrimitive.Content
    ref={ref}
    sideOffset={sideOffset}
    className={cn(
      "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
TooltipContent.displayName = TooltipPrimitive.Content.displayName

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }


// File: src\components\ui\use-toast.ts

export { useToast, toast } from "@/hooks/use-toast"

// File: src\components\version\VersionHistory.tsx

import React, { useEffect, useState } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/hooks/use-toast';
import { ThesisVersion } from '@/types/thesis';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { History, RotateCcw } from 'lucide-react';
import { format } from 'date-fns';

interface VersionHistoryProps {
  thesisId: string;
  onRestoreVersion: (version: ThesisVersion) => void;
}

export const VersionHistory = ({ thesisId, onRestoreVersion }: VersionHistoryProps) => {
  const [versions, setVersions] = useState<ThesisVersion[]>([]);
  const { toast } = useToast();

  useEffect(() => {
    const fetchVersions = async () => {
      const { data, error } = await supabase
        .from('thesis_versions')
        .select(`
          *,
          profiles (
            email
          )
        `)
        .eq('thesis_id', thesisId)
        .order('version_number', { ascending: false });

      if (error) {
        console.error('Error fetching versions:', error);
        toast({
          title: 'Error',
          description: 'Failed to fetch version history',
          variant: 'destructive',
        });
        return;
      }

      setVersions(data);
    };

    fetchVersions();

    // Set up real-time subscription
    const channel = supabase
      .channel('thesis_versions')
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'thesis_versions',
          filter: `thesis_id=eq.${thesisId}`,
        },
        (payload) => {
          console.log('Real-time update:', payload);
          fetchVersions();
        }
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, [thesisId, toast]);

  const handleRestore = (version: ThesisVersion) => {
    onRestoreVersion(version);
    toast({
      title: 'Version Restored',
      description: `Restored to version ${version.version_number}`,
    });
  };

  return (
    <Card className="w-full max-w-md">
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <History className="w-5 h-5" />
          Version History
        </CardTitle>
      </CardHeader>
      <CardContent>
        <ScrollArea className="h-[400px] pr-4">
          <div className="space-y-4">
            {versions.map((version) => (
              <Card key={version.id} className="p-4">
                <div className="flex justify-between items-start">
                  <div>
                    <h4 className="font-medium">Version {version.version_number}</h4>
                    <p className="text-sm text-muted-foreground">
                      {format(new Date(version.created_at), 'PPpp')}
                    </p>
                    <p className="text-sm text-muted-foreground">
                      By {(version as any).profiles?.email}
                    </p>
                    {version.description && (
                      <p className="mt-2 text-sm">{version.description}</p>
                    )}
                  </div>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => handleRestore(version)}
                    className="ml-4"
                  >
                    <RotateCcw className="w-4 h-4 mr-2" />
                    Restore
                  </Button>
                </div>
              </Card>
            ))}
          </div>
        </ScrollArea>
      </CardContent>
    </Card>
  );
};

// File: src\contexts\auth\userRole.ts

export type UserRole = 'admin' | 'user' | 'guest';

export const getUserRole = (email: string | undefined): UserRole => {
  if (!email) return 'guest';
  // You can implement your role logic here
  return email.includes('admin') ? 'admin' : 'user';
};

// File: src\contexts\auth\useSession.ts

import { useEffect, useState } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { Session } from '@supabase/supabase-js';

export const useSession = () => {
  const [session, setSession] = useState<Session | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    console.log('ðŸ” Checking session...');
    
    // Get initial session
    supabase.auth.getSession().then(({ data: { session } }) => {
      setSession(session);
      setLoading(false);
    });

    // Listen for changes
    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange((_event, session) => {
      console.log('ðŸ”„ Auth state changed:', _event);
      setSession(session);
      setLoading(false);
    });

    return () => subscription.unsubscribe();
  }, []);

  return {
    session,
    loading,
    isAuthenticated: !!session,
    user: session?.user ?? null,
  };
};

// File: src\contexts\AuthContext.tsx

import React, { createContext, useContext, useState, useEffect } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { Session, User } from '@supabase/supabase-js';

interface AuthContextType {
  isAuthenticated: boolean;
  loading: boolean;
  session: Session | null;
  user: User | null;
  handleLogout: () => Promise<void>;
  userId: string | null;
}

const AuthContext = createContext<AuthContextType>({
  isAuthenticated: false,
  loading: true,
  session: null,
  user: null,
  handleLogout: async () => {},
  userId: null,
});

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};

export const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [session, setSession] = useState<Session | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Initial session check
    const initializeAuth = async () => {
      try {
        const { data: { session: currentSession } } = await supabase.auth.getSession();
        
        if (currentSession) {
          // Check if session is expired or about to expire (within 5 minutes)
          const expiresAt = new Date(currentSession.expires_at! * 1000);
          const now = new Date();
          const fiveMinutes = 5 * 60 * 1000;
          
          if (expiresAt.getTime() - now.getTime() < fiveMinutes) {
            // Attempt to refresh the session
            const { data: { session: refreshedSession }, error } = await supabase.auth.refreshSession();
            if (error) {
              await handleLogout();
              return;
            }
            setSession(refreshedSession);
          } else {
            setSession(currentSession);
          }
        }
        setLoading(false);
      } catch {
        setSession(null);
        setLoading(false);
      }
    };

    initializeAuth();

    // Listen for auth changes
    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange(async (event, currentSession) => {
      if (event === 'TOKEN_REFRESHED') {
        setSession(currentSession);
      } else if (event === 'SIGNED_OUT') {
        setSession(null);
      } else {
        setSession(currentSession);
      }
      setLoading(false);
    });

    // Set up periodic session check (every 4 minutes)
    const sessionCheckInterval = setInterval(async () => {
      const { data: { session: currentSession } } = await supabase.auth.getSession();
      if (currentSession) {
        const expiresAt = new Date(currentSession.expires_at! * 1000);
        const now = new Date();
        const fiveMinutes = 5 * 60 * 1000;
        
        if (expiresAt.getTime() - now.getTime() < fiveMinutes) {
          await supabase.auth.refreshSession();
        }
      }
    }, 4 * 60 * 1000);

    return () => {
      subscription.unsubscribe();
      clearInterval(sessionCheckInterval);
    };
  }, []);

  const handleLogout = async () => {
    try {
      await supabase.auth.signOut();
      setSession(null);
    } catch {
      // Silent fail - user is logged out anyway
      setSession(null);
    }
  };

  const value = {
    isAuthenticated: !!session,
    loading,
    session,
    user: session?.user ?? null,
    handleLogout,
    userId: session?.user?.id ?? null,
  };

  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
};

// File: src\contexts\LanguageContext.tsx

import React, { createContext, useContext, useState } from 'react';

type Language = 'en' | 'fr' | 'ar';

interface LanguageContextType {
  language: Language;
  setLanguage: (lang: Language) => void;
  dir: 'ltr' | 'rtl';
}

const LanguageContext = createContext<LanguageContextType | undefined>(undefined);

export function LanguageProvider({ children }: { children: React.ReactNode }) {
  console.log('ðŸŒ Language Provider rendering');
  const [language, setLanguage] = useState<Language>('en');

  const value = {
    language,
    setLanguage,
    dir: language === 'ar' ? 'rtl' as const : 'ltr' as const
  };

  return (
    <LanguageContext.Provider value={value}>
      <div dir={value.dir} lang={language}>
        {children}
      </div>
    </LanguageContext.Provider>
  );
}

export function useLanguage() {
  const context = useContext(LanguageContext);
  if (!context) {
    console.error('âŒ useLanguage must be used within a LanguageProvider');
    throw new Error('useLanguage must be used within a LanguageProvider');
  }
  return context;
}

// File: src\hooks\use-mobile.tsx

import * as React from "react"

const MOBILE_BREAKPOINT = 768

export function useIsMobile() {
  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)

  React.useEffect(() => {
    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)
    const onChange = () => {
      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    }
    mql.addEventListener("change", onChange)
    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    return () => mql.removeEventListener("change", onChange)
  }, [])

  return !!isMobile
}


// File: src\hooks\use-toast.ts

import * as React from "react"

const TOAST_LIMIT = 1
const TOAST_REMOVE_DELAY = 1000000

type ToasterToast = {
  id: string
  title?: string
  description?: string
  action?: {
    label: string
    onClick: () => void
  }
  variant?: "default" | "destructive"
}

const actionTypes = {
  ADD_TOAST: "ADD_TOAST",
  UPDATE_TOAST: "UPDATE_TOAST",
  DISMISS_TOAST: "DISMISS_TOAST",
  REMOVE_TOAST: "REMOVE_TOAST",
} as const

let count = 0

function genId() {
  count = (count + 1) % Number.MAX_VALUE
  return count.toString()
}

type ActionType = typeof actionTypes

type Action =
  | {
      type: ActionType["ADD_TOAST"]
      toast: ToasterToast
    }
  | {
      type: ActionType["UPDATE_TOAST"]
      toast: Partial<ToasterToast>
    }
  | {
      type: ActionType["DISMISS_TOAST"]
      toastId?: ToasterToast["id"]
    }
  | {
      type: ActionType["REMOVE_TOAST"]
      toastId?: ToasterToast["id"]
    }

interface State {
  toasts: ToasterToast[]
}

const toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()

const addToRemoveQueue = (toastId: string) => {
  if (toastTimeouts.has(toastId)) {
    return
  }

  const timeout = setTimeout(() => {
    toastTimeouts.delete(toastId)
    dispatch({
      type: "REMOVE_TOAST",
      toastId: toastId,
    })
  }, TOAST_REMOVE_DELAY)

  toastTimeouts.set(toastId, timeout)
}

export const reducer = (state: State, action: Action): State => {
  switch (action.type) {
    case "ADD_TOAST":
      return {
        ...state,
        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),
      }

    case "UPDATE_TOAST":
      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === action.toast.id ? { ...t, ...action.toast } : t
        ),
      }

    case "DISMISS_TOAST": {
      const { toastId } = action

      if (toastId) {
        addToRemoveQueue(toastId)
      } else {
        state.toasts.forEach((toast) => {
          addToRemoveQueue(toast.id)
        })
      }

      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === toastId || toastId === undefined
            ? {
                ...t,
              }
            : t
        ),
      }
    }

    case "REMOVE_TOAST":
      if (action.toastId === undefined) {
        return {
          ...state,
          toasts: [],
        }
      }
      return {
        ...state,
        toasts: state.toasts.filter((t) => t.id !== action.toastId),
      }
  }
}

const listeners: Array<(state: State) => void> = []

let memoryState: State = { toasts: [] }

function dispatch(action: Action) {
  memoryState = reducer(memoryState, action)
  listeners.forEach((listener) => {
    listener(memoryState)
  })
}

type Toast = Omit<ToasterToast, "id">

function toast({ ...props }: Toast) {
  const id = genId()

  const update = (props: ToasterToast) =>
    dispatch({
      type: "UPDATE_TOAST",
      toast: { ...props, id },
    })
  const dismiss = () => dispatch({ type: "DISMISS_TOAST", toastId: id })

  dispatch({
    type: "ADD_TOAST",
    toast: {
      ...props,
      id,
      title: props.title,
      description: props.description,
      action: props.action,
    },
  })

  return {
    id: id,
    dismiss,
    update,
  }
}

function useToast() {
  const [state, setState] = React.useState<State>(() => memoryState)

  React.useEffect(() => {
    listeners.push(setState)
    return () => {
      const index = listeners.indexOf(setState)
      if (index > -1) {
        listeners.splice(index, 1)
      }
    }
  }, [state])

  return {
    ...state,
    toast,
    dismiss: (toastId?: string) => dispatch({ type: "DISMISS_TOAST", toastId }),
  }
}

export { useToast, toast }

// File: src\hooks\useCitationManager.ts

import { useState } from 'react';
import { Citation } from '@/types/thesis';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/hooks/use-toast';

export const useCitationManager = (thesisId: string) => {
  const [citations, setCitations] = useState<Citation[]>([]);
  const [loading, setLoading] = useState(false);
  const [selectedCitation, setSelectedCitation] = useState<Citation | null>(null);
  const [searchDialogOpen, setSearchDialogOpen] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [filterType, setFilterType] = useState<'all' | Citation['type']>('all');
  const [sortField, setSortField] = useState<'year' | 'author' | 'title'>('year');
  const [sortDirection, setSortDirection] = useState<'asc' | 'desc'>('desc');
  const { toast } = useToast();

  const addCitation = async (citation: Omit<Citation, 'thesis_id'>) => {
    try {
      setLoading(true);
      const now = new Date().toISOString();
      const newCitation: Citation = {
        ...citation,
        thesis_id: thesisId,
        type: citation.type || 'article',
        created_at: now,
        updated_at: now
      };

      const { data, error } = await supabase
        .from('citations')
        .insert([newCitation])
        .select()
        .single();

      if (error) throw error;

      setCitations(prev => [...prev, data as Citation]);
      toast({
        title: "Success",
        description: "Citation added successfully",
      });
    } catch (error) {
      console.error('Error adding citation:', error);
      toast({
        title: "Error",
        description: "Failed to add citation",
        variant: "destructive",
      });
    } finally {
      setLoading(false);
    }
  };

  const fetchCitations = async () => {
    try {
      setLoading(true);
      const { data, error } = await supabase
        .from('citations')
        .select('*')
        .eq('thesis_id', thesisId)
        .order('created_at', { ascending: false });

      if (error) throw error;

      setCitations(data as Citation[]);
    } catch (error) {
      console.error('Error fetching citations:', error);
      toast({
        title: "Error",
        description: "Failed to fetch citations",
        variant: "destructive",
      });
    } finally {
      setLoading(false);
    }
  };

  const deleteCitation = async (id: string) => {
    try {
      setLoading(true);
      const { error } = await supabase
        .from('citations')
        .delete()
        .eq('id', id);

      if (error) throw error;

      setCitations(prev => prev.filter(citation => citation.id !== id));
      toast({
        title: "Success",
        description: "Citation deleted successfully",
      });
    } catch (error) {
      console.error('Error deleting citation:', error);
      toast({
        title: "Error",
        description: "Failed to delete citation",
        variant: "destructive",
      });
    } finally {
      setLoading(false);
    }
  };

  const handleAddCitation = () => {
    setSearchDialogOpen(true);
  };

  const handleSearchResult = (citation: Omit<Citation, 'thesis_id'>) => {
    addCitation(citation);
    setSearchDialogOpen(false);
  };

  const getFilteredAndSortedCitations = (citationsToFilter: Citation[]) => {
    let filtered = [...citationsToFilter];
    
    if (searchTerm) {
      filtered = filtered.filter(citation => 
        citation.text.toLowerCase().includes(searchTerm.toLowerCase()) ||
        citation.authors.some(author => 
          author.toLowerCase().includes(searchTerm.toLowerCase())
        )
      );
    }

    if (filterType !== 'all') {
      filtered = filtered.filter(citation => citation.type === filterType);
    }

    filtered.sort((a, b) => {
      let comparison = 0;
      switch (sortField) {
        case 'year':
          comparison = a.year.localeCompare(b.year);
          break;
        case 'author':
          comparison = (a.authors[0] || '').localeCompare(b.authors[0] || '');
          break;
        case 'title':
          comparison = a.text.localeCompare(b.text);
          break;
      }
      return sortDirection === 'asc' ? comparison : -comparison;
    });

    return filtered;
  };

  return {
    citations,
    loading,
    selectedCitation,
    setSelectedCitation,
    searchDialogOpen,
    setSearchDialogOpen,
    searchTerm,
    setSearchTerm,
    filterType,
    setFilterType,
    sortField,
    setSortField,
    sortDirection,
    setSortDirection,
    addCitation,
    fetchCitations,
    deleteCitation,
    handleAddCitation,
    handleSearchResult,
    getFilteredAndSortedCitations
  };
};


// File: src\hooks\useCollaboratorPermissions.tsx

import { useState, useEffect } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { Profile } from '@/types/profile';
import { CollaboratorWithProfile } from '@/types/collaborator';
import { useToast } from '@/hooks/use-toast';
import { useNavigate } from 'react-router-dom';

export const useCollaboratorPermissions = (thesisId: string) => {
  const [collaborators, setCollaborators] = useState<CollaboratorWithProfile[]>([]);
  const [canManageCollaborators, setCanManageCollaborators] = useState(false);
  const [currentUserRole, setCurrentUserRole] = useState<string | null>(null);
  const [userProfile, setUserProfile] = useState<Profile | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);
  const { toast } = useToast();
  const navigate = useNavigate();

  const checkPermissions = async () => {
    try {
      setLoading(true);
      console.log('Checking permissions for thesis:', thesisId);
      
      const { data: { session } } = await supabase.auth.getSession();
      
      if (!session) {
        console.log('No session found, redirecting to auth...');
        navigate('/auth');
        return;
      }

      console.log('Current user ID:', session.user.id);

      // First get user profile
      const { data: profileData, error: profileError } = await supabase
        .from('profiles')
        .select(`
          *,
          roles (
            name
          )
        `)
        .eq('id', session.user.id)
        .maybeSingle();

      if (profileError) {
        console.error('Error fetching profile:', profileError);
        setError(profileError);
        return;
      }

      if (profileData) {
        setUserProfile(profileData as Profile);
        console.log('User profile:', profileData);
      }

      // Then check collaborator role
      const { data: collaboratorData, error: collaboratorError } = await supabase
        .from('thesis_collaborators')
        .select('role')
        .eq('thesis_id', thesisId)
        .eq('user_id', session.user.id)
        .maybeSingle();

      if (collaboratorError && collaboratorError.code !== 'PGRST116') {
        console.error('Error checking permissions:', collaboratorError);
        setError(collaboratorError);
        return;
      }

      const role = collaboratorData?.role;
      console.log('Current user role:', role);
      
      setCurrentUserRole(role);
      setCanManageCollaborators(
        role === 'owner' ||
        role === 'admin' ||
        profileData?.roles?.name === 'admin'
      );
    } catch (error: any) {
      console.error('Error in checkPermissions:', error);
      setError(error);
      toast({
        title: "Error checking permissions",
        description: error.message,
        variant: "destructive",
      });
    } finally {
      setLoading(false);
    }
  };

  const fetchCollaborators = async () => {
    try {
      console.log('Fetching collaborators for thesis:', thesisId);
      
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        console.log('No session for fetchCollaborators, redirecting...');
        navigate('/auth');
        return;
      }

      const { data, error } = await supabase
        .from('thesis_collaborators')
        .select(`
          id,
          user_id,
          role,
          created_at,
          profiles (
            id,
            email,
            role_id,
            roles (
              name
            )
          )
        `)
        .eq('thesis_id', thesisId);

      if (error) {
        console.error('Error fetching collaborators:', error);
        setError(error);
        toast({
          title: "Error fetching collaborators",
          description: error.message,
          variant: "destructive",
        });
        return;
      }

      if (data) {
        console.log('Fetched collaborators:', data);
        setCollaborators(data as CollaboratorWithProfile[]);
      }
    } catch (error: any) {
      console.error('Error in fetchCollaborators:', error);
      setError(error);
      toast({
        title: "Error fetching collaborators",
        description: error.message,
        variant: "destructive",
      });
    }
  };

  useEffect(() => {
    if (thesisId) {
      checkPermissions();
      fetchCollaborators();
    }
  }, [thesisId]);

  return {
    collaborators,
    canManageCollaborators,
    currentUserRole,
    userProfile,
    loading,
    error,
    fetchCollaborators
  };
};

// File: src\hooks\useDashboardData.tsx

import { useUserProfile } from './useUserProfile';
import { useThesisStats } from './useThesisStats';

export const useDashboardData = (userId: string | null) => {
  const { 
    data: userProfile, 
    isLoading: isProfileLoading, 
    error: profileError 
  } = useUserProfile(userId);

  const { 
    data: thesesStats, 
    isLoading: isStatsLoading, 
    error: statsError 
  } = useThesisStats(userId);

  return {
    userProfile,
    thesesStats,
    isLoading: isProfileLoading || isStatsLoading,
    error: profileError || statsError,
  };
};

// File: src\hooks\useForm.ts

import { useState, useCallback } from 'react';

interface FormState<T> {
  values: T;
  errors: Partial<Record<keyof T, string>>;
  isSubmitting: boolean;
}

interface UseFormOptions<T> {
  initialValues: T;
  validate?: (values: T) => Partial<Record<keyof T, string>>;
  onSubmit: (values: T) => Promise<void> | void
}

export const useForm = <T extends Record<string, any>>({
  initialValues,
  validate,
  onSubmit,
}: UseFormOptions<T>) => {
  const [formState, setFormState] = useState<FormState<T>>({
    values: initialValues,
    errors: {},
    isSubmitting: false,
  });

   const handleChange = useCallback((e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
        setFormState(prev => ({
         ...prev,
        values: {
            ...prev.values,
            [name]: value
          },
          errors: {
            ...prev.errors,
              [name]: undefined
            }
        }));
      }, []);


    const setFieldValue = useCallback((field: keyof T, value: any) => {
     setFormState(prev => ({
        ...prev,
          values: {
            ...prev.values,
            [field]: value
          },
        errors: {
            ...prev.errors,
              [field]: undefined
            }
     }))
    }, []);

    const handleArrayChange = useCallback((field: keyof T, index: number, value: any) => {
      setFormState(prev => {
           const values = Array.isArray(prev.values[field]) ? [...(prev.values[field] as any[])] : []
          values[index] = value;
           return {
                ...prev,
                values: {
                    ...prev.values,
                    [field]: values
                 },
                 errors: {
                    ...prev.errors,
                      [field]: undefined
                   }
               }
       })
    }, []);


  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (validate) {
         const errors = validate(formState.values);
        setFormState(prev => ({
           ...prev,
            errors: errors
         }))
        if (Object.keys(errors).length > 0) return;
    }

    setFormState(prev => ({
        ...prev,
         isSubmitting: true,
        }))

    try {
      await onSubmit(formState.values);
    } finally {
        setFormState(prev => ({
         ...prev,
         isSubmitting: false,
        }))
    }
  };

  return {
    ...formState,
     setFieldValue,
    handleArrayChange,
    handleChange,
    handleSubmit,
  };
};

// File: src\hooks\useNotifications.ts

import { useState, useEffect, useRef, useCallback } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/hooks/use-toast';
import { Notification } from '../components/collaboration/types';

export const useNotifications = (thesisId: string) => {
  const [notifications, setNotifications] = useState<Notification[]>([]);
  const [loading, setLoading] = useState(true);
  const { toast } = useToast();
  const processedNotificationsRef = useRef<Set<string>>(new Set());
  const subscriptionRef = useRef<any>(null);
  const lastToastTime = useRef<number>(0);
  const TOAST_COOLDOWN = 5000; // 5 seconds between toasts

  const fetchNotifications = useCallback(async () => {
    try {
      console.log('ðŸ”„ Fetching notifications for thesis:', thesisId);
      const { data: userData } = await supabase.auth.getUser();
      if (!userData.user) {
        console.error('âŒ No authenticated user found');
        return;
      }

      const { data, error } = await supabase
        .from('notifications')
        .select('*')
        .eq('thesis_id', thesisId)
        .eq('user_id', userData.user.id)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('âŒ Error fetching notifications:', error);
        throw error;
      }

      console.log('âœ… Fetched notifications:', data?.length);
      setNotifications(data || []);
      data?.forEach(notification => {
        processedNotificationsRef.current.add(notification.id);
      });
    } catch (error) {
      console.error('âŒ Error in fetchNotifications:', error);
      toast({
        title: "Error",
        description: "Failed to load notifications",
        variant: "destructive",
      });
    } finally {
      setLoading(false);
    }
  }, [thesisId, toast]);

  const handleNewNotification = useCallback((payload: any) => {
    console.log('ðŸ“¨ New notification received:', payload);
    const notification = payload.new;
    
    if (processedNotificationsRef.current.has(notification.id)) {
      console.log('ðŸ”„ Notification already processed, skipping:', notification.id);
      return;
    }

    console.log('âœ¨ Processing new notification:', notification.id);
    processedNotificationsRef.current.add(notification.id);
    
    setNotifications(prev => {
      const exists = prev.some(n => n.id === notification.id);
      if (exists) {
        console.log('ðŸ”„ Notification already in state, skipping:', notification.id);
        return prev;
      }
      console.log('âž• Adding new notification to state:', notification.id);
      return [notification, ...prev];
    });

    // Only show toast if enough time has passed since the last one
    const now = Date.now();
    if (now - lastToastTime.current >= TOAST_COOLDOWN) {
      lastToastTime.current = now;
      toast({
        title: "New Notification",
        description: notification.message,
      });
    }
  }, [toast]);

  const markAsRead = useCallback(async (notificationId: string) => {
    try {
      console.log('ðŸ“ Marking notification as read:', notificationId);
      const { error } = await supabase
        .from('notifications')
        .update({ read: true })
        .eq('id', notificationId);

      if (error) {
        console.error('âŒ Error marking notification as read:', error);
        throw error;
      }

      setNotifications(prev =>
        prev.map(n =>
          n.id === notificationId ? { ...n, read: true } : n
        )
      );
      console.log('âœ… Notification marked as read:', notificationId);
    } catch (error) {
      console.error('âŒ Error in markAsRead:', error);
      toast({
        title: "Error",
        description: "Failed to mark notification as read",
        variant: "destructive",
      });
    }
  }, [toast]);

  useEffect(() => {
    console.log('ðŸ”„ Setting up notifications subscription for thesis:', thesisId);
    
    fetchNotifications();

    const channel = supabase
      .channel('notifications')
      .on(
        'postgres_changes',
        {
          event: 'INSERT',
          schema: 'public',
          table: 'notifications',
          filter: `thesis_id=eq.${thesisId}`,
        },
        handleNewNotification
      )
      .subscribe(status => {
        console.log('ðŸ“¡ Notification subscription status:', status);
      });

    subscriptionRef.current = channel;

    return () => {
      console.log('ðŸ§¹ Cleaning up notifications subscription');
      if (subscriptionRef.current) {
        supabase.removeChannel(subscriptionRef.current);
      }
      processedNotificationsRef.current.clear();
    };
  }, [thesisId, fetchNotifications, handleNewNotification]);

  return {
    notifications,
    loading,
    markAsRead,
  };
};

// File: src\hooks\useThesesList.ts

import { useState } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/hooks/use-toast';

export interface ThesisListItem {
  id: string;
  title: string;
  thesis_collaborators?: {
    user_id: string;
    role: string;
  }[];
}

export const useThesesList = () => {
  const [thesisList, setThesisList] = useState<ThesisListItem[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const { toast } = useToast();

  const fetchTheses = async () => {
    try {
      console.log('ðŸ“š Fetching theses list...');
      setIsLoading(true);
      setError(null);

      const { data: session } = await supabase.auth.getSession();
      if (!session?.session?.user) {
        console.error('âŒ No authenticated user found');
        setError('Please sign in to view your theses');
        toast({
          title: "Authentication Required",
          description: "Please sign in to view your theses",
          variant: "destructive",
        });
        return;
      }

      console.log('ðŸ”‘ User authenticated, fetching theses for user:', session.session.user.id);

      // First get all thesis IDs the user has access to
      const { data: collaborations, error: collabError } = await supabase
        .from('thesis_collaborators')
        .select('thesis_id')
        .eq('user_id', session.session.user.id);

      if (collabError) {
        console.error('âŒ Error fetching collaborations:', collabError);
        throw collabError;
      }

      if (!collaborations || collaborations.length === 0) {
        console.log('â„¹ï¸ No theses found for user');
        setThesisList([]);
        return;
      }

      const thesisIds = collaborations.map(c => c.thesis_id);
      console.log('ðŸ“‹ Found thesis IDs:', thesisIds);

      // Then fetch the actual theses
      const { data: thesesData, error: thesesError } = await supabase
        .from('theses')
        .select(`
          id,
          title,
          thesis_collaborators (
            user_id,
            role
          )
        `)
        .in('id', thesisIds);

      if (thesesError) {
        console.error('âŒ Error fetching theses:', thesesError);
        throw thesesError;
      }

      console.log('âœ… Theses loaded successfully:', thesesData?.length || 0, 'theses');
      setThesisList(thesesData || []);

    } catch (error: any) {
      console.error('âŒ Unexpected error:', error);
      setError(error.message);
      toast({
        title: "Error",
        description: "Failed to load your theses. Please try again.",
        variant: "destructive",
      });
    } finally {
      setIsLoading(false);
    }
  };

  return {
    thesisList,
    isLoading,
    error,
    fetchTheses
  };
};

// File: src\hooks\useThesisAutosave.ts

import { useCallback, useEffect, useRef } from 'react';
import { debounce } from 'lodash';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/hooks/use-toast';
import { Thesis } from '@/types/thesis';
import { Json } from '@/integrations/supabase/types';
import { ensureThesisStructure } from '@/utils/thesisUtils';

export const useThesisAutosave = (thesis: Thesis | null) => {
  const { toast } = useToast();
  const lastSavedContent = useRef<string>(thesis ? JSON.stringify(thesis) : '');
  const lastToastTime = useRef<number>(0);
  const TOAST_COOLDOWN = 5000; // 5 seconds between toasts

  const saveThesis = useCallback(async (thesisData: Thesis | null) => {
    if (!thesisData || !thesisData.id) {
      console.log('No thesis data to save');
      return;
    }
    
    console.log('Thesis object before saving:', thesisData);
    console.log('Thesis object structure:', {
      hasId: !!thesisData.id,
      hasTitle: !!thesisData.title,
      hasDescription: !!thesisData.description,
      hasMetadata: !!thesisData.metadata,
      hasFrontMatter: Array.isArray(thesisData.frontMatter),
      hasGeneralIntroduction: !!thesisData.generalIntroduction,
      hasChapters: Array.isArray(thesisData.chapters),
      hasGeneralConclusion: !!thesisData.generalConclusion,
      hasBackMatter: Array.isArray(thesisData.backMatter)
    });
    
    try {
      console.log('Auto-saving thesis:', thesisData.id);
      
      // Use the utility function to ensure all required fields are present
      const safeThesisData = ensureThesisStructure(thesisData);

      const serializedContent = JSON.stringify(safeThesisData) as unknown as Json;

      const { error } = await supabase
        .from('theses')
        .update({ 
          content: serializedContent,
          updated_at: new Date().toISOString()
        })
        .eq('id', thesisData.id);

      if (error) {
        console.error('Supabase error while saving:', error);
        throw new Error(error.message);
      }
      
      lastSavedContent.current = JSON.stringify(thesisData);
      console.log('Auto-save successful');
      
      // Only show toast if enough time has passed since the last one
      const now = Date.now();
      if (now - lastToastTime.current >= TOAST_COOLDOWN) {
        lastToastTime.current = now;
        toast({
          title: "Auto-saved",
          description: "Your thesis has been automatically saved.",
          variant: "success"
        });
      }
    } catch (error) {
      console.error('Error auto-saving thesis:', error);
      toast({
        title: "Auto-save failed",
        description: error instanceof Error ? error.message : "Failed to save your thesis. Please try again.",
        variant: "destructive"
      });
    }
  }, [toast]);

  // Debounced version of saveThesis
  const debouncedSave = useCallback(
    debounce((thesis: Thesis) => {
      saveThesis(thesis);
    }, 2000),
    [saveThesis]
  );

  useEffect(() => {
    if (!thesis) return;

    const currentContent = JSON.stringify(thesis);
    if (currentContent !== lastSavedContent.current) {
      debouncedSave(thesis);
    }

    return () => {
      debouncedSave.cancel();
    };
  }, [thesis, debouncedSave]);

  return { saveThesis };
};

// File: src\hooks\useThesisData.ts

import { useState } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { Thesis, ThesisContent, SectionType } from '@/types/thesis';
import { useToast } from '@/hooks/use-toast';
import { validate as validateUUID } from 'uuid';
import { useQuery, useQueryClient } from '@tanstack/react-query';

interface ValidationError {
  field: string;
  message: string;
}

const validateThesisContent = (content: any): ValidationError[] => {
  const errors: ValidationError[] = [];

  if (!content) {
    errors.push({ field: 'content', message: 'Thesis content is required' });
    return errors;
  }

  // Validate metadata
  if (!content.metadata) {
    errors.push({ field: 'metadata', message: 'Thesis metadata is required' });
  } else {
    if (!content.metadata.authors?.length) {
      errors.push({ field: 'metadata.authors', message: 'At least one author is required' });
    }
    if (!content.metadata.universityName) {
      errors.push({ field: 'metadata.universityName', message: 'University name is required' });
    }
    if (!content.metadata.departmentName) {
      errors.push({ field: 'metadata.departmentName', message: 'Department name is required' });
    }
  }

  // Validate structure
  if (!Array.isArray(content.frontMatter)) {
    errors.push({ field: 'frontMatter', message: 'Front matter must be an array' });
  }
  if (!Array.isArray(content.chapters)) {
    errors.push({ field: 'chapters', message: 'Chapters must be an array' });
  }
  if (!Array.isArray(content.backMatter)) {
    errors.push({ field: 'backMatter', message: 'Back matter must be an array' });
  }

  return errors;
};

const parseThesisContent = (rawContent: any): ThesisContent => {
  const content = typeof rawContent === 'string' ? JSON.parse(rawContent) : rawContent;

  return {
    metadata: {
      description: content?.metadata?.description || '',
      keywords: Array.isArray(content?.metadata?.keywords) ? content.metadata.keywords : [],
      createdAt: content?.metadata?.createdAt || new Date().toISOString(),
      universityName: content?.metadata?.universityName || '',
      departmentName: content?.metadata?.departmentName || '',
      authors: Array.isArray(content?.metadata?.authors) ? content.metadata.authors : [],
      supervisors: Array.isArray(content?.metadata?.supervisors) ? content.metadata.supervisors : [],
      committeeMembers: Array.isArray(content?.metadata?.committeeMembers) ? content.metadata.committeeMembers : [],
      thesisDate: content?.metadata?.thesisDate || '',
      language: content?.metadata?.language || 'en',
      version: content?.metadata?.version || '1.0.0',
    },
    frontMatter: Array.isArray(content?.frontMatter) ? content.frontMatter.map((section: any) => ({
      ...section,
      type: section.type || SectionType.ABSTRACT,
      required: typeof section.required === 'boolean' ? section.required : true,
      content: Array.isArray(section.content) ? section.content : [],
      figures: Array.isArray(section.figures) ? section.figures : [],
      tables: Array.isArray(section.tables) ? section.tables : [],
      citations: Array.isArray(section.citations) ? section.citations : [],
      references: Array.isArray(section.references) ? section.references : [],
      footnotes: Array.isArray(section.footnotes) ? section.footnotes : [],
    })) : [],
    chapters: Array.isArray(content?.chapters) ? content.chapters.map((chapter: any, index: number) => ({
      ...chapter,
      order: chapter.order || index + 1,
      content: Array.isArray(chapter.content) ? chapter.content : [],
      sections: Array.isArray(chapter.sections) ? chapter.sections : [],
    })) : [],
    backMatter: Array.isArray(content?.backMatter) ? content.backMatter.map((section: any) => ({
      ...section,
      type: section.type || SectionType.APPENDIX,
      required: typeof section.required === 'boolean' ? section.required : false,
      content: Array.isArray(section.content) ? section.content : [],
      figures: Array.isArray(section.figures) ? section.figures : [],
      tables: Array.isArray(section.tables) ? section.tables : [],
      citations: Array.isArray(section.citations) ? section.citations : [],
      references: Array.isArray(section.references) ? section.references : [],
      footnotes: Array.isArray(section.footnotes) ? section.footnotes : [],
    })) : [],
  };
};

export const useThesisData = (thesisId: string | undefined) => {
  const { toast } = useToast();
  const queryClient = useQueryClient();

  const {
    data: thesis,
    isLoading,
    error,
  } = useQuery({
    queryKey: ['thesis', thesisId],
    queryFn: async () => {
      if (!thesisId) {
        return null;
      }

      if (!validateUUID(thesisId)) {
        throw new Error('Invalid thesis ID format');
      }

      try {
        const { data: session } = await supabase.auth.getSession();
        if (!session?.session?.user) {
          throw new Error('Authentication required');
        }

        // First check if user has permission to access this thesis
        const { data: permission, error: permissionError } = await supabase
          .from('thesis_collaborators')
          .select('role')
          .eq('thesis_id', thesisId)
          .eq('user_id', session.session.user.id)
          .maybeSingle();

        if (permissionError) {
          throw new Error('Error checking thesis permissions');
        }

        if (!permission) {
          throw new Error('Access denied');
        }

        const { data: fetchedThesis, error: fetchError } = await supabase
          .from('theses')
          .select(`
            *,
            thesis_collaborators (
              user_id,
              role,
              profiles (
                email
              )
            )
          `)
          .eq('id', thesisId)
          .maybeSingle();

        if (fetchError) {
          throw new Error('Error fetching thesis data');
        }

        if (!fetchedThesis) {
          return null;
        }

        // Validate thesis content
        const validationErrors = validateThesisContent(fetchedThesis.content);
        if (validationErrors.length > 0) {
          toast({
            title: 'Warning',
            description: 'Some thesis data is invalid or missing. Default values will be used.',
            variant: 'warning',
          });
        }

        // Parse and structure the thesis content
        const parsedContent = parseThesisContent(fetchedThesis.content);

        const formattedThesis: Thesis = {
          id: fetchedThesis.id,
          title: fetchedThesis.title,
          content: parsedContent,
          user_id: fetchedThesis.user_id,
          created_at: fetchedThesis.created_at,
          updated_at: fetchedThesis.updated_at,
          language: fetchedThesis.language || 'en',
          status: fetchedThesis.status || 'draft',
          version: fetchedThesis.version || '1.0.0',
          permissions: {
            isPublic: fetchedThesis.is_public || false,
            allowComments: fetchedThesis.allow_comments || true,
            allowSharing: fetchedThesis.allow_sharing || false,
          },
        };

        return formattedThesis;
      } catch (err: any) {
        toast({
          title: 'Error',
          description: err.message || 'Failed to load thesis',
          variant: 'destructive',
        });
        throw err;
      }
    },
    staleTime: 1000 * 60 * 5, // Cache for 5 minutes
    gcTime: 1000 * 60 * 30, // Keep in cache for 30 minutes
    retry: 3, // Increase retries to 3
    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000), // Exponential backoff
  });

  const setThesis = (newThesis: Thesis | ((prev: Thesis | null) => Thesis | null)) => {
    queryClient.setQueryData(['thesis', thesisId], newThesis);
  };

  return { thesis, setThesis, isLoading, error };
};

// File: src\hooks\useThesisInitialization.ts

import { useEffect } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/hooks/use-toast';
import { Thesis } from '@/types/thesis';
import { Json } from '@/integrations/supabase/types';

export const useThesisInitialization = (thesis: Thesis | null) => {
  const { toast } = useToast();

  useEffect(() => {
    const initializeThesis = async () => {
      // Only proceed if thesis is not null
      if (!thesis) {
        return;
      }

      try {
        console.log('Initializing thesis in database:', thesis.id);
        
        // Get current user
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        
        if (userError) {
          console.error('Error getting current user:', userError);
          throw userError;
        }

        if (!user) {
          throw new Error('No authenticated user found');
        }

        console.log('Current user:', user.id);

        // First get user profile to ensure it exists
        const { data: profile, error: profileError } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', user.id)
          .maybeSingle();

        if (profileError) {
          console.error('Error fetching profile:', profileError);
          throw profileError;
        }

        console.log('User profile:', profile);

        // Check if thesis already exists
        const { data: existingThesis, error: checkError } = await supabase
          .from('theses')
          .select('*')
          .eq('id', thesis.id)
          .maybeSingle();

        if (checkError) {
          console.error('Error checking thesis:', checkError);
          throw checkError;
        }

        if (!existingThesis) {
          console.log('Creating new thesis with user_id:', user.id);
          
          // Create the thesis with the content
          const thesisContent = {
            frontMatter: thesis.frontMatter.map(section => ({
              ...section,
              figures: section.figures || [],
              tables: section.tables || [],
              citations: section.citations || [],
              references: section.references || []
            })),
            chapters: thesis.chapters.map(chapter => ({
              ...chapter,
              sections: chapter.sections.map(section => ({
                ...section,
                figures: section.figures || [],
                tables: section.tables || [],
                citations: section.citations || [],
                references: section.references || []
              }))
            })),
            backMatter: thesis.backMatter.map(section => ({
              ...section,
              figures: section.figures || [],
              tables: section.tables || [],
              citations: section.citations || [],
              references: section.references || []
            })),
            description: thesis.description || '',
            metadata: thesis.metadata || {},
            generalIntroduction: thesis.generalIntroduction || {
              id: 'general-introduction',
              title: 'General Introduction',
              type: 'general-introduction',
              content: ''
            },
            generalConclusion: thesis.generalConclusion || {
              id: 'general-conclusion',
              title: 'General Conclusion',
              type: 'general-conclusion',
              content: ''
            }
          } as unknown as Json;

          // Insert thesis
          const { error: thesisError } = await supabase
            .from('theses')
            .insert({
              id: thesis.id,
              title: 'Untitled Thesis',
              content: thesisContent,
              user_id: user.id
            });

          if (thesisError) {
            console.error('Error creating thesis:', thesisError);
            throw thesisError;
          }

          // Add current user as owner
          const { error: collaboratorError } = await supabase
            .from('thesis_collaborators')
            .insert({
              thesis_id: thesis.id,
              user_id: user.id,
              role: 'owner'
            });

          if (collaboratorError) {
            console.error('Error adding thesis owner:', collaboratorError);
            // If we fail to add collaborator, delete the thesis
            await supabase
              .from('theses')
              .delete()
              .eq('id', thesis.id);
            throw collaboratorError;
          }

          console.log('Added user as thesis owner');
        }
      } catch (error: any) {
        console.error('Error in thesis initialization:', error);
        toast({
          title: "Error",
          description: error.message || "Failed to initialize thesis. Please try again.",
          variant: "destructive",
        });
      }
    };

    initializeThesis();
  }, [thesis?.id, toast]);
};

// File: src\hooks\useThesisRealtime.ts

import { useEffect } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { Thesis } from '@/types/thesis';
import { useToast } from './use-toast';
import { debounce } from 'lodash';

export const useThesisRealtime = (
  thesisId: string | undefined,
  currentThesis: Thesis | null,
  setThesis: (thesis: Thesis | ((prev: Thesis | null) => Thesis | null)) => void
) => {
  const { toast } = useToast();

  useEffect(() => {
    if (!thesisId || !currentThesis) return;

    console.log('Setting up realtime subscription for thesis:', thesisId);

    // Create a debounced version of the notification toast
    const showUpdateNotification = debounce(() => {
      toast({
        title: "Thesis Updated",
        description: "Changes from another collaborator have been applied",
      });
    }, 5000); // Show notification at most once every 5 seconds

    let lastUpdateTime = new Date().toISOString();
    let lastProcessedContent = JSON.stringify(currentThesis);

    const channel = supabase
      .channel('thesis_changes')
      .on(
        'postgres_changes',
        {
          event: 'UPDATE',
          schema: 'public',
          table: 'theses',
          filter: `id=eq.${thesisId}`
        },
        (payload) => {
          console.log('Received thesis update:', payload);
          
          // Skip if we're the ones who made the change
          if (payload.new.updated_at === currentThesis.updated_at) {
            console.log('Skipping own update');
            return;
          }

          // Skip if this update is too close to the last one we processed
          if (payload.new.updated_at <= lastUpdateTime) {
            console.log('Skipping duplicate/old update');
            return;
          }

          // Skip if the content hasn't actually changed
          const newContentStr = JSON.stringify(payload.new.content);
          if (newContentStr === lastProcessedContent) {
            console.log('Content unchanged, skipping update');
            return;
          }

          lastUpdateTime = payload.new.updated_at;
          lastProcessedContent = newContentStr;
          const newContent = payload.new.content;
          
          if (!newContent) {
            console.log('Update contained no content, skipping');
            return;
          }

          setThesis({
            ...currentThesis,
            ...payload.new,
            metadata: newContent.metadata || currentThesis.metadata,
            frontMatter: newContent.frontMatter || currentThesis.frontMatter,
            chapters: newContent.chapters || currentThesis.chapters,
            backMatter: newContent.backMatter || currentThesis.backMatter,
          });

          // Show notification about the update
          showUpdateNotification();
        }
      )
      .subscribe();

    // Cleanup
    return () => {
      console.log('Cleaning up realtime subscription');
      showUpdateNotification.cancel(); // Cancel any pending notifications
      supabase.removeChannel(channel);
    };
  }, [thesisId, currentThesis?.id]);
};

// File: src\hooks\useThesisStats.tsx

import { useQuery } from '@tanstack/react-query';
import { supabase } from '@/integrations/supabase/client';

interface ThesisStats {
  total: number;
  inProgress: number;
  completed: number;
}

export const useThesisStats = (userId: string | null) => {
  return useQuery({
    queryKey: ['thesis-stats', userId],
    queryFn: async (): Promise<ThesisStats> => {
      console.log('ðŸ“Š Fetching thesis stats for user:', userId);
      
      if (!userId) {
        console.log('âŒ No user ID available for fetching thesis stats');
        throw new Error('User ID is required');
      }

      const { data: theses, error } = await supabase
        .from('thesis_collaborators')
        .select('role')
        .eq('user_id', userId);

      if (error) {
        console.error('âŒ Error fetching thesis stats:', error);
        throw error;
      }

      console.log('âœ… Thesis stats fetched:', theses);

      return {
        total: theses?.length || 0,
        inProgress: theses?.filter(t => t.role === 'editor').length || 0,
        completed: theses?.filter(t => t.role === 'owner').length || 0,
      };
    },
    retry: 1,
    staleTime: 30000,
    enabled: !!userId,
  });
};

// File: src\hooks\useThesisVersioning.ts

import { useState } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { Thesis, ThesisVersion, ThesisContent } from '@/types/thesis';
import { useToast } from '@/hooks/use-toast';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';

interface VersionDiff {
  path: string;
  type: 'addition' | 'deletion' | 'modification';
  oldValue?: any;
  newValue?: any;
}

const generateVersionDiff = (oldContent: ThesisContent, newContent: ThesisContent): VersionDiff[] => {
  const diff: VersionDiff[] = [];

  // Compare metadata
  Object.keys(newContent.metadata).forEach(key => {
    const oldValue = oldContent.metadata[key as keyof typeof oldContent.metadata];
    const newValue = newContent.metadata[key as keyof typeof newContent.metadata];
    
    if (JSON.stringify(oldValue) !== JSON.stringify(newValue)) {
      diff.push({
        path: `metadata.${key}`,
        type: 'modification',
        oldValue,
        newValue
      });
    }
  });

  // Compare chapters
  newContent.chapters.forEach((chapter, index) => {
    const oldChapter = oldContent.chapters[index];
    if (!oldChapter) {
      diff.push({
        path: `chapters[${index}]`,
        type: 'addition',
        newValue: chapter
      });
      return;
    }

    if (chapter.title !== oldChapter.title) {
      diff.push({
        path: `chapters[${index}].title`,
        type: 'modification',
        oldValue: oldChapter.title,
        newValue: chapter.title
      });
    }

    // Compare chapter content
    chapter.content.forEach((content, contentIndex) => {
      const oldContent = oldChapter.content[contentIndex];
      if (!oldContent) {
        diff.push({
          path: `chapters[${index}].content[${contentIndex}]`,
          type: 'addition',
          newValue: content
        });
      } else if (JSON.stringify(content) !== JSON.stringify(oldContent)) {
        diff.push({
          path: `chapters[${index}].content[${contentIndex}]`,
          type: 'modification',
          oldValue: oldContent,
          newValue: content
        });
      }
    });
  });

  // Check for deleted chapters
  oldContent.chapters.forEach((chapter, index) => {
    if (!newContent.chapters[index]) {
      diff.push({
        path: `chapters[${index}]`,
        type: 'deletion',
        oldValue: chapter
      });
    }
  });

  return diff;
};

export const useThesisVersioning = (thesisId: string) => {
  const { toast } = useToast();
  const queryClient = useQueryClient();

  // Fetch version history
  const {
    data: versions,
    isLoading: isLoadingVersions,
    error: versionsError
  } = useQuery({
    queryKey: ['thesis-versions', thesisId],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('thesis_versions')
        .select('*')
        .eq('thesis_id', thesisId)
        .order('version_number', { ascending: false });

      if (error) throw error;
      return data as ThesisVersion[];
    }
  });

  // Create new version
  const createVersion = useMutation({
    mutationFn: async ({ 
      thesis, 
      description 
    }: { 
      thesis: Thesis; 
      description: string;
    }) => {
      const { data: latestVersion } = await supabase
        .from('thesis_versions')
        .select('version_number')
        .eq('thesis_id', thesisId)
        .order('version_number', { ascending: false })
        .limit(1)
        .single();

      const newVersionNumber = (latestVersion?.version_number || 0) + 1;

      // Get previous version for diff
      const { data: previousVersion } = await supabase
        .from('thesis_versions')
        .select('content')
        .eq('thesis_id', thesisId)
        .eq('version_number', newVersionNumber - 1)
        .single();

      const changes = previousVersion 
        ? generateVersionDiff(previousVersion.content, thesis.content)
        : [{ type: 'addition', path: 'root', description: 'Initial version' }];

      const { data, error } = await supabase
        .from('thesis_versions')
        .insert({
          thesis_id: thesisId,
          content: thesis.content,
          version_number: newVersionNumber,
          description,
          created_by: thesis.user_id,
          changes
        });

      if (error) throw error;
      return data;
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['thesis-versions', thesisId]);
      toast({
        title: 'Success',
        description: 'New version created successfully',
      });
    },
    onError: (error: Error) => {
      toast({
        title: 'Error',
        description: `Failed to create version: ${error.message}`,
        variant: 'destructive',
      });
    }
  });

  // Restore version
  const restoreVersion = useMutation({
    mutationFn: async (versionNumber: number) => {
      const { data: version } = await supabase
        .from('thesis_versions')
        .select('content')
        .eq('thesis_id', thesisId)
        .eq('version_number', versionNumber)
        .single();

      if (!version) throw new Error('Version not found');

      const { error } = await supabase
        .from('theses')
        .update({ content: version.content })
        .eq('id', thesisId);

      if (error) throw error;

      return version;
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['thesis', thesisId]);
      toast({
        title: 'Success',
        description: 'Version restored successfully',
      });
    },
    onError: (error: Error) => {
      toast({
        title: 'Error',
        description: `Failed to restore version: ${error.message}`,
        variant: 'destructive',
      });
    }
  });

  // Compare versions
  const compareVersions = async (versionA: number, versionB: number) => {
    const { data: versions } = await supabase
      .from('thesis_versions')
      .select('content, version_number')
      .in('version_number', [versionA, versionB])
      .eq('thesis_id', thesisId);

    if (!versions || versions.length !== 2) {
      throw new Error('Could not find both versions for comparison');
    }

    const [oldVersion, newVersion] = versions.sort((a, b) => a.version_number - b.version_number);
    return generateVersionDiff(oldVersion.content, newVersion.content);
  };

  return {
    versions,
    isLoadingVersions,
    versionsError,
    createVersion,
    restoreVersion,
    compareVersions
  };
};


// File: src\hooks\useTranslation.ts

import { useLanguage } from "@/contexts/LanguageContext";
import { translations } from "@/utils/translations";

export function useTranslation() {
  const { language } = useLanguage();
  
  function t(key: string) {
    const keys = key.split('.');
    let current: any = translations[language];
    
    for (const k of keys) {
      if (current[k] === undefined) {
        console.warn(`Translation key "${key}" not found for language "${language}"`);
        return key;
      }
      current = current[k];
    }
    
    return current;
  }

  return { t };
}

// File: src\hooks\useUser.tsx

import { useState, useEffect } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { useNavigate } from 'react-router-dom';
import { useToast } from '@/hooks/use-toast';

export const useUser = () => {
  const [userEmail, setUserEmail] = useState<string>('');
  const [userRole, setUserRole] = useState<string>('');
  const [isLoading, setIsLoading] = useState(false);
  const navigate = useNavigate();
  const { toast } = useToast();

  useEffect(() => {
    let mounted = true;
    
    const loadProfile = async () => {
      try {
        console.log('Loading user profile...');
        setIsLoading(true);
        
        const { data: { session } } = await supabase.auth.getSession();
        
        if (!session) {
          console.log('No active session found, redirecting to auth...');
          if (mounted) {
            setIsLoading(false);
            navigate('/auth');
          }
          return;
        }

        const { data: profile, error } = await supabase
          .from('profiles')
          .select(`
            email,
            roles (
              name
            )
          `)
          .eq('id', session.user.id)
          .maybeSingle();

        if (error) {
          console.error('Error loading profile:', error);
          if (mounted) {
            setIsLoading(false);
            if (error.code === 'PGRST116') {
              console.log('Profile not found, redirecting to auth...');
              await handleLogout();
            }
          }
          return;
        }

        if (profile && mounted) {
          console.log('Profile loaded:', profile);
          setUserEmail(profile.email);
          setUserRole(profile.roles?.name || '');
        }
      } catch (error) {
        console.error('Error in loadProfile:', error);
        if (mounted) {
          navigate('/auth');
        }
      } finally {
        if (mounted) {
          setIsLoading(false);
        }
      }
    };

    loadProfile();

    const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {
      console.log('Auth state changed:', event, session?.user?.email);
      
      if (event === 'SIGNED_OUT') {
        if (mounted) {
          setUserEmail('');
          setUserRole('');
          setIsLoading(false);
          navigate('/auth');
        }
      } else if (event === 'SIGNED_IN' && session) {
        if (mounted) {
          await loadProfile();
        }
      }
    });

    return () => {
      mounted = false;
      subscription.unsubscribe();
    };
  }, [navigate]);

  const handleLogout = async () => {
    try {
      setIsLoading(true);
      setUserEmail('');
      setUserRole('');
      
      const { error } = await supabase.auth.signOut();
      if (error) {
        console.error('Error during sign out:', error);
        toast({
          title: "Error signing out",
          description: error.message,
          variant: "destructive",
        });
      }
      
      console.log('Navigating to auth page...');
      navigate('/auth');
      
    } catch (error: any) {
      console.error('Error during logout:', error);
      toast({
        title: "Error signing out",
        description: "An unexpected error occurred. Please try again.",
        variant: "destructive",
      });
      navigate('/auth');
    } finally {
      setIsLoading(false);
    }
  };

  return { userEmail, userRole, isLoading, handleLogout };
};

// File: src\hooks\useUserProfile.tsx

import { useQuery } from '@tanstack/react-query';
import { supabase } from '@/integrations/supabase/client';
import { Profile } from '@/types/profile';

export const useUserProfile = (userId: string | null) => {
  return useQuery({
    queryKey: ['user-profile', userId],
    queryFn: async (): Promise<Profile | null> => {
      console.log('ðŸ‘¤ Fetching user profile for:', userId);
      
      if (!userId) {
        console.log('âŒ No user ID available for fetching profile');
        throw new Error('User ID is required');
      }

      const { data: profile, error } = await supabase
        .from('profiles')
        .select(`
          *,
          roles (
            name
          )
        `)
        .eq('id', userId)
        .maybeSingle();

      if (error) {
        console.error('âŒ Error fetching profile:', error);
        throw error;
      }

      console.log('âœ… Profile fetched:', profile);
      return profile;
    },
    retry: 1,
    staleTime: 30000,
    enabled: !!userId,
  });
};

// File: src\integrations\supabase\client.ts

import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const SUPABASE_URL = "https://xkwdfddamvuhucorwttw.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhrd2RmZGRhbXZ1aHVjb3J3dHR3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzUzNzcwMDQsImV4cCI6MjA1MDk1MzAwNH0.6Ml1JDiKKsjSnM1z82bD9bVoiT_ZQmTRZaqtpxTPF2g";

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: {
    autoRefreshToken: true,
    persistSession: true,
    detectSessionInUrl: true,
    storage: typeof window !== 'undefined' ? window.localStorage : undefined
  },
  global: {
    headers: {
      'X-Client-Info': 'supabase-js-web',
    },
  },
  realtime: {
    params: {
      eventsPerSecond: 10
    }
  }
});

// File: src\integrations\supabase\types.ts

export type Json =
  | string
  | number
  | boolean
  | null
  | { [key: string]: Json | undefined }
  | Json[]

export type Database = {
  public: {
    Tables: {
      active_sessions: {
        Row: {
          id: string
          last_seen: string | null
          session_id: string
          user_id: string
        }
        Insert: {
          id?: string
          last_seen?: string | null
          session_id: string
          user_id: string
        }
        Update: {
          id?: string
          last_seen?: string | null
          session_id?: string
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "active_sessions_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: true
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
        ]
      }
      app_issues: {
        Row: {
          browser_info: string | null
          component_name: string | null
          created_at: string
          error_message: string
          error_stack: string | null
          id: string
          route_path: string | null
          user_id: string | null
        }
        Insert: {
          browser_info?: string | null
          component_name?: string | null
          created_at?: string
          error_message: string
          error_stack?: string | null
          id?: string
          route_path?: string | null
          user_id?: string | null
        }
        Update: {
          browser_info?: string | null
          component_name?: string | null
          created_at?: string
          error_message?: string
          error_stack?: string | null
          id?: string
          route_path?: string | null
          user_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "app_issues_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
        ]
      }
      chat_messages: {
        Row: {
          content: string
          created_at: string
          id: string
          sender_id: string
          thesis_id: string
        }
        Insert: {
          content: string
          created_at?: string
          id?: string
          sender_id: string
          thesis_id: string
        }
        Update: {
          content?: string
          created_at?: string
          id?: string
          sender_id?: string
          thesis_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "chat_messages_sender_id_fkey"
            columns: ["sender_id"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "chat_messages_thesis_id_fkey"
            columns: ["thesis_id"]
            isOneToOne: false
            referencedRelation: "supervisor_theses"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "chat_messages_thesis_id_fkey"
            columns: ["thesis_id"]
            isOneToOne: false
            referencedRelation: "theses"
            referencedColumns: ["id"]
          },
        ]
      }
      citations: {
        Row: {
          authors: string[]
          created_at: string
          doi: string | null
          id: string
          issue: string | null
          journal: string | null
          pages: string | null
          publisher: string | null
          source: string
          text: string
          thesis_id: string
          type: string
          updated_at: string
          url: string | null
          volume: string | null
          year: string
        }
        Insert: {
          authors?: string[]
          created_at?: string
          doi?: string | null
          id?: string
          issue?: string | null
          journal?: string | null
          pages?: string | null
          publisher?: string | null
          source: string
          text: string
          thesis_id: string
          type: string
          updated_at?: string
          url?: string | null
          volume?: string | null
          year: string
        }
        Update: {
          authors?: string[]
          created_at?: string
          doi?: string | null
          id?: string
          issue?: string | null
          journal?: string | null
          pages?: string | null
          publisher?: string | null
          source?: string
          text?: string
          thesis_id?: string
          type?: string
          updated_at?: string
          url?: string | null
          volume?: string | null
          year?: string
        }
        Relationships: [
          {
            foreignKeyName: "citations_thesis_id_fkey"
            columns: ["thesis_id"]
            isOneToOne: false
            referencedRelation: "supervisor_theses"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "citations_thesis_id_fkey"
            columns: ["thesis_id"]
            isOneToOne: false
            referencedRelation: "theses"
            referencedColumns: ["id"]
          },
        ]
      }
      features: {
        Row: {
          created_at: string | null
          description: string | null
          health: string
          id: string
          is_sub_feature: boolean | null
          last_updated: string | null
          name: string
          parent_id: string | null
          pricing_tier: string | null
          status: string
          trial_days: number | null
          usage_data: Json | null
        }
        Insert: {
          created_at?: string | null
          description?: string | null
          health?: string
          id?: string
          is_sub_feature?: boolean | null
          last_updated?: string | null
          name: string
          parent_id?: string | null
          pricing_tier?: string | null
          status?: string
          trial_days?: number | null
          usage_data?: Json | null
        }
        Update: {
          created_at?: string | null
          description?: string | null
          health?: string
          id?: string
          is_sub_feature?: boolean | null
          last_updated?: string | null
          name?: string
          parent_id?: string | null
          pricing_tier?: string | null
          status?: string
          trial_days?: number | null
          usage_data?: Json | null
        }
        Relationships: [
          {
            foreignKeyName: "features_parent_id_fkey"
            columns: ["parent_id"]
            isOneToOne: false
            referencedRelation: "features"
            referencedColumns: ["id"]
          },
        ]
      }
      footnotes: {
        Row: {
          content: string
          created_at: string
          id: string
          number: number
          section_id: string
          thesis_id: string
          updated_at: string
        }
        Insert: {
          content: string
          created_at?: string
          id?: string
          number: number
          section_id: string
          thesis_id: string
          updated_at?: string
        }
        Update: {
          content?: string
          created_at?: string
          id?: string
          number?: number
          section_id?: string
          thesis_id?: string
          updated_at?: string
        }
        Relationships: [
          {
            foreignKeyName: "footnotes_thesis_id_fkey"
            columns: ["thesis_id"]
            isOneToOne: false
            referencedRelation: "supervisor_theses"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "footnotes_thesis_id_fkey"
            columns: ["thesis_id"]
            isOneToOne: false
            referencedRelation: "theses"
            referencedColumns: ["id"]
          },
        ]
      }
      notifications: {
        Row: {
          created_at: string
          id: string
          message: string
          read: boolean | null
          thesis_id: string
          type: string
          user_id: string
        }
        Insert: {
          created_at?: string
          id?: string
          message: string
          read?: boolean | null
          thesis_id: string
          type: string
          user_id: string
        }
        Update: {
          created_at?: string
          id?: string
          message?: string
          read?: boolean | null
          thesis_id?: string
          type?: string
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "notifications_thesis_id_fkey"
            columns: ["thesis_id"]
            isOneToOne: false
            referencedRelation: "supervisor_theses"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "notifications_thesis_id_fkey"
            columns: ["thesis_id"]
            isOneToOne: false
            referencedRelation: "theses"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "notifications_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
        ]
      }
      profiles: {
        Row: {
          created_at: string
          department: string | null
          email: string
          full_name: string | null
          id: string
          program: string | null
          role_id: string | null
          student_id: string | null
          year_of_study: string | null
        }
        Insert: {
          created_at?: string
          department?: string | null
          email: string
          full_name?: string | null
          id: string
          program?: string | null
          role_id?: string | null
          student_id?: string | null
          year_of_study?: string | null
        }
        Update: {
          created_at?: string
          department?: string | null
          email?: string
          full_name?: string | null
          id?: string
          program?: string | null
          role_id?: string | null
          student_id?: string | null
          year_of_study?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "profiles_role_id_fkey"
            columns: ["role_id"]
            isOneToOne: false
            referencedRelation: "roles"
            referencedColumns: ["id"]
          },
        ]
      }
      roles: {
        Row: {
          id: string
          name: string
        }
        Insert: {
          id?: string
          name: string
        }
        Update: {
          id?: string
          name?: string
        }
        Relationships: []
      }
      theses: {
        Row: {
          content: Json
          created_at: string
          description: string | null
          id: string
          language: string
          permissions: Json | null
          status: string | null
          supervisor_email: string | null
          supervisor_id: string | null
          title: string
          updated_at: string
          user_id: string
          version: string | null
        }
        Insert: {
          content?: Json
          created_at?: string
          description?: string | null
          id?: string
          language?: string
          permissions?: Json | null
          status?: string | null
          supervisor_email?: string | null
          supervisor_id?: string | null
          title: string
          updated_at?: string
          user_id: string
          version?: string | null
        }
        Update: {
          content?: Json
          created_at?: string
          description?: string | null
          id?: string
          language?: string
          permissions?: Json | null
          status?: string | null
          supervisor_email?: string | null
          supervisor_id?: string | null
          title?: string
          updated_at?: string
          user_id?: string
          version?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "theses_supervisor_id_fkey"
            columns: ["supervisor_id"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
        ]
      }
      thesis_annotations: {
        Row: {
          content: Json
          created_at: string
          id: string
          reviewer_id: string | null
          section_id: string
          thesis_id: string | null
          type: string
          updated_at: string
        }
        Insert: {
          content?: Json
          created_at?: string
          id?: string
          reviewer_id?: string | null
          section_id: string
          thesis_id?: string | null
          type: string
          updated_at?: string
        }
        Update: {
          content?: Json
          created_at?: string
          id?: string
          reviewer_id?: string | null
          section_id?: string
          thesis_id?: string | null
          type?: string
          updated_at?: string
        }
        Relationships: [
          {
            foreignKeyName: "thesis_annotations_reviewer_id_fkey"
            columns: ["reviewer_id"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "thesis_annotations_thesis_id_fkey"
            columns: ["thesis_id"]
            isOneToOne: false
            referencedRelation: "supervisor_theses"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "thesis_annotations_thesis_id_fkey"
            columns: ["thesis_id"]
            isOneToOne: false
            referencedRelation: "theses"
            referencedColumns: ["id"]
          },
        ]
      }
      thesis_collaborators: {
        Row: {
          created_at: string
          id: string
          role: string
          thesis_id: string
          user_id: string
        }
        Insert: {
          created_at?: string
          id?: string
          role: string
          thesis_id: string
          user_id: string
        }
        Update: {
          created_at?: string
          id?: string
          role?: string
          thesis_id?: string
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "thesis_collaborators_thesis_id_fkey"
            columns: ["thesis_id"]
            isOneToOne: false
            referencedRelation: "supervisor_theses"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "thesis_collaborators_thesis_id_fkey"
            columns: ["thesis_id"]
            isOneToOne: false
            referencedRelation: "theses"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "thesis_collaborators_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
        ]
      }
      thesis_references: {
        Row: {
          authors: string[]
          created_at: string
          doi: string | null
          id: string
          issue: string | null
          journal: string | null
          pages: string | null
          publisher: string | null
          source: string
          text: string
          thesis_id: string
          title: string
          type: string
          updated_at: string
          url: string | null
          volume: string | null
          year: string
        }
        Insert: {
          authors?: string[]
          created_at?: string
          doi?: string | null
          id?: string
          issue?: string | null
          journal?: string | null
          pages?: string | null
          publisher?: string | null
          source: string
          text: string
          thesis_id: string
          title: string
          type: string
          updated_at?: string
          url?: string | null
          volume?: string | null
          year: string
        }
        Update: {
          authors?: string[]
          created_at?: string
          doi?: string | null
          id?: string
          issue?: string | null
          journal?: string | null
          pages?: string | null
          publisher?: string | null
          source?: string
          text?: string
          thesis_id?: string
          title?: string
          type?: string
          updated_at?: string
          url?: string | null
          volume?: string | null
          year?: string
        }
        Relationships: [
          {
            foreignKeyName: "thesis_references_thesis_id_fkey"
            columns: ["thesis_id"]
            isOneToOne: false
            referencedRelation: "supervisor_theses"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "thesis_references_thesis_id_fkey"
            columns: ["thesis_id"]
            isOneToOne: false
            referencedRelation: "theses"
            referencedColumns: ["id"]
          },
        ]
      }
      thesis_reviews: {
        Row: {
          content: Json
          created_at: string
          id: string
          parent_id: string | null
          reviewer_id: string
          section_id: string
          status: string
          thesis_id: string
          updated_at: string
        }
        Insert: {
          content?: Json
          created_at?: string
          id?: string
          parent_id?: string | null
          reviewer_id: string
          section_id: string
          status?: string
          thesis_id: string
          updated_at?: string
        }
        Update: {
          content?: Json
          created_at?: string
          id?: string
          parent_id?: string | null
          reviewer_id?: string
          section_id?: string
          status?: string
          thesis_id?: string
          updated_at?: string
        }
        Relationships: [
          {
            foreignKeyName: "thesis_reviews_parent_id_fkey"
            columns: ["parent_id"]
            isOneToOne: false
            referencedRelation: "thesis_reviews"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "thesis_reviews_reviewer_id_fkey"
            columns: ["reviewer_id"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "thesis_reviews_thesis_id_fkey"
            columns: ["thesis_id"]
            isOneToOne: false
            referencedRelation: "supervisor_theses"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "thesis_reviews_thesis_id_fkey"
            columns: ["thesis_id"]
            isOneToOne: false
            referencedRelation: "theses"
            referencedColumns: ["id"]
          },
        ]
      }
      thesis_templates: {
        Row: {
          created_at: string
          description: string | null
          id: string
          language: string
          name: string
          structure: Json
          updated_at: string
        }
        Insert: {
          created_at?: string
          description?: string | null
          id?: string
          language?: string
          name: string
          structure: Json
          updated_at?: string
        }
        Update: {
          created_at?: string
          description?: string | null
          id?: string
          language?: string
          name?: string
          structure?: Json
          updated_at?: string
        }
        Relationships: []
      }
      thesis_versions: {
        Row: {
          content: Json
          created_at: string
          created_by: string
          description: string | null
          id: string
          language: string
          thesis_id: string
          version_number: number
        }
        Insert: {
          content?: Json
          created_at?: string
          created_by: string
          description?: string | null
          id?: string
          language?: string
          thesis_id: string
          version_number: number
        }
        Update: {
          content?: Json
          created_at?: string
          created_by?: string
          description?: string | null
          id?: string
          language?: string
          thesis_id?: string
          version_number?: number
        }
        Relationships: [
          {
            foreignKeyName: "thesis_versions_created_by_fkey"
            columns: ["created_by"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "thesis_versions_thesis_id_fkey"
            columns: ["thesis_id"]
            isOneToOne: false
            referencedRelation: "supervisor_theses"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "thesis_versions_thesis_id_fkey"
            columns: ["thesis_id"]
            isOneToOne: false
            referencedRelation: "theses"
            referencedColumns: ["id"]
          },
        ]
      }
      trial_settings: {
        Row: {
          created_at: string
          id: string
          trial_days: number
          updated_at: string
        }
        Insert: {
          created_at?: string
          id?: string
          trial_days?: number
          updated_at?: string
        }
        Update: {
          created_at?: string
          id?: string
          trial_days?: number
          updated_at?: string
        }
        Relationships: []
      }
      user_features: {
        Row: {
          access_type: string
          created_at: string
          expires_at: string | null
          feature_id: string | null
          id: string
          updated_at: string
          user_id: string | null
        }
        Insert: {
          access_type: string
          created_at?: string
          expires_at?: string | null
          feature_id?: string | null
          id?: string
          updated_at?: string
          user_id?: string | null
        }
        Update: {
          access_type?: string
          created_at?: string
          expires_at?: string | null
          feature_id?: string | null
          id?: string
          updated_at?: string
          user_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "user_features_feature_id_fkey"
            columns: ["feature_id"]
            isOneToOne: false
            referencedRelation: "features"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "user_features_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
        ]
      }
      user_feedback: {
        Row: {
          created_at: string
          email: string
          id: string
          message: string
          rating: number | null
          user_id: string | null
        }
        Insert: {
          created_at?: string
          email: string
          id?: string
          message: string
          rating?: number | null
          user_id?: string | null
        }
        Update: {
          created_at?: string
          email?: string
          id?: string
          message?: string
          rating?: number | null
          user_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "user_feedback_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
        ]
      }
      user_interactions: {
        Row: {
          created_at: string
          element_class: string | null
          element_id: string | null
          event_type: string
          id: string
          page_path: string | null
          scroll_depth: number | null
          user_id: string | null
          x_position: number | null
          y_position: number | null
        }
        Insert: {
          created_at?: string
          element_class?: string | null
          element_id?: string | null
          event_type: string
          id?: string
          page_path?: string | null
          scroll_depth?: number | null
          user_id?: string | null
          x_position?: number | null
          y_position?: number | null
        }
        Update: {
          created_at?: string
          element_class?: string | null
          element_id?: string | null
          event_type?: string
          id?: string
          page_path?: string | null
          scroll_depth?: number | null
          user_id?: string | null
          x_position?: number | null
          y_position?: number | null
        }
        Relationships: [
          {
            foreignKeyName: "user_interactions_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
        ]
      }
    }
    Views: {
      supervisor_theses: {
        Row: {
          content: Json | null
          created_at: string | null
          id: string | null
          language: string | null
          student_email: string | null
          supervisor_email: string | null
          supervisor_id: string | null
          title: string | null
          updated_at: string | null
          user_id: string | null
        }
        Relationships: [
          {
            foreignKeyName: "theses_supervisor_id_fkey"
            columns: ["supervisor_id"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
        ]
      }
    }
    Functions: {
      create_section_if_not_exists: {
        Args: {
          p_thesis_id: string
          p_section_title: string
          p_section_type?: string
        }
        Returns: string
      }
      get_latest_thesis_version: {
        Args: {
          p_thesis_id: string
        }
        Returns: {
          content: Json
          created_at: string
          created_by: string
          description: string | null
          id: string
          language: string
          thesis_id: string
          version_number: number
        }
      }
    }
    Enums: {
      section_type:
        | "abstract"
        | "general-introduction"
        | "introduction"
        | "chapter"
        | "conclusion"
        | "general-conclusion"
        | "references"
        | "appendix"
        | "table-of-contents"
        | "acknowledgments"
    }
    CompositeTypes: {
      [_ in never]: never
    }
  }
}

type PublicSchema = Database[Extract<keyof Database, "public">]

export type Tables<
  PublicTableNameOrOptions extends
    | keyof (PublicSchema["Tables"] & PublicSchema["Views"])
    | { schema: keyof Database },
  TableName extends PublicTableNameOrOptions extends { schema: keyof Database }
    ? keyof (Database[PublicTableNameOrOptions["schema"]]["Tables"] &
        Database[PublicTableNameOrOptions["schema"]]["Views"])
    : never = never,
> = PublicTableNameOrOptions extends { schema: keyof Database }
  ? (Database[PublicTableNameOrOptions["schema"]]["Tables"] &
      Database[PublicTableNameOrOptions["schema"]]["Views"])[TableName] extends {
      Row: infer R
    }
    ? R
    : never
  : PublicTableNameOrOptions extends keyof (PublicSchema["Tables"] &
        PublicSchema["Views"])
    ? (PublicSchema["Tables"] &
        PublicSchema["Views"])[PublicTableNameOrOptions] extends {
        Row: infer R
      }
      ? R
      : never
    : never

export type TablesInsert<
  PublicTableNameOrOptions extends
    | keyof PublicSchema["Tables"]
    | { schema: keyof Database },
  TableName extends PublicTableNameOrOptions extends { schema: keyof Database }
    ? keyof Database[PublicTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = PublicTableNameOrOptions extends { schema: keyof Database }
  ? Database[PublicTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Insert: infer I
    }
    ? I
    : never
  : PublicTableNameOrOptions extends keyof PublicSchema["Tables"]
    ? PublicSchema["Tables"][PublicTableNameOrOptions] extends {
        Insert: infer I
      }
      ? I
      : never
    : never

export type TablesUpdate<
  PublicTableNameOrOptions extends
    | keyof PublicSchema["Tables"]
    | { schema: keyof Database },
  TableName extends PublicTableNameOrOptions extends { schema: keyof Database }
    ? keyof Database[PublicTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = PublicTableNameOrOptions extends { schema: keyof Database }
  ? Database[PublicTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Update: infer U
    }
    ? U
    : never
  : PublicTableNameOrOptions extends keyof PublicSchema["Tables"]
    ? PublicSchema["Tables"][PublicTableNameOrOptions] extends {
        Update: infer U
      }
      ? U
      : never
    : never

export type Enums<
  PublicEnumNameOrOptions extends
    | keyof PublicSchema["Enums"]
    | { schema: keyof Database },
  EnumName extends PublicEnumNameOrOptions extends { schema: keyof Database }
    ? keyof Database[PublicEnumNameOrOptions["schema"]]["Enums"]
    : never = never,
> = PublicEnumNameOrOptions extends { schema: keyof Database }
  ? Database[PublicEnumNameOrOptions["schema"]]["Enums"][EnumName]
  : PublicEnumNameOrOptions extends keyof PublicSchema["Enums"]
    ? PublicSchema["Enums"][PublicEnumNameOrOptions]
    : never

export type CompositeTypes<
  PublicCompositeTypeNameOrOptions extends
    | keyof PublicSchema["CompositeTypes"]
    | { schema: keyof Database },
  CompositeTypeName extends PublicCompositeTypeNameOrOptions extends {
    schema: keyof Database
  }
    ? keyof Database[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"]
    : never = never,
> = PublicCompositeTypeNameOrOptions extends { schema: keyof Database }
  ? Database[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"][CompositeTypeName]
  : PublicCompositeTypeNameOrOptions extends keyof PublicSchema["CompositeTypes"]
    ? PublicSchema["CompositeTypes"][PublicCompositeTypeNameOrOptions]
    : never


// File: src\lib\utils.ts

import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}


// File: src\main.tsx

import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App.tsx'
import './index.css'

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)

// File: src\pages\AdminPanel.tsx

import { AdminDashboard } from '@/components/admin/AdminDashboard';

const AdminPanel = () => {
  return <AdminDashboard />;
};

export default AdminPanel;

// File: src\pages\Auth.tsx

import { useState } from 'react';
import { Separator } from '@/components/ui/separator';
import { EmailAuthForm } from '@/components/auth/EmailAuthForm';
import { SocialAuth } from '@/components/auth/SocialAuth';
import { X } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { Button } from '@/components/ui/button';
import LandingPage from './LandingPage';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { AuthError, AuthApiError } from '@supabase/supabase-js';
import { supabase } from '@/integrations/supabase/client';
import { useEffect } from 'react';

const Auth = () => {
  const [loading, setLoading] = useState(false);
  const [authMode, setAuthMode] = useState<'signin' | 'signup'>('signin');
  const [errorMessage, setErrorMessage] = useState<string>('');
  const navigate = useNavigate();

  const handleClose = () => {
    navigate('/');
  };

  const toggleAuthMode = () => {
    setAuthMode(prev => prev === 'signin' ? 'signup' : 'signin');
    setErrorMessage(''); // Clear any existing errors when switching modes
  };

  useEffect(() => {
    // Check if user is already logged in
    const checkSession = async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        navigate('/');
      }
    };
    checkSession();

    // Listen for auth state changes
    const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session) {
        navigate('/');
      }
    });

    return () => {
      subscription.unsubscribe();
    };
  }, [navigate]);

  // Error message handler
  const getErrorMessage = (error: AuthError) => {
    // Do not log the full error object as it may contain sensitive information
    if (error instanceof AuthApiError) {
      switch (error.status) {
        case 400:
          return 'Invalid credentials. Please try again.';
        case 422:
          return 'Invalid email format.';
        case 429:
          return 'Too many attempts. Please try again later.';
        default:
          return 'An error occurred during authentication.';
      }
    }
    return 'An unexpected error occurred. Please try again.';
  };

  return (
    <div className="relative min-h-screen">
      {/* Background Landing Page with reduced opacity */}
      <div className="fixed inset-0 opacity-25">
        <LandingPage />
      </div>

      {/* Auth Content */}
      <div className="relative min-h-screen flex flex-col items-center justify-center px-4">
        <div className="w-full max-w-md space-y-8 bg-[#1A1F2C]/95 p-8 rounded-2xl backdrop-blur-sm relative">
          {/* Close Button */}
          <Button
            variant="ghost"
            size="icon"
            className="absolute right-4 top-4 text-gray-400 hover:text-white"
            onClick={handleClose}
          >
            <X className="h-4 w-4" />
          </Button>

          <div className="text-center">
            <h1 className="text-3xl font-bold text-white mb-2">
              {authMode === 'signin' ? 'Welcome Back' : 'Create Account'}
            </h1>
            <p className="text-gray-400">
              {authMode === 'signin' 
                ? 'Sign in to continue to your account' 
                : 'Sign up to get started'}
            </p>
          </div>

          {errorMessage && (
            <Alert variant="destructive" className="mt-4">
              <AlertDescription>{errorMessage}</AlertDescription>
            </Alert>
          )}

          <div className="space-y-4">
            <SocialAuth 
              isLoading={loading} 
              setLoading={setLoading}
              onError={(error) => setErrorMessage(getErrorMessage(error))}
            />

            <div className="relative">
              <div className="absolute inset-0 flex items-center">
                <Separator className="w-full border-t border-gray-600" />
              </div>
              <div className="relative flex justify-center text-xs uppercase">
                <span className="bg-[#1A1F2C] px-2 text-gray-400">Or continue with</span>
              </div>
            </div>

            <EmailAuthForm 
              mode={authMode} 
              onModeChange={toggleAuthMode}
              onError={(error) => setErrorMessage(getErrorMessage(error))} 
            />
          </div>

          <p className="text-center text-sm text-gray-400">
            By continuing, you agree to our{' '}
            <a href="#" className="text-[#9b87f5] hover:underline">Terms of Service</a>
            {' '}and{' '}
            <a href="#" className="text-[#9b87f5] hover:underline">Privacy Policy</a>
          </p>
        </div>
      </div>
    </div>
  );
};

export default Auth;

// File: src\pages\CreateThesis.tsx

// File: src/pages/CreateThesis.tsx
import { ThesisCreationForm } from "@/components/thesis/ThesisCreationForm";

const CreateThesis = () => {
  return <ThesisCreationForm />;
};

export default CreateThesis;

// File: src\pages\Index.tsx

import React from 'react';
import { useNavigate } from 'react-router-dom';
import { Button } from '@/components/ui/button';
import { Settings, Plus, LogOut } from 'lucide-react';
import { ThesisList } from '@/components/thesis/ThesisList';
import { GettingStartedWizard } from '@/components/onboarding/GettingStartedWizard';
import { StatsGrid } from '@/components/dashboard/StatsGrid';
import { ThesisProgressMap } from '@/components/dashboard/ThesisProgressMap';
import { UserProfile } from '@/components/dashboard/UserProfile';
import { Card } from '@/components/ui/card';
import { useToast } from '@/hooks/use-toast';
import { QuickTips } from '@/components/dashboard/QuickTips';
import { useAuth } from '@/contexts/AuthContext';
import { useDashboardData } from '@/hooks/useDashboardData';
import { motion } from 'framer-motion';

const Index = () => {
  console.log('ðŸ“Š Dashboard page rendering');
  const navigate = useNavigate();
  const { toast } = useToast();
  const { handleLogout, userId } = useAuth();
  const { userProfile, thesesStats, isLoading, error } = useDashboardData(userId);

  const handleCreateThesis = () => {
    navigate('/create-thesis');
    toast({
      title: "Starting New Thesis",
      description: "You're being redirected to create a new thesis.",
    });
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-[#1a1f2c] via-[#2d364d] to-[#1a1f2c] text-gray-100 flex items-center justify-center">
        <div className="animate-pulse">Loading dashboard data...</div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-[#1a1f2c] via-[#2d364d] to-[#1a1f2c] text-gray-100 flex items-center justify-center">
        <p>Error loading dashboard: {error.message}</p>
      </div>
    );
  }

  const isAdmin = userProfile?.roles?.name === 'admin';

  return (
    <div className="min-h-screen bg-gradient-to-br from-[#1a1f2c] via-[#2d364d] to-[#1a1f2c] text-gray-100 relative overflow-hidden">
      {/* Animated background elements */}
      <div className="absolute inset-0 overflow-hidden">
        <div className="absolute w-full h-full">
          {[...Array(20)].map((_, i) => (
            <motion.div
              key={i}
              className="absolute bg-white/5 rounded-full"
              style={{
                width: Math.random() * 300 + 50,
                height: Math.random() * 300 + 50,
                left: `${Math.random() * 100}%`,
                top: `${Math.random() * 100}%`,
              }}
              animate={{
                scale: [1, 1.2, 1],
                opacity: [0.1, 0.2, 0.1],
              }}
              transition={{
                duration: Math.random() * 5 + 5,
                repeat: Infinity,
                ease: "easeInOut",
              }}
            />
          ))}
        </div>
      </div>

      <div className="container mx-auto px-4 py-8 space-y-8 relative z-10">
        {/* Header Section */}
        <div className="flex justify-between items-center">
          <div className="space-y-1">
            <h1 className="text-4xl font-serif font-bold bg-clip-text text-transparent bg-gradient-to-r from-[#9b87f5] to-[#D6BCFA]">
              Dashboard
            </h1>
            <p className="text-[#D6BCFA]/80 font-sans">
              Manage your thesis projects and track progress
            </p>
          </div>
          <div className="flex items-center gap-4">
            <Button 
              onClick={handleLogout}
              variant="outline"
              className="bg-red-500/10 hover:bg-red-500/20 text-red-400 border-red-400/20 font-sans"
            >
              <LogOut className="w-4 h-4 mr-2" />
              Logout
            </Button>
            {isAdmin && (
              <Button 
                onClick={() => navigate('/admin')} 
                variant="outline"
                className="bg-[#7E69AB]/10 hover:bg-[#7E69AB]/20 text-[#D6BCFA] border-[#D6BCFA]/20 font-sans"
              >
                <Settings className="w-4 h-4 mr-2" />
                Admin Panel
              </Button>
            )}
          </div>
        </div>

        {/* User Profile Section */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5 }}
          className="backdrop-blur-xl bg-white/5 rounded-xl border border-white/10 p-6 transition-all duration-200 hover:bg-white/10"
        >
          <UserProfile 
            email={userProfile?.email || 'Loading...'}
            role={userProfile?.roles?.name || 'user'}
          />
        </motion.div>
        
        {/* Stats Grid */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5, delay: 0.2 }}
        >
          <StatsGrid stats={thesesStats || { total: 0, inProgress: 0, completed: 0 }} />
        </motion.div>

        {/* Thesis Progress Map */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5, delay: 0.4 }}
        >
          <ThesisProgressMap stats={thesesStats || { total: 0, inProgress: 0, completed: 0 }} />
        </motion.div>

        {/* Main Content Grid */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          {/* Left Column - Thesis Management */}
          <motion.div 
            initial={{ opacity: 0, x: -20 }}
            animate={{ opacity: 1, x: 0 }}
            transition={{ duration: 0.5, delay: 0.6 }}
            className="space-y-6"
          >
            <div className="backdrop-blur-xl bg-white/5 rounded-xl border border-white/10 p-6">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-serif font-semibold text-[#D6BCFA]">
                  Thesis Management
                </h2>
                <Button
                  onClick={handleCreateThesis}
                  className="bg-[#9b87f5] hover:bg-[#7E69AB] text-white font-sans"
                >
                  <Plus className="w-4 h-4 mr-2" />
                  Create New Thesis
                </Button>
              </div>
              <Card className="bg-white/5 border-[#D6BCFA]/20">
                <ThesisList />
              </Card>
            </div>
          </motion.div>

          {/* Right Column - Quick Tips and Getting Started */}
          <motion.div 
            initial={{ opacity: 0, x: 20 }}
            animate={{ opacity: 1, x: 0 }}
            transition={{ duration: 0.5, delay: 0.8 }}
            className="space-y-6"
          >
            <div className="backdrop-blur-xl bg-white/5 rounded-xl border border-white/10 p-6">
              <QuickTips />
            </div>
            <div className="backdrop-blur-xl bg-white/5 rounded-xl border border-white/10 p-6">
              <GettingStartedWizard />
            </div>
          </motion.div>
        </div>
      </div>
    </div>
  );
};

export default Index;

// File: src\pages\LandingPage.tsx

import React from "react";
import { HeroSection } from "@/components/landing/HeroSection";
import { FeaturesSection } from "@/components/landing/FeaturesSection";
import { PricingSection } from "@/components/landing/PricingSection";
import { Footer } from "@/components/landing/Footer";
import EnhancedThesisViz from "@/components/landing/visualization/EnhancedThesisViz";
import { Navbar } from "@/components/shared/Navbar";

const LandingPage = () => {
  return (
    <div className="min-h-screen bg-gradient-to-b from-gray-50 to-white">
      <Navbar />
      <div className="pt-16"> {/* Add padding-top to account for fixed navbar */}
        <HeroSection />
        <div className="relative py-32 overflow-hidden">
          <div className="absolute inset-0 bg-gradient-to-b from-white via-gray-50 to-white opacity-50" />
          <div className="relative max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8">
            <div className="text-center mb-16">
              <h2 className="text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl">
                Visualize Your Progress
              </h2>
              <p className="mt-4 text-lg leading-8 text-gray-600 max-w-2xl mx-auto">
                Track your thesis development with our interactive visualization tool. 
                Monitor progress, collaborate with team members, and stay on top of deadlines.
              </p>
            </div>
            <div className="bg-white/50 backdrop-blur-sm rounded-3xl shadow-xl p-8">
              <EnhancedThesisViz />
            </div>
          </div>
        </div>
        <FeaturesSection />
        <PricingSection />
        <Footer />
      </div>
    </div>
  );
};

export default LandingPage;

// File: src\pages\SectionEditor.tsx

import React from 'react';
import { useParams } from 'react-router-dom';
import { useToast } from '@/hooks/use-toast';
import { Card } from '@/components/ui/card';
import { MarkdownEditor } from '@/components/MarkdownEditor';
import { useThesisData } from '@/hooks/useThesisData';

export default function SectionEditor() {
  const { thesisId, sectionId } = useParams();
  const { thesis, setThesis } = useThesisData(thesisId);
  const { toast } = useToast();

  console.log('SectionEditor rendering:', { thesisId, sectionId });

  if (!thesis) return null;

  const findSection = () => {
    // Check if it's the general introduction
    if (thesis.generalIntroduction?.id === sectionId || sectionId === 'general-introduction') {
      return thesis.generalIntroduction;
    }

    // Check if it's the general conclusion
    if (thesis.generalConclusion?.id === sectionId || sectionId === 'general-conclusion') {
      return thesis.generalConclusion;
    }

    // Check front matter
    const frontMatterSection = thesis.frontMatter.find(s => s.id === sectionId);
    if (frontMatterSection) return frontMatterSection;

    // Check back matter
    const backMatterSection = thesis.backMatter.find(s => s.id === sectionId);
    if (backMatterSection) return backMatterSection;

    // Check chapters
    for (const chapter of thesis.chapters) {
      const section = chapter.sections.find(s => s.id === sectionId);
      if (section) return section;
    }

    return null;
  };

  const section = findSection();

  if (!section) {
    return (
      <div className="p-8">
        <h1 className="text-2xl font-bold text-red-500">Section not found</h1>
        <p className="mt-4 text-gray-600">The requested section could not be found. Please check the URL and try again.</p>
      </div>
    );
  }

  const handleContentChange = (newContent: string) => {
    const updatedThesis = { ...thesis };
    
    // Update general introduction
    if (thesis.generalIntroduction?.id === sectionId || sectionId === 'general-introduction') {
      updatedThesis.generalIntroduction = {
        ...thesis.generalIntroduction!,
        content: newContent
      };
    }
    // Update general conclusion
    else if (thesis.generalConclusion?.id === sectionId || sectionId === 'general-conclusion') {
      updatedThesis.generalConclusion = {
        ...thesis.generalConclusion!,
        content: newContent
      };
    }
    // Update front matter
    else {
      const frontMatterIndex = thesis.frontMatter.findIndex(s => s.id === sectionId);
      if (frontMatterIndex !== -1) {
        updatedThesis.frontMatter[frontMatterIndex] = {
          ...thesis.frontMatter[frontMatterIndex],
          content: newContent
        };
      }

      // Update back matter
      const backMatterIndex = thesis.backMatter.findIndex(s => s.id === sectionId);
      if (backMatterIndex !== -1) {
        updatedThesis.backMatter[backMatterIndex] = {
          ...thesis.backMatter[backMatterIndex],
          content: newContent
        };
      }

      // Update chapters
      updatedThesis.chapters = thesis.chapters.map(chapter => ({
        ...chapter,
        sections: chapter.sections.map(s => 
          s.id === sectionId ? { ...s, content: newContent } : s
        )
      }));
    }

    setThesis(updatedThesis);
    toast({
      title: "Success",
      description: "Section content updated",
    });
  };

  return (
    <div className="container mx-auto p-8">
      <Card className="p-6">
        <h1 className="text-2xl font-bold mb-6">{section.title}</h1>
        <MarkdownEditor
          value={section.content}
          onChange={handleContentChange}
          placeholder="Start writing your section content..."
        />
      </Card>
    </div>
  );
}

// File: src\Routes.tsx

import { Routes as RouterRoutes, Route } from 'react-router-dom';
import Index from '@/pages/Index';
import Auth from '@/pages/Auth';
import CreateThesis from '@/pages/CreateThesis';
import AdminPanel from '@/pages/AdminPanel';
import LandingPage from '@/pages/LandingPage';
import { useAuth } from '@/contexts/AuthContext';
import { ThesisEditor } from '@/components/ThesisEditor';
import SectionEditor from '@/components/thesis/section/EditorSection';

const Routes = () => {
  const { isAuthenticated, loading } = useAuth();
  
  console.log('ðŸ” Auth state:', { isAuthenticated, loading });

  if (loading) {
    return (
      <div className="min-h-screen bg-[#1A1F2C] flex items-center justify-center">
        <p className="text-white">Loading...</p>
      </div>
    );
  }

  return (
    <RouterRoutes>
      {isAuthenticated ? (
        <>
          <Route path="/" element={<Index />} />
          <Route path="/create-thesis" element={<CreateThesis />} />
          <Route path="/admin" element={<AdminPanel />} />
          <Route path="/thesis/:thesisId" element={<ThesisEditor />} />
          <Route path="/thesis/:thesisId/sections/:sectionId" element={<SectionEditor />} />
          <Route path="/thesis/:thesisId/section/:sectionId" element={<SectionEditor />} />
          <Route path="*" element={<Index />} />
        </>
      ) : (
        <>
          <Route path="/" element={<LandingPage />} />
          <Route path="/auth" element={<Auth />} />
          <Route path="*" element={<LandingPage />} />
        </>
      )}
    </RouterRoutes>
  );
};

export default Routes;

// File: src\tests\thesisCreation.test.ts

import { render, screen, fireEvent } from '@testing-library/react';
import { ThesisCreationModal } from '../components/thesis/ThesisCreationModal';
import { supabase } from '../integrations/supabase/client';

jest.mock('../integrations/supabase/client');

describe('ThesisCreationModal', () => {
  beforeEach(() => {
    // Mock the supabase.auth.getSession to return a user session
    jest.spyOn(supabase.auth, 'getSession').mockResolvedValue({
      data: { session: { user: { id: 'user-id' } } },
    });
  });

  test('creates a thesis and redirects', async () => {
    render(<ThesisCreationModal />);

    // Simulate selecting a template
    const template = { structure: { frontMatter: [], chapters: [], backMatter: [] } };
    fireEvent.click(screen.getByText('New Thesis'));
    fireEvent.click(screen.getByText('Choose a Template'));

    // Simulate the creation process
    await fireEvent.click(screen.getByText('Create Thesis')); // Adjust this to match the button text

    // Check if the thesis was created and the redirection occurred
    expect(supabase.from).toHaveBeenCalledWith('theses');
    expect(supabase.from('theses').insert).toHaveBeenCalled();
  });
});


// File: src\types\chat.d.ts

export interface Message {
  id: string;
  content: string;
  sender_id: string;
  created_at: string;
  thesis_id: string;
}

export interface ChatMessage extends Message {
  sender?: {
    id: string;
    email: string;
  };
}

// File: src\types\collaborator.ts

import { Profile } from './profile';

export type CollaboratorRole = 'owner' | 'editor' | 'viewer' | 'admin';

export interface Collaborator {
  user_id: string;
  role: CollaboratorRole;
  created_at?: string;
  profiles: {
    email: string;
    role: string;
    roles?: {
      name: string;
    };
  };
}

export interface CollaboratorWithProfile extends Omit<Collaborator, 'profiles'> {
  profiles: Profile & {
    roles?: {
      name: string;
    };
  };
}

// File: src\types\common.ts

import { ReactNode } from 'react';

export interface BaseProps {
  children?: ReactNode;
  className?: string;
}

export interface WithId {
  id: string;
}

export interface WithTimestamps {
  created_at: string;
  updated_at?: string;
}

export interface WithUser {
  user_id: string;
}

export type Status = 'active' | 'inactive' | 'pending' | 'completed';

// File: src\types\components.ts

import { Citation, Reference, Figure, Table } from './thesis';

export interface CitationManagerProps {
  citations: Citation[];
  onCitationSelect?: (citation: Citation) => void;
  selectedCitation?: Citation | null;
  onCitationCreate?: (citation: Citation) => void;
  onCitationUpdate?: (citation: Citation) => void;
  onCitationDelete?: (citation: Citation) => void;
  thesisId: string;
  onAddCitation?: (citation: any) => void;
  onRemoveCitation?: (id: any) => void;
  onUpdateCitation?: (citation: any) => void;
}

export interface ReferenceManagerProps {
  items: Reference[];
  onAdd: (reference: Reference) => void;
  onRemove: (id: string) => void;
  onUpdate: (reference: Reference) => void;
}

export interface SectionProps {
  section: {
    id: string;
    title: string;
    content: string;
    type?: string;
    order?: number;
    figures?: Figure[];
    tables?: Table[];
    citations?: Citation[];
    required?: boolean;
    references?: Reference[];
  };
  isActive: boolean;
  onContentChange: (id: string, content: string) => void;
  onTitleChange: (id: string, title: string) => void;
}

export interface ThesisProps {
  thesis: {
    id: string;
    title: string;
    content: any;
  };
  activeSection: string;
  onSectionSelect: (id: string) => void;
}

export interface ThesisEditorProps {
  thesisId?: string;
}

export interface ThesisPreviewProps {
  thesis: {
    id: string;
    title: string;
    content: any;
  };
  language?: 'en' | 'fr';
}

export interface ThesisSidebarProps {
  sections: Array<{
    id: string;
    title: string;
    content: string;
  }>;
  activeSection: string;
  onSectionSelect: (id: string) => void;
}

export interface ThesisContentProps {
  frontMatter: Array<{
    id: string;
    title: string;
    content: string;
  }>;
  chapters: Array<{
    id: string;
    title: string;
    content: string;
  }>;
  backMatter: Array<{
    id: string;
    title: string;
    content: string;
  }>;
  activeSection: string;
  onContentChange: (id: string, content: string) => void;
  onTitleChange: (id: string, title: string) => void;
  onUpdateChapter: (chapter: any) => void;
  onAddChapter: (chapter: any) => void;
  thesisId: string;
}

export interface ThesisEditorMainProps {
  thesis: {
    id: string;
    title: string;
    content: any;
  } | null;
  activeSection: string;
  showPreview: boolean;
  previewRef: React.RefObject<HTMLDivElement>;
  onContentChange: (id: string, content: string) => void;
  onTitleChange: (id: string, title: string) => void;
  onUpdateChapter: (chapter: any) => void;
  onAddChapter: (chapter: any) => void;
}

// File: src\types\forms.ts

export interface FormField {
  name: string;
  label: string;
  type: 'text' | 'email' | 'password' | 'number' | 'date' | 'textarea';
  placeholder?: string;
  required?: boolean;
  validation?: {
    required?: string;
    pattern?: {
      value: RegExp;
      message: string;
    };
    minLength?: {
      value: number;
      message: string;
    };
    maxLength?: {
      value: number;
      message: string;
    };
  };
}

export interface FormConfig {
  fields: FormField[];
  onSubmit: (data: any) => Promise<void>;
  submitText?: string;
}

export interface ValidationError {
  field: string;
  message: string;
}

export interface FormState {
  isSubmitting: boolean;
  errors: ValidationError[];
}

// File: src\types\hooks.ts

import { UseQueryResult } from '@tanstack/react-query';
import { Thesis, Chapter, Section } from './thesis';

export interface UseThesisResult {
  thesis: Thesis | null;
  isLoading: boolean;
  error: Error | null;
  setThesis: (thesis: Thesis | ((prev: Thesis | null) => Thesis | null)) => void;
}

export interface UseChapterResult {
  chapter: Chapter | null;
  isLoading: boolean;
  error: Error | null;
  updateChapter: (chapter: Chapter) => Promise<void>;
}

export interface UseSectionResult {
  section: Section | null;
  isLoading: boolean;
  error: Error | null;
  updateSection: (section: Section) => Promise<void>;
}

export type QueryResult<T> = UseQueryResult<T, Error>;

// File: src\types\profile.ts

export interface Profile {
  id: string;
  email: string;
  created_at?: string;
  role_id?: string;
  roles?: {
    name: string;
  };
}

// File: src\types\thesis.d.ts

export interface Thesis {
  id: string;
  title: string;
  generalIntroduction?: Section;
  generalConclusion?: Section;
  frontMatter: Section[];
  chapters: Chapter[];
  backMatter: Section[];
}

export interface Chapter {
  id: string;
  title: string;
  sections: Section[];
  thesis_id: string;
}

export interface Section {
  id: string;
  title: string;
  content: string;
  type: string;
  required?: boolean;
  order?: number;
  status?: 'draft' | 'in_review' | 'published';
  created_at?: string;
  updated_at?: string;
  figures?: Figure[];
  tables?: Table[];
  citations?: Citation[];
  references?: Reference[];
  footnotes?: Footnote[];
}

export interface Footnote {
  id: string;
  text: string;
}

export interface CommentThread {
  id: string;
  comments: Comment[];
  section_id: string;
  created_at: string;
}

export interface Comment {
  id: string;
  text: string;
  author: string;
  created_at: string;
}

export interface Figure {
  id: string;
  caption: string;
  url: string;
}

export interface Table {
  id: string;
  caption: string;
  data: any;
}

export interface Citation {
  id: string;
  reference_id: string;
  text: string;
}

export interface Reference {
  id: string;
  title: string;
  authors: string[];
  year: string;
  type: string;
  url?: string;
}


// File: src\types\thesis.ts

// Enums for type safety
export enum CitationType {
  BOOK = 'book',
  ARTICLE = 'article',
  CONFERENCE = 'conference',
  WEBSITE = 'website',
  OTHER = 'other'
}

export enum SectionType {
  ABSTRACT = 'abstract',
  GENERAL_INTRODUCTION = 'general-introduction',
  INTRODUCTION = 'introduction',
  CHAPTER = 'chapter',
  CONCLUSION = 'conclusion',
  GENERAL_CONCLUSION = 'general-conclusion',
  REFERENCES = 'references',
  APPENDIX = 'appendix',
  TABLE_OF_CONTENTS = 'table-of-contents',
  ACKNOWLEDGMENTS = 'acknowledgments',
  CUSTOM = 'custom',
  TITLE = 'title'
}

export enum ElementPosition {
  INLINE = 'inline',
  FLOAT_LEFT = 'float-left',
  FLOAT_RIGHT = 'float-right',
  CENTER = 'center'
}

// Base interface for common fields
interface BaseEntity {
  id: string;
  created_at: string;
  updated_at: string;
}

// Author information
export interface Author {
  firstName: string;
  lastName: string;
  email?: string;
  affiliation?: string;
  toString(): string;
}

// Structured content type
export interface StructuredContent {
  type: 'paragraph' | 'heading' | 'list' | 'quote' | 'code';
  content: string;
  metadata?: Record<string, unknown>;
}

export interface Citation extends BaseEntity {
  text: string;
  source: string;
  authors: string[];
  year: string;
  type: CitationType;
  doi?: string;
  url?: string;
  journal?: string;
  volume?: string;
  issue?: string;
  pages?: string;
  publisher?: string;
  thesis_id: string;
  title: string;
  author_last_names?: string[];
  author_first_initials?: string[];
  author_middle_initials?: string[];
  specific_date?: string;
  container_title?: string;
  edition?: string;
}

export interface Reference extends BaseEntity {
  text: string;
  title: string;
  source: string;
  authors: string[];
  year: string;
  type: CitationType;
  doi?: string;
  url?: string;
  journal?: string;
  volume?: string;
  issue?: string;
  pages?: string;
  publisher?: string;
  specific_date?: string;
  container_title?: string;
  edition?: string;
}

export interface Figure extends BaseEntity {
  url: string;
  caption: string;
  alt_text: string;
  title: string;
  label: string;
  position: ElementPosition;
  dimensions: {
    width: number;
    height: number;
  };
  metadata?: {
    source?: string;
    copyright?: string;
    notes?: string;
  };
}

export interface TableCell {
  content: string;
  rowSpan?: number;
  colSpan?: number;
  header?: boolean;
}

export interface Table extends BaseEntity {
  title: string;
  caption: string;
  content: string;
  data: TableCell[][];
  metadata?: {
    source?: string;
    notes?: string;
  };
}

export interface Footnote extends BaseEntity {
  content: string;
  number: number;
  thesis_id: string;
  section_id: string;
}

export interface Section extends BaseEntity {
  title: string;
  content: string;
  type: SectionType;
  order: number;
  required: boolean;
  figures: Figure[];
  tables: Table[];
  citations: Citation[];
  references: Reference[];
  footnotes?: Footnote[];
  metadata?: {
    keywords?: string[];
    abstract?: string;
    language?: string;
  };
}

export interface Chapter extends BaseEntity {
  title: string;
  content: string;
  sections: Section[];
  order: number;
  figures: Figure[];
  tables: Table[];
  citations: Citation[];
  references: Reference[];
  metadata?: {
    keywords?: string[];
    abstract?: string;
  };
}

export interface ThesisMetadata {
  description: string;
  keywords: string[];
  createdAt: string;
  universityName: string;
  departmentName: string;
  authors: Author[];
  supervisors: Author[];
  committeeMembers: Author[];
  thesisDate: string;
  language: string;
  version: string;
  license?: string;
  fundingInformation?: string[];
}

export interface ThesisContent {
  metadata: ThesisMetadata;
  frontMatter: Section[];
  generalIntroduction?: Section;
  chapters: Chapter[];
  generalConclusion?: Section;
  backMatter: Section[];
}

export interface Thesis extends BaseEntity {
  title: string;
  content: ThesisContent;
  metadata: ThesisMetadata;
  frontMatter: Section[];
  generalIntroduction?: Section;
  chapters: Chapter[];
  generalConclusion?: Section;
  backMatter: Section[];
  user_id: string;
  language: string;
  status: 'draft' | 'in_review' | 'published';
  version: string;
  permissions: {
    isPublic: boolean;
    allowComments: boolean;
    allowSharing: boolean;
  };
  description?: string;
}

export interface ThesisVersion extends BaseEntity {
  thesis_id: string;
  content: ThesisContent;
  version_number: number;
  description?: string;
  created_by: string;
  changes: {
    type: 'addition' | 'deletion' | 'modification';
    path: string;
    description: string;
  }[];
  version?: string;
}

export interface CommentThread extends BaseEntity {
  comments: Comment[];
  section_id: string;
  status: 'open' | 'resolved' | 'archived';
  metadata?: {
    context?: string;
    tags?: string[];
  };
}

export interface Comment extends BaseEntity {
  content: string;
  user_id: string;
  thread_id: string;
  parent_id?: string;
  edited?: boolean;
  reactions?: Record<string, string[]>;
}

// File: src\utils\authorUtils.ts

import { Author } from '@/types/thesis';

export const authorToString = (author: Author): string => {
  return `${author.lastName}, ${author.firstName}${author.affiliation ? ` (${author.affiliation})` : ''}`;
};

// Helper to create an Author object
export const createAuthor = (
  firstName: string,
  lastName: string,
  email?: string,
  affiliation?: string
): Author => ({
  firstName,
  lastName,
  email,
  affiliation,
  toString: function() {
    return authorToString(this);
  }
});

// File: src\utils\commentTransforms.ts

import { Comment } from '@/types/thesis';

export const transformComment = (rawComment: any): Comment => {
  return {
    id: rawComment.id,
    content: rawComment.content?.text || '',
    user_id: rawComment.reviewer_id,
    created_at: rawComment.created_at
  };
};

// File: src\utils\conversion.ts

import { convertInchesToTwip as docxConvertInchesToTwip } from 'docx';

export const convertInchesToTwip = (inches: number): number => {
  return docxConvertInchesToTwip(inches);
};

// File: src\utils\docx\contentGenerators.ts

import { Document, Paragraph, TextRun, ImageRun, HeadingLevel, TableOfContents, IImageOptions } from 'docx';
import { Thesis, Section, Chapter } from '@/types/thesis';

export const generateImageParagraph = async (imageData: Buffer, caption: string) => {
  const imageOptions: IImageOptions = {
    data: imageData,
    transformation: {
      width: 400,
      height: 300,
    },
    type: 'png'
  };

  const image = new ImageRun(imageOptions);

  return new Paragraph({
    children: [
      image,
      new TextRun({
        text: caption,
        break: 1
      })
    ]
  });
};

export const generateTableOfContents = () => {
  return new TableOfContents("Table of Contents", {
    hyperlink: true,
    headingStyleRange: "1-5",
  });
};

export const generateContent = async ({ thesis, isPreview = false }: { thesis: Thesis, isPreview?: boolean }): Promise<Paragraph[]> => {
  const content: Paragraph[] = [];

  // Validate thesis structure
  if (!thesis || typeof thesis !== 'object') {
    throw new Error('Invalid thesis object');
  }
  if (!Array.isArray(thesis.frontMatter)) {
    throw new Error('Invalid front matter structure');
  }
  if (!Array.isArray(thesis.chapters)) {
    throw new Error('Invalid chapters structure');
  }
  if (!Array.isArray(thesis.backMatter)) {
    throw new Error('Invalid back matter structure');
  }
  if (thesis.chapters.some(chapter => !Array.isArray(chapter.sections))) {
    throw new Error('Invalid chapter sections structure');
  }
  if (thesis.frontMatter.some(section => typeof section !== 'object')) {
    throw new Error('Invalid front matter section structure');
  }
  if (thesis.backMatter.some(section => typeof section !== 'object')) {
    throw new Error('Invalid back matter section structure');
  }
  if (thesis.chapters.some(chapter => typeof chapter !== 'object')) {
    throw new Error('Invalid chapter structure');
  }
  if (thesis.chapters.some(chapter => chapter.sections.some(section => typeof section !== 'object'))) {
    throw new Error('Invalid chapter section structure');
  }

  // Add general introduction if exists
  if (thesis.generalIntroduction) {
    content.push(new Paragraph({
      text: thesis.generalIntroduction.title,
      heading: HeadingLevel.HEADING_1,
    }));
    content.push(new Paragraph({
      text: thesis.generalIntroduction.content
    }));
  }

  // Add front matter sections
  thesis.frontMatter.forEach(section => {
    content.push(new Paragraph({
      text: section.title,
      heading: HeadingLevel.HEADING_2,
    }));
    content.push(new Paragraph({
      text: section.content
    }));
  });

  // Add chapters
  thesis.chapters.forEach(chapter => {
    content.push(new Paragraph({
      text: chapter.title,
      heading: HeadingLevel.HEADING_1,
    }));

    chapter.sections.forEach(section => {
      content.push(new Paragraph({
        text: section.title,
        heading: HeadingLevel.HEADING_2,
      }));
      content.push(new Paragraph({
        text: section.content
      }));
    });
  });

  // Add general conclusion if exists
  if (thesis.generalConclusion) {
    content.push(new Paragraph({
      text: thesis.generalConclusion.title,
      heading: HeadingLevel.HEADING_1,
    }));
    content.push(new Paragraph({
      text: thesis.generalConclusion.content
    }));
  }

  // Add back matter sections
  thesis.backMatter.forEach(section => {
    content.push(new Paragraph({
      text: section.title,
      heading: HeadingLevel.HEADING_2,
    }));
    content.push(new Paragraph({
      text: section.content
    }));
  });

  return content;
};

// File: src\utils\docx\imageUtils.ts

export const convertImageToBase64 = async (imageUrl: string): Promise<string> => {
  try {
    const response = await fetch(imageUrl);
    const blob = await response.blob();
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => {
        const base64data = reader.result as string;
        resolve(base64data.split(',')[1]); // Remove data URL prefix
      };
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  } catch (error) {
    console.error('Error converting image to base64:', error);
    throw error;
  }
};

// File: src\utils\docx\styleConfig.ts

import { 
  IStylesOptions, 
  convertInchesToTwip,
  HeadingLevel,
  AlignmentType
} from 'docx';

export const defaultStyles: IStylesOptions = {
  default: {
    document: {
      run: {
        font: 'Times New Roman',
        size: 24,
      },
      paragraph: {
        spacing: { line: 360, before: 240, after: 240 },
      },
    },
    heading1: {
      run: {
        font: 'Times New Roman',
        size: 32,
        bold: true,
      },
      paragraph: {
        spacing: { before: convertInchesToTwip(1), after: convertInchesToTwip(0.5) },
        alignment: AlignmentType.CENTER,
      },
    },
    heading2: {
      run: {
        font: 'Times New Roman',
        size: 28,
        bold: true,
      },
      paragraph: {
        spacing: { before: convertInchesToTwip(0.75), after: convertInchesToTwip(0.5) },
      },
    },
    heading3: {
      run: {
        font: 'Times New Roman',
        size: 26,
        bold: true,
      },
      paragraph: {
        spacing: { before: convertInchesToTwip(0.5), after: convertInchesToTwip(0.25) },
      },
    },
  },
  paragraphStyles: [
    {
      id: 'title',
      name: 'Title',
      basedOn: 'Normal',
      next: 'Normal',
      quickFormat: true,
      run: {
        font: 'Times New Roman',
        size: 36,
        bold: true,
      },
      paragraph: {
        alignment: AlignmentType.CENTER,
        spacing: { before: convertInchesToTwip(1), after: convertInchesToTwip(1) },
      },
    },
    {
      id: 'subtitle',
      name: 'Subtitle',
      basedOn: 'Normal',
      next: 'Normal',
      quickFormat: true,
      run: {
        font: 'Times New Roman',
        size: 28,
        italics: true,
      },
      paragraph: {
        alignment: AlignmentType.CENTER,
        spacing: { before: convertInchesToTwip(0.5), after: convertInchesToTwip(0.5) },
      },
    },
    {
      id: 'footnote',
      name: 'Footnote',
      basedOn: 'Normal',
      next: 'Normal',
      quickFormat: true,
      run: {
        font: 'Times New Roman',
        size: 20,
      },
      paragraph: {
        indent: { left: convertInchesToTwip(0.5) },
        spacing: { before: convertInchesToTwip(0.25), after: convertInchesToTwip(0.25) },
      },
    },
  ],
};

export const previewStyles: IStylesOptions = {
  default: {
    document: {
      run: {
        font: 'Arial',
        size: 24,
      },
      paragraph: {
        spacing: { line: 360, before: 240, after: 240 },
      },
    },
    heading1: {
      run: {
        font: 'Arial',
        size: 32,
        bold: true,
      },
      paragraph: {
        spacing: { before: convertInchesToTwip(1), after: convertInchesToTwip(0.5) },
        alignment: AlignmentType.CENTER,
      },
    },
    heading2: {
      run: {
        font: 'Arial',
        size: 28,
        bold: true,
      },
      paragraph: {
        spacing: { before: convertInchesToTwip(0.75), after: convertInchesToTwip(0.5) },
      },
    },
    heading3: {
      run: {
        font: 'Arial',
        size: 26,
        bold: true,
      },
      paragraph: {
        spacing: { before: convertInchesToTwip(0.5), after: convertInchesToTwip(0.25) },
      },
    },
  },
  paragraphStyles: [
    {
      id: 'title',
      name: 'Title',
      basedOn: 'Normal',
      next: 'Normal',
      quickFormat: true,
      run: {
        font: 'Arial',
        size: 36,
        bold: true,
      },
      paragraph: {
        alignment: AlignmentType.CENTER,
        spacing: { before: convertInchesToTwip(1), after: convertInchesToTwip(1) },
      },
    },
    {
      id: 'subtitle',
      name: 'Subtitle',
      basedOn: 'Normal',
      next: 'Normal',
      quickFormat: true,
      run: {
        font: 'Arial',
        size: 28,
        italics: true,
      },
      paragraph: {
        alignment: AlignmentType.CENTER,
        spacing: { before: convertInchesToTwip(0.5), after: convertInchesToTwip(0.5) },
      },
    },
    {
      id: 'footnote',
      name: 'Footnote',
      basedOn: 'Normal',
      next: 'Normal',
      quickFormat: true,
      run: {
        font: 'Arial',
        size: 20,
      },
      paragraph: {
        indent: { left: convertInchesToTwip(0.5) },
        spacing: { before: convertInchesToTwip(0.25), after: convertInchesToTwip(0.25) },
      },
    },
  ],
};

// File: src\utils\docx\titlePageGenerator.ts

import { Document, Paragraph, TextRun, HeadingLevel, AlignmentType, convertInchesToTwip } from 'docx';
import { TitlePageOptions } from './types';
import { defaultStyles } from './styleConfig';

export const generateTitlePage = ({ thesis, language = 'en' }: TitlePageOptions): Paragraph[] => {
  const { metadata } = thesis;
  const paragraphs: Paragraph[] = [];

  // Find title from frontMatter
  const titleSection = thesis.frontMatter.find(section => section.type === 'title');
  const titleText = titleSection?.content || 'Untitled Thesis';

  // University Logo Space
  paragraphs.push(
    new Paragraph({
      text: '',
      spacing: { before: convertInchesToTwip(1), after: convertInchesToTwip(0.5) },
    })
  );

  // University Name
  if (metadata.universityName) {
    paragraphs.push(
      new Paragraph({
        text: metadata.universityName.toUpperCase(),
        alignment: AlignmentType.CENTER,
        spacing: { before: convertInchesToTwip(0.5), after: convertInchesToTwip(0.25) },
        style: 'title',
      })
    );
  }

  // Department
  if (metadata.departmentName) {
    paragraphs.push(
      new Paragraph({
        text: metadata.departmentName,
        alignment: AlignmentType.CENTER,
        spacing: { before: convertInchesToTwip(0.25), after: convertInchesToTwip(1) },
        style: 'subtitle',
      })
    );
  }

  // Thesis Title
  paragraphs.push(
    new Paragraph({
      text: titleText,
      style: 'title',
      alignment: AlignmentType.CENTER,
      spacing: { before: convertInchesToTwip(2), after: convertInchesToTwip(1) },
    })
  );

  // Description (if available)
  if (metadata.description) {
    paragraphs.push(
      new Paragraph({
        text: metadata.description,
        alignment: AlignmentType.CENTER,
        spacing: { before: convertInchesToTwip(0.5), after: convertInchesToTwip(1) },
        style: 'subtitle',
      })
    );
  }

  // Keywords (if available)
  if (metadata.keywords && metadata.keywords.length > 0) {
    paragraphs.push(
      new Paragraph({
        text: 'Keywords: ' + metadata.keywords.join(', '),
        alignment: AlignmentType.CENTER,
        spacing: { before: convertInchesToTwip(0.5), after: convertInchesToTwip(1) },
        style: 'subtitle',
      })
    );
  }

  // Thesis Statement
  paragraphs.push(
    new Paragraph({
      text: 'A thesis submitted in partial fulfillment of the requirements for the degree of',
      alignment: AlignmentType.CENTER,
      spacing: { before: convertInchesToTwip(0.5), after: convertInchesToTwip(0.25) },
      style: 'subtitle',
    }),
    new Paragraph({
      text: 'Doctor of Philosophy',
      alignment: AlignmentType.CENTER,
      spacing: { before: convertInchesToTwip(0.25), after: convertInchesToTwip(1) },
      style: 'subtitle',
    })
  );

  // Author
  if (metadata.authorName) {
    paragraphs.push(
      new Paragraph({
        text: 'by',
        alignment: AlignmentType.CENTER,
        spacing: { before: convertInchesToTwip(1), after: convertInchesToTwip(0.25) },
        style: 'Normal',
      }),
      new Paragraph({
        text: metadata.authorName,
        alignment: AlignmentType.CENTER,
        spacing: { before: convertInchesToTwip(0.25), after: convertInchesToTwip(1) },
        style: 'subtitle',
      })
    );
  }

  // Date
  if (metadata.thesisDate) {
    paragraphs.push(
      new Paragraph({
        text: new Date(metadata.thesisDate).toLocaleDateString(language === 'fr' ? 'fr-FR' : 'en-US', {
          year: 'numeric',
          month: 'long',
        }),
        alignment: AlignmentType.CENTER,
        spacing: { before: convertInchesToTwip(1), after: convertInchesToTwip(1) },
        style: 'Normal',
      })
    );
  }

  // Committee Members
  if (metadata.committeeMembers && metadata.committeeMembers.length > 0) {
    paragraphs.push(
      new Paragraph({
        text: 'Thesis Committee',
        alignment: AlignmentType.CENTER,
        spacing: { before: convertInchesToTwip(1), after: convertInchesToTwip(0.5) },
        style: 'subtitle',
      })
    );

    metadata.committeeMembers.forEach(member => {
      if (member) {
        paragraphs.push(
          new Paragraph({
            text: member,
            alignment: AlignmentType.CENTER,
            spacing: { before: convertInchesToTwip(0.25), after: convertInchesToTwip(0.25) },
            style: 'Normal',
          })
        );
      }
    });
  }

  return paragraphs;
};

// File: src\utils\docx\types.ts

import { Thesis } from '@/types/thesis';

export interface ImageOptions {
  width?: number;
  height?: number;
  altText: string;
}

export interface DocPropertiesOptions {
  name: string;
  description: string;
  title: string;
}

export interface DocxGenerationOptions {
  thesis: Thesis;
  includeTableOfContents?: boolean;
  includeTitlePage?: boolean;
}

export interface TitlePageOptions {
  thesis: Thesis;
  language?: 'en' | 'fr' | 'ar';
}

export interface ContentGenerationOptions {
  thesis: Thesis;
  includeTableOfContents?: boolean;
  isPreview?: boolean;
}

// File: src\utils\docxExport.ts

import { 
  Document, 
  TableOfContents,
  convertInchesToTwip,
  StyleLevel,
  Paragraph,
  TextRun,
  HeadingLevel,
  AlignmentType,
  Header,
  Footer,
} from 'docx';
import { Thesis } from '@/types/thesis';
import { generateTitlePage } from './docx/titlePageGenerator';
import { generateContent, generateTableOfContents } from './docx/contentGenerators';
import { defaultStyles, previewStyles } from './docx/styleConfig';

const PAGE_WIDTH = convertInchesToTwip(8.5);
const PAGE_MARGINS = {
  top: convertInchesToTwip(1),
  right: convertInchesToTwip(1),
  bottom: convertInchesToTwip(1),
  left: convertInchesToTwip(1.5),
};

const createPageNumberParagraph = (): Paragraph => {
  return new Paragraph({
    children: [
      new TextRun("Page "),
      new TextRun({
        children: ["PAGE"],
      }),
      new TextRun(" of "),
      new TextRun({
        children: ["NUMPAGES"],
      }),
    ],
    alignment: AlignmentType.CENTER,
  });
};

export const generateThesisDocx = async (thesis: Thesis) => {
  console.log('Generating academic DOCX with thesis data:', thesis);

  // Ensure thesis data is properly structured
  if (!thesis || !Array.isArray(thesis.frontMatter)) {
    console.error('Invalid thesis data structure in generateThesisDocx:', thesis);
    throw new Error('Invalid thesis data structure');
  }

  const sections = [];

  // Title Page
  const titlePageChildren = generateTitlePage({ thesis });
  if (!Array.isArray(titlePageChildren)) {
    console.error('Title page children is not an array in generateThesisDocx:', titlePageChildren);
    throw new Error('Failed to generate title page');
  }

  sections.push({
    properties: {
      page: {
        margin: PAGE_MARGINS,
        size: {
          width: PAGE_WIDTH,
          height: convertInchesToTwip(11),
        },
      },
    },
    children: titlePageChildren,
  });

  // Table of Contents and Content sections
  const contentSections = [
    {
      title: "Table of Contents",
      content: [
        new Paragraph({
          text: "Table of Contents",
          heading: HeadingLevel.HEADING_1,
          spacing: { before: 240, after: 240 },
        }),
        generateTableOfContents(),
      ],
    },
    {
      title: thesis.frontMatter[0]?.title || "Untitled Thesis",
      content: await generateContent({ thesis, isPreview: false }),
    },
  ];

  for (const section of contentSections) {
    if (!Array.isArray(section.content)) {
      console.error('Section content is not an array:', section);
      continue;
    }

    sections.push({
      properties: {
        page: {
          margin: PAGE_MARGINS,
        },
      },
      headers: {
        default: new Header({
          children: [
            new Paragraph({
              text: section.title,
              alignment: AlignmentType.CENTER,
            }),
          ],
        }),
      },
      footers: {
        default: new Footer({
          children: [createPageNumberParagraph()],
        }),
      },
      children: section.content,
    });
  }

  const doc = new Document({
    sections,
    styles: defaultStyles,
  });

  return doc;
};

export const generatePreviewDocx = async (thesis: Thesis) => {
  console.log('Generating preview-style DOCX with thesis data:', thesis);

  if (!thesis || !Array.isArray(thesis.frontMatter)) {
    console.error('Invalid thesis data structure:', thesis);
    throw new Error('Invalid thesis data structure');
  }

  const sections = [];

  // Title Page with preview styling
  sections.push({
    properties: {
      page: {
        margin: {
          top: convertInchesToTwip(1),
          right: convertInchesToTwip(1),
          bottom: convertInchesToTwip(1),
          left: convertInchesToTwip(1),
        },
      },
    },
    children: [
      new Paragraph({
        children: [
          new TextRun({
            text: thesis.frontMatter[0]?.title || "Untitled Thesis",
            size: 36,
            bold: true,
            font: 'Arial',
          }),
        ],
        alignment: AlignmentType.CENTER,
        spacing: { before: 480, after: 240 },
      }),
      // Add preview-styled metadata
      ...(thesis.metadata ? Object.entries(thesis.metadata).map(([key, value]) => 
        new Paragraph({
          text: `${key}: ${value}`,
          spacing: { before: 120, after: 120 },
          alignment: AlignmentType.CENTER,
          style: 'Normal',
        })
      ) : []),
    ],
  });

  // Table of Contents with preview styling
  sections.push({
    properties: {
      page: {
        margin: {
          top: convertInchesToTwip(1),
          right: convertInchesToTwip(1),
          bottom: convertInchesToTwip(1),
          left: convertInchesToTwip(1),
        },
      },
    },
    headers: {
      default: new Header({
        children: [
          new Paragraph({
            text: thesis.frontMatter[0]?.title || "Untitled Thesis",
            alignment: AlignmentType.CENTER,
          }),
        ],
      }),
    },
    footers: {
      default: new Footer({
        children: [createPageNumberParagraph()],
      }),
    },
    children: [
      new Paragraph({
        text: "Table of Contents",
        heading: HeadingLevel.HEADING_1,
        spacing: { before: 240, after: 240 },
      }),
      generateTableOfContents(),
    ],
  });

  // Content with preview styling
  const contentChildren = await generateContent({ thesis, isPreview: true });
  if (!Array.isArray(contentChildren)) {
    console.error('Content children is not an array:', contentChildren);
    throw new Error('Failed to generate content');
  }

  sections.push({
    properties: {
      page: {
        margin: {
          top: convertInchesToTwip(1),
          right: convertInchesToTwip(1),
          bottom: convertInchesToTwip(1),
          left: convertInchesToTwip(1),
        },
      },
    },
    headers: {
      default: new Header({
        children: [
          new Paragraph({
            text: thesis.frontMatter[0]?.title || "Untitled Thesis",
            alignment: AlignmentType.CENTER,
          }),
        ],
      }),
    },
    footers: {
      default: new Footer({
        children: [createPageNumberParagraph()],
      }),
    },
    children: contentChildren,
  });

  const doc = new Document({
    sections,
    styles: previewStyles,
  });

  return doc;
};

// File: src\utils\referenceParser.ts

interface ParsedReference {
  title: string;
  authors: string[];
  year: string;
  publisher?: string;
  journal?: string;
  volume?: string;
  issue?: string;
  pages?: string;
  doi?: string;
  url?: string;
  author_last_names: string[];
  author_first_initials: string[];
  author_middle_initials: string[];
  specific_date?: string;
  container_title?: string;
  edition?: string;
}

export const parseReference = (text: string): ParsedReference => {
  console.log('Starting reference parsing for:', text);
  
  // Remove any special characters at the start (like %%)
  const cleanText = text.trim().replace(/^[%\s]+/, '');
  
  // Extract authors and split into components
  const authorPattern = /^(.*?)\s*\(/;
  const authorMatch = cleanText.match(authorPattern);
  const authorString = authorMatch ? authorMatch[1] : '';
  
  // Split authors by comma and '&' or 'and'
  const authorNames = authorString
    .split(/,\s*(?:&|\band\b)?\s*/)
    .filter(name => name.trim().length > 0)
    .map(name => name.trim());

  // Process each author name
  const author_last_names: string[] = [];
  const author_first_initials: string[] = [];
  const author_middle_initials: string[] = [];
  
  authorNames.forEach(name => {
    // Handle names in format "LastName, FirstName MiddleName"
    const nameParts = name.split(',');
    if (nameParts.length > 1) {
      const lastName = nameParts[0].trim();
      const otherNames = nameParts[1].trim().split(' ');
      
      author_last_names.push(lastName);
      author_first_initials.push(otherNames[0]?.[0] || '');
      author_middle_initials.push(otherNames[1]?.[0] || '');
    } else {
      // Handle names in format "FirstName MiddleName LastName"
      const parts = name.split(' ').filter(p => p.length > 0);
      if (parts.length > 0) {
        author_last_names.push(parts[parts.length - 1]);
        if (parts.length > 1) {
          author_first_initials.push(parts[0][0] || '');
          if (parts.length > 2) {
            author_middle_initials.push(parts[1][0] || '');
          } else {
            author_middle_initials.push('');
          }
        }
      }
    }
  });

  // Extract year
  const yearPattern = /\((\d{4})\)/;
  const yearMatch = cleanText.match(yearPattern);
  const year = yearMatch ? yearMatch[1] : 'n.d.';

  // Extract title
  const titlePattern = /\)\.\s*(.*?)\./;
  const titleMatch = cleanText.match(titlePattern);
  const title = titleMatch ? titleMatch[1].trim() : '';

  // Extract journal/container title
  const journalPattern = /\.\s*(.*?),\s*\d/;
  const journalMatch = cleanText.match(journalPattern);
  const journal = journalMatch ? journalMatch[1].trim() : '';

  // Extract volume and issue
  const volumeIssuePattern = /,\s*(\d+)\((\d+)\)/;
  const volumeIssueMatch = cleanText.match(volumeIssuePattern);
  const volume = volumeIssueMatch ? volumeIssueMatch[1] : '';
  const issue = volumeIssueMatch ? volumeIssueMatch[2] : '';

  // Extract pages
  const pagesPattern = /,\s*(\d+(?:-\d+)?)\./;
  const pagesMatch = cleanText.match(pagesPattern);
  const pages = pagesMatch ? pagesMatch[1] : '';

  // Extract DOI or URL
  const doiPattern = /https:\/\/doi\.org\/(.*?)(?:\s|$)/;
  const doiMatch = cleanText.match(doiPattern);
  const doi = doiMatch ? doiMatch[1] : '';
  
  const urlPattern = /(https?:\/\/[^\s]+)(?:\s|$)/;
  const urlMatch = cleanText.match(urlPattern);
  const url = urlMatch ? urlMatch[1] : '';

  console.log('Parsed reference result:', {
    authors: authorNames,
    author_last_names,
    author_first_initials,
    author_middle_initials,
    year,
    title,
    journal,
    volume,
    issue,
    pages,
    doi,
    url
  });

  return {
    authors: authorNames,
    author_last_names,
    author_first_initials,
    author_middle_initials,
    year,
    title,
    journal,
    volume,
    issue,
    pages,
    doi,
    url,
    specific_date: undefined,
    container_title: journal,
    edition: undefined
  };
};

// File: src\utils\thesisStructure.ts

export const frenchThesisSections = {
  frontMatter: [
    { type: 'title', title: 'Page de garde', required: true },
    { type: 'preface', title: 'Avant-propos', required: false },
    { type: 'preface', title: 'PrÃ©face', required: false },
    { type: 'acknowledgments', title: 'Remerciements', required: false },
    { type: 'abstract', title: 'RÃ©sumÃ©', required: true },
    { type: 'table-of-contents', title: 'Sommaire', required: true },
    { type: 'list-of-figures', title: 'Liste des tableaux et figures', required: true },
    { type: 'abbreviations', title: 'Liste des abrÃ©viations', required: false },
    { type: 'glossary', title: 'Glossaire', required: false }
  ],
  mainMatter: [
    { type: 'introduction', title: 'Introduction', required: true },
    { type: 'literature-review', title: 'Revue de littÃ©rature', required: true },
    { type: 'methodology', title: 'MÃ©thodologie', required: true },
    { type: 'results', title: 'RÃ©sultats', required: true },
    { type: 'discussion', title: 'Discussion', required: true },
    { type: 'conclusion', title: 'Conclusion', required: true },
    { type: 'recommendations', title: 'Recommandations', required: false }
  ],
  backMatter: [
    { type: 'postface', title: 'Postface', required: false },
    { type: 'references', title: 'Bibliographie', required: true },
    { type: 'appendix', title: 'Annexes', required: false },
    { type: 'advice', title: 'Conseils', required: false }
  ]
};

export const arabicThesisSections = {
  frontMatter: [
    { type: 'title', title: 'ØµÙØ­Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', required: true },
    { type: 'abstract', title: 'Ù…Ù„Ø®Øµ', required: true },
    { type: 'acknowledgments', title: 'Ø´ÙƒØ± ÙˆØªÙ‚Ø¯ÙŠØ±', required: false },
    { type: 'table-of-contents', title: 'Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª', required: true },
    { type: 'list-of-figures', title: 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø´ÙƒØ§Ù„', required: true },
    { type: 'list-of-tables', title: 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„', required: true },
    { type: 'abbreviations', title: 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª', required: false }
  ],
  mainMatter: [
    { type: 'introduction', title: 'Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©', required: true },
    { type: 'theoretical-framework', title: 'Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ù†Ø¸Ø±ÙŠ', required: true },
    { type: 'methodology', title: 'Ù…Ù†Ù‡Ø¬ÙŠØ© Ø§Ù„Ø¨Ø­Ø«', required: true },
    { type: 'results', title: 'Ø§Ù„Ù†ØªØ§Ø¦Ø¬', required: true },
    { type: 'discussion', title: 'Ø§Ù„Ù…Ù†Ø§Ù‚Ø´Ø©', required: true },
    { type: 'conclusion', title: 'Ø§Ù„Ø®Ø§ØªÙ…Ø©', required: true },
    { type: 'recommendations', title: 'Ø§Ù„ØªÙˆØµÙŠØ§Øª', required: false }
  ],
  backMatter: [
    { type: 'references', title: 'Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹', required: true },
    { type: 'appendix', title: 'Ø§Ù„Ù…Ù„Ø§Ø­Ù‚', required: false }
  ]
};

export type ThesisSectionType = 
  | 'title'
  | 'preface'
  | 'acknowledgments'
  | 'abstract'
  | 'table-of-contents'
  | 'list-of-figures'
  | 'list-of-tables'
  | 'abbreviations'
  | 'glossary'
  | 'introduction'
  | 'literature-review'
  | 'theoretical-framework'
  | 'methodology'
  | 'empirical-study'
  | 'results'
  | 'discussion'
  | 'conclusion'
  | 'recommendations'
  | 'postface'
  | 'references'
  | 'appendix'
  | 'advice'
  | 'custom';

// File: src\utils\thesisUtils.ts

import { Section, Thesis } from '@/types/thesis';

export type SectionType = 'general-introduction' | 'general-conclusion' | 'abstract' | 'acknowledgments' | 'chapter' | 'references' | 'appendix';

export const createEmptySection = (type: SectionType, order: number = 1): Section => ({
  id: type === 'general-introduction' || type === 'general-conclusion' ? type : crypto.randomUUID(),
  title: type.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' '),
  content: '',
  type,
  required: type === 'general-introduction' || type === 'general-conclusion',
  order,
  status: 'draft',
  created_at: new Date().toISOString(),
  updated_at: new Date().toISOString(),
  figures: [],
  tables: [],
  citations: [],
  references: [],
  footnotes: []
});

export const ensureThesisStructure = (thesis: Partial<Thesis>): Thesis => ({
  ...thesis,
  id: thesis.id || crypto.randomUUID(),
  title: thesis.title || 'Untitled Thesis',
  metadata: thesis.metadata || {},
  frontMatter: thesis.frontMatter || [],
  generalIntroduction: thesis.generalIntroduction || createEmptySection('general-introduction'),
  chapters: thesis.chapters || [],
  generalConclusion: thesis.generalConclusion || createEmptySection('general-conclusion'),
  backMatter: thesis.backMatter || []
});


// File: src\utils\translations.ts

export const translations = {
  en: {
    common: {
      login: "Login",
      signup: "Sign Up",
      features: "Features",
      about: "About",
      getStarted: "Get Started",
      home: "Home"
    },
    landing: {
      hero: {
        title: "Write Your Thesis with Confidence",
        subtitle: "A powerful platform for academic writing and collaboration",
        cta: "Start Writing Now",
        learnMore: "Learn More"
      },
      features: {
        title: "Powerful Features for Academic Success",
        subtitle: "Everything you need to write a professional thesis",
        smartEditor: {
          title: "Smart Editor",
          description: "Write and format your thesis with our intelligent editor"
        },
        collaboration: {
          title: "Real-time Collaboration",
          description: "Work together with advisors and peers seamlessly"
        },
        versionControl: {
          title: "Version Control",
          description: "Track changes and manage different versions effortlessly"
        },
        aiPowered: {
          title: "AI-Powered",
          description: "Get intelligent suggestions and formatting assistance"
        }
      },
      pricing: {
        title: "Choose Your Plan",
        subtitle: "Select the perfect plan for your academic journey",
        basic: {
          title: "Basic",
          price: "0 DZD",
          duration: "one thesis"
        },
        standard: {
          title: "Standard",
          price: "3,900 DZD",
          duration: "per thesis"
        },
        research: {
          title: "Research",
          price: "13,900 DZD",
          duration: "yearly"
        }
      }
    }
  },
  fr: {
    common: {
      login: "Connexion",
      signup: "S'inscrire",
      features: "FonctionnalitÃ©s",
      about: "Ã€ propos",
      getStarted: "Commencer",
      home: "Accueil"
    },
    landing: {
      hero: {
        title: "RÃ©digez votre thÃ¨se en toute confiance",
        subtitle: "Une plateforme puissante pour la rÃ©daction acadÃ©mique et la collaboration",
        cta: "Commencer Ã  Ã©crire",
        learnMore: "En savoir plus"
      },
      features: {
        title: "Des fonctionnalitÃ©s puissantes pour la rÃ©ussite acadÃ©mique",
        subtitle: "Tout ce dont vous avez besoin pour rÃ©diger une thÃ¨se professionnelle",
        smartEditor: {
          title: "Ã‰diteur intelligent",
          description: "RÃ©digez et formatez votre thÃ¨se avec notre Ã©diteur intelligent"
        },
        collaboration: {
          title: "Collaboration en temps rÃ©el",
          description: "Travaillez ensemble avec vos directeurs et pairs de maniÃ¨re transparente"
        },
        versionControl: {
          title: "ContrÃ´le de version",
          description: "Suivez les modifications et gÃ©rez diffÃ©rentes versions sans effort"
        },
        aiPowered: {
          title: "PropulsÃ© par l'IA",
          description: "Obtenez des suggestions intelligentes et une assistance au formatage"
        }
      },
      pricing: {
        title: "Choisissez votre forfait",
        subtitle: "SÃ©lectionnez le forfait parfait pour votre parcours acadÃ©mique",
        basic: {
          title: "Basique",
          price: "0 DZD",
          duration: "une thÃ¨se"
        },
        standard: {
          title: "Standard",
          price: "3 900 DZD",
          duration: "par thÃ¨se"
        },
        research: {
          title: "Recherche",
          price: "13 900 DZD",
          duration: "par an"
        }
      }
    }
  },
  ar: {
    common: {
      login: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
      signup: "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨",
      features: "Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª",
      about: "Ø­ÙˆÙ„",
      getStarted: "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†",
      home: "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"
    },
    landing: {
      hero: {
        title: "Ø§ÙƒØªØ¨ Ø£Ø·Ø±ÙˆØ­ØªÙƒ Ø¨Ø«Ù‚Ø©",
        subtitle: "Ù…Ù†ØµØ© Ù‚ÙˆÙŠØ© Ù„Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© ÙˆØ§Ù„ØªØ¹Ø§ÙˆÙ†",
        cta: "Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¢Ù†",
        learnMore: "Ø§Ø¹Ø±Ù Ø§Ù„Ù…Ø²ÙŠØ¯"
      },
      features: {
        title: "Ù…ÙŠØ²Ø§Øª Ù‚ÙˆÙŠØ© Ù„Ù„Ù†Ø¬Ø§Ø­ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ",
        subtitle: "ÙƒÙ„ Ù…Ø§ ØªØ­ØªØ§Ø¬Ù‡ Ù„ÙƒØªØ§Ø¨Ø© Ø£Ø·Ø±ÙˆØ­Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ©",
        smartEditor: {
          title: "Ù…Ø­Ø±Ø± Ø°ÙƒÙŠ",
          description: "Ø§ÙƒØªØ¨ ÙˆÙ†Ø³Ù‚ Ø£Ø·Ø±ÙˆØ­ØªÙƒ Ù…Ø¹ Ù…Ø­Ø±Ø±Ù†Ø§ Ø§Ù„Ø°ÙƒÙŠ"
        },
        collaboration: {
          title: "ØªØ¹Ø§ÙˆÙ† ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ",
          description: "Ø§Ø¹Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙˆØ§Ù„Ø²Ù…Ù„Ø§Ø¡ Ø¨Ø³Ù„Ø§Ø³Ø©"
        },
        versionControl: {
          title: "Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª",
          description: "ØªØªØ¨Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ© Ø¨Ø³Ù‡ÙˆÙ„Ø©"
        },
        aiPowered: {
          title: "Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ",
          description: "Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø°ÙƒÙŠØ© ÙˆÙ…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚"
        }
      },
      pricing: {
        title: "Ø§Ø®ØªØ± Ø®Ø·ØªÙƒ",
        subtitle: "Ø§Ø®ØªØ± Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ© Ù„Ø±Ø­Ù„ØªÙƒ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©",
        basic: {
          title: "Ø£Ø³Ø§Ø³ÙŠ",
          price: "0 Ø¯Ø¬",
          duration: "Ø£Ø·Ø±ÙˆØ­Ø© ÙˆØ§Ø­Ø¯Ø©"
        },
        standard: {
          title: "Ù‚ÙŠØ§Ø³ÙŠ",
          price: "3,900 Ø¯Ø¬",
          duration: "Ù„ÙƒÙ„ Ø£Ø·Ø±ÙˆØ­Ø©"
        },
        research: {
          title: "Ø¨Ø­Ø«",
          price: "13,900 Ø¯Ø¬",
          duration: "Ø³Ù†ÙˆÙŠØ§"
        }
      }
    }
  }
} as const;

export type Language = keyof typeof translations;

// File: src\vite-env.d.ts

/// <reference types="vite/client" />